
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>(機械翻訳) フックの使用 &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="next" title="(機械翻訳) ピラミッド構成のイントロスペクション" href="introspector.html" />
    <link rel="prev" title="(機械翻訳) サブリクエストの呼び出し" href="subrequest.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="introspector.html" title="(機械翻訳) ピラミッド構成のイントロスペクション"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="subrequest.html" title="(機械翻訳) サブリクエストの呼び出し"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-hooks">
<span id="hooks-chapter"></span><h1>(機械翻訳) フックの使用<a class="headerlink" href="#using-hooks" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>&amp;quot;Hooks &amp;quot;は：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`フレームワークの動作にさまざまな形で影響を与えるために使用できます。</p>
<div class="section" id="changing-the-not-found-view">
<span id="changing-the-notfound-view"></span><span id="index-0"></span><h2>見つからないビューの変更<a class="headerlink" href="#changing-the-not-found-view" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：app： <cite>Pyramid`がURLをコードを見るためにマップすることができないとき、：term：</cite> Not Found View`を呼び出します。これは：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>view callable`です。既定の[見つからない]ビューは、アプリケーション構成によって上書きできます。</p>
<p>アプリケーションでterm： <cite>imperative configuration`を使用している場合は、：meth：</cite> pyramid.config.Configurator.add_notfound_view`メソッドを使用してNot Found Viewを置き換えることができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_notfound_view</span><span class="p">(</span><span class="n">notfound</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>Not Found View`呼び出し可能とは、他の呼び出し可能なビューと同じです。</p>
<p>あなたのアプリケーションが：class： <cite>pyramid.view.view_config`デコレータとa：term：</cite> scan`を代わりに使用している場合は、：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.view.notfound_view_config`デコレータを使用して、</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">notfound_view_config</span>

<span class="nd">@notfound_view_config</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>これは、上記の必須の例が示したこととまったく同じです。</p>
<p>アプリケーションは、必要に応じて複数の*見つからなかったビューを定義することができます。 meth： <cite>pyramid.config.Configurator.add_notfound_view`と：class：</cite> pyramid.view.notfound_view_config`は、class： <cite>pyramid.config.Configurator.add_view`と：class：</cite> pyramid &amp;#39;と同じ引数を取ります。 view.view_config`と呼びます。これは、Not Found Viewsが述語を適用してその適用性を制限できることを意味します。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">notfound_view_config</span>

<span class="nd">@notfound_view_config</span><span class="p">(</span><span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notfound_get</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Not Found during GET&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">)</span>

<span class="nd">@notfound_view_config</span><span class="p">(</span><span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notfound_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Not Found during POST&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
   <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
   <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>`` notfound_get``ビューは、ビューが見つからず、リクエストメソッドが `` GET``であるときに呼び出されます。ビューが見つからず、リクエストメソッドが `` POST``だったときに `` notfound_post``ビューが呼び出されます。</p>
<p>他のビューと同様、Not Found Viewは、少なくとも `` request``パラメータ、あるいは `` context``と `` request``の両方を受け入れなければなりません。 `` request``は、拒否されたアクションを表すcurrent：term： <cite>request`です。 `</cite> context``（コールシグネチャで使用されている場合）は、ビューを呼び出す原因となった：exc： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.httpexceptions.HTTPNotFound`例外のインスタンスになります。</p>
<p>：meth： <cite>pyramid.config.Configurator.add_notfound_view`と：class：</cite> pyramid.view.notfound_view_config`はリクエストをスラッシュで追加されたルートに自動的にリダイレクトするために使用できます。例については：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>redirecting_to_slash_appended_routes`を参照してください。</p>
<p>以下は、minimal：termを実装するサンプルコードです： <a href="#id1"><span class="problematic" id="id2">`</span></a>Not Found View`呼び出し可能：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPNotFound</span>

<span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">見つからないビューの呼び出し可能関数が呼び出されると、a：term： <cite>request`が渡されます。要求の `</cite> exception``属性は、Not Found Viewが呼び出される原因となった：exc： <cite>〜pyramid.httpexceptions.HTTPNotFound`例外のインスタンスになります。 `</cite> request.exception.message``の値は、Not Found例外が発生した理由を説明する値になります。このメッセージは、 `` pyramid.debug_notfound``環境設定が真であるか偽であるかによって異なる値を持ちます。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Not Found View呼び出し可能関数が：ref： <cite>request_and_context_view_definitions`に記述されているように引数リストを受け入れると、ビュー呼び出し可能関数の最初の引数として渡される</cite> <cite>context``は、：exc：</cite>〜pyramid.httpexceptions.HTTPNotFound`例外ですインスタンス。可能であれば、リソースコンテキストは `` request.context``として利用できます。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">：term： <cite>Not Found View`呼び出しは、a：exc：</cite>〜pyramid.httpexceptions.HTTPNotFound`例外が発生したときにのみ呼び出されます。ビューから例外が返された場合、それは通常のレスポンスオブジェクトとして扱われ、カスタムビューはトリガされません。</p>
</div>
</div>
<div class="section" id="changing-the-forbidden-view">
<span id="index-1"></span><span id="id1"></span><h2>禁止されたビューの変更<a class="headerlink" href="#changing-the-forbidden-view" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`は、使用中の：term：<a href="#id3"><span class="problematic" id="id4">`</span></a>認可ポリシー <a href="#id5"><span class="problematic" id="id6">`</span></a>に基づいてビューの実行を認可できないとき、：term：<a href="#id7"><span class="problematic" id="id8">`</span></a>禁止ビュー &amp;#39;を呼び出します。禁止されたデフォルトの応答は403ステータスコードを持ち、非常に単純ですが、それを生成するビューは必要に応じてオーバーライドできます。</p>
<p>：term： <cite>禁じられたビュー</cite> callableは、他のものと同様に呼び出し可能なビューです。 ：term： <cite>view configuration`は：meth：</cite> pyramid.config.Configurator.add_forbidden_​​view` APIまたは：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.view.forbidden_​​view_config`デコレータを使用して構成されます。</p>
<p>たとえば、禁止されたビューを登録するために、：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_forbidden_​​view`メソッドを使用して、禁止されたビューを追加することができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forbidden</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;forbidden&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_forbidden_view</span><span class="p">(</span><span class="n">forbidden</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>デコレータとa：term： <cite>scan`を使いたい場合は、：class：</cite> pyramid.view.forbidden_​​view_config`デコレータを使用して、呼び出し可能なビューを禁止ビューとしてマークすることができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">forbidden_view_config</span>

<span class="nd">@forbidden_view_config</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">forbidden</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;forbidden&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
   <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
   <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>他のビューと同様に、禁止されたビューは少なくとも `` request``パラメータ、あるいは `` context``と `` request``の両方を受け入れなければなりません。禁じられたビュー呼び出し可能オブジェクトが `` context``と `` request``の両方を受け入れるならば、HTTP Exceptionはコンテキストとして渡されます。ビューが拒否されたとき（通常はあなたが期待する）ルータが見つけた <a href="#id1"><span class="problematic" id="id2">``</span></a>コンテキスト <a href="#id3"><span class="problematic" id="id4">``</span></a>は `` request.context``として利用できます。 `` request``は、拒否されたアクションを表すcurrent：term： <a href="#id5"><span class="problematic" id="id6">`</span></a>request`です。</p>
<p>禁止されていない最小限のビューを実装するサンプルコードを次に示します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">def</span> <span class="nf">forbidden_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;forbidden&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">禁止ビュー呼び出し可能関数が呼び出されると、a：term： <cite>request`が渡されます。要求の `</cite> exception``属性は：for：exc： <cite>〜pyramid.httpexceptions.HTTPForbidden`例外のインスタンスになり、禁止されたビューが呼び出されます。 `</cite> request.exception.message``の値は、禁止された例外が発生した理由を説明する値になります。また、 `` request.exception.result``は、禁止された例外に関する拡張情報になります。これらのメッセージは、 `` pyramid.debug_authorization``環境設定が真であるか偽であるかによって、値が異なります。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">：term： <cite>forbidden view`呼び出しは、a：exc：</cite>〜pyramid.httpexceptions.HTTPForbidden`例外が発生したときにのみ呼び出されます。ビューから例外が返された場合、それは通常のレスポンスオブジェクトとして扱われ、カスタムビューはトリガされません。</p>
</div>
</div>
<div class="section" id="changing-the-request-factory">
<span id="index-2"></span><span id="id2"></span><h2>リクエストファクトリの変更<a class="headerlink" href="#changing-the-request-factory" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：app： <cite>Pyramid`は：term：</cite> WSGI`サーバからのリクエストを処理するたびに、渡されたWSGI環境に基づいて：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>request`オブジェクトを作成します。デフォルトでは：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>pyramid.request.Request`クラスのインスタンスが作成され、リクエストオブジェクトを表します。</p>
<p>app： <cite>Pyramid`が要求オブジェクトインスタンスを作成するために使用するクラス（別名&amp;quot; factory &amp;quot;）は、</cite> <cite>request_factory``引数を：term：</cite> configurator`のコンストラクタに渡すことによって変更できます。この引数は、呼び出し可能かa：term：呼び出し可能を表す <a href="#id1"><span class="problematic" id="id2">`</span></a>ドット付きPython名`のいずれかです。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">class</span> <span class="nc">MyRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">request_factory</span><span class="o">=</span><span class="n">MyRequest</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>命令型の設定をしていて、：term： <cite>configurator`を既に構築した後、それをやりたいのであれば、：meth：</cite> pyramid.config.Configurator.set_request_factory`メソッドで登録することもできます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">class</span> <span class="nc">MyRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_request_factory</span><span class="p">(</span><span class="n">MyRequest</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="adding-methods-or-properties-to-a-request-object">
<span id="adding-request-method"></span><span id="index-3"></span><h2>リクエストオブジェクトへのメソッドまたはプロパティの追加<a class="headerlink" href="#adding-methods-or-properties-to-a-request-object" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.4 で追加.</span></p>
</div>
<p>各Pyramidアプリケーションはterm： <a href="#id1"><span class="problematic" id="id2">`</span></a>request`ファクトリ、：ref：<a href="#id3"><span class="problematic" id="id4">`</span></a>要求ファクトリを変更する&lt;changing_the_request_factory&gt; <a href="#id5"><span class="problematic" id="id6">`</span></a>は拡張可能ではありません（特に、Pyramidアドオンやプラグインなど）。</p>
<p>lazyプロパティは、：meth： <cite>pyramid.config.Configurator.add_request_method</cite> APIを介して要求オブジェクトに登録できます。これにより、要求オブジェクトで使用できる呼び出し可能オブジェクトを指定できますが、アクセスされるまで関数を実際には実行しません。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">これは、同じ名前を持つ：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>request factory`からメソッドとプロパティを暗黙にオーバーライドします。</p>
</div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prop</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;getting the property&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;the property&quot;</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、 `` total``がメソッドとして追加されています。しかし、 `` prop``はプロパティとして追加され、その結果は `` reify = True``を設定することによって要求ごとにキャッシュされます。このようにして、関数を複数回実行するオーバーヘッドを排除します。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">total</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">prop</span>
<span class="go">getting the property</span>
<span class="go">&#39;the property&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">prop</span>
<span class="go">&#39;the property&#39;</span>
</pre></div>
</div>
<p>`` request.prop``の結果をキャッシュしないようにするには、 `` reify = True``の代わりに `` property = True``を設定します。</p>
<p>`` Configurator.add_request_method``にクラスを渡す例です：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.decorator</span> <span class="kn">import</span> <span class="n">reify</span>

<span class="k">class</span> <span class="nc">ExtraStuff</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># use @property if you don&#39;t want to cache the result</span>
    <span class="nd">@reify</span>
    <span class="k">def</span> <span class="nf">prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;getting the property&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;the property&quot;</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">ExtraStuff</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>`` extra``という名前のオブジェクトを `` request``オブジェクトに添付してキャッシュします。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">total</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">prop</span>
<span class="go">getting the property</span>
<span class="go">&#39;the property&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">prop</span>
<span class="go">&#39;the property&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-the-response-factory">
<span id="index-4"></span><span id="id3"></span><h2>レスポンスファクトリの変更<a class="headerlink" href="#changing-the-response-factory" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.6 で追加.</span></p>
</div>
<p>：app： <cite>Pyramid`はビューから応答を返すたびに：term：</cite> response`オブジェクトを作成します。デフォルトでは：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.response.Response`クラスのインスタンスがレスポンスオブジェクトを表すために作成されます。</p>
<p>app： <cite>Pyramid`がレスポンスオブジェクトのインスタンスを作成するために使うfactoryは：class：</cite> pyramid.interfaces.IResponseFactory`引数を：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>configurator`のコンストラクタに渡すことで変更できます。この引数は、呼び出し可能かa：term：呼び出し可能を表す <a href="#id3"><span class="problematic" id="id4">`</span></a>ドット付きPython名`のいずれかです。</p>
<p>ファクトリは：term： <cite>Request`オブジェクトの1つの位置引数をとります。引数は `</cite> None``です。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">MyResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">response_factory</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">MyResponse</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>命令型の設定をしていて、：term： <cite>configurator`を既に構築した後に、それをやりたいのであれば、：meth：</cite> pyramid.config.Configurator.set_response_factory`メソッドで登録することもできます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">MyResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_response_factory</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">MyResponse</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="using-the-before-render-event">
<span id="beforerender-event"></span><span id="index-5"></span><h2>Before Renderイベントの使用<a class="headerlink" href="#using-the-before-render-event" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：class： <cite>pyramid.events.BeforeRender`イベントのサブスクライバは、：term：</cite> renderer globals`のセットをイントロスペクトして変更してから：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>renderer`に渡します。このイベントオブジェクトiselfは、この目的のために使用できる辞書のようなインターフェイスを備えています。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">subscriber</span>
<span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">BeforeRender</span>

<span class="nd">@subscriber</span><span class="p">(</span><span class="n">BeforeRender</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_global</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;mykey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
</pre></div>
</td></tr></table></div>
<p>この型のオブジェクトは、a：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>renderer`が呼び出される直前のイベントとして送信されます。</p>
<p>サブスクライバが既にレンダラグローバルディクショナリに存在するキーを追加しようとすると、：exc： <a href="#id1"><span class="problematic" id="id2">`</span></a>KeyError`が送出されます。イベントのサブスクライバは相対的な順序付けを持たないため、この制限が適用されます。レンダラーグローバルディクショナリにall：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>pyramid.events.BeforeRender`サブスクライバおよびレンダラグローバルファクトリに追加されたキーのセットは一意でなければなりません。</p>
<p>ビューから返された辞書は：class： <cite>〜pyramid.events.BeforeRender`イベントの：attr：</cite> rendering_val`属性からアクセスできます。</p>
<p>`` {&amp;#39;mykey&amp;#39;： &amp;#39;somevalue&amp;#39;、 &amp;#39;mykey2&amp;#39;： &amp;#39;somevalue2&amp;#39;} <a href="#id1"><span class="problematic" id="id2">``</span></a>を呼び出し可能なビューから返すとします：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;some_renderer&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mykey&#39;</span><span class="p">:</span> <span class="s1">&#39;somevalue&#39;</span><span class="p">,</span> <span class="s1">&#39;mykey2&#39;</span><span class="p">:</span> <span class="s1">&#39;somevalue2&#39;</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>：attr： <cite>rendering_val`は：class：</cite>〜pyramid.events.BeforeRender`オブジェクトからこれらの値にアクセスするために使用できます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">subscriber</span>
<span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">BeforeRender</span>

<span class="nd">@subscriber</span><span class="p">(</span><span class="n">BeforeRender</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_return</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="c1"># {&#39;mykey&#39;: &#39;somevalue&#39;} is returned from the view</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">rendering_val</span><span class="p">[</span><span class="s1">&#39;mykey&#39;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>：class： <cite>pyramid.interfaces.IBeforeRender`の：class：</cite>〜pyramid.events.BeforeRender`イベントインタフェースに関するAPIのドキュメントを参照してください。</p>
</div>
<div class="section" id="using-response-callbacks">
<span id="index-6"></span><span id="id4"></span><h2>応答コールバックの使用<a class="headerlink" href="#using-response-callbacks" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>他の多くのWebフレームワークとは異なり、：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`は、グローバルレスポンスオブジェクトを熱心に作成しません。 a：term： <a href="#id3"><span class="problematic" id="id4">`</span></a>response callback &amp;#39;を追加すると、通常、応答を変更するために、アプリケーションがビューによって返されるどんな応答オブジェクトに対しても実行されるアクションを登録することができます。</p>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.request.Request.add_response_callback`メソッドは、応答コールバックを登録するために使用されます。</p>
<p>応答コールバックは、 `` request``と `` response``という2つの位置パラメータを受け入れる呼び出し可能なコールバックです。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cache_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the cache_control max_age for the response&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">cache_control</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="mi">360</span>
<span class="n">request</span><span class="o">.</span><span class="n">add_response_callback</span><span class="p">(</span><span class="n">cache_callback</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>未処理の例外がアプリケーションコードで発生した場合、または：term： <cite>view callable`によって返された応答オブジェクトが無効な場合は、応答コールバックは呼び出されません。ただし、応答コールバック*は、：term： `exception view`が正常にレンダリングされたときに*呼び出されます。そのような場合、リクエストのレスポンスコールバックに入るときの：attr： `request.exception`属性はデフォルト値の</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>None``ではなく例外オブジェクトになります。</p>
<p>応答コールバックは、追加された順に（最初から最後に追加された順に）呼び出されます。すべての応答コールバックは*：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.events.NewResponse`イベントが送信される前に呼び出されます。応答コールバックによって発生したエラーは特別に処理されません。彼らは：app： <a href="#id3"><span class="problematic" id="id4">`</span></a>Pyramid`ルータアプリケーションの呼び出し側に伝播します。</p>
<p>応答コールバックは、* single <a href="#id1"><span class="problematic" id="id2">*</span></a>要求の存続期間を持ちます。 <a href="#id3"><span class="problematic" id="id4">*</span></a>すべての*リクエストの結果として応答コールバックが必要な場合は、（：class： <a href="#id5"><span class="problematic" id="id6">`</span></a>〜pyramid.events.NewRequest`イベントのサブスクライバ内の）新しいリクエストごとにコールバックを再登録する必要があります。</p>
</div>
<div class="section" id="using-finished-callbacks">
<span id="index-7"></span><span id="id5"></span><h2>終了コールバックの使用<a class="headerlink" href="#using-finished-callbacks" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A：term： <cite>終了コールバック`は、リクエスト処理の最後で、：app： `Pyramid</cite>：term：` router`によって無条件に呼び出される関数です。完了コールバックを使用して、要求の最後に無条件にアクションを実行できます。</p>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.request.Request.add_finished_callback`メソッドは、終了したコールバックを登録するために使用されます。</p>
<p>完成したコールバックは、単一の位置パラメータ： `` request``を受け入れる呼び出し可能な呼び出しです。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log information at the end of request&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Request is finished.&#39;</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">add_finished_callback</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>完成したコールバックは、追加された順に呼び出されます（最初から最後まで追加された）。応答が生成されないようにするアプリケーションコード内で例外が発生しても、終了コールバック（a：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>応答コールバック（））は*常に呼び出されます。</p>
<p>要求に関連付けられた完了コールバックのセットは、その要求の処理中に非常に遅い*と呼ばれます。それらは本質的に要求の前に：term： <cite>router`によって呼び出される最後のものです。これらは、ルータ要求処理コード内の最上位の `</cite> finally： <a href="#id1"><span class="problematic" id="id2">``</span></a>ブロックで既に応答処理が行われた後に呼び出されます。結果として、完了したコールバックに与えられた `` request``に対して実行された突然変異は、応答処理が既に発生しており、完了したすべてのコールバックが処理された直後にリクエストの有効範囲が失効するため、意味のある効果はありません。</p>
<p>終了コールバックによって発生したエラーは特別に処理されません。彼らは：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`ルータアプリケーションの呼び出し側に伝播します。</p>
<p>終了コールバックは、* single <a href="#id1"><span class="problematic" id="id2">*</span></a>要求の存続期間を持ちます。すべての*要求の結果として終了コールバックが必要な場合は、（：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜pyramid.events.NewRequest`イベントのサブスクライバ内の）新しいリクエストごとにコールバックを再登録する必要があります。</p>
</div>
<div class="section" id="changing-the-traverser">
<span id="index-8"></span><span id="id6"></span><h2>トラバーサの変更<a class="headerlink" href="#changing-the-traverser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>app： <cite>Pyramid`が使うデフォルト：term：</cite> traversal`アルゴリズムは：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>traversal_algorithm`で説明されています。ほとんどの場合は必要ではありませんが、このデフォルトアルゴリズムは、コンフィギュレーションを介して異なるトラバーサルパターンに対して選択的にスワップアウトできます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">myapp.traversal</span> <span class="kn">import</span> <span class="n">Traverser</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_traverser</span><span class="p">(</span><span class="n">Traverser</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、 `` myapp.traversal.Traverser``は次のインタフェースを実装するクラスとみなされています：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Traverser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Accept the root object returned from the root factory &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dictionary with (at least) the keys ``root``,</span>
<span class="sd">        ``context``, ``view_name``, ``subpath``, ``traversed``,</span>
<span class="sd">        ``virtual_root``, and ``virtual_root_path``.  These values are</span>
<span class="sd">        typically the result of a resource tree traversal.  ``root``</span>
<span class="sd">        is the physical root object, ``context`` will be a resource</span>
<span class="sd">        object, ``view_name`` will be the view name used (a Unicode</span>
<span class="sd">        name), ``subpath`` will be a sequence of Unicode names that</span>
<span class="sd">        followed the view name but were not traversed, ``traversed``</span>
<span class="sd">        will be a sequence of Unicode names that were traversed</span>
<span class="sd">        (including the virtual root path, if any) ``virtual_root``</span>
<span class="sd">        will be a resource object representing the virtual root (or the</span>
<span class="sd">        physical root if traversal was not performed), and</span>
<span class="sd">        ``virtual_root_path`` will be a sequence representing the</span>
<span class="sd">        virtual root path (a sequence of Unicode names) or None if</span>
<span class="sd">        traversal was not performed.</span>

<span class="sd">        Extra keys for special purpose functionality can be added as</span>
<span class="sd">        necessary.</span>

<span class="sd">        All values returned in the dictionary will be made available</span>
<span class="sd">        as attributes of the ``request`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
<p>複数のトラバーサルアルゴリズムを同時にアクティブにすることができます。たとえば、：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>root factory`が複数の型のオブジェクトを条件付きで返した場合、代替のトラバーサアダプタは特定のクラスまたはインタフェースの1つのみであると主張することができます。ルートファクトリがそのクラスまたはインターフェイスを実装したオブジェクトを返すと、カスタムトラバーサが使用されます。それ以外の場合は、デフォルトのトラバーサが使用されます。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">myapp.traversal</span> <span class="kn">import</span> <span class="n">Traverser</span>
<span class="kn">from</span> <span class="nn">myapp.resources</span> <span class="kn">import</span> <span class="n">MyRoot</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_traverser</span><span class="p">(</span><span class="n">Traverser</span><span class="p">,</span> <span class="n">MyRoot</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>ピラミッドの ​​`` __init __。py``ファイルの `` main``関数に上記のスタンザが追加された場合、：app： <cite>Pyramid`は</cite>：myapp.traversal.Traverser``を使用します：application：term： ` root factory`は `` myapp.resources.MyRoot``オブジェクトのインスタンスを返しました。それ以外の場合は、デフォルト：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`トラバーサを使用してトラバーサルを行います。</p>
</div>
<div class="section" id="changing-how-pyramid-request-request-resource-url-generates-a-url">
<span id="changing-resource-url"></span><span id="index-9"></span><h2>How：meth： <cite>pyramid.request.Request.resource_url</cite> URLを生成します。<a class="headerlink" href="#changing-how-pyramid-request-request-resource-url-generates-a-url" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：ref： <cite>changing_the_traverser`で説明されているようにトラバーサを追加すると、：meth：</cite> pyramid.request.Request.resource_url` APIを使い続けると便利なことがよくあります。ただし、トラバーサルが行われる方法は変更されるため、カスタムトラバーサから派生したリソースに対して使用されると、デフォルトで生成されるURLが正しくない可能性があります。</p>
<p>トラバーサを追加した場合、以下を変更することができます：meth： <cite>〜pyramid.request.Request.resource_url</cite>：meth：` pyramid.config.Configurator.add_resource_url_adapterの呼び出しを追加することにより、特定のタイプのリソースのURLを生成します`。</p>
<p>例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">myapp.traversal</span> <span class="kn">import</span> <span class="n">ResourceURLAdapter</span>
<span class="kn">from</span> <span class="nn">myapp.resources</span> <span class="kn">import</span> <span class="n">MyRoot</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_resource_url_adapter</span><span class="p">(</span><span class="n">ResourceURLAdapter</span><span class="p">,</span> <span class="n">MyRoot</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、 `` myapp.traversal.ResourceURLAdapter``クラスは：term： <cite>resource`が</cite> <cite>resource_url &amp;#39;&amp;#39;に渡されるときにいつでも：meth：</cite>〜pyramid.request.Request.resource_url`にサービスを提供するために使われます。 <a href="#id1"><span class="problematic" id="id2">``</span></a>は `` myapp.resources.MyRoot``クラスのものです。 `` resource_iface``引数 `` MyRoot``は、このリソースurlファクトリが見つかるためにリソースが所有しなければならないインタフェースのタイプを表します。 `` resource_iface``引数を省略すると、このリソースURLアダプタは* all <a href="#id3"><span class="problematic" id="id4">*</span></a>リソースに使用されます。</p>
<p>class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.interfaces.IResourceURL`を提供するクラスによって実装されなければならないAPIは以下の通りです：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyResourceURL</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An adapter which provides the virtual and physical paths of a</span>
<span class="sd">        resource</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Accept the resource and request and set self.physical_path and</span>
<span class="sd">        self.virtual_path &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_path</span> <span class="o">=</span>  <span class="n">some_function_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_path_tuple</span> <span class="o">=</span>  <span class="n">some_function_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_path</span> <span class="o">=</span>  <span class="n">some_other_function_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_path_tuple</span> <span class="o">=</span>  <span class="n">some_function_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>デフォルトコンテキストURLジェネレータは、 <cite>traversalモジュールのクラス：class：</cite> pyramid.traversal.ResourceURL`として閲覧することができます&lt;<a class="reference external" href="https://github.com/Pylons/pyramid/blob/master/pyramid/traversal.py">https://github.com/Pylons/pyramid/blob/master/pyramid/traversal.py</a>&gt; <cite>term：</cite> Pylons` GitHub Pyramidリポジトリ。</p>
<p>詳細は、meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_resource_url_adapter`を参照してください。</p>
</div>
<div class="section" id="changing-how-pyramid-treats-view-responses">
<span id="using-iresponse"></span><span id="index-10"></span><h2>ピラミッドが応答を見る方法を変える<a class="headerlink" href="#changing-how-pyramid-treats-view-responses" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.1 で追加.</span></p>
</div>
<p>meth： <cite>pyramid.config.Configurator.add_response_adapter`または：class：</cite>〜pyramid.response.response_adapter &amp;#39;を含むフックを使用して、Pyramidがタイプごとに呼び出し可能なビューを呼び出した結果をどのように扱うかを制御することは可能です`デコレータ。</p>
<p>Pyramidは、さまざまな場所で、view：callableを呼び出した結果を：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.interfaces.IResponse`インタフェースに適応させて、ビュー呼び出し可能オブジェクトが返すオブジェクトが&amp;quot; true &amp;quot;応答オブジェクトであることを保証します。大部分の時間は、この適応の結果は結果オブジェクトそのものです。このマニュアルに含まれている説明文を読んでいる &amp;quot;一般市民&amp;quot;が作成したビュー呼び出し可能ファイルは、常に：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜ピラミッドを実装するものを返します。 interfaces.IResponse`インタフェースを使用します。最も一般的には、これは：class： <a href="#id5"><span class="problematic" id="id6">`</span></a>pyramid.response.Response`クラスまたはサブクラスのインスタンスになります。民間人が：term： <a href="#id7"><span class="problematic" id="id8">`</span></a>renderer`を使うように設定されていないビュー呼び出し可能オブジェクトから非応答オブジェクトを返すと、通常、ルータはエラーを発生させると予想します。しかしPyramidは、任意の戻り値を：class： <a href="#id9"><span class="problematic" id="id10">`</span></a>〜pyramid.interfaces.IResponse`を実装するものに変換するアダプタを提供することで、呼び出し可能なビューから任意の値を返すことができます。</p>
<p>たとえば、ビュー呼び出し可能オブジェクトが（文字列をレスポンスオブジェクトに変換するために：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>rendererを必要とせずに）ベア文字列オブジェクトを返すようにしたい場合は、文字列をレスポンスに変換するアダプタを登録できます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">def</span> <span class="nf">string_response_adapter</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># config is an instance of pyramid.config.Configurator</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_response_adapter</span><span class="p">(</span><span class="n">string_response_adapter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>同様に、ビューコールバックから単純化された種類の応答オブジェクトを返すには、IResponseフックを使用して、より複雑なIResponseインターフェイスにアダプタを登録します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">SimpleResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

<span class="k">def</span> <span class="nf">simple_response_adapter</span><span class="p">(</span><span class="n">simple_response</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">simple_response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># config is an instance of pyramid.config.Configurator</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_response_adapter</span><span class="p">(</span><span class="n">simple_response_adapter</span><span class="p">,</span> <span class="n">SimpleResponse</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>：class： <cite>pyramid.response.Response`オブジェクトを任意の容量で使うのではなく、独自のResponseオブジェクトを実装したい場合は、そのオブジェクトが以下で説明するすべての属性とメソッドを実装していることを確認する必要があります：class： `pyramid.interfaces.IResponse`と</cite> <cite>zope.interface.implementer（IResponse）</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>をクラスデコレータとして使用するようにする必要があります。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.interfaces</span> <span class="kn">import</span> <span class="n">IResponse</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IResponse</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ... an implementation of every method and attribute</span>
    <span class="c1"># documented in IResponse should follow ...</span>
</pre></div>
</td></tr></table></div>
<p>呼び出し可能なビューによって代替の応答オブジェクト実装が返されたとき、そのオブジェクトが：class： <cite>〜pyramid.interfaces.IResponse`（</cite> <cite>zope.interface.implementer（IResponse）</cite> &amp;#39;を介して）を実装していると主張する場合、オブジェクトのために登録されていない。ピラミッドはそれを直接使用します。</p>
<p>`` webob.Response``のIResponseアダプタ（：class： <cite>pyramid.response.Response</cite>）は、起動時にPyramidによって本質的にこのクラスのインスタンス（およびサブクラスのインスタンス）によって登録されます）は、ネイティブにIResponseを提供します。 `` webob.Response``に登録されたアダプタは単にレスポンスオブジェクトを返します。</p>
<p>：meth： <cite>pyramid.config.Configurator.add_response_adapter`を使う代わりに、：class：</cite> pyramid.response.response_adapter`デコレータを使うことができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">response_adapter</span>

<span class="nd">@response_adapter</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">string_response_adapter</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、スキャンしたときと同じ効果があります。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_response_adapter</span><span class="p">(</span><span class="n">string_response_adapter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<p>：class： <cite>〜pyramid.response.response_adapter`デコレータは：term：</cite> scan`によって起動されるまで効果を持ちません。</p>
</div>
<div class="section" id="using-a-view-mapper">
<span id="index-11"></span><span id="id7"></span><h2>ビューマッパーの使用<a class="headerlink" href="#using-a-view-mapper" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>view callablesのデフォルトの呼び出し規約は、：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>views_chapter`の章に記述されています。 ：term： <a href="#id3"><span class="problematic" id="id4">`</span></a>view mapper`を使って、ユーザがビュー呼び出し可能関数を定義する方法を変更することができます。</p>
<p>ビューマッパーは、キーワード引数のセットを受け入れ、呼び出し可能なオブジェクトを返すオブジェクトです。返された呼び出し可能関数は：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>view callable`オブジェクトで呼び出されます。返された呼び出し可能コードは、それ自身&amp;quot;内部呼び出しプロトコル&amp;quot; <a href="#id3"><span class="problematic" id="id4">``</span></a>（コンテキスト、要求） <a href="#id5"><span class="problematic" id="id6">`</span></a>&amp;#39;で呼び出すことができる別の呼び出し可能コードを返さなければなりません。</p>
<p>ビューマッパーは、さまざまな方法で使用できます。</p>
<ul class="simple">
<li>`` __view_mapper__``属性（ビューマッパーオブジェクト）をビューの呼び出し可能なもの自体に設定することで</li>
<li>マッパーオブジェクトを `` mapper``引数として：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_view`（またはその宣言とデコレータの同等物）に渡すことで、</li>
<li><a href="#id1"><span class="problematic" id="id2">*</span></a>デフォルト*ビューマッパーを登録することで</li>
</ul>
<p>以下に、Pylons &amp;quot;controller &amp;quot;をエミュレートするビューマッパーの例を示します。マッパーはいくつかのキーワード引数で初期化されます。 `` __call__``メソッドはビューオブジェクト（クラスになります）を受け入れます。どの属性をアクションメソッドとして使用するかを決定するために渡される `` attr``キーワード引数を使用します。それが返すラッパーメソッドは、 <a href="#id1"><span class="problematic" id="id2">``</span></a>（context、request） <a href="#id3"><span class="problematic" id="id4">``</span></a>を受け取り、 `` action``をポップした後：：term： <a href="#id5"><span class="problematic" id="id6">`</span></a>matchdict`で暗黙指定されたキーワード引数を持つアクションメソッドを呼び出した結果を返します。これは、パス引数dictをキーワード引数として引き出したルーティングパラメータを使用して、Pylonsスタイルの呼び出しメソッドをエミュレートします。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># framework</span>

<span class="k">class</span> <span class="nc">PylonsControllerViewMapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="n">matchdict</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">matchdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="o">**</span><span class="n">matchdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">BaseController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__view_mapper__</span> <span class="o">=</span> <span class="n">PylonsControllerViewMapper</span>
</pre></div>
</td></tr></table></div>
<p>ユーザーは、次のようにこれらのフレームワークコンポーネントを利用することができます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># user application</span>

<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">import</span> <span class="nn">pyramid_handlers</span>
<span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>

<span class="k">class</span> <span class="nc">MyController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">pyramid_handlers</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;/{id}&#39;</span><span class="p">,</span> <span class="n">MyController</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;/{action}/{id}&#39;</span><span class="p">,</span> <span class="n">MyController</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">())</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.set_view_mapper`メソッドは、<a href="#id3"><span class="problematic" id="id4">*</span></a>デフォルト*のビューマッパーを設定するために使用できます（Pyramid自身が使用するスーパーディファクトビューマッパーをオーバーライドします）。</p>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>単一ビューの登録では、mapperを `` mapper``引数として：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜pyramid.config.Configurator.add_view`に渡すことによって、ビューマッパーを使用できます。</p>
</div>
<div class="section" id="registering-configuration-decorators">
<span id="index-12"></span><span id="id8"></span><h2>設定デコレータの登録<a class="headerlink" href="#registering-configuration-decorators" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：class： <cite>〜pyramid.view.view_config`のようなデコレータは、装飾している関数やクラスの動作を変更しません。代わりにa：term： `scan`が実行されると、関数またはクラスの修正版が：app：</cite> Pyramid`で登録されます。</p>
<p>そのような動作を提供する独自のデコレータを使用することをお勧めします。これは、：term： <cite>Venusian`パッケージを：app：</cite> Pyramid`によって使用されるのと同じ方法で使用することで可能です。</p>
<p>例として、あなたが：term： <cite>Zope Component Architecture</cite> &amp;quot; utility &amp;quot;で囲んでいる関数を：term：<cite>アプリケーションレジストリ `で囲んで登録するデコレータを書いたとしましょう：app：</cite> Pyramid <a href="#id1"><span class="problematic" id="id2">`</span></a>。アプリケーションレジストリとレジストリ内のユーティリティは、アプリケーションの構成が少なくとも部分的に完了すると利用可能になる可能性があります。通常のデコレータは、設定が開始される前に実行されるので失敗します。</p>
<p>しかし、term： <a href="#id1"><span class="problematic" id="id2">`</span></a>Venusian`を使うと、デコレータは次のように書くことができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">venusian</span>
<span class="kn">from</span> <span class="nn">mypackage.interfaces</span> <span class="kn">import</span> <span class="n">IMyUtility</span>

<span class="k">class</span> <span class="nc">registerFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">registry</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">IMyUtility</span><span class="p">)</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapped</span>
</pre></div>
</td></tr></table></div>
<p>このデコレータを使用して、コード全体に関数を登録することができます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@registerFunction</span><span class="p">(</span><span class="s1">&#39;/some/path&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_function</span><span class="p">():</span>
    <span class="n">do_stuff</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>ただし、ユーティリティは：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>scan`が実行されたときにのみ検索され、事前にユーティリティーを設定することができます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">mypackage.interfaces</span> <span class="kn">import</span> <span class="n">IMyUtility</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IMyUtility</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UtilityImplementation</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">callable_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">callable_</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">UtilityImplementation</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>詳細については、：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>Venusian documentation &lt;venusian:venusian&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>。</p>
</div>
<div class="section" id="registering-tweens">
<span id="id9"></span><h2>Tweensの登録<a class="headerlink" href="#registering-tweens" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.2 で追加: </span>トゥイーンズ</p>
</div>
<p>A：term： <cite>tween`（単語間の&amp;quot; &amp;quot;の短縮形）は、ピラミッドルータのメインリクエスト処理関数と、アップストリームWSGIコンポーネントの間にあるコードです。app：</cite> Pyramid`を&amp;quot;app &amp;quot;これはPyramidフレームワーク拡張がPyramid固有のビュータイミングをサポートするために使用する機能です。たとえば、例外が上流のWSGIアプリケーションに返される前にその例外を調べます。 Tweensはterm： <cite>WSGI</cite>：term：` middleware`のように動作しますが、Pyramid：term： <cite>request</cite>、：term：` response`にアクセスできるコンテキストで動作する利点があります。 and：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>アプリケーションレジストリ`とピラミッドレンダリング機構。</p>
<div class="section" id="creating-a-tween">
<h3>トゥイーンの作成<a class="headerlink" href="#creating-a-tween" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>トゥイーンを作成するには、&amp;quot;トゥイーンファクトリー&amp;quot;を作成する必要があります。トゥイーンファクトリは、 `` handler``と `` registry``という2つの引数を受け入れる、グローバルにインポート可能な呼び出し可能でなければなりません。 `` handler``はメインのPyramidリクエスト処理関数か別のトゥイーンのいずれかになります。 `` registry``は、このコンフィギュレータが表すPyramid：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>アプリケーションレジストリ &amp;#39;になります。トゥイーンファクトリは、呼び出されたときにトゥイーン（呼び出し可能なオブジェクト）を返さなければなりません。</p>
<p>トゥイーンは単一の引数 `` request``で呼び出されます。これはPyramidのルータがWSGI要求を受け取ったときに作成される：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>request`です。トゥイーンは：term： <a href="#id3"><span class="problematic" id="id4">`</span></a>response`を返します。通常は、下流のPyramidアプリケーションによって生成されます。</p>
<p>トゥイーンファクトリを単純なクロージャー戻り関数として書くことができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_tween_factory</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
    <span class="c1"># one-time configuration code goes here</span>

    <span class="k">def</span> <span class="nf">simple_tween</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="c1"># code to be executed for each request before</span>
        <span class="c1"># the actual application code goes here</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># code to be executed for each request after</span>
        <span class="c1"># the actual application code goes here</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">return</span> <span class="n">simple_tween</span>
</pre></div>
</td></tr></table></div>
<p>あるいは、tweenファクトリは `` __call__``という魔法のメソッドを持つクラスにすることができます：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">simple_tween_factory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>

        <span class="c1"># one-time configuration code goes here</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># code to be executed for each request before</span>
        <span class="c1"># the actual application code goes here</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># code to be executed for each request after</span>
        <span class="c1"># the actual application code goes here</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table></div>
<p>トゥイーンインスタンス上の状態を変更するのは避けてください。トゥイーンは要求ごとに1回呼び出され、競合状態を避けるために共有される可変状態を注意深く処理する必要があります。</p>
<p>クロージャースタイルは少し良くなり、要求処理パイプラインからトゥイーンを条件付きで省略することができます（次のタイミングトゥイーンの例を参照）。一方、クラススタイルでは、共有可能な可変状態を簡単にでき、サブクラス化が可能です。</p>
<p>各リクエストの処理に要した時間を記録するトゥイーンの完全な例を次に示します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># in a module named myapp.tweens</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pyramid.settings</span> <span class="kn">import</span> <span class="n">asbool</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">timing_tween_factory</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;do_timing&#39;</span><span class="p">)):</span>
        <span class="c1"># if timing support is enabled, return a wrapper</span>
        <span class="k">def</span> <span class="nf">timing_tween</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;The request took </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">timing_tween</span>
    <span class="c1"># if timing support is not enabled, return the original</span>
    <span class="c1"># handler</span>
    <span class="k">return</span> <span class="n">handler</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、トゥイーンファクトリは `` timing_tween``トゥイーンを定義し、 `` asbool（registry.settings.get（ &amp;#39;do_timing&amp;#39;）） <a href="#id1"><span class="problematic" id="id2">``</span></a>が真であればそれを返します。さもなければ、単に与えられたハンドラを返します。 `` registry.settings``属性は、ユーザが提供する配備設定（通常は `` .ini``ファイル）のハンドルです。この場合、ユーザが `` do_timing``設定を定義し、その設定が `` True``であると、ユーザはタイミングを実行すると言っているので、トゥイーン工場はタイミングトゥイーンを返します。さもなければ、提供されたハンドラを返すだけで、タイミングを妨げることになります。</p>
<p>サンプルのタイミングトゥイーンは、開始時間を記録し、ダウンストリームハンドラを呼び出し、ダウンストリームハンドラが消費した秒数を記録し、応答を返します。</p>
</div>
<div class="section" id="registering-an-implicit-tween-factory">
<h3>暗黙的なTweenファクトリの登録<a class="headerlink" href="#registering-an-implicit-tween-factory" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>トゥイーンファクトリを作成したら、：term： <cite>dotted Python name`を使用して、：meth：</cite> pyramid.config.Configurator.add_tween`メソッドを使用して暗黙のトゥイーンチェーンに登録できます。</p>
<p>次に、ピラミッドアプリケーションでトゥイーンファクトリを&amp;quot;暗黙的&amp;quot;トゥイーンとして登録する例を示します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tweens.timing_tween_factory&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>：term： <cite>dotted Python name`を：meth：</cite> pyramid.config.Configurator.add_tween`の最初の引数として使う必要があることに注意してください。これはツイーン工場を指している必要があります。トゥイーンファクトリオブジェクト自体をメソッドに渡すことはできません。それは、term： <cite>dotted Python name`で、グローバルにインポート可能なオブジェクトを指している必要があります。上記の例では、 `</cite> timing_tween_factory`` tweenファクトリが `` myapp.tweens``というモジュールに定義されていると仮定しています。したがって、トゥイーンファクトリは `` myapp.tweens.timing_tween_factory``としてインポートできます。</p>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_tween`を使用すると、ユーザーが構成に明示的なトゥイーンリストを提供していない限り、起動時にシステムにtweenファクトリを使用するよう指示されます。これは&amp;quot;暗黙的な&amp;quot;トゥイーンの意味です。ユーザーは、暗黙的に追加されたトゥイーンを並べ替えたり、並べ替えたりすることにより、明示的なトゥイーンリストを指定することができます。明示的なトゥイーンの順序付けの詳細については、ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>explicit_tween_ordering`を参照してください。</p>
<p>単一のアプリケーション構成内で：meth： <cite>pyramid.config.Configurator.add_tween`を複数回呼び出すと、アプリケーション起動時にトゥイーンが連鎖します。 `</cite> add_tween`を介して追加された* first * tweenファクトリは、ピラミッド例外ビューのtweenファクトリを `` handler``引数として呼び出されます。その後、その直後に追加されたtweenファクトリが最初に呼び出されますトゥイーンのファクトリが呼び出されてしまうまで、無限に無限になります。ピラミッドルータは、このチェーンによって生成された最も外側のトゥイーン（最後に追加されたトゥイーンファクトリによって生成されたトゥイーン）をその要求ハンドラ関数として使用します。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tween_factory1&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tween_factory2&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、次のような暗黙のトゥイーンチェーンが生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INGRESS</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">tween_factory2</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">tween_factory1</span>
<span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">excview_tween_factory</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">MAIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="suggesting-implicit-tween-ordering">
<h3>暗黙的なTweenオーダーの提案<a class="headerlink" href="#suggesting-implicit-tween-ordering" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デフォルトでは、上で説明したように、チェーンの順序は、：meth： <cite>pyramid.config.Configurator.add_tween`への呼び出しの相対順序によって完全に制御されます。しかし、 `</cite> add_tween``の呼び出し側は、 `` under``または `` over``（または両方）の引数を：meth： <cite>〜pyramid.configに与えることで、暗黙のトゥイーンチェーンの順序付けに影響を与えるオプションのヒントを提供できます.Configurator.add_tween</cite>。これらのヒントは、明示的なトゥイーンの順序付けが使用されていない場合にのみ使用されます。明示的なトゥイーンの順序付けを設定する方法については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>explicit_tween_ordering`を参照してください。</p>
<p>`` under``または `` over``（または両方）の許容値は以下のとおりです：</p>
<ul class="simple">
<li>`` None``（デフォルト）、</li>
<li>a：term： <cite>dotted Python name`をトゥイーンファクトリに：同じコンフィグレーションセッションで</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>add_tween``への呼び出しで追加されたトゥイーンファクトリの予測されたドット名を表す文字列、</li>
<li>attr： <cite>pyramid.tweens.MAIN</cite>、：attr：` pyramid.tweens.INGRESS`、または：attr： <cite>pyramid.tweens.EXCVIEW</cite>、または次のいずれかです。</li>
<li>上記の任意の組み合わせの繰り返し可能なもの。これにより、必要なトゥイーンが含まれていない場合や複数の他のトゥイーンとの互換性がある場合にフォールバックを指定することができます。</li>
</ul>
<p>効果的には、 &amp;quot;over&amp;quot;は&amp;quot;要求入力より&amp;quot;に近いことを意味し、 &amp;quot;under&amp;quot;は&amp;quot;主ピラミッドアプリケーションに&amp;quot;より近いことを意味します。あなたは内側のレイヤー上の外側のレイヤーを持つタマネギを考えることができ、そのアプリケーションは中央のすべてのレイヤーの下にあります。</p>
<p>たとえば、次のように：meth： <cite>〜pyramid.config.Configurator.add_tween`を呼び出すと、</cite> <cite>myapp.tween_factory``で表されるトゥイーンファクトリを直接&amp;quot;上に&amp;quot;（</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>ptweens``順序）主ピラミッド要求ハンドラ。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyramid.tweens</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tween_factory&#39;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">MAIN</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、次のような暗黙のトゥイーンチェーンが生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INGRESS</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">excview_tween_factory</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">tween_factory</span>
<span class="n">MAIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
</pre></div>
</div>
<p>同様に、meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.config.Configurator.add_tween`を呼び出すと、メインのハンドラの上にこのトゥイーンファクトリを配置しようと試みますが、別途追加されたトゥイーンファクトリの下に</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyramid.tweens</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tween_factory1&#39;</span><span class="p">,</span>
                 <span class="n">over</span><span class="o">=</span><span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">MAIN</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tween</span><span class="p">(</span><span class="s1">&#39;myapp.tween_factory2&#39;</span><span class="p">,</span>
                 <span class="n">over</span><span class="o">=</span><span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">MAIN</span><span class="p">,</span>
                 <span class="n">under</span><span class="o">=</span><span class="s1">&#39;myapp.tween_factory1&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上記の例では、次のような暗黙のトゥイーンチェーンが生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INGRESS</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">pyramid</span><span class="o">.</span><span class="n">tweens</span><span class="o">.</span><span class="n">excview_tween_factory</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">tween_factory1</span>
<span class="n">myapp</span><span class="o">.</span><span class="n">tween_factory2</span>
<span class="n">MAIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
</pre></div>
</div>
<p>`` over``と `` under``のどちらも指定しない場合、 `` under = INGRESS``を指定するのと同じです。</p>
<p>`` under``（または `` over``）のすべてのオプションが現在の設定で見つからない場合、それはエラーです。一部のオプションが純粋に他のトゥイーンとの互換性のために指定されている場合は、 `` MAIN`または `` INGRESS``のフォールバックを追加してください。例えば、 `` under =（ &amp;#39;someothertween&amp;#39;、 &amp;#39;someothertween2&amp;#39;、INGRESS） <a href="#id1"><span class="problematic" id="id2">``</span></a>などです。この制約は、トゥイーンが `` someothertween``トゥイーン、 `` someothertween```トゥイーン、 `` INGRESS``の下に置かれることを要求します。これらのいずれかが現在の構成にない場合、この制約は存在するトゥイーンに基づいて構成されます。</p>
</div>
<div class="section" id="explicit-tween-ordering">
<span id="id10"></span><h3>明示的なTweenの注文<a class="headerlink" href="#explicit-tween-ordering" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>明示的なトゥイーンの順序は、明らかにベストエフォートのみです。ピラミッドは、：meth： <cite>〜pyramid.config.Configurator.add_tween`の呼び出しによって提供されるヒントを使用して、最高のトゥイーンの暗黙の順序を提供しようとします。しかし、それは単なるベストエフォート型なので、非常に正確なトゥイーンの注文が必要な場合は、それを得るための唯一の確実な方法は、明示的なトゥイーンの注文を使用することです。展開するユーザは、 `</cite> pyramid.tweens``設定値を使って：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.config.Configurator.add_tween`を呼び出すことによって暗黙のトゥイーンのインクルードと順序付けをオーバーライドすることができます。この設定値を使用する場合は、暗黙のトゥイーンチェーン内のトゥイーンファクトリの順序付け（および包含）を無効にする、Pythonのドット付きの名前のリストでなければなりません。例えば：</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">[app:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:MyApp</span>
<span class="na">pyramid.reload_templates</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">pyramid.debug_authorization</span> <span class="o">=</span> <span class="s">false</span>
<span class="na">pyramid.debug_notfound</span> <span class="o">=</span> <span class="s">false</span>
<span class="na">pyramid.debug_routematch</span> <span class="o">=</span> <span class="s">false</span>
<span class="na">pyramid.debug_templates</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">pyramid.tweens</span> <span class="o">=</span> <span class="s">myapp.my_cool_tween_factory</span>
<span class="s">                 pyramid.tweens.excview_tween_factory</span>
</pre></div>
</td></tr></table></div>
<p>上記の設定では、設定中に：meth： <cite>pyramid.config.Configurator.add_tween`への呼び出しは無視され、ユーザは</cite> <cite>pyramid.tweens``設定でリストアップしたトゥイーンファクトリを使用するようにシステムに指示しています：meth： `pyramid.config.Configurator.add_tween`を使って追加されたトゥイーンファクトリの代わりに、（それぞれ：a：term：</cite> dotted Python name`がトゥイーンファクトリを指しています）。 `` pyramid.tweens``リストの* first * tweenファクトリは、effective：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`リクエスト処理関数のプロデューサとして使用されます。これは、広告の無限に直接&amp;quot;下に&amp;quot;宣言されたトゥウィーン工場をラップします。 &amp;quot;メイン&amp;quot;ピラミッド要求ハンドラは暗黙的で、常に&amp;quot;下に&amp;quot;あります。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Pyramid自身の：term： <cite>例外ビュー`処理ロジックは、：func： `pyramid.tweens.excview_tween_factory`というトゥイーンファクトリ関数として実装されています。 Pyramidの例外ビューの処理が望まれ、 `</cite> pyramid.tweens``設定でtweenファクトリが指定されている場合、 `` pyramid.tweens``設定に：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.tweens.excview_tween_factory`関数を追加する必要がありますリストを明示的に設定する。存在しない場合、Pyramidは例外ビュー処理を実行しません。</p>
</div>
</div>
<div class="section" id="tween-conflicts-and-ordering-cycles">
<h3>ツイーン競合と注文サイクル<a class="headerlink" href="#tween-conflicts-and-ordering-cycles" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ピラミッドは、構成の競合検出を使用して、同じトゥイーンファクトリがトゥイーンチェーンに複数回追加されるのを防ぎます。同じトゥイーンファクトリをコンフィグレーションに複数回追加する場合は、次のいずれかを行う必要があります。（a）グローバルにインポート可能なインスタンスオブジェクトであるトゥイーンファクトリを使用します。 （b）他のトゥイーンファクトリと同じロジックを持つが、違う `` __name__``属性を持つトゥイーンファクトリとして関数またはクラスを使用する。または（c）：meth： <cite>pyramid.config.Configurator.add_tween`の呼び出しの間に：meth：</cite> pyramid.config.Configurator.commit`を呼び出します。</p>
<p>`` over``と `` under``が `` add_tween``の呼び出しで使用されたときに暗黙的なトゥイーンの順序でサイクルが検出されると、起動時に例外が発生します。</p>
</div>
<div class="section" id="displaying-tween-ordering">
<h3>Tweenオーダーの表示<a class="headerlink" href="#displaying-tween-ordering" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` ptweens``コマンドラインユーティリティは、アプリケーションで使用されている現在の暗黙のトーンチェーンと明示的なトゥイーンチェーンを報告するために使用できます。参照：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>displaying_tweens`を参照してください。</p>
</div>
</div>
<div class="section" id="adding-a-third-party-view-route-or-subscriber-predicate">
<span id="registering-thirdparty-predicates"></span><h2>第三者のビュー、ルート、またはサブスクライバの述語を追加する<a class="headerlink" href="#adding-a-third-party-view-route-or-subscriber-predicate" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.4 で追加.</span></p>
</div>
<div class="section" id="view-and-route-predicates">
<span id="id11"></span><h3>述語の表示とルーティング<a class="headerlink" href="#view-and-route-predicates" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>構成時に使用されるビューおよびルート述部を使用すると、ビューまたはルートが一致する一連の状況を絞り込むことができます。例えば、 `` request_method``のビュー述語は、ビューの呼び出し可能メソッドがリクエストのメソッドが `` POST``である場合にのみ呼び出されるようにするために使用できます：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">someview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>同様に、類似の述語を*経路*述語として使用することができます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;/foo&#39;</span><span class="p">,</span> <span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>他の多くの組み込み述語が存在します（ `` request_param`など）。サードパーティの述語は、：meth： <cite>pyramid.config.Configurator.add_view_predicate`または：meth：</cite> pyramid.config.Configurator.add_route_predicate`のいずれかを使用して、利用可能な述語のリストに追加できます。前者はビュー述語を追加し、後者はルート述語を追加します。</p>
<p>これらのAPIのいずれかを使用する場合は、* name <em>と</em> factory <a href="#id1"><span class="problematic" id="id2">*</span></a>を渡してPyramidの設定段階で述語を追加します。例えば：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_view_predicate</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="n">ContentTypePredicate</span><span class="p">)</span>
</pre></div>
</div>
<p>上記の例では、 `` content_type``という名前の新しい述語を、ビューの利用可能な述語のリストに追加しています。これにより、次のビュー構成ステートメントを実行できます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;File&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">aview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<p>：meth： <cite>pyramid.config.Configurator.add_view_predicate`の最初の引数は、</cite> <cite>view_config``（またはその必須の</cite> <cite>add_view`</cite>）に渡されると予想される名前を表す文字列です。</p>
<p>2番目の引数は、ビューまたはルート述語ファクトリです。または、：term： <cite>dotted Python name`は、ビューまたはルート述語ファクトリを参照します。ビューまたはルート述語ファクトリは、コンストラクタ（ `</cite> __init__``）、 `` text``メソッド、 `` phash``メソッド、 `` __call__``メソッドを持つクラスが最もよく使用されます。例えば：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ContentTypePredicate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;content_type = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">,)</span>

    <span class="n">phash</span> <span class="o">=</span> <span class="n">text</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>
</pre></div>
</td></tr></table></div>
<p>述語ファクトリのコンストラクタは、 `` val``と `` config``の2つの引数をとります。 `` val``引数は `` view_config``（または `` add_view``）に渡される引数になります。上記の例では、文字列 `` File``になります。第2引数 `` config``は、設定時のコンフィギュレータインスタンスになります。</p>
<p>`` text``メソッドは文字列を返す必要があります。エラー・メッセージ内の述部の動作を記述すると便利です。</p>
<p>`` phash``メソッドは、文字列または一連の文字列を返す必要があります。 `` text``は述語の名前とコンストラクタに渡される値を一意的に記述する限り、 `` text``とほとんど同じです。 `` text``がより一般的であるか、そうしたことを記述していない場合、 `` phash``は、名前と値を直列化した文字列を返さなければなりません。 `` phash``の結果はどこにも出力されません。ビュー構成の一意性の制約を通知するだけです。</p>
<p>`` __call__``メソッドは、述語が：term： <cite>view述語`またはa：term： `</cite> `` `` `` `` `` ``</p>
<ul class="simple">
<li>ルート述語として使用されるとき、 `` __call__``シグネチャは <a href="#id1"><span class="problematic" id="id2">``</span></a>（info、request） <a href="#id3"><span class="problematic" id="id4">``</span></a>です。 `` info``オブジェクトは `` match``と `` route``の2つのキーを含む辞書です。 `` info [&amp;#39;match&amp;#39;] <a href="#id5"><span class="problematic" id="id6">``</span></a>はルートパターンにマッチしたパターンを含むmatchdictです。 `` info [&amp;#39;route&amp;#39;] <a href="#id7"><span class="problematic" id="id8">``</span></a>は現在のルートの：class： <a href="#id9"><span class="problematic" id="id10">`</span></a>pyramid.interfaces.IRoute`オブジェクトです。</li>
<li>ビュー述語として使用する場合、 `` __call__``シグニチャは <a href="#id1"><span class="problematic" id="id2">``</span></a>（context、request） <a href="#id3"><span class="problematic" id="id4">``</span></a>です。 `` context``は、ルート：term： <a href="#id5"><span class="problematic" id="id6">`</span></a>ルートファクトリ`またはアプリの：term： <a href="#id7"><span class="problematic" id="id8">`</span></a>デフォルトルートファクトリ`のいずれかを使って実行されるterm： <a href="#id9"><span class="problematic" id="id10">`</span></a>traversal`の結果です。</li>
</ul>
<p>どちらの場合も `` __call__``メソッドは `` True``または `` False``を返すと予想されます。</p>
<p>ビュー述語とルート述語の両方と同じ述語ファクトリを使うことは可能ですが、 `` info``や `` context``引数を特別に扱う必要があります（多くの述語はこの引数を必要としません）同じファクトリで `` add_view_predicate``と `` add_route_predicate``を別々に呼び出す必要があります。</p>
</div>
<div class="section" id="subscriber-predicates">
<span id="id12"></span><h3>購読者の述語<a class="headerlink" href="#subscriber-predicates" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>サブスクライバ述語は、ビューとルート述語とほぼ同じように動作します。加入者が呼び出される一連の状況を絞り込みます。サブスクライバ述語とビューまたはルート述語の間には、いくつかの小さな違いがあります。</p>
<ul class="simple">
<li>デフォルトのサブスクライバ述語はありません。あなたは1つを使用して登録する必要があります。</li>
<li>サブスクライバ述語の `` __call__``メソッドは、 `` context``と `` request``の代わりに単一の `` event``オブジェクトを受け取ります。</li>
<li>すべてのイベントタイプですべてのサブスクライバ述語を使用できるわけではありません。一部のサブスクライバ述部では、特定のイベントタイプが想定されます。</li>
</ul>
<p>：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.events.NewRequest`イベントタイプにサブスクライブするサブスクライバと一緒に使用できるサブスクライバ述語の例を次に示します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RequestPathStartsWith</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;path_startswith = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">,)</span>

    <span class="n">phash</span> <span class="o">=</span> <span class="n">text</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>サブスクライバ述語を作成したら、それは：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_subscriber_predicate`で登録することができます。例えば：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_subscriber_predicate</span><span class="p">(</span>
    <span class="s1">&#39;request_path_startswith&#39;</span><span class="p">,</span> <span class="n">RequestPathStartsWith</span><span class="p">)</span>
</pre></div>
</div>
<p>サブスクライバ述語が登録されると、それを：meth： <cite>pyramid.config.Configurator.add_subscriber`または：class：</cite> pyramid.events.subscriber`への呼び出しで使用できます。ここには、以前に登録された `` request_path_startswith``述語を：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.config.Configurator.add_subscriber`の呼び出しで使用する例があります：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># define a subscriber in your code</span>

<span class="k">def</span> <span class="nf">yosubscriber</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">yo</span> <span class="o">=</span> <span class="s1">&#39;YO!&#39;</span>

<span class="c1"># and at configuration time</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_subscriber</span><span class="p">(</span><span class="n">yosubscriber</span><span class="p">,</span> <span class="n">NewRequest</span><span class="p">,</span>
       <span class="n">request_path_startswith</span><span class="o">=</span><span class="s1">&#39;/add_yo&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜pyramid.events.subscriber`を介して使用されるのと同じサブスクライバ/述語/イベントタイプの組み合わせがあります。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.events</span> <span class="kn">import</span> <span class="n">subscriber</span>

<span class="nd">@subscriber</span><span class="p">(</span><span class="n">NewRequest</span><span class="p">,</span> <span class="n">request_path_startswith</span><span class="o">=</span><span class="s1">&#39;/add_yo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">yosubscriber</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">yo</span> <span class="o">=</span> <span class="s1">&#39;YO!&#39;</span>
</pre></div>
</td></tr></table></div>
<p>上記のいずれの設定においても、 `` yosubscriber``呼び出し可能ファイルは、リクエストパスが `` / add_yo``で始まる場合にのみ呼び出されます。そうしないと、イベント加入者は呼び出されません。</p>
<p>あなたが定義した `` request_path_startswith``サブスクライバは、 `` request``属性を持つイベントでは使用できますが、そうでないものには使用できないことに注意してください。たとえば、述語は：class： <cite>pyramid.events.NewRequest`と：class：</cite> pyramid.events.ContextFound`イベントに登録されたサブスクライバで使用できますが、class： <cite>に登録されたサブスクライバでは使用できません。後者のタイプのイベントには `</cite> request``属性がないため、pyramid.events.ApplicationCreatedを呼び出す必要があります。ルートとビュー述語とは異なり、すべてのタイプのサブスクライバ述語が必ずしもすべてのサブスクライバ登録で使用するために適用可能ではありません。すべての述語をすべてのイベントタイプに対して意味を持たせることは、述語作成者の責任ではありません。特定のイベント・タイプ登録に合った述部を使用するのは、述部コンシューマーの責任です。</p>
</div>
</div>
<div class="section" id="view-derivers">
<span id="index-13"></span><span id="id13"></span><h2>デリバーを見る<a class="headerlink" href="#view-derivers" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.7 で追加.</span></p>
</div>
<p>：app： <cite>Pyramid`によって処理されるすべてのURLはカスタムビューのパイプラインと照合されます。これがどのように動作するかについては：ref： `router_chapter`を参照してください。ビューパイプライン自体はユーザ提供の：term： `view callable`から構築され、それは：term：</cite> view derivers &lt;view deriver&gt; <cite>。ビュー・デリバは、ビュー・パイプラインの構成可能な要素であり、追加された機能を持つビューをラップするために使用されます。ビューデリバーは：meth： `pyramid.config.Configurator.add_view`の</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>decorator``引数に非常によく似ていますが、アプリケーション内のすべてのビューに対して実行するオプションがあります。</p>
<p>ビューのミドルウェアとして、：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>view deriver &amp;#39;を考えることは有益です。アプリケーション自体に適用されるトゥイーンまたはWSGIミドルウェアとは異なり、ビュー・デリバはアプリケーションのビューごとに1回呼び出され、ビューの構成オプションを使用してその動作をカスタマイズできます。</p>
<div class="section" id="built-in-view-derivers">
<h3>ビルトインビューデリバー<a class="headerlink" href="#built-in-view-derivers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>app： <cite>Pyramid`は自動的にどのビューにも適用されます。以下は、ユーザ定義の最も近いものから順に定義されています。term： `view callable</cite>：</p>
<p>`` secured_view``</p>
<blockquote>
<div><p>ビューに定義された `` permission``を強制します。パーミッションが定義されていない場合、この要素はno-opです。ビューが：term： <cite>exception view`でない限り、デフォルトのパーミッションが：meth：</cite> pyramid.config.Configurator.set_default_permission`によって割り当てられた場合、常にパーミッションが定義されます。</p>
<p>この要素は、 `` pyramid.debug_authorization``が有効になっているときに有用なデバッグ情報も出力します。</p>
</div></blockquote>
<p>`` csrf_view``</p>
<blockquote>
<div>要求で提供されたCSRFトークンをチェックするために使用されます。 `` require_csrf``の表示オプションが `` True``でなければ、この要素はno-opです。ビューが：term： <cite>exception view`でない限り、デフォルト値が：meth：</cite> pyramid.config.Configurator.set_default_csrf_options`によって割り当てられた場合、 `` require_csrf``オプションが常にあることに注意してください。</div></blockquote>
<p>`` owrapped_view``</p>
<blockquote>
<div>`` wrapper``オプションで定義されたラップビューを呼び出します。</div></blockquote>
<p>`` http_cached_view``</p>
<blockquote>
<div>`` http_cache``オプションで定義されたレスポンスにキャッシュコントロールヘッダを適用します。 `` pyramid.prevent_http_cache``が有効になっているか、 `` http_cache``オプションが `` None``であれば、この要素はno-opです。</div></blockquote>
<p>`` decorated_view``</p>
<blockquote>
<div>`` decorator``オプションのデコレータでビューをラップします。</div></blockquote>
<p><cite>rendered_view`</cite></p>
<blockquote>
<div>：term： <cite>view callable`の結果を：term：</cite> response`オブジェクトに適用します。この点の下には、結果としてPythonオブジェクトがあります。</div></blockquote>
<p>`` mapped_view``</p>
<blockquote>
<div>`` mapper``オプションまたはアプリケーションのデフォルトビューマッパーによって定義された：term： <cite>view mapper`を：term：</cite> view callable`に適用します。これは、常にユーザー定義ビューに最も近いデリバであり、ビューパイプラインインターフェイスを標準化して、以前のすべてのビューデリバーから <a href="#id1"><span class="problematic" id="id2">``</span></a>（コンテキスト、要求）を受け入れるようにします。</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">`` rendered_view``で `` under &amp;#39;&amp;#39;に定義されたビューデリバーは、有効なレスポンスオブジェクトを受け取ることが保証されていません。むしろ、彼らは：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>view mapper`から結果を受け取ります。これは、元の応答がビューから返された可能性が高いです。これはおそらくレンダラーの辞書ですが、レスポンスに適合させることができる任意のPythonオブジェクトである可能性があります。</p>
</div>
</div>
<div class="section" id="custom-view-derivers">
<h3>カスタムビューデリバー<a class="headerlink" href="#custom-view-derivers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>アプリケーションのすべてのビューに影響するカスタムビューデリバーを定義することは可能です。これには多くの用途がありますが、ほとんどの場合、監視とセキュリティに重点が置かれます。 custom：term： <cite>view deriver`を登録するには、：class：</cite> pyramid.interfaces.IViewDeriver`インターフェースに準拠した呼び出し可能ファイルを作成し、それを以下のようにアプリケーションに登録してください：meth： <cite>pyramid.config .Configurator.add_view_deriver</cite>。呼び出し可能オブジェクトはラップされる `` view``と：class： <cite>pyramid.interfaces.IViewDeriverInfo`のインスタンスである</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>info``オブジェクトを受け入れるべきです。たとえば、ビューパイプラインのタイミング情報を提供できる呼び出し可能コードは次のとおりです。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">timing_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timed&#39;</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper_view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-View-Performance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">wrapper_view</span>
    <span class="k">return</span> <span class="n">view</span>

<span class="n">timing_view</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;timed&#39;</span><span class="p">,)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_view_deriver</span><span class="p">(</span><span class="n">timing_view</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>timing_viewに `` timed`を設定すると、Pyramidは `` timed``が有効な `` view_config``キーワード引数であることを示します。上記で登録された `` timing_view``カスタムビューデリバは、 `` view_config``キーワードの1つとして渡される `` timed = True``値で定義されたビューに対してのみアクティブになります。</p>
<p>たとえば、このビューの設定は、時間切れのビューではありません。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Home&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>しかし、このビューでは、応答ヘッダーにタイミング情報が追加されます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">timed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Home&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>ビューデリバーは、何をすべきかを決めるために：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.config.Configurator.add_view`に渡されるほとんどのオプションにアクセスできるという点で独特です。アプリケーションのすべてのビューに影響を及ぼす可能性があります。</p>
</div>
<div class="section" id="exception-views-and-view-derivers">
<span id="exception-view-derivers"></span><h3>例外ビューとビューデリバー<a class="headerlink" href="#exception-views-and-view-derivers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>A：term： <cite>view deriver`は：term：</cite> exception view`を含む任意のビューをラップする機会があります。一般的にはこれは問題ありませんが、例外を処理する際には、特定のビュー・デリバリが特定の処理を行うことを避けたい場合があります。例えば、 `` csrf_view``と `` secured_view``の組み込みビューデリバは、明示的に指示されない限り、例外ビューに対するセキュリティチェックを実行しません。</p>
<p>例外ビューまたは通常ビューをラップするかどうかを判断するためにビューをラップするときは、：class： <cite>pyramid.interfaces.IViewDeriverInfo`オブジェクトで</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>info.exception_only``をチェックすることができます。</p>
</div>
<div class="section" id="ordering-view-derivers">
<h3>デリバリービューの注文<a class="headerlink" href="#ordering-view-derivers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デフォルトでは、すべての新しいビュー・ディリバは、 `` decorated_view``と `` rendered_view``の組み込み関数の間に追加されます。 `` over``と `` under``オプションを使ってこの順序をカスタマイズすることが可能です。各オプションは、順序を指定するために他のビュー・デリバーの名前を使用できます。デリバリがビューパイプライン内の他の操作に依存する場合を除いて、デリバリの順序について心配する必要はほとんどありません。</p>
<p>`` over``と `` under``の両方は、制約の繰り返し可能性もあります。どちらのオプションでも、1つまたは複数の制約が定義されている場合、少なくとも1つは満たされなければなりません。それ以外の場合は：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.exceptions.ConfigurationError`が発生します。これは、別のデリバーがない場合、フォールバック制約を定義するために使用できます。</p>
<p>attr： <cite>pyramid.viewderivers.INGRESS`と：attr：</cite> pyramid.viewderivers.VIEW`の2つのセンチネル値が存在し、ビューパイプラインのエッジで制約を指定するときに使用されます。たとえば、パイプラインの始めにderiverを追加するには、 `` under = INGRESS``を使用します。</p>
<p>`` mapped_view``の下に：term： <cite>view mapper`がuser-defined：term：</cite> view callable`のシグネチャに密接に結びついているように、ビュー・デリバを追加することはできません。元のビューの呼び出し可能性を知る必要がある場合は、提供された：class： <cite>pyramid.interfaces.IViewDeriverInfo`オブジェクト上の</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>info.original_view``で見つけることができます。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">任意のビュー・デリバーのデフォルトの制約は、 `` over = &amp;#39;rendered_view&amp;#39;``と `` under =&amp;#39; decorated_view&amp;#39;``です。これらの制約をエスケープするときは、デリバ間の循環依存性を避けるように注意する必要があります。たとえば、 `` secured_view``の前に新しいビュー・デリバを追加したい場合、 `` over = &amp;#39;secured_view&amp;#39;``を指定するだけでは不十分です。デフォルトは <a href="#id1"><span class="problematic" id="id2">``</span></a>装飾されたビュー <a href="#id3"><span class="problematic" id="id4">``</span></a>の下にもあります。充足できないサイクル。 `` under = INGRESS``がビューパイプラインの始めにINGRESSと `` secured_view``の間に入るような、有効な `` under``制約も指定する必要があります。</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">(機械翻訳) フックの使用</a><ul>
<li><a class="reference internal" href="#changing-the-not-found-view">見つからないビューの変更</a></li>
<li><a class="reference internal" href="#changing-the-forbidden-view">禁止されたビューの変更</a></li>
<li><a class="reference internal" href="#changing-the-request-factory">リクエストファクトリの変更</a></li>
<li><a class="reference internal" href="#adding-methods-or-properties-to-a-request-object">リクエストオブジェクトへのメソッドまたはプロパティの追加</a></li>
<li><a class="reference internal" href="#changing-the-response-factory">レスポンスファクトリの変更</a></li>
<li><a class="reference internal" href="#using-the-before-render-event">Before Renderイベントの使用</a></li>
<li><a class="reference internal" href="#using-response-callbacks">応答コールバックの使用</a></li>
<li><a class="reference internal" href="#using-finished-callbacks">終了コールバックの使用</a></li>
<li><a class="reference internal" href="#changing-the-traverser">トラバーサの変更</a></li>
<li><a class="reference internal" href="#changing-how-pyramid-request-request-resource-url-generates-a-url">How：meth： <cite>pyramid.request.Request.resource_url</cite> URLを生成します。</a></li>
<li><a class="reference internal" href="#changing-how-pyramid-treats-view-responses">ピラミッドが応答を見る方法を変える</a></li>
<li><a class="reference internal" href="#using-a-view-mapper">ビューマッパーの使用</a></li>
<li><a class="reference internal" href="#registering-configuration-decorators">設定デコレータの登録</a></li>
<li><a class="reference internal" href="#registering-tweens">Tweensの登録</a><ul>
<li><a class="reference internal" href="#creating-a-tween">トゥイーンの作成</a></li>
<li><a class="reference internal" href="#registering-an-implicit-tween-factory">暗黙的なTweenファクトリの登録</a></li>
<li><a class="reference internal" href="#suggesting-implicit-tween-ordering">暗黙的なTweenオーダーの提案</a></li>
<li><a class="reference internal" href="#explicit-tween-ordering">明示的なTweenの注文</a></li>
<li><a class="reference internal" href="#tween-conflicts-and-ordering-cycles">ツイーン競合と注文サイクル</a></li>
<li><a class="reference internal" href="#displaying-tween-ordering">Tweenオーダーの表示</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-a-third-party-view-route-or-subscriber-predicate">第三者のビュー、ルート、またはサブスクライバの述語を追加する</a><ul>
<li><a class="reference internal" href="#view-and-route-predicates">述語の表示とルーティング</a></li>
<li><a class="reference internal" href="#subscriber-predicates">購読者の述語</a></li>
</ul>
</li>
<li><a class="reference internal" href="#view-derivers">デリバーを見る</a><ul>
<li><a class="reference internal" href="#built-in-view-derivers">ビルトインビューデリバー</a></li>
<li><a class="reference internal" href="#custom-view-derivers">カスタムビューデリバー</a></li>
<li><a class="reference internal" href="#exception-views-and-view-derivers">例外ビューとビューデリバー</a></li>
<li><a class="reference internal" href="#ordering-view-derivers">デリバリービューの注文</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="subrequest.html"
                        title="前の章へ">(機械翻訳) サブリクエストの呼び出し</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="introspector.html"
                        title="次の章へ">(機械翻訳)  ピラミッド構成のイントロスペクション</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/narr/hooks.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="introspector.html" title="(機械翻訳) ピラミッド構成のイントロスペクション"
             >次へ</a> |</li>
        <li class="right" >
          <a href="subrequest.html" title="(機械翻訳) サブリクエストの呼び出し"
             >前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 03, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>