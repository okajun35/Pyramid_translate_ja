
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Security &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="next" title="Combining Traversal and URL Dispatch" href="hybrid.html" />
    <link rel="prev" title="Traversal" href="traversal.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="hybrid.html" title="Combining Traversal and URL Dispatch"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="traversal.html" title="Traversal"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="security">
<span id="security-chapter"></span><span id="index-0"></span><h1>Security<a class="headerlink" href="#security" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p><span>Pyramid</span> provides an optional, declarative, security system. Security in
<span>Pyramid</span> is separated into authentication and authorization. The two
systems communicate via <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> identifiers. Authentication is merely
the mechanism by which credentials provided in the <a class="reference internal" href="../glossary.html#term-request"><span class="xref std std-term">request</span></a> are resolved
to one or more <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> identifiers. These identifiers represent the
users and groups that are in effect during the request. Authorization then
determines access based on the <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> identifiers, the requested
<a class="reference internal" href="../glossary.html#term-permission"><span class="xref std std-term">permission</span></a>, and a <a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a>.</p>
<p>The <span>Pyramid</span> authorization system can prevent a <a class="reference internal" href="../glossary.html#term-view"><span class="xref std std-term">view</span></a> from being
invoked based on an <a class="reference internal" href="../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a>. Before a view is invoked, the
authorization system can use the credentials in the <a class="reference internal" href="../glossary.html#term-request"><span class="xref std std-term">request</span></a> along with
the <a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a> resource to determine if access will be allowed.  Here's
how it works at a high level:</p>
<ul class="simple">
<li>A user may or may not have previously visited the application and supplied
authentication credentials, including a <a class="reference internal" href="../glossary.html#term-userid"><span class="xref std std-term">userid</span></a>.  If so, the
application may have called <a class="reference internal" href="../api/security.html#pyramid.security.remember" title="pyramid.security.remember"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyramid.security.remember()</span></code></a> to remember
these.</li>
<li>A <a class="reference internal" href="../glossary.html#term-request"><span class="xref std std-term">request</span></a> is generated when a user visits the application.</li>
<li>Based on the request, a <a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a> resource is located through
<a class="reference internal" href="../glossary.html#term-resource-location"><span class="xref std std-term">resource location</span></a>.  A context is located differently depending on
whether the application uses <a class="reference internal" href="../glossary.html#term-traversal"><span class="xref std std-term">traversal</span></a> or <a class="reference internal" href="../glossary.html#term-url-dispatch"><span class="xref std std-term">URL dispatch</span></a>, but a
context is ultimately found in either case.  See the
<a class="reference internal" href="urldispatch.html#urldispatch-chapter"><span class="std std-ref">URL Dispatch</span></a> chapter for more information.</li>
<li>A <a class="reference internal" href="../glossary.html#term-view-callable"><span class="xref std std-term">view callable</span></a> is located by <a class="reference internal" href="../glossary.html#term-view-lookup"><span class="xref std std-term">view lookup</span></a> using the context
as well as other attributes of the request.</li>
<li>If an <a class="reference internal" href="../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> is in effect, it is passed the request.
It will return some number of <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> identifiers. To do this, the
policy would need to determine the authenticated <a class="reference internal" href="../glossary.html#term-userid"><span class="xref std std-term">userid</span></a> present in
the request.</li>
<li>If an <a class="reference internal" href="../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> is in effect and the <a class="reference internal" href="../glossary.html#term-view-configuration"><span class="xref std std-term">view
configuration</span></a> associated with the view callable that was found has a
<a class="reference internal" href="../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> associated with it, the authorization policy is passed the
<a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a>, some number of <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> identifiers returned by the
authentication policy, and the <a class="reference internal" href="../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> associated with the view;
it will allow or deny access.</li>
<li>If the authorization policy allows access, the view callable is invoked.</li>
<li>If the authorization policy denies access, the view callable is not invoked.
Instead the <a class="reference internal" href="../glossary.html#term-forbidden-view"><span class="xref std std-term">forbidden view</span></a> is invoked.</li>
</ul>
<p>Authorization is enabled by modifying your application to include an
<a class="reference internal" href="../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> and <a class="reference internal" href="../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a>. <span>Pyramid</span>
comes with a variety of implementations of these policies.  To provide maximal
flexibility, <span>Pyramid</span> also allows you to create custom authentication
policies and authorization policies.</p>
<div class="section" id="enabling-an-authorization-policy">
<span id="enabling-authorization-policy"></span><span id="index-1"></span><h2>Enabling an Authorization Policy<a class="headerlink" href="#enabling-an-authorization-policy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><span>Pyramid</span> does not enable any authorization policy by default.  All views
are accessible by completely anonymous users.  In order to begin protecting
views from execution based on security settings, you need to enable an
authorization policy.</p>
<div class="section" id="enabling-an-authorization-policy-imperatively">
<h3>Enabling an Authorization Policy Imperatively<a class="headerlink" href="#enabling-an-authorization-policy-imperatively" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Use the <a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_authorization_policy" title="pyramid.config.Configurator.set_authorization_policy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_authorization_policy()</span></code></a> method of
the <a class="reference internal" href="../api/config.html#pyramid.config.Configurator" title="pyramid.config.Configurator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Configurator</span></code></a> to enable an authorization policy.</p>
<p>You must also enable an <a class="reference internal" href="../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> in order to enable the
authorization policy.  This is because authorization, in general, depends upon
authentication.  Use the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_authentication_policy" title="pyramid.config.Configurator.set_authentication_policy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_authentication_policy()</span></code></a> method during
application setup to specify the authentication policy.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span><span class="s1">&#39;seekrit&#39;</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">)</span>
<span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">authentication_policy</span></code> and <code class="docutils literal notranslate"><span class="pre">authorization_policy</span></code> arguments
may also be passed to their respective methods mentioned above as
<a class="reference internal" href="../glossary.html#term-dotted-python-name"><span class="xref std std-term">dotted Python name</span></a> values, each representing the dotted name path to
a suitable implementation global defined at Python module scope.</p>
</div>
<p>The above configuration enables a policy which compares the value of an &quot;auth
ticket&quot; cookie passed in the request's environment which contains a reference
to a single <a class="reference internal" href="../glossary.html#term-userid"><span class="xref std std-term">userid</span></a>, and matches that userid's <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principals</span></a> against the principals present in any <a class="reference internal" href="../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> found in the
resource tree when attempting to call some <a class="reference internal" href="../glossary.html#term-view"><span class="xref std std-term">view</span></a>.</p>
<p>While it is possible to mix and match different authentication and
authorization policies, it is an error to configure a Pyramid application with
an authentication policy but without the authorization policy or vice versa. If
you do this, you'll receive an error at application startup time.</p>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">See also the <a class="reference internal" href="../api/authorization.html#module-pyramid.authorization" title="pyramid.authorization"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.authorization</span></code></a> and <a class="reference internal" href="../api/authentication.html#module-pyramid.authentication" title="pyramid.authentication"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.authentication</span></code></a>
modules for alternative implementations of authorization and authentication
policies.</p>
</div>
</div>
</div>
<div class="section" id="protecting-views-with-permissions">
<span id="protecting-views"></span><span id="index-2"></span><h2>Protecting Views with Permissions<a class="headerlink" href="#protecting-views-with-permissions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>To protect a <a class="reference internal" href="../glossary.html#term-view-callable"><span class="xref std std-term">view callable</span></a> from invocation based on a user's security
settings when a particular type of resource becomes the <a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a>, you
must pass a <a class="reference internal" href="../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> to <a class="reference internal" href="../glossary.html#term-view-configuration"><span class="xref std std-term">view configuration</span></a>.  Permissions are
usually just strings, and they have no required composition: you can name
permissions whatever you like.</p>
<p>For example, the following view declaration protects the view named
<code class="docutils literal notranslate"><span class="pre">add_entry.html</span></code> when the context resource is of type <code class="docutils literal notranslate"><span class="pre">Blog</span></code> with the
<code class="docutils literal notranslate"><span class="pre">add</span></code> permission using the <a class="reference internal" href="../api/config.html#pyramid.config.Configurator.add_view" title="pyramid.config.Configurator.add_view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_view()</span></code></a> API:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config is an instance of pyramid.config.Configurator</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="s1">&#39;mypackage.views.blog_entry_add_view&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add_entry.html&#39;</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="s1">&#39;mypackage.resources.Blog&#39;</span><span class="p">,</span>
                <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The equivalent view registration including the <code class="docutils literal notranslate"><span class="pre">add</span></code> permission name may be
performed via the <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> decorator:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">resources</span> <span class="kn">import</span> <span class="n">Blog</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">Blog</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add_entry.html&#39;</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">blog_entry_add_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Add blog entry code goes here &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>As a result of any of these various view configuration statements, if an
authorization policy is in place when the view callable is found during normal
application operations, the requesting user will need to possess the <code class="docutils literal notranslate"><span class="pre">add</span></code>
permission against the <a class="reference internal" href="../glossary.html#term-context"><span class="xref std std-term">context</span></a> resource in order to be able to invoke
the <code class="docutils literal notranslate"><span class="pre">blog_entry_add_view</span></code> view.  If they do not, the <a class="reference internal" href="../glossary.html#term-forbidden-view"><span class="xref std std-term">Forbidden view</span></a>
will be invoked.</p>
<div class="section" id="setting-a-default-permission">
<span id="index-3"></span><span id="id1"></span><h3>Setting a Default Permission<a class="headerlink" href="#setting-a-default-permission" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>If a permission is not supplied to a view configuration, the registered view
will always be executable by entirely anonymous users: any authorization policy
in effect is ignored.</p>
<p>In support of making it easier to configure applications which are &quot;secure by
default&quot;, <span>Pyramid</span> allows you to configure a <em>default</em> permission.  If
supplied, the default permission is used as the permission string to all view
registrations which don't otherwise name a <code class="docutils literal notranslate"><span class="pre">permission</span></code> argument.</p>
<p>The <a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_default_permission" title="pyramid.config.Configurator.set_default_permission"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.set_default_permission()</span></code></a> method supports
configuring a default permission for an application.</p>
<p>When a default permission is registered:</p>
<ul class="simple">
<li>If a view configuration names an explicit <code class="docutils literal notranslate"><span class="pre">permission</span></code>, the default
permission is ignored for that view registration, and the
view-configuration-named permission is used.</li>
<li>If a view configuration names the permission
<a class="reference internal" href="../api/security.html#pyramid.security.NO_PERMISSION_REQUIRED" title="pyramid.security.NO_PERMISSION_REQUIRED"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.NO_PERMISSION_REQUIRED</span></code></a>, the default permission is
ignored, and the view is registered <em>without</em> a permission (making it
available to all callers regardless of their credentials).</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">When you register a default permission, <em>all</em> views (even <a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception
view</span></a> views) are protected by a permission.  For all views which are truly
meant to be anonymously accessible, you will need to associate the view's
configuration with the <a class="reference internal" href="../api/security.html#pyramid.security.NO_PERMISSION_REQUIRED" title="pyramid.security.NO_PERMISSION_REQUIRED"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.NO_PERMISSION_REQUIRED</span></code></a>
permission.</p>
</div>
</div>
</div>
<div class="section" id="assigning-acls-to-your-resource-objects">
<span id="assigning-acls"></span><span id="index-4"></span><h2>Assigning ACLs to Your Resource Objects<a class="headerlink" href="#assigning-acls-to-your-resource-objects" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>When the default <span>Pyramid</span> <a class="reference internal" href="../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> determines whether
a user possesses a particular permission with respect to a resource, it
examines the <a class="reference internal" href="../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> associated with the resource.  An ACL is associated
with a resource by adding an <code class="docutils literal notranslate"><span class="pre">__acl__</span></code> attribute to the resource object.
This attribute can be defined on the resource <em>instance</em> if you need
instance-level security, or it can be defined on the resource <em>class</em> if you
just need type-level security.</p>
<p>For example, an ACL might be attached to the resource for a blog via its class:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
        <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Or, if your resources are persistent, an ACL might be specified via the
<code class="docutils literal notranslate"><span class="pre">__acl__</span></code> attribute of an <em>instance</em> of a resource:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">blog</span> <span class="o">=</span> <span class="n">Blog</span><span class="p">()</span>

<span class="n">blog</span><span class="o">.</span><span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
        <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Whether an ACL is attached to a resource's class or an instance of the resource
itself, the effect is the same.  It is useful to decorate individual resource
instances with an ACL (as opposed to just decorating their class) in
applications such as content management systems where fine-grained access is
required on an object-by-object basis.</p>
<p>Dynamic ACLs are also possible by turning the ACL into a callable on the
resource. This may allow the ACL to dynamically generate rules based on
properties of the instance.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span>
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">Writing <code class="docutils literal notranslate"><span class="pre">__acl__</span></code> as properties is discouraged because an
<code class="docutils literal notranslate"><span class="pre">AttributeError</span></code> occurring in <code class="docutils literal notranslate"><span class="pre">fget</span></code> or <code class="docutils literal notranslate"><span class="pre">fset</span></code> will be silently
dismissed (this is consistent with Python <code class="docutils literal notranslate"><span class="pre">getattr</span></code> and <code class="docutils literal notranslate"><span class="pre">hasattr</span></code>
behaviors). For dynamic ACLs, simply use callables, as documented above.</p>
</div>
</div>
<div class="section" id="elements-of-an-acl">
<span id="index-5"></span><h2>Elements of an ACL<a class="headerlink" href="#elements-of-an-acl" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Here's an example ACL:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
        <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The example ACL indicates that the <a class="reference internal" href="../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Everyone</span></code></a>
principal—a special system-defined principal indicating, literally, everyone—is
allowed to view the blog, and the <code class="docutils literal notranslate"><span class="pre">group:editors</span></code> principal is allowed to add
to and edit the blog.</p>
<p>Each element of an ACL is an <a class="reference internal" href="../glossary.html#term-ace"><span class="xref std std-term">ACE</span></a>, or access control entry. For example,
in the above code block, there are three ACEs: <code class="docutils literal notranslate"><span class="pre">(Allow,</span> <span class="pre">Everyone,</span> <span class="pre">'view')</span></code>,
<code class="docutils literal notranslate"><span class="pre">(Allow,</span> <span class="pre">'group:editors',</span> <span class="pre">'add')</span></code>, and <code class="docutils literal notranslate"><span class="pre">(Allow,</span> <span class="pre">'group:editors',</span> <span class="pre">'edit')</span></code>.</p>
<p>The first element of any ACE is either <a class="reference internal" href="../api/security.html#pyramid.security.Allow" title="pyramid.security.Allow"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Allow</span></code></a>, or
<a class="reference internal" href="../api/security.html#pyramid.security.Deny" title="pyramid.security.Deny"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Deny</span></code></a>, representing the action to take when the ACE
matches.  The second element is a <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a>.  The third argument is a
permission or sequence of permission names.</p>
<p>A principal is usually a user id, however it also may be a group id if your
authentication system provides group information and the effective
<a class="reference internal" href="../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> policy is written to respect group information.
See <a class="reference internal" href="#extending-default-authentication-policies"><span class="std std-ref">Extending Default Authentication Policies</span></a>.</p>
<p>Each ACE in an ACL is processed by an authorization policy <em>in the order
dictated by the ACL</em>.  So if you have an ACL like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Deny</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Deny</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The default authorization policy will <em>allow</em> everyone the view permission,
even though later in the ACL you have an ACE that denies everyone the view
permission.  On the other hand, if you have an ACL like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Deny</span>

<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">Deny</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The authorization policy will deny everyone the view permission, even though
later in the ACL, there is an ACE that allows everyone.</p>
<p>The third argument in an ACE can also be a sequence of permission names instead
of a single permission name.  So instead of creating multiple ACEs representing
a number of different permission grants to a single <code class="docutils literal notranslate"><span class="pre">group:editors</span></code> group, we
can collapse this into a single ACE, as below.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Everyone</span>

<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;group:editors&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">)),</span>
    <span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="special-principal-names">
<span id="index-6"></span><h2>Special Principal Names<a class="headerlink" href="#special-principal-names" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Special principal names exist in the <a class="reference internal" href="../api/security.html#module-pyramid.security" title="pyramid.security"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.security</span></code></a> module.  They can
be imported for use in your own code to populate ACLs, e.g.,
<a class="reference internal" href="../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Everyone</span></code></a>.</p>
<p><a class="reference internal" href="../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Everyone</span></code></a></p>
<blockquote>
<div>Literally, everyone, no matter what.  This object is actually a string under
the hood (<code class="docutils literal notranslate"><span class="pre">system.Everyone</span></code>).  Every user <em>is</em> the principal named
&quot;Everyone&quot; during every request, even if a security policy is not in use.</div></blockquote>
<p><a class="reference internal" href="../api/security.html#pyramid.security.Authenticated" title="pyramid.security.Authenticated"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Authenticated</span></code></a></p>
<blockquote>
<div>Any user with credentials as determined by the current security policy.  You
might think of it as any user that is &quot;logged in&quot;.  This object is actually a
string under the hood (<code class="docutils literal notranslate"><span class="pre">system.Authenticated</span></code>).</div></blockquote>
</div>
<div class="section" id="special-permissions">
<span id="index-7"></span><h2>Special Permissions<a class="headerlink" href="#special-permissions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Special permission names exist in the <a class="reference internal" href="../api/security.html#module-pyramid.security" title="pyramid.security"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.security</span></code></a> module.  These
can be imported for use in ACLs.</p>
<p id="all-permissions"><a class="reference internal" href="../api/security.html#pyramid.security.ALL_PERMISSIONS" title="pyramid.security.ALL_PERMISSIONS"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.ALL_PERMISSIONS</span></code></a></p>
<blockquote>
<div>An object representing, literally, <em>all</em> permissions.  Useful in an ACL like
so: <code class="docutils literal notranslate"><span class="pre">(Allow,</span> <span class="pre">'fred',</span> <span class="pre">ALL_PERMISSIONS)</span></code>.  The <code class="docutils literal notranslate"><span class="pre">ALL_PERMISSIONS</span></code> object is
actually a stand-in object that has a <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> method that always
returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, which, for all known authorization policies, has the effect
of indicating that a given principal has any permission asked for by the
system.</div></blockquote>
</div>
<div class="section" id="special-aces">
<span id="index-8"></span><h2>Special ACEs<a class="headerlink" href="#special-aces" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A convenience <a class="reference internal" href="../glossary.html#term-ace"><span class="xref std std-term">ACE</span></a> is defined representing a deny to everyone of all
permissions in <a class="reference internal" href="../api/security.html#pyramid.security.DENY_ALL" title="pyramid.security.DENY_ALL"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.DENY_ALL</span></code></a>.  This ACE is often used as
the <em>last</em> ACE of an ACL to explicitly cause inheriting authorization policies
to &quot;stop looking up the traversal tree&quot; (effectively breaking any inheritance).
For example, an ACL which allows <em>only</em> <code class="docutils literal notranslate"><span class="pre">fred</span></code> the view permission for a
particular resource, despite what inherited ACLs may say when the default
authorization policy is in effect, might look like so:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">Allow</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">DENY_ALL</span>

<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span> <span class="n">DENY_ALL</span> <span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Under the hood, the <a class="reference internal" href="../api/security.html#pyramid.security.DENY_ALL" title="pyramid.security.DENY_ALL"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.DENY_ALL</span></code></a> ACE equals the
following:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="n">ALL_PERMISSIONS</span>
<span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">Deny</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="n">ALL_PERMISSIONS</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="acl-inheritance-and-location-awareness">
<span id="index-9"></span><h2>ACL Inheritance and Location-Awareness<a class="headerlink" href="#acl-inheritance-and-location-awareness" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>While the default <a class="reference internal" href="../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> is in place, if a resource
object does not have an ACL when it is the context, its <em>parent</em> is consulted
for an ACL.  If that object does not have an ACL, <em>its</em> parent is consulted for
an ACL, ad infinitum, until we've reached the root and there are no more
parents left.</p>
<p>In order to allow the security machinery to perform ACL inheritance, resource
objects must provide <em>location-awareness</em>.  Providing <em>location-awareness</em>
means two things: the root object in the resource tree must have a <code class="docutils literal notranslate"><span class="pre">__name__</span></code>
attribute and a <code class="docutils literal notranslate"><span class="pre">__parent__</span></code> attribute.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">__parent__</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</td></tr></table></div>
<p>An object with a <code class="docutils literal notranslate"><span class="pre">__parent__</span></code> attribute and a <code class="docutils literal notranslate"><span class="pre">__name__</span></code> attribute is said
to be <em>location-aware</em>.  Location-aware objects define a <code class="docutils literal notranslate"><span class="pre">__parent__</span></code>
attribute which points at their parent object.  The root object's
<code class="docutils literal notranslate"><span class="pre">__parent__</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">See also <a class="reference internal" href="../api/location.html#location-module"><span class="std std-ref">pyramid.location</span></a> for documentations of functions which use
location-awareness.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">See also <a class="reference internal" href="resources.html#location-aware"><span class="std std-ref">Location-Aware Resources</span></a>.</p>
</div>
</div>
<div class="section" id="changing-the-forbidden-view">
<span id="index-10"></span><h2>Changing the Forbidden View<a class="headerlink" href="#changing-the-forbidden-view" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>When <span>Pyramid</span> denies a view invocation due to an authorization denial,
the special <code class="docutils literal notranslate"><span class="pre">forbidden</span></code> view is invoked.  Out of the box, this forbidden view
is very plain.  See <a class="reference internal" href="hooks.html#changing-the-forbidden-view"><span class="std std-ref">Changing the Forbidden View</span></a> within
<a class="reference internal" href="hooks.html#hooks-chapter"><span class="std std-ref">Using Hooks</span></a> for instructions on how to create a custom forbidden view
and arrange for it to be called when view authorization is denied.</p>
</div>
<div class="section" id="debugging-view-authorization-failures">
<span id="debug-authorization-section"></span><span id="index-11"></span><h2>Debugging View Authorization Failures<a class="headerlink" href="#debugging-view-authorization-failures" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>If your application in your judgment is allowing or denying view access
inappropriately, start your application under a shell using the
<code class="docutils literal notranslate"><span class="pre">PYRAMID_DEBUG_AUTHORIZATION</span></code> environment variable set to <code class="docutils literal notranslate"><span class="pre">1</span></code>.  For
example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ PYRAMID_DEBUG_AUTHORIZATION=1 $VENV/bin/pserve myproject.ini
</pre></div>
</div>
<p>When any authorization takes place during a top-level view rendering, a message
will be logged to the console (to stderr) about what ACE in which ACL permitted
or denied the authorization based on authentication information.</p>
<p>This behavior can also be turned on in the application <code class="docutils literal notranslate"><span class="pre">.ini</span></code> file by setting
the <code class="docutils literal notranslate"><span class="pre">pyramid.debug_authorization</span></code> key to <code class="docutils literal notranslate"><span class="pre">true</span></code> within the application's
configuration section, e.g.:</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">[app:main]</span>
<span class="na">use</span> <span class="o">=</span> <span class="s">egg:MyProject</span>
<span class="na">pyramid.debug_authorization</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</td></tr></table></div>
<p>With this debug flag turned on, the response sent to the browser will also
contain security debugging information in its body.</p>
</div>
<div class="section" id="debugging-imperative-authorization-failures">
<h2>Debugging Imperative Authorization Failures<a class="headerlink" href="#debugging-imperative-authorization-failures" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <a class="reference internal" href="../api/request.html#pyramid.request.Request.has_permission" title="pyramid.request.Request.has_permission"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.has_permission()</span></code></a> API is used to check
security within view functions imperatively.  It returns instances of objects
that are effectively booleans.  But these objects are not raw <code class="docutils literal notranslate"><span class="pre">True</span></code> or
<code class="docutils literal notranslate"><span class="pre">False</span></code> objects, and have information attached to them about why the
permission was allowed or denied.  The object will be one of
<a class="reference internal" href="../api/security.html#pyramid.security.ACLAllowed" title="pyramid.security.ACLAllowed"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.ACLAllowed</span></code></a>, <a class="reference internal" href="../api/security.html#pyramid.security.ACLDenied" title="pyramid.security.ACLDenied"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.ACLDenied</span></code></a>,
<a class="reference internal" href="../api/security.html#pyramid.security.Allowed" title="pyramid.security.Allowed"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Allowed</span></code></a>, or <a class="reference internal" href="../api/security.html#pyramid.security.Denied" title="pyramid.security.Denied"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.security.Denied</span></code></a>, as
documented in <a class="reference internal" href="../api/security.html#security-module"><span class="std std-ref">pyramid.security</span></a>.  At the very minimum, these objects will
have a <code class="docutils literal notranslate"><span class="pre">msg</span></code> attribute, which is a string indicating why the permission was
denied or allowed.  Introspecting this information in the debugger or via print
statements when a call to <a class="reference internal" href="../api/request.html#pyramid.request.Request.has_permission" title="pyramid.request.Request.has_permission"><code class="xref py py-meth docutils literal notranslate"><span class="pre">has_permission()</span></code></a> fails
is often useful.</p>
</div>
<div class="section" id="extending-default-authentication-policies">
<span id="index-12"></span><span id="id2"></span><h2>Extending Default Authentication Policies<a class="headerlink" href="#extending-default-authentication-policies" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Pyramid ships with some built in authentication policies for use in your
applications. See <a class="reference internal" href="../api/authentication.html#module-pyramid.authentication" title="pyramid.authentication"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.authentication</span></code></a> for the available policies.
They differ on their mechanisms for tracking authentication credentials between
requests, however they all interface with your application in mostly the same
way.</p>
<p>Above you learned about <a class="reference internal" href="#assigning-acls"><span class="std std-ref">Assigning ACLs to Your Resource Objects</span></a>. Each <a class="reference internal" href="../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> used in
the <a class="reference internal" href="../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> is matched against the list returned from
<a class="reference internal" href="../api/interfaces.html#pyramid.interfaces.IAuthenticationPolicy.effective_principals" title="pyramid.interfaces.IAuthenticationPolicy.effective_principals"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.interfaces.IAuthenticationPolicy.effective_principals()</span></code></a>.
Similarly, <a class="reference internal" href="../api/request.html#pyramid.request.Request.authenticated_userid" title="pyramid.request.Request.authenticated_userid"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.authenticated_userid()</span></code></a> maps to
<a class="reference internal" href="../api/interfaces.html#pyramid.interfaces.IAuthenticationPolicy.authenticated_userid" title="pyramid.interfaces.IAuthenticationPolicy.authenticated_userid"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.interfaces.IAuthenticationPolicy.authenticated_userid()</span></code></a>.</p>
<p>You may control these values by subclassing the default authentication
policies. For example, below we subclass the
<a class="reference internal" href="../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy" title="pyramid.authentication.AuthTktAuthenticationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.authentication.AuthTktAuthenticationPolicy</span></code></a> and define extra
functionality to query our database before confirming that the <a class="reference internal" href="../glossary.html#term-userid"><span class="xref std std-term">userid</span></a>
is valid in order to avoid blindly trusting the value in the cookie (what if
the cookie is still valid, but the user has deleted their account?).  We then
use that <a class="reference internal" href="../glossary.html#term-userid"><span class="xref std std-term">userid</span></a> to augment the <code class="docutils literal notranslate"><span class="pre">effective_principals</span></code> with
information about groups and other state for that user.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>

<span class="k">class</span> <span class="nc">MyAuthenticationPolicy</span><span class="p">(</span><span class="n">AuthTktAuthenticationPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">userid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">verify_userid_is_still_valid</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">userid</span>

    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">userid</span><span class="p">:</span>
            <span class="n">principals</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Authenticated</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">userid</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">principals</span>
</pre></div>
</td></tr></table></div>
<p>In most instances <code class="docutils literal notranslate"><span class="pre">authenticated_userid</span></code> and <code class="docutils literal notranslate"><span class="pre">effective_principals</span></code> are
application-specific, whereas <code class="docutils literal notranslate"><span class="pre">unauthenticated_userid</span></code>, <code class="docutils literal notranslate"><span class="pre">remember</span></code>, and
<code class="docutils literal notranslate"><span class="pre">forget</span></code> are generic and focused on transport and serialization of data
between consecutive requests.</p>
</div>
<div class="section" id="creating-your-own-authentication-policy">
<span id="creating-an-authentication-policy"></span><span id="index-13"></span><h2>Creating Your Own Authentication Policy<a class="headerlink" href="#creating-your-own-authentication-policy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><span>Pyramid</span> ships with a number of useful out-of-the-box security policies
(see <a class="reference internal" href="../api/authentication.html#module-pyramid.authentication" title="pyramid.authentication"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid.authentication</span></code></a>).  However, creating your own authentication
policy is often necessary when you want to control the &quot;horizontal and
vertical&quot; of how your users authenticate.  Doing so is a matter of creating an
instance of something that implements the following interface:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IAuthenticationPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An object representing a Pyramid authentication policy. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the authenticated :term:`userid` or ``None`` if</span>
<span class="sd">        no authenticated userid can be found. This method of the</span>
<span class="sd">        policy should ensure that a record exists in whatever</span>
<span class="sd">        persistent store is used related to the user (the user</span>
<span class="sd">        should not have been deleted); if a record associated with</span>
<span class="sd">        the current id does not exist in a persistent store, it</span>
<span class="sd">        should return ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the *unauthenticated* userid.  This method</span>
<span class="sd">        performs the same duty as ``authenticated_userid`` but is</span>
<span class="sd">        permitted to return the userid based only on data present</span>
<span class="sd">        in the request; it needn&#39;t (and shouldn&#39;t) check any</span>
<span class="sd">        persistent store to ensure that the user record related to</span>
<span class="sd">        the request userid exists.</span>

<span class="sd">        This method is intended primarily a helper to assist the</span>
<span class="sd">        ``authenticated_userid`` method in pulling credentials out</span>
<span class="sd">        of the request data, abstracting away the specific headers,</span>
<span class="sd">        query strings, etc that are used to authenticate the request.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a sequence representing the effective principals</span>
<span class="sd">        typically including the :term:`userid` and any groups belonged</span>
<span class="sd">        to by the current user, always including &#39;system&#39; groups such</span>
<span class="sd">        as ``pyramid.security.Everyone`` and</span>
<span class="sd">        ``pyramid.security.Authenticated``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a set of headers suitable for &#39;remembering&#39; the</span>
<span class="sd">        :term:`userid` named ``userid`` when set in a response.  An</span>
<span class="sd">        individual authentication policy and its consumers can</span>
<span class="sd">        decide on the composition and meaning of **kw.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a set of headers suitable for &#39;forgetting&#39; the</span>
<span class="sd">        current user on subsequent requests.</span>

<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
<p>After you do so, you can pass an instance of such a class into the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_authentication_policy" title="pyramid.config.Configurator.set_authentication_policy"><code class="xref py py-class docutils literal notranslate"><span class="pre">set_authentication_policy</span></code></a> method at
configuration time to use it.</p>
</div>
<div class="section" id="creating-your-own-authorization-policy">
<span id="creating-an-authorization-policy"></span><span id="index-14"></span><h2>Creating Your Own Authorization Policy<a class="headerlink" href="#creating-your-own-authorization-policy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>An authorization policy is a policy that allows or denies access after a user
has been authenticated.  Most <span>Pyramid</span> applications will use the default
<a class="reference internal" href="../api/authorization.html#pyramid.authorization.ACLAuthorizationPolicy" title="pyramid.authorization.ACLAuthorizationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.authorization.ACLAuthorizationPolicy</span></code></a>.</p>
<p>However, in some cases, it's useful to be able to use a different authorization
policy than the default <a class="reference internal" href="../api/authorization.html#pyramid.authorization.ACLAuthorizationPolicy" title="pyramid.authorization.ACLAuthorizationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">ACLAuthorizationPolicy</span></code></a>.
For example, it might be desirable to construct an alternate authorization
policy which allows the application to use an authorization mechanism that does
not involve <a class="reference internal" href="../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> objects.</p>
<p><span>Pyramid</span> ships with only a single default authorization policy, so you'll
need to create your own if you'd like to use a different one.  Creating and
using your own authorization policy is a matter of creating an instance of an
object that implements the following interface:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IAuthorizationPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An object representing a Pyramid authorization policy. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">permits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">principals</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return ``True`` if any of the ``principals`` is allowed the</span>
<span class="sd">        ``permission`` in the current ``context``, else return ``False``</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">principals_allowed_by_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a set of principal identifiers allowed by the</span>
<span class="sd">        ``permission`` in ``context``.  This behavior is optional; if you</span>
<span class="sd">        choose to not implement it you should define this method as</span>
<span class="sd">        something which raises a ``NotImplementedError``.  This method</span>
<span class="sd">        will only be called when the</span>
<span class="sd">        ``pyramid.security.principals_allowed_by_permission`` API is</span>
<span class="sd">        used.&quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
<p>After you do so, you can pass an instance of such a class into the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_authorization_policy" title="pyramid.config.Configurator.set_authorization_policy"><code class="xref py py-class docutils literal notranslate"><span class="pre">set_authorization_policy</span></code></a> method at
configuration time to use it.</p>
</div>
<div class="section" id="admonishment-against-secret-sharing">
<span id="id3"></span><h2>Admonishment Against Secret-Sharing<a class="headerlink" href="#admonishment-against-secret-sharing" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A &quot;secret&quot; is required by various components of Pyramid.  For example, the
<a class="reference internal" href="../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> below uses a secret value <code class="docutils literal notranslate"><span class="pre">seekrit</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span><span class="s1">&#39;seekrit&#39;</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A <a class="reference internal" href="../glossary.html#term-session-factory"><span class="xref std std-term">session factory</span></a> also requires a secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_session_factory</span> <span class="o">=</span> <span class="n">SignedCookieSessionFactory</span><span class="p">(</span><span class="s1">&#39;itsaseekreet&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is tempting to use the same secret for multiple Pyramid subsystems.  For
example, you might be tempted to use the value <code class="docutils literal notranslate"><span class="pre">seekrit</span></code> as the secret for
both the authentication policy and the session factory defined above.  This is
a bad idea, because in both cases, these secrets are used to sign the payload
of the data.</p>
<p>If you use the same secret for two different parts of your application for
signing purposes, it may allow an attacker to get his chosen plaintext signed,
which would allow the attacker to control the content of the payload.  Re-using
a secret across two different subsystems might drop the security of signing to
zero. Keys should not be re-used across different contexts where an attacker
has the possibility of providing a chosen plaintext.</p>
</div>
<div class="section" id="preventing-cross-site-request-forgery-attacks">
<span id="index-15"></span><h2>Preventing Cross-Site Request Forgery Attacks<a class="headerlink" href="#preventing-cross-site-request-forgery-attacks" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">Cross-site request forgery</a> attacks are a
phenomenon whereby a user who is logged in to your website might inadvertantly
load a URL because it is linked from, or embedded in, an attacker's website.
If the URL is one that may modify or delete data, the consequences can be dire.</p>
<p>You can avoid most of these attacks by issuing a unique token to the browser
and then requiring that it be present in all potentially unsafe requests.
<span>Pyramid</span> provides facilities to create and check CSRF tokens.</p>
<p>By default <span>Pyramid</span> comes with a session-based CSRF implementation
<a class="reference internal" href="../api/csrf.html#pyramid.csrf.SessionCSRFStoragePolicy" title="pyramid.csrf.SessionCSRFStoragePolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.csrf.SessionCSRFStoragePolicy</span></code></a>. To use it, you must first enable
a <a class="reference internal" href="../glossary.html#term-session-factory"><span class="xref std std-term">session factory</span></a> as described in
<a class="reference internal" href="sessions.html#using-the-default-session-factory"><span class="std std-ref">Using the Default Session Factory</span></a> or
<a class="reference internal" href="sessions.html#using-alternate-session-factories"><span class="std std-ref">Using Alternate Session Factories</span></a>. Alternatively, you can use
a cookie-based implementation <a class="reference internal" href="../api/csrf.html#pyramid.csrf.CookieCSRFStoragePolicy" title="pyramid.csrf.CookieCSRFStoragePolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.csrf.CookieCSRFStoragePolicy</span></code></a> which gives
some additional flexibility as it does not require a session for each user.
You can also define your own implementation of
<a class="reference internal" href="../api/interfaces.html#pyramid.interfaces.ICSRFStoragePolicy" title="pyramid.interfaces.ICSRFStoragePolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.interfaces.ICSRFStoragePolicy</span></code></a> and register it with the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_csrf_storage_policy" title="pyramid.config.Configurator.set_csrf_storage_policy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.set_csrf_storage_policy()</span></code></a> directive.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_csrf_storage_policy</span><span class="p">(</span><span class="n">MyCustomCSRFPolicy</span><span class="p">())</span>
</pre></div>
</div>
<div class="section" id="using-the-csrf-get-csrf-token-method">
<span id="index-16"></span><h3>Using the <code class="docutils literal notranslate"><span class="pre">csrf.get_csrf_token</span></code> Method<a class="headerlink" href="#using-the-csrf-get-csrf-token-method" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To get the current CSRF token, use the
<a class="reference internal" href="../api/csrf.html#pyramid.csrf.get_csrf_token" title="pyramid.csrf.get_csrf_token"><code class="xref py py-data docutils literal notranslate"><span class="pre">pyramid.csrf.get_csrf_token</span></code></a> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.csrf</span> <span class="kn">import</span> <span class="n">get_csrf_token</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_csrf_token()</span></code> method accepts a single argument: the request. It
returns a CSRF <em>token</em> string. If <code class="docutils literal notranslate"><span class="pre">get_csrf_token()</span></code> or <code class="docutils literal notranslate"><span class="pre">new_csrf_token()</span></code>
was invoked previously for this user, then the existing token will be returned.
If no CSRF token previously existed for this user, then a new token will be set
into the session and returned. The newly created token will be opaque and
randomized.</p>
</div>
<div class="section" id="using-the-get-csrf-token-global-in-templates">
<span id="get-csrf-token-in-templates"></span><h3>Using the <code class="docutils literal notranslate"><span class="pre">get_csrf_token</span></code> global in templates<a class="headerlink" href="#using-the-get-csrf-token-global-in-templates" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Templates have a <code class="docutils literal notranslate"><span class="pre">get_csrf_token()</span></code> method inserted into their globals, which
allows you to get the current token without modifying the view code. This
method takes no arguments and returns a CSRF token string. You can use the
returned token as the value of a hidden field in a form that posts to a method
that requires elevated privileges, or supply it as a request header in AJAX
requests.</p>
<p>For example, include the CSRF token as a hidden field:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/myview&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;csrf_token&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;${get_csrf_token()}&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Delete Everything&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Or include it as a header in a jQuery AJAX request:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">csrfToken</span> <span class="o">=</span> <span class="s2">&quot;${get_csrf_token()}&quot;</span><span class="p">;</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
  <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/myview&quot;</span><span class="p">,</span>
  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;X-CSRF-Token&#39;</span><span class="o">:</span> <span class="nx">csrfToken</span> <span class="p">}</span>
<span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Deleted&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The handler for the URL that receives the request should then require that the
correct CSRF token is supplied.</p>
</div>
<div class="section" id="using-the-csrf-new-csrf-token-method">
<span id="index-17"></span><h3>Using the <code class="docutils literal notranslate"><span class="pre">csrf.new_csrf_token</span></code> Method<a class="headerlink" href="#using-the-csrf-new-csrf-token-method" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To explicitly create a new CSRF token, use the <code class="docutils literal notranslate"><span class="pre">csrf.new_csrf_token()</span></code>
method.  This differs only from <code class="docutils literal notranslate"><span class="pre">csrf.get_csrf_token()</span></code> inasmuch as it
clears any existing CSRF token, creates a new CSRF token, sets the token into
the user, and returns the token.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.csrf</span> <span class="kn">import</span> <span class="n">new_csrf_token</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">new_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">It is not possible to force a new CSRF token from a template. If you
want to regenerate your CSRF token then do it in the view code and return
the new token as part of the context.</p>
</div>
</div>
<div class="section" id="checking-csrf-tokens-manually">
<h3>Checking CSRF Tokens Manually<a class="headerlink" href="#checking-csrf-tokens-manually" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>In request handling code, you can check the presence and validity of a CSRF
token with <a class="reference internal" href="../api/csrf.html#pyramid.csrf.check_csrf_token" title="pyramid.csrf.check_csrf_token"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyramid.csrf.check_csrf_token()</span></code></a>. If the token is valid, it
will return <code class="docutils literal notranslate"><span class="pre">True</span></code>, otherwise it will raise <code class="docutils literal notranslate"><span class="pre">HTTPBadRequest</span></code>. Optionally,
you can specify <code class="docutils literal notranslate"><span class="pre">raises=False</span></code> to have the check return <code class="docutils literal notranslate"><span class="pre">False</span></code> instead of
raising an exception.</p>
<p>By default, it checks for a POST parameter named <code class="docutils literal notranslate"><span class="pre">csrf_token</span></code> or a header
named <code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.csrf</span> <span class="kn">import</span> <span class="n">check_csrf_token</span>

<span class="k">def</span> <span class="nf">myview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Require CSRF Token</span>
    <span class="n">check_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<div class="section" id="checking-csrf-tokens-automatically">
<span id="auto-csrf-checking"></span><h3>Checking CSRF Tokens Automatically<a class="headerlink" href="#checking-csrf-tokens-automatically" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.7 で追加.</span></p>
</div>
<p><span>Pyramid</span> supports automatically checking CSRF tokens on requests with an
unsafe method as defined by RFC2616. Any other request may be checked manually.
This feature can be turned on globally for an application using the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_default_csrf_options" title="pyramid.config.Configurator.set_default_csrf_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.set_default_csrf_options()</span></code></a> directive.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_default_csrf_options</span><span class="p">(</span><span class="n">require_csrf</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>CSRF checking may be explicitly enabled or disabled on a per-view basis using
the <code class="docutils literal notranslate"><span class="pre">require_csrf</span></code> view option. A value of <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> will
override the default set by <code class="docutils literal notranslate"><span class="pre">set_default_csrf_options</span></code>. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">require_csrf</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>When CSRF checking is active, the token and header used to find the
supplied CSRF token will be <code class="docutils literal notranslate"><span class="pre">csrf_token</span></code> and <code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code>, respectively,
unless otherwise overridden by <code class="docutils literal notranslate"><span class="pre">set_default_csrf_options</span></code>. The token is
checked against the value in <code class="docutils literal notranslate"><span class="pre">request.POST</span></code> which is the submitted form body.
If this value is not present, then the header will be checked.</p>
<p>In addition to token based CSRF checks, if the request is using HTTPS then the
automatic CSRF checking will also check the referrer of the request to ensure
that it matches one of the trusted origins. By default the only trusted origin
is the current host, however additional origins may be configured by setting
<code class="docutils literal notranslate"><span class="pre">pyramid.csrf_trusted_origins</span></code> to a list of domain names (and ports if they
are non-standard). If a host in the list of domains starts with a <code class="docutils literal notranslate"><span class="pre">.</span></code> then
that will allow all subdomains as well as the domain without the <code class="docutils literal notranslate"><span class="pre">.</span></code>.</p>
<p>If CSRF checks fail then a <a class="reference internal" href="../api/exceptions.html#pyramid.exceptions.BadCSRFToken" title="pyramid.exceptions.BadCSRFToken"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.exceptions.BadCSRFToken</span></code></a> or
<a class="reference internal" href="../api/exceptions.html#pyramid.exceptions.BadCSRFOrigin" title="pyramid.exceptions.BadCSRFOrigin"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.exceptions.BadCSRFOrigin</span></code></a> exception will be raised. This
exception may be caught and handled by an <a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception view</span></a> but, by
default, will result in a <code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code> response being sent to the
client.</p>
</div>
<div class="section" id="checking-csrf-tokens-with-a-view-predicate">
<h3>Checking CSRF Tokens with a View Predicate<a class="headerlink" href="#checking-csrf-tokens-with-a-view-predicate" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="deprecated">
<p><span class="versionmodified">バージョン 1.7 で非推奨: </span>Use the <code class="docutils literal notranslate"><span class="pre">require_csrf</span></code> option or read <a class="reference internal" href="#auto-csrf-checking"><span class="std std-ref">Checking CSRF Tokens Automatically</span></a> instead
to have <a class="reference internal" href="../api/exceptions.html#pyramid.exceptions.BadCSRFToken" title="pyramid.exceptions.BadCSRFToken"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.exceptions.BadCSRFToken</span></code></a> exceptions raised.</p>
</div>
<p>A convenient way to require a valid CSRF token for a particular view is to
include <code class="docutils literal notranslate"><span class="pre">check_csrf=True</span></code> as a view predicate. See
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.add_view" title="pyramid.config.Configurator.add_view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_view()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">request_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">check_csrf</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">A mismatch of a CSRF token is treated like any other predicate miss, and the
predicate system, when it doesn't find a view, raises <code class="docutils literal notranslate"><span class="pre">HTTPNotFound</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">HTTPBadRequest</span></code>, so <code class="docutils literal notranslate"><span class="pre">check_csrf=True</span></code> behavior is different
from calling <a class="reference internal" href="../api/csrf.html#pyramid.csrf.check_csrf_token" title="pyramid.csrf.check_csrf_token"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyramid.csrf.check_csrf_token()</span></code></a>.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Security</a><ul>
<li><a class="reference internal" href="#enabling-an-authorization-policy">Enabling an Authorization Policy</a><ul>
<li><a class="reference internal" href="#enabling-an-authorization-policy-imperatively">Enabling an Authorization Policy Imperatively</a></li>
</ul>
</li>
<li><a class="reference internal" href="#protecting-views-with-permissions">Protecting Views with Permissions</a><ul>
<li><a class="reference internal" href="#setting-a-default-permission">Setting a Default Permission</a></li>
</ul>
</li>
<li><a class="reference internal" href="#assigning-acls-to-your-resource-objects">Assigning ACLs to Your Resource Objects</a></li>
<li><a class="reference internal" href="#elements-of-an-acl">Elements of an ACL</a></li>
<li><a class="reference internal" href="#special-principal-names">Special Principal Names</a></li>
<li><a class="reference internal" href="#special-permissions">Special Permissions</a></li>
<li><a class="reference internal" href="#special-aces">Special ACEs</a></li>
<li><a class="reference internal" href="#acl-inheritance-and-location-awareness">ACL Inheritance and Location-Awareness</a></li>
<li><a class="reference internal" href="#changing-the-forbidden-view">Changing the Forbidden View</a></li>
<li><a class="reference internal" href="#debugging-view-authorization-failures">Debugging View Authorization Failures</a></li>
<li><a class="reference internal" href="#debugging-imperative-authorization-failures">Debugging Imperative Authorization Failures</a></li>
<li><a class="reference internal" href="#extending-default-authentication-policies">Extending Default Authentication Policies</a></li>
<li><a class="reference internal" href="#creating-your-own-authentication-policy">Creating Your Own Authentication Policy</a></li>
<li><a class="reference internal" href="#creating-your-own-authorization-policy">Creating Your Own Authorization Policy</a></li>
<li><a class="reference internal" href="#admonishment-against-secret-sharing">Admonishment Against Secret-Sharing</a></li>
<li><a class="reference internal" href="#preventing-cross-site-request-forgery-attacks">Preventing Cross-Site Request Forgery Attacks</a><ul>
<li><a class="reference internal" href="#using-the-csrf-get-csrf-token-method">Using the <code class="docutils literal notranslate"><span class="pre">csrf.get_csrf_token</span></code> Method</a></li>
<li><a class="reference internal" href="#using-the-get-csrf-token-global-in-templates">Using the <code class="docutils literal notranslate"><span class="pre">get_csrf_token</span></code> global in templates</a></li>
<li><a class="reference internal" href="#using-the-csrf-new-csrf-token-method">Using the <code class="docutils literal notranslate"><span class="pre">csrf.new_csrf_token</span></code> Method</a></li>
<li><a class="reference internal" href="#checking-csrf-tokens-manually">Checking CSRF Tokens Manually</a></li>
<li><a class="reference internal" href="#checking-csrf-tokens-automatically">Checking CSRF Tokens Automatically</a></li>
<li><a class="reference internal" href="#checking-csrf-tokens-with-a-view-predicate">Checking CSRF Tokens with a View Predicate</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="traversal.html"
                        title="前の章へ">Traversal</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="hybrid.html"
                        title="次の章へ">Combining Traversal and URL Dispatch</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/narr/security.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="hybrid.html" title="Combining Traversal and URL Dispatch"
             >次へ</a> |</li>
        <li class="right" >
          <a href="traversal.html" title="Traversal"
             >前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 8月 18, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4 で生成しました。
    </div>
  </body>
</html>