
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Invoking a Subrequest &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="next" title="Using Hooks" href="hooks.html" />
    <link rel="prev" title="Combining Traversal and URL Dispatch" href="hybrid.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="hooks.html" title="Using Hooks"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="hybrid.html" title="Combining Traversal and URL Dispatch"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="invoking-a-subrequest">
<span id="subrequest-chapter"></span><span id="index-0"></span><h1>Invoking a Subrequest<a class="headerlink" href="#invoking-a-subrequest" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.4 で追加.</span></p>
</div>
<p><span>Pyramid</span> allows you to invoke a subrequest at any point during the
processing of a request.  Invoking a subrequest allows you to obtain a
<a class="reference internal" href="../glossary.html#term-response"><span class="xref std std-term">response</span></a> object from a view callable within your <span>Pyramid</span>
application while you're executing a different view callable within the same
application.</p>
<p>Here's an example application which uses a subrequest:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">def</span> <span class="nf">view_one</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">subreq</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">invoke_subrequest</span><span class="p">(</span><span class="n">subreq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">view_two</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;This came from view_two&#39;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">response</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_one</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_two</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>When <code class="docutils literal notranslate"><span class="pre">/view_one</span></code> is visted in a browser, the text printed in the browser pane
will be <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">came</span> <span class="pre">from</span> <span class="pre">view_two</span></code>.  The <code class="docutils literal notranslate"><span class="pre">view_one</span></code> view used the
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_subrequest()</span></code></a> API to obtain a response from
another view (<code class="docutils literal notranslate"><span class="pre">view_two</span></code>) within the same application when it executed.  It
did so by constructing a new request that had a URL that it knew would match
the <code class="docutils literal notranslate"><span class="pre">view_two</span></code> view registration, and passed that new request along to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_subrequest()</span></code></a>.  The <code class="docutils literal notranslate"><span class="pre">view_two</span></code> view
callable was invoked, and it returned a response.  The <code class="docutils literal notranslate"><span class="pre">view_one</span></code> view
callable then simply returned the response it obtained from the <code class="docutils literal notranslate"><span class="pre">view_two</span></code>
view callable.</p>
<p>Note that it doesn't matter if the view callable invoked via a subrequest
actually returns a <em>literal</em> Response object.  Any view callable that uses a
renderer or which returns an object that can be interpreted by a response
adapter when found and invoked via
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_subrequest()</span></code></a> will return a Response
object:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">def</span> <span class="nf">view_one</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">subreq</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">invoke_subrequest</span><span class="p">(</span><span class="n">subreq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">view_two</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="k">return</span> <span class="s1">&#39;This came from view_two&#39;</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_one</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_two</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
</span>    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Even though the <code class="docutils literal notranslate"><span class="pre">view_two</span></code> view callable returned a string, it was invoked in
such a way that the <code class="docutils literal notranslate"><span class="pre">string</span></code> renderer associated with the view registration
that was found turned it into a &quot;real&quot; response object for consumption by
<code class="docutils literal notranslate"><span class="pre">view_one</span></code>.</p>
<p>Being able to unconditionally obtain a response object by invoking a view
callable indirectly is the main advantage to using
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_subrequest()</span></code></a> instead of simply importing a
view callable and executing it directly.  Note that there's not much advantage
to invoking a view using a subrequest if you <em>can</em> invoke a view callable
directly.  Subrequests are slower and are less convenient if you actually do
want just the literal information returned by a function that happens to be a
view callable.</p>
<p>Note that, by default, if a view callable invoked by a subrequest raises an
exception, the exception will be raised to the caller of
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> even if you have a
<a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception view</span></a> configured:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">def</span> <span class="nf">view_one</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">subreq</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">invoke_subrequest</span><span class="p">(</span><span class="n">subreq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">view_two</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">def</span> <span class="nf">excview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;An exception was raised&#39;</span>
</span><span class="hll">    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_int</span> <span class="o">=</span> <span class="mi">500</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">response</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_one</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_two</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">excview</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>When we run the above code and visit <code class="docutils literal notranslate"><span class="pre">/view_one</span></code> in a browser, the
<code class="docutils literal notranslate"><span class="pre">excview</span></code> <a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception view</span></a> will <em>not</em> be executed.  Instead, the call
to <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> will cause a
<a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.7)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValueError</span></code></a> exception to be raised and a response will never be
generated.  We can change this behavior; how to do so is described below in our
discussion of the <code class="docutils literal notranslate"><span class="pre">use_tweens</span></code> argument.</p>
<div class="section" id="subrequests-with-tweens">
<span id="index-1"></span><h2>Subrequests with Tweens<a class="headerlink" href="#subrequests-with-tweens" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_subrequest()</span></code></a> API accepts two
arguments: a required positional argument <code class="docutils literal notranslate"><span class="pre">request</span></code>, and an optional keyword
argument <code class="docutils literal notranslate"><span class="pre">use_tweens</span></code> which defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">request</span></code> object passed to the API must be an object that implements the
Pyramid request interface (such as a <a class="reference internal" href="../api/request.html#pyramid.request.Request" title="pyramid.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.request.Request</span></code></a>
instance).  If <code class="docutils literal notranslate"><span class="pre">use_tweens</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, the request will be sent to the
<a class="reference internal" href="../glossary.html#term-tween"><span class="xref std std-term">tween</span></a> in the tween stack closest to the request ingress.  If
<code class="docutils literal notranslate"><span class="pre">use_tweens</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>, the request will be sent to the main router
handler, and no tweens will be invoked.</p>
<p>In the example above, the call to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> will always raise an
exception.  This is because it's using the default value for <code class="docutils literal notranslate"><span class="pre">use_tweens</span></code>,
which is <code class="docutils literal notranslate"><span class="pre">False</span></code>.  Alternatively, you can pass <code class="docutils literal notranslate"><span class="pre">use_tweens=True</span></code> to ensure
that it will convert an exception to a Response if an <a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception view</span></a> is
configured, instead of raising the exception.  This is because exception views
are called by the exception view <a class="reference internal" href="../glossary.html#term-tween"><span class="xref std std-term">tween</span></a> as described in
<a class="reference internal" href="views.html#exception-views"><span class="std std-ref">Custom Exception Views</span></a> when any view raises an exception.</p>
<p>We can cause the subrequest to be run through the tween stack by passing
<code class="docutils literal notranslate"><span class="pre">use_tweens=True</span></code> to the call to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a>, like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">def</span> <span class="nf">view_one</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">subreq</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">invoke_subrequest</span><span class="p">(</span><span class="n">subreq</span><span class="p">,</span> <span class="n">use_tweens</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">view_two</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">excview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;An exception was raised&#39;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_int</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">response</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;/view_two&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_one</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view_two</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">excview</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>In the above case, the call to <code class="docutils literal notranslate"><span class="pre">request.invoke_subrequest(subreq)</span></code> will not
raise an exception.  Instead, it will retrieve a &quot;500&quot; response from the
attempted invocation of <code class="docutils literal notranslate"><span class="pre">view_two</span></code>, because the tween which invokes an
exception view to generate a response is run, and therefore <code class="docutils literal notranslate"><span class="pre">excview</span></code> is
executed.</p>
<p>This is one of the major differences between specifying the <code class="docutils literal notranslate"><span class="pre">use_tweens=True</span></code>
and <code class="docutils literal notranslate"><span class="pre">use_tweens=False</span></code> arguments to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a>.  <code class="docutils literal notranslate"><span class="pre">use_tweens=True</span></code> may
also imply invoking a transaction commit or abort for the logic executed in the
subrequest if you've got <code class="docutils literal notranslate"><span class="pre">pyramid_tm</span></code> in the tween list, injecting debug HTML
if you've got <code class="docutils literal notranslate"><span class="pre">pyramid_debugtoolbar</span></code> in the tween list, and other
tween-related side effects as defined by your particular tween list.</p>
<p>The <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> function also
unconditionally does the following:</p>
<ul class="simple">
<li>It manages the threadlocal stack so that
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_current_request()</span></code></a> and
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_registry" title="pyramid.threadlocal.get_current_registry"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_current_registry()</span></code></a> work during a request (they
will return the subrequest instead of the original request).</li>
<li>It adds a <code class="docutils literal notranslate"><span class="pre">registry</span></code> attribute and an <code class="docutils literal notranslate"><span class="pre">invoke_subrequest</span></code> attribute (a
callable) to the request object to which it is handed.</li>
<li>It sets request extensions (such as those added via
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.add_request_method" title="pyramid.config.Configurator.add_request_method"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_request_method()</span></code></a> or
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.set_request_property" title="pyramid.config.Configurator.set_request_property"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_request_property()</span></code></a>) on the subrequest
object passed as <code class="docutils literal notranslate"><span class="pre">request</span></code>.</li>
<li>It causes a <a class="reference internal" href="../api/events.html#pyramid.events.NewRequest" title="pyramid.events.NewRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">NewRequest</span></code></a> event to be sent at the
beginning of request processing.</li>
<li>It causes a <a class="reference internal" href="../api/events.html#pyramid.events.ContextFound" title="pyramid.events.ContextFound"><code class="xref py py-class docutils literal notranslate"><span class="pre">ContextFound</span></code></a> event to be sent when a
context resource is found.</li>
<li>It ensures that the user implied by the request passed in has the necessary
authorization to invoke the view callable before calling it.</li>
<li>It calls any <a class="reference internal" href="../glossary.html#term-response-callback"><span class="xref std std-term">response callback</span></a> functions defined within the
subrequest's lifetime if a response is obtained from the Pyramid application.</li>
<li>It causes a <a class="reference internal" href="../api/events.html#pyramid.events.NewResponse" title="pyramid.events.NewResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">NewResponse</span></code></a> event to be sent if a
response is obtained.</li>
<li>It calls any <a class="reference internal" href="../glossary.html#term-finished-callback"><span class="xref std std-term">finished callback</span></a> functions defined within the
subrequest's lifetime.</li>
</ul>
<p>The invocation of a subrequest has more or less exactly the same effect as the
invocation of a request received by the <span>Pyramid</span> router from a web client
when <code class="docutils literal notranslate"><span class="pre">use_tweens=True</span></code>.  When <code class="docutils literal notranslate"><span class="pre">use_tweens=False</span></code>, the tweens are skipped
but all the other steps take place.</p>
<p>It's a poor idea to use the original <code class="docutils literal notranslate"><span class="pre">request</span></code> object as an argument to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a>.  You should construct a new
request instead as demonstrated in the above example, using
<a class="reference internal" href="../api/request.html#pyramid.request.Request.blank" title="pyramid.request.Request.blank"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.blank()</span></code></a>.  Once you've constructed a request
object, you'll need to massage it to match the view callable that you'd like to
be executed during the subrequest.  This can be done by adjusting the
subrequest's URL, its headers, its request method, and other attributes.  The
documentation for <a class="reference internal" href="../api/request.html#pyramid.request.Request" title="pyramid.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.request.Request</span></code></a> exposes the methods you
should call and attributes you should set on the request that you create, then
massage it into something that will actually match the view you'd like to call
via a subrequest.</p>
<p>We've demonstrated use of a subrequest from within a view callable, but you can
use the <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> API from within a
tween or an event handler as well.  Even though you can do it, it's usually a
poor idea to invoke <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> from
within a tween, because tweens already, by definition, have access to a
function that will cause a subrequest (they are passed a <code class="docutils literal notranslate"><span class="pre">handle</span></code> function).
It's fine to invoke <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_subrequest" title="pyramid.request.Request.invoke_subrequest"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke_subrequest()</span></code></a> from
within an event handler, however.</p>
</div>
<div class="section" id="invoking-an-exception-view">
<span id="index-2"></span><h2>Invoking an Exception View<a class="headerlink" href="#invoking-an-exception-view" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.7 で追加.</span></p>
</div>
<p><span>Pyramid</span> apps may define <a class="reference internal" href="../glossary.html#term-exception-view"><span class="xref std std-term">exception views</span></a> which
can handle any raised exceptions that escape from your code while processing
a request. By default an unhandled exception will be caught by the <code class="docutils literal notranslate"><span class="pre">EXCVIEW</span></code>
<a class="reference internal" href="../glossary.html#term-tween"><span class="xref std std-term">tween</span></a>, which will then lookup an exception view that can handle the
exception type, generating an appropriate error response.</p>
<p>In <span>Pyramid</span> 1.7 the <a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_exception_view" title="pyramid.request.Request.invoke_exception_view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_exception_view()</span></code></a>
was introduced, allowing a user to invoke an exception view while manually
handling an exception. This can be useful in a few different circumstances:</p>
<ul class="simple">
<li>Manually handling an exception losing the current call stack or flow.</li>
<li>Handling exceptions outside of the context of the <code class="docutils literal notranslate"><span class="pre">EXCVIEW</span></code> tween. The
tween only covers certain parts of the request processing pipeline (See
<a class="reference internal" href="router.html#router-chapter"><span class="std std-ref">Request Processing</span></a>). There are also some corner cases where an exception
can be raised that will still bubble up to middleware, and possibly to the
web server in which case a generic <code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code> will be
returned to the client.</li>
</ul>
<p>Below is an example usage of
<a class="reference internal" href="../api/request.html#pyramid.request.Request.invoke_exception_view" title="pyramid.request.Request.invoke_exception_view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.request.Request.invoke_exception_view()</span></code></a>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">some_func_that_errors</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">invoke_exception_view</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># there is no exception view for this exception, simply</span>
            <span class="c1"># re-raise and let someone else handle it</span>
            <span class="k">raise</span>
</pre></div>
</td></tr></table></div>
<p>Please note that in most cases you do not need to write code like this, and you
may rely on the <code class="docutils literal notranslate"><span class="pre">EXCVIEW</span></code> tween to handle this for you.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Invoking a Subrequest</a><ul>
<li><a class="reference internal" href="#subrequests-with-tweens">Subrequests with Tweens</a></li>
<li><a class="reference internal" href="#invoking-an-exception-view">Invoking an Exception View</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="hybrid.html"
                        title="前の章へ">Combining Traversal and URL Dispatch</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="hooks.html"
                        title="次の章へ">Using Hooks</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/narr/subrequest.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="hooks.html" title="Using Hooks"
             >次へ</a> |</li>
        <li class="right" >
          <a href="hybrid.html" title="Combining Traversal and URL Dispatch"
             >前へ</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 8月 18, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4 で生成しました。
    </div>
  </body>
</html>