
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Adding authorization &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="Adding Tests" href="tests.html" />
    <link rel="prev" title="Adding authentication" href="authentication.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="tests.html" title="Adding Tests"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="Adding authentication"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-authorization">
<span id="wiki2-adding-authorization"></span><h1>Adding authorization<a class="headerlink" href="#adding-authorization" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>In the last chapter we built <a class="reference internal" href="../../glossary.html#term-authentication"><span class="xref std std-term">authentication</span></a> into our wiki. We also
went one step further and used the <code class="docutils literal notranslate"><span class="pre">request.user</span></code> object to perform some
explicit <a class="reference internal" href="../../glossary.html#term-authorization"><span class="xref std std-term">authorization</span></a> checks. This is fine for a lot of applications,
but <span>Pyramid</span> provides some facilities for cleaning this up and decoupling
the constraints from the view function itself.</p>
<p>We will implement access control with the following steps:</p>
<ul class="simple">
<li>Update the <a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> to break down the <a class="reference internal" href="../../glossary.html#term-userid"><span class="xref std std-term">userid</span></a>
into a list of <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principals</span></a> (<code class="docutils literal notranslate"><span class="pre">security.py</span></code>).</li>
<li>Define an <a class="reference internal" href="../../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> for mapping users, resources and
permissions (<code class="docutils literal notranslate"><span class="pre">security.py</span></code>).</li>
<li>Add new <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> definitions that will be used as the <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a>
for the wiki pages (<code class="docutils literal notranslate"><span class="pre">routes.py</span></code>).</li>
<li>Add an <a class="reference internal" href="../../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> to each resource (<code class="docutils literal notranslate"><span class="pre">routes.py</span></code>).</li>
<li>Replace the inline checks on the views with <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> declarations
(<code class="docutils literal notranslate"><span class="pre">views/default.py</span></code>).</li>
</ul>
<div class="section" id="add-user-principals">
<h2>Add user principals<a class="headerlink" href="#add-user-principals" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> is a level of abstraction on top of the raw <a class="reference internal" href="../../glossary.html#term-userid"><span class="xref std std-term">userid</span></a>
that describes the user in terms of its capabilities, roles, or other
identifiers that are easier to generalize. The permissions are then written
against the principals without focusing on the exact user involved.</p>
<p><span>Pyramid</span> defines two builtin principals used in every application:
<a class="reference internal" href="../../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pyramid.security.Everyone</span></code></a> and <a class="reference internal" href="../../api/security.html#pyramid.security.Authenticated" title="pyramid.security.Authenticated"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pyramid.security.Authenticated</span></code></a>.
On top of these we have already mentioned the required principals for this
application in the original design. The user has two possible roles: <code class="docutils literal notranslate"><span class="pre">editor</span></code>
or <code class="docutils literal notranslate"><span class="pre">basic</span></code>. These will be prefixed by the string <code class="docutils literal notranslate"><span class="pre">role:</span></code> to avoid clashing
with any other types of principals.</p>
<p>Open the file <code class="docutils literal notranslate"><span class="pre">tutorial/security.py</span></code> and edit it as follows:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">Authenticated</span><span class="p">,</span>
</span><span class="hll">    <span class="n">Everyone</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span> <span class="nc">MyAuthenticationPolicy</span><span class="p">(</span><span class="n">AuthTktAuthenticationPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>

<span class="hll">    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class="hll">        <span class="n">principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
</span><span class="hll">        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Authenticated</span><span class="p">)</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;role:&#39;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">principals</span>
</span>
<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">unauthenticated_userid</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">MyAuthenticationPolicy</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth.secret&#39;</span><span class="p">],</span>
        <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Only the highlighted lines need to be added.</p>
<p>Note that the role comes from the <code class="docutils literal notranslate"><span class="pre">User</span></code> object. We also add the <code class="docutils literal notranslate"><span class="pre">user.id</span></code>
as a principal for when we want to allow that exact user to edit pages which
they have created.</p>
</div>
<div class="section" id="add-the-authorization-policy">
<h2>Add the authorization policy<a class="headerlink" href="#add-the-authorization-policy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>We already added the <a class="reference internal" href="../../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> in the previous chapter
because <span>Pyramid</span> requires one when adding an
<a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a>. However, it was not used anywhere, so we'll
mention it now.</p>
<p>In the file <code class="docutils literal notranslate"><span class="pre">tutorial/security.py</span></code>, notice the following lines:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>We're using the <a class="reference internal" href="../../api/authorization.html#pyramid.authorization.ACLAuthorizationPolicy" title="pyramid.authorization.ACLAuthorizationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.authorization.ACLAuthorizationPolicy</span></code></a>, which
will suffice for most applications. It uses the <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> to define the
mapping between a <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> and <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> for the current
request via the <code class="docutils literal notranslate"><span class="pre">__acl__</span></code>.</p>
</div>
<div class="section" id="add-resources-and-acls">
<h2>Add resources and ACLs<a class="headerlink" href="#add-resources-and-acls" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Resources are the hidden gem of <span>Pyramid</span>. You've made it!</p>
<p>Every URL in a web application represents a <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> (the &quot;R&quot; in
Uniform Resource Locator). Often the resource is something in your data model,
but it could also be an abstraction over many models.</p>
<p>Our wiki has two resources:</p>
<ol class="arabic simple">
<li>A <code class="docutils literal notranslate"><span class="pre">NewPage</span></code>. Represents a potential <code class="docutils literal notranslate"><span class="pre">Page</span></code> that does not exist. Any
logged-in user, having either role of <code class="docutils literal notranslate"><span class="pre">basic</span></code> or <code class="docutils literal notranslate"><span class="pre">editor</span></code>, can create
pages.</li>
<li>A <code class="docutils literal notranslate"><span class="pre">PageResource</span></code>. Represents a <code class="docutils literal notranslate"><span class="pre">Page</span></code> that is to be viewed or edited.
<code class="docutils literal notranslate"><span class="pre">editor</span></code> users, as well as the original creator of the <code class="docutils literal notranslate"><span class="pre">Page</span></code>, may edit
the <code class="docutils literal notranslate"><span class="pre">PageResource</span></code>. Anyone may view it.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">The wiki data model is simple enough that the <code class="docutils literal notranslate"><span class="pre">PageResource</span></code> is mostly
redundant with our <code class="docutils literal notranslate"><span class="pre">models.Page</span></code> SQLAlchemy class. It is completely valid
to combine these into one class. However, for this tutorial, they are
explicitly separated to make clear the distinction between the parts about
which <span>Pyramid</span> cares versus application-defined objects.</p>
</div>
<p>There are many ways to define these resources, and they can even be grouped
into collections with a hierarchy. However, we're keeping it simple here!</p>
<p>Open the file <code class="docutils literal notranslate"><span class="pre">tutorial/routes.py</span></code> and edit the following lines:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">HTTPNotFound</span><span class="p">,</span>
</span><span class="hll">    <span class="n">HTTPFound</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">Allow</span><span class="p">,</span>
</span><span class="hll">    <span class="n">Everyone</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Page</span>
</span><span class="hll">
</span><span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}/edit_page&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">def</span> <span class="nf">new_page_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">NewPage</span><span class="p">(</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">class</span> <span class="nc">NewPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagename</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">pagename</span> <span class="o">=</span> <span class="n">pagename</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:basic&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span><span class="hll">
</span><span class="hll"><span class="k">def</span> <span class="nf">page_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPNotFound</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">PageResource</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">class</span> <span class="nc">PageResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">creator_id</span><span class="p">),</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>The highlighted lines need to be edited or added.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NewPage</span></code> class has an <code class="docutils literal notranslate"><span class="pre">__acl__</span></code> on it that returns a list of mappings
from <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> to <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a>. This defines <em>who</em> can do <em>what</em>
with that <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a>. In our case we want to allow only those users with
the principals of either <code class="docutils literal notranslate"><span class="pre">role:editor</span></code> or <code class="docutils literal notranslate"><span class="pre">role:basic</span></code> to have the
<code class="docutils literal notranslate"><span class="pre">create</span></code> permission:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pagename</span> <span class="o">=</span> <span class="n">pagename</span>

<span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:basic&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">NewPage</span></code> is loaded as the <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> of the <code class="docutils literal notranslate"><span class="pre">add_page</span></code> route by
declaring a <code class="docutils literal notranslate"><span class="pre">factory</span></code> on the route:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">PageResource</span></code> class defines the <a class="reference internal" href="../../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> for a <code class="docutils literal notranslate"><span class="pre">Page</span></code>. It uses an
actual <code class="docutils literal notranslate"><span class="pre">Page</span></code> object to determine <em>who</em> can do <em>what</em> to the page.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PageResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>

<span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">creator_id</span><span class="p">),</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">PageResource</span></code> is loaded as the <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> of the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> and
<code class="docutils literal notranslate"><span class="pre">edit_page</span></code> routes by declaring a <code class="docutils literal notranslate"><span class="pre">factory</span></code> on the routes:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}/edit_page&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add-view-permissions">
<h2>Add view permissions<a class="headerlink" href="#add-view-permissions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>At this point we've modified our application to load the <code class="docutils literal notranslate"><span class="pre">PageResource</span></code>,
including the actual <code class="docutils literal notranslate"><span class="pre">Page</span></code> model in the <code class="docutils literal notranslate"><span class="pre">page_factory</span></code>. The
<code class="docutils literal notranslate"><span class="pre">PageResource</span></code> is now the <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> for all <code class="docutils literal notranslate"><span class="pre">view_page</span></code> and
<code class="docutils literal notranslate"><span class="pre">edit_page</span></code> views. Similarly the <code class="docutils literal notranslate"><span class="pre">NewPage</span></code> will be the context for the
<code class="docutils literal notranslate"><span class="pre">add_page</span></code> view.</p>
<p>Open the file <code class="docutils literal notranslate"><span class="pre">tutorial/views/default.py</span></code>.</p>
<p>First, you can drop a few imports that are no longer necessary:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
</span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

</pre></div>
</td></tr></table></div>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view to declare the <code class="docutils literal notranslate"><span class="pre">view</span></code> permission, and remove the
explicit checks within the view:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
</span>
    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
</pre></div>
</td></tr></table></div>
<p>The work of loading the page has already been done in the factory, so we can
just pull the <code class="docutils literal notranslate"><span class="pre">page</span></code> object out of the <code class="docutils literal notranslate"><span class="pre">PageResource</span></code>, loaded as
<code class="docutils literal notranslate"><span class="pre">request.context</span></code>. Our factory also guarantees we will have a <code class="docutils literal notranslate"><span class="pre">Page</span></code>, as it
raises the <code class="docutils literal notranslate"><span class="pre">HTTPNotFound</span></code> exception if no <code class="docutils literal notranslate"><span class="pre">Page</span></code> exists, again simplifying
the view logic.</p>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view to declare the <code class="docutils literal notranslate"><span class="pre">edit</span></code> permission:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
</span>    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">add_page</span></code> view to declare the <code class="docutils literal notranslate"><span class="pre">create</span></code> permission:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pagename</span>
</span>    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">pagename</span></code> here is pulled off of the context instead of
<code class="docutils literal notranslate"><span class="pre">request.matchdict</span></code>. The factory has done a lot of work for us to hide the
actual route pattern.</p>
<p>The ACLs defined on each <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> are used by the <a class="reference internal" href="../../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization
policy</span></a> to determine if any <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> is allowed to have some
<a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a>. If this check fails (for example, the user is not logged
in) then an <code class="docutils literal notranslate"><span class="pre">HTTPForbidden</span></code> exception will be raised automatically. Thus
we're able to drop those exceptions and checks from the views themselves.
Rather we've defined them in terms of operations on a resource.</p>
<p>The final <code class="docutils literal notranslate"><span class="pre">tutorial/views/default.py</span></code> should look like the following:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">docutils.core</span> <span class="kn">import</span> <span class="n">publish_parts</span>

<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Page</span>

<span class="c1"># regular expression used to find WikiWords</span>
<span class="n">wikiwords</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="s1">&#39;FrontPage&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>

    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">add_link</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">pagedata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pagename</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">pagedata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="viewing-the-application-in-a-browser">
<h2>Viewing the application in a browser<a class="headerlink" href="#viewing-the-application-in-a-browser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>We can finally examine our application in a browser (See
<a class="reference internal" href="installation.html#wiki2-start-the-application"><span class="std std-ref">Start the application</span></a>).  Launch a browser and visit each of the
following URLs, checking that the result is as expected:</p>
<ul class="simple">
<li><a class="reference external" href="http://localhost:6543/">http://localhost:6543/</a> invokes the <code class="docutils literal notranslate"><span class="pre">view_wiki</span></code> view.  This always
redirects to the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view of the <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object.  It
is executable by any user.</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage">http://localhost:6543/FrontPage</a> invokes the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view of the
<code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object. There is a &quot;Login&quot; link in the upper right corner
while the user is not authenticated, else it is a &quot;Logout&quot; link when the user
is authenticated.</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage/edit_page">http://localhost:6543/FrontPage/edit_page</a> invokes the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view for
the <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object.  It is executable by only the <code class="docutils literal notranslate"><span class="pre">editor</span></code> user.
If a different user (or the anonymous user) invokes it, then a login form
will be displayed. Supplying the credentials with the username <code class="docutils literal notranslate"><span class="pre">editor</span></code> and
password <code class="docutils literal notranslate"><span class="pre">editor</span></code> will display the edit page form.</li>
<li><a class="reference external" href="http://localhost:6543/add_page/SomePageName">http://localhost:6543/add_page/SomePageName</a> invokes the <code class="docutils literal notranslate"><span class="pre">add_page</span></code> view for
a page. If the page already exists, then it redirects the user to the
<code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view for the page object. It is executable by either the
<code class="docutils literal notranslate"><span class="pre">editor</span></code> or <code class="docutils literal notranslate"><span class="pre">basic</span></code> user.  If a different user (or the anonymous user)
invokes it, then a login form will be displayed. Supplying the credentials
with either the username <code class="docutils literal notranslate"><span class="pre">editor</span></code> and password <code class="docutils literal notranslate"><span class="pre">editor</span></code>, or username
<code class="docutils literal notranslate"><span class="pre">basic</span></code> and password <code class="docutils literal notranslate"><span class="pre">basic</span></code>, will display the edit page form.</li>
<li><a class="reference external" href="http://localhost:6543/SomePageName/edit_page">http://localhost:6543/SomePageName/edit_page</a> invokes the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view
for an existing page, or generates an error if the page does not exist. It is
editable by the <code class="docutils literal notranslate"><span class="pre">basic</span></code> user if the page was created by that user in the
previous step. If, instead, the page was created by the <code class="docutils literal notranslate"><span class="pre">editor</span></code> user, then
the login page should be shown for the <code class="docutils literal notranslate"><span class="pre">basic</span></code> user.</li>
<li>After logging in (as a result of hitting an edit or add page and submitting
the login form with the <code class="docutils literal notranslate"><span class="pre">editor</span></code> credentials), we'll see a &quot;Logout&quot; link in
the upper right hand corner.  When we click it, we're logged out, redirected
back to the front page, and a &quot;Login&quot; link is shown in the upper right hand
corner.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding authorization</a><ul>
<li><a class="reference internal" href="#add-user-principals">Add user principals</a></li>
<li><a class="reference internal" href="#add-the-authorization-policy">Add the authorization policy</a></li>
<li><a class="reference internal" href="#add-resources-and-acls">Add resources and ACLs</a></li>
<li><a class="reference internal" href="#add-view-permissions">Add view permissions</a></li>
<li><a class="reference internal" href="#viewing-the-application-in-a-browser">Viewing the application in a browser</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="authentication.html"
                        title="前の章へ">Adding authentication</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="tests.html"
                        title="次の章へ">Adding Tests</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/authorization.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="tests.html" title="Adding Tests"
             >次へ</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="Adding authentication"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 8月 05, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4 で生成しました。
    </div>
  </body>
</html>