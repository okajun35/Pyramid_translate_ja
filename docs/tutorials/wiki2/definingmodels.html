
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Defining the Domain Model &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="Defining Views" href="definingviews.html" />
    <link rel="prev" title="Basic Layout" href="basiclayout.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="basiclayout.html" title="Basic Layout"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="defining-the-domain-model">
<span id="wiki2-defining-the-domain-model"></span><h1>Defining the Domain Model<a class="headerlink" href="#defining-the-domain-model" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>The first change we'll make to our stock cookiecutter-generated application will
be to define a wiki page <a class="reference internal" href="../../glossary.html#term-domain-model"><span class="xref std std-term">domain model</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">There is nothing special about the filename <code class="docutils literal notranslate"><span class="pre">user.py</span></code> or <code class="docutils literal notranslate"><span class="pre">page.py</span></code> except
that they are Python modules.  A project may have many models throughout its
codebase in arbitrarily named modules.  Modules implementing models often
have <code class="docutils literal notranslate"><span class="pre">model</span></code> in their names or they may live in a Python subpackage of
your application package named <code class="docutils literal notranslate"><span class="pre">models</span></code> (as we've done in this tutorial),
but this is only a convention and not a requirement.</p>
</div>
<div class="section" id="declaring-dependencies-in-our-setup-py-file">
<h2>Declaring dependencies in our <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file<a class="headerlink" href="#declaring-dependencies-in-our-setup-py-file" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The models code in our application will depend on a package which is not a
dependency of the original &quot;tutorial&quot; application.  The original &quot;tutorial&quot;
application was generated by the cookiecutter; it doesn't know about our
custom application requirements.</p>
<p>We need to add a dependency, the <a class="reference external" href="https://pypi.org/project/bcrypt/">bcrypt</a> package, to our <code class="docutils literal notranslate"><span class="pre">tutorial</span></code>
package's <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file by assigning this dependency to the <code class="docutils literal notranslate"><span class="pre">requires</span></code>
parameter in the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> function.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">tutorial/setup.py</span></code> and edit it to look like the following:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="s1">&#39;README.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">README</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="s1">&#39;CHANGES.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">CHANGES</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
<span class="hll">    <span class="s1">&#39;bcrypt&#39;</span><span class="p">,</span>
</span>    <span class="s1">&#39;plaster_pastedeploy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid &gt;= 1.9a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_debugtoolbar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_retry&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_tm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SQLAlchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;transaction&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zope.sqlalchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;waitress&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">tests_require</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;WebTest &gt;= 1.3.1&#39;</span><span class="p">,</span>  <span class="c1"># py3 compat</span>
    <span class="s1">&#39;pytest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pytest-cov&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tutorial&#39;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.0&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;myproj&#39;</span><span class="p">,</span>
    <span class="n">long_description</span><span class="o">=</span><span class="n">README</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">CHANGES</span><span class="p">,</span>
    <span class="n">classifiers</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Programming Language :: Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Framework :: Pyramid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Topic :: Internet :: WWW/HTTP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Topic :: Internet :: WWW/HTTP :: WSGI :: Application&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">author</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">keywords</span><span class="o">=</span><span class="s1">&#39;web pyramid pylons&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(),</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">extras_require</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="n">tests_require</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="n">requires</span><span class="p">,</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;paste.app_factory&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;main = tutorial:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;initialize_tutorial_db = tutorial.scripts.initializedb:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Only the highlighted line needs to be added.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">We are using the <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code> package from PyPI to hash our passwords securely. There are other one-way hash algorithms for passwords if <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code> is an issue on your system. Just make sure that it's an algorithm approved for storing passwords versus a generic one-way hash.</p>
</div>
</div>
<div class="section" id="running-pip-install-e">
<h2>Running <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.</span></code><a class="headerlink" href="#running-pip-install-e" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Since a new software dependency was added, you will need to run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span>
<span class="pre">-e</span> <span class="pre">.</span></code> again inside the root of the <code class="docutils literal notranslate"><span class="pre">tutorial</span></code> package to obtain and register
the newly added dependency distribution.</p>
<p>Make sure your current working directory is the root of the project (the
directory in which <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> lives) and execute the following command.</p>
<p>On UNIX:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">$VENV</span>/bin/pip install -e .
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-doscon notranslate"><div class="highlight"><pre><span></span><span class="gp">c:\tutorial&gt;</span> <span class="nv">%VENV%</span>\Scripts\pip install -e .
</pre></div>
</div>
<p>Success executing this command will end with a line to the console something
like the following.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Successfully installed bcrypt-3.1.2 cffi-1.9.1 pycparser-2.17 tutorial
</pre></div>
</div>
</div>
<div class="section" id="remove-mymodel-py">
<h2>Remove <code class="docutils literal notranslate"><span class="pre">mymodel.py</span></code><a class="headerlink" href="#remove-mymodel-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Let's delete the file <code class="docutils literal notranslate"><span class="pre">tutorial/models/mymodel.py</span></code>. The <code class="docutils literal notranslate"><span class="pre">MyModel</span></code> class is
only a sample and we're not going to use it.</p>
</div>
<div class="section" id="add-user-py">
<h2>Add <code class="docutils literal notranslate"><span class="pre">user.py</span></code><a class="headerlink" href="#add-user-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Create a new file <code class="docutils literal notranslate"><span class="pre">tutorial/models/user.py</span></code> with the following contents:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bcrypt</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.meta</span> <span class="kn">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The SQLAlchemy declarative model class for a User object. &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="n">pwhash</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">=</span> <span class="n">pwhash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">expected_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">expected_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</td></tr></table></div>
<p>This is a very basic model for a user who can authenticate with our wiki.</p>
<p>We discussed briefly in the previous chapter that our models will inherit from
an SQLAlchemy <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declarative_base" title="(in SQLAlchemy v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sqlalchemy.ext.declarative.declarative_base()</span></code></a>. This will
attach the model to our schema.</p>
<p>As you can see, our <code class="docutils literal notranslate"><span class="pre">User</span></code> class has a class-level attribute
<code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> which equals the string <code class="docutils literal notranslate"><span class="pre">users</span></code>. Our <code class="docutils literal notranslate"><span class="pre">User</span></code> class will
also have class-level attributes named <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">password_hash</span></code>,
and <code class="docutils literal notranslate"><span class="pre">role</span></code> (all instances of <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/core/metadata.html#sqlalchemy.schema.Column" title="(in SQLAlchemy v1.2)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.schema.Column</span></code></a>). These will
map to columns in the <code class="docutils literal notranslate"><span class="pre">users</span></code> table. The <code class="docutils literal notranslate"><span class="pre">id</span></code> attribute will be the primary
key in the table. The <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute will be a text column, each value of
which needs to be unique within the column. The <code class="docutils literal notranslate"><span class="pre">password_hash</span></code> is a nullable
text attribute that will contain a securely hashed password. Finally, the
<code class="docutils literal notranslate"><span class="pre">role</span></code> text attribute will hold the role of the user.</p>
<p>There are two helper methods that will help us later when using the user
objects. The first is <code class="docutils literal notranslate"><span class="pre">set_password</span></code> which will take a raw password and
transform it using <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code> into an irreversible representation, a process known
as &quot;hashing&quot;. The second method, <code class="docutils literal notranslate"><span class="pre">check_password</span></code>, will allow us to compare
the hashed value of the submitted password against the hashed value of the
password stored in the user's record in the database. If the two hashed values
match, then the submitted password is valid, and we can authenticate the user.</p>
<p>We hash passwords so that it is impossible to decrypt them and use them to
authenticate in the application. If we stored passwords foolishly in clear
text, then anyone with access to the database could retrieve any password to
authenticate as any user.</p>
</div>
<div class="section" id="add-page-py">
<h2>Add <code class="docutils literal notranslate"><span class="pre">page.py</span></code><a class="headerlink" href="#add-page-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Create a new file <code class="docutils literal notranslate"><span class="pre">tutorial/models/page.py</span></code> with the following contents:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">ForeignKey</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="kn">from</span> <span class="nn">.meta</span> <span class="kn">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The SQLAlchemy declarative model class for a Page object. &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;pages&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">creator_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;created_pages&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>As you can see, our <code class="docutils literal notranslate"><span class="pre">Page</span></code> class is very similar to the <code class="docutils literal notranslate"><span class="pre">User</span></code> defined
above, except with attributes focused on storing information about a wiki page,
including <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">name</span></code>, and <code class="docutils literal notranslate"><span class="pre">data</span></code>. The only new construct introduced
here is the <code class="docutils literal notranslate"><span class="pre">creator_id</span></code> column, which is a foreign key referencing the
<code class="docutils literal notranslate"><span class="pre">users</span></code> table. Foreign keys are very useful at the schema-level, but since we
want to relate <code class="docutils literal notranslate"><span class="pre">User</span></code> objects with <code class="docutils literal notranslate"><span class="pre">Page</span></code> objects, we also define a
<code class="docutils literal notranslate"><span class="pre">creator</span></code> attribute as an ORM-level mapping between the two tables.
SQLAlchemy will automatically populate this value using the foreign key
referencing the user. Since the foreign key has <code class="docutils literal notranslate"><span class="pre">nullable=False</span></code>, we are
guaranteed that an instance of <code class="docutils literal notranslate"><span class="pre">page</span></code> will have a corresponding
<code class="docutils literal notranslate"><span class="pre">page.creator</span></code>, which will be a <code class="docutils literal notranslate"><span class="pre">User</span></code> instance.</p>
</div>
<div class="section" id="edit-models-init-py">
<h2>Edit <code class="docutils literal notranslate"><span class="pre">models/__init__.py</span></code><a class="headerlink" href="#edit-models-init-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Since we are using a package for our models, we also need to update our
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file to ensure that the models are attached to the metadata.</p>
<p>Open the <code class="docutils literal notranslate"><span class="pre">tutorial/models/__init__.py</span></code> file and edit it to look like
the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">configure_mappers</span>
<span class="kn">import</span> <span class="nn">zope.sqlalchemy</span>

<span class="c1"># import or define all models here to ensure they are attached to the</span>
<span class="c1"># Base.metadata prior to any initialization routines</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.page</span> <span class="kn">import</span> <span class="n">Page</span>  <span class="c1"># noqa</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">User</span>  <span class="c1"># noqa</span>
</span>
<span class="c1"># run configure_mappers after defining all of the models to ensure</span>
<span class="c1"># all relationships can be setup</span>
<span class="n">configure_mappers</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_session_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factory</span>


<span class="k">def</span> <span class="nf">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a ``sqlalchemy.orm.Session`` instance backed by a transaction.</span>

<span class="sd">    This function will hook the session to the transaction manager which</span>
<span class="sd">    will take care of committing any changes.</span>

<span class="sd">    - When using pyramid_tm it will automatically be committed or aborted</span>
<span class="sd">      depending on whether an exception is raised.</span>

<span class="sd">    - When using scripts you should wrap the session in a manager yourself.</span>
<span class="sd">      For example::</span>

<span class="sd">          import transaction</span>

<span class="sd">          engine = get_engine(settings)</span>
<span class="sd">          session_factory = get_session_factory(engine)</span>
<span class="sd">          with transaction.manager:</span>
<span class="sd">              dbsession = get_tm_session(session_factory, transaction.manager)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">zope</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
        <span class="n">dbsession</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="o">=</span><span class="n">transaction_manager</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbsession</span>


<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the model for a Pyramid app.</span>

<span class="sd">    Activate this setup using ``config.include(&#39;tutorial.models&#39;)``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tm.manager_hook&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pyramid_tm.explicit_manager&#39;</span>

    <span class="c1"># use pyramid_tm to hook the transaction lifecycle to the request</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_tm&#39;</span><span class="p">)</span>

    <span class="c1"># use pyramid_retry to retry a request when transient exceptions occur</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_retry&#39;</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">get_session_factory</span><span class="p">(</span><span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;dbsession_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_factory</span>

    <span class="c1"># make request.dbsession available for use in Pyramid</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span>
        <span class="c1"># r.tm is the transaction manager used by pyramid_tm</span>
        <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tm</span><span class="p">),</span>
        <span class="s1">&#39;dbsession&#39;</span><span class="p">,</span>
        <span class="n">reify</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Here we align our imports with the names of the models, <code class="docutils literal notranslate"><span class="pre">Page</span></code> and <code class="docutils literal notranslate"><span class="pre">User</span></code>.</p>
</div>
<div class="section" id="edit-scripts-initializedb-py">
<h2>Edit <code class="docutils literal notranslate"><span class="pre">scripts/initializedb.py</span></code><a class="headerlink" href="#edit-scripts-initializedb-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>We haven't looked at the details of this file yet, but within the <code class="docutils literal notranslate"><span class="pre">scripts</span></code>
directory of your <code class="docutils literal notranslate"><span class="pre">tutorial</span></code> package is a file named <code class="docutils literal notranslate"><span class="pre">initializedb.py</span></code>.
Code in this file is executed whenever we run the <code class="docutils literal notranslate"><span class="pre">initialize_tutorial_db</span></code>
command, as we did in the installation step of this tutorial.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">The command is named <code class="docutils literal notranslate"><span class="pre">initialize_tutorial_db</span></code> because of the mapping defined in the <code class="docutils literal notranslate"><span class="pre">[console_scripts]</span></code> entry point of our project's <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file.</p>
</div>
<p>Since we've changed our model, we need to make changes to our
<code class="docutils literal notranslate"><span class="pre">initializedb.py</span></code> script.  In particular, we'll replace our import of
<code class="docutils literal notranslate"><span class="pre">MyModel</span></code> with those of <code class="docutils literal notranslate"><span class="pre">User</span></code> and <code class="docutils literal notranslate"><span class="pre">Page</span></code>. We'll also change the very end
of the script to create two <code class="docutils literal notranslate"><span class="pre">User</span></code> objects (<code class="docutils literal notranslate"><span class="pre">basic</span></code> and <code class="docutils literal notranslate"><span class="pre">editor</span></code>) as well
as a <code class="docutils literal notranslate"><span class="pre">Page</span></code>, rather than a <code class="docutils literal notranslate"><span class="pre">MyModel</span></code>, and add them to our <code class="docutils literal notranslate"><span class="pre">dbsession</span></code>.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">tutorial/scripts/initializedb.py</span></code> and edit it to look like the
following:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">transaction</span>

<span class="kn">from</span> <span class="nn">pyramid.paster</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_appsettings</span><span class="p">,</span>
    <span class="n">setup_logging</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.scripts.common</span> <span class="kn">import</span> <span class="n">parse_vars</span>

<span class="kn">from</span> <span class="nn">..models.meta</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span>
    <span class="n">get_session_factory</span><span class="p">,</span>
    <span class="n">get_tm_session</span><span class="p">,</span>
    <span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Page</span><span class="p">,</span> <span class="n">User</span>
</span>

<span class="k">def</span> <span class="nf">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;usage: </span><span class="si">%s</span><span class="s1"> &lt;config_uri&gt; [var=value]</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39;(example: &quot;</span><span class="si">%s</span><span class="s1"> development.ini&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">config_uri</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_vars</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">setup_logging</span><span class="p">(</span><span class="n">config_uri</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_appsettings</span><span class="p">(</span><span class="n">config_uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">get_session_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

<span class="hll">        <span class="n">editor</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">editor</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">editor</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">basic</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;basic&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;basic&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">basic</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;basic&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">basic</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span>
</span><span class="hll">            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FrontPage&#39;</span><span class="p">,</span>
</span><span class="hll">            <span class="n">creator</span><span class="o">=</span><span class="n">editor</span><span class="p">,</span>
</span><span class="hll">            <span class="n">data</span><span class="o">=</span><span class="s1">&#39;This is the front page&#39;</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>Only the highlighted lines need to be changed.</p>
</div>
<div class="section" id="installing-the-project-and-re-initializing-the-database">
<h2>Installing the project and re-initializing the database<a class="headerlink" href="#installing-the-project-and-re-initializing-the-database" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Because our model has changed, and in order to reinitialize the database, we
need to rerun the <code class="docutils literal notranslate"><span class="pre">initialize_tutorial_db</span></code> command to pick up the changes
we've made to both the models.py file and to the initializedb.py file. See
<a class="reference internal" href="installation.html#initialize-db-wiki2"><span class="std std-ref">Initializing the database</span></a> for instructions.</p>
<p>Success will look something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,195 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1235<span class="o">][</span>MainThread<span class="o">]</span> SELECT CAST<span class="o">(</span><span class="s1">&#39;test plain returns&#39;</span> AS VARCHAR<span class="o">(</span><span class="m">60</span><span class="o">))</span> AS anon_1
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,195 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1236<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,195 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1235<span class="o">][</span>MainThread<span class="o">]</span> SELECT CAST<span class="o">(</span><span class="s1">&#39;test unicode returns&#39;</span> AS VARCHAR<span class="o">(</span><span class="m">60</span><span class="o">))</span> AS anon_1
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,195 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1236<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,196 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span> PRAGMA table_info<span class="o">(</span><span class="s2">&quot;pages&quot;</span><span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,196 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,196 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span> PRAGMA table_info<span class="o">(</span><span class="s2">&quot;users&quot;</span><span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,197 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,197 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span>
CREATE TABLE users <span class="o">(</span>
        id INTEGER NOT NULL,
        name TEXT NOT NULL,
        role TEXT NOT NULL,
        password_hash TEXT,
        CONSTRAINT pk_users PRIMARY KEY <span class="o">(</span>id<span class="o">)</span>,
        CONSTRAINT uq_users_name UNIQUE <span class="o">(</span>name<span class="o">)</span>
<span class="o">)</span>


<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,197 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,198 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:719<span class="o">][</span>MainThread<span class="o">]</span> COMMIT
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,199 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span>
CREATE TABLE pages <span class="o">(</span>
        id INTEGER NOT NULL,
        name TEXT NOT NULL,
        data TEXT NOT NULL,
        creator_id INTEGER NOT NULL,
        CONSTRAINT pk_pages PRIMARY KEY <span class="o">(</span>id<span class="o">)</span>,
        CONSTRAINT uq_pages_name UNIQUE <span class="o">(</span>name<span class="o">)</span>,
        CONSTRAINT fk_pages_creator_id_users FOREIGN KEY<span class="o">(</span>creator_id<span class="o">)</span> REFERENCES users <span class="o">(</span>id<span class="o">)</span>
<span class="o">)</span>


<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,199 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">()</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,200 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:719<span class="o">][</span>MainThread<span class="o">]</span> COMMIT
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,755 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:679<span class="o">][</span>MainThread<span class="o">]</span> BEGIN <span class="o">(</span>implicit<span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,755 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span> INSERT INTO users <span class="o">(</span>name, role, password_hash<span class="o">)</span> VALUES <span class="o">(</span>?, ?, ?<span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,755 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">(</span><span class="s1">&#39;editor&#39;</span>, <span class="s1">&#39;editor&#39;</span>, <span class="s1">&#39;$2b$12$ds7h2Zb7.l6TEFup5h8f4ekA9GRfEpE1yQGDRvT9PConw73kKuupG&#39;</span><span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,756 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span> INSERT INTO users <span class="o">(</span>name, role, password_hash<span class="o">)</span> VALUES <span class="o">(</span>?, ?, ?<span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,756 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">(</span><span class="s1">&#39;basic&#39;</span>, <span class="s1">&#39;basic&#39;</span>, <span class="s1">&#39;$2b$12$KgruXP5Vv7rikr6dGB3TF.flGXYpiE0Li9K583EVomjY.SYmQOsyi&#39;</span><span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,757 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1140<span class="o">][</span>MainThread<span class="o">]</span> INSERT INTO pages <span class="o">(</span>name, data, creator_id<span class="o">)</span> VALUES <span class="o">(</span>?, ?, ?<span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,757 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:1143<span class="o">][</span>MainThread<span class="o">]</span> <span class="o">(</span><span class="s1">&#39;FrontPage&#39;</span>, <span class="s1">&#39;This is the front page&#39;</span>, <span class="m">1</span><span class="o">)</span>
<span class="m">2016</span>-12-20 <span class="m">02</span>:51:11,757 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine:719<span class="o">][</span>MainThread<span class="o">]</span> COMMIT
</pre></div>
</div>
</div>
<div class="section" id="view-the-application-in-a-browser">
<h2>View the application in a browser<a class="headerlink" href="#view-the-application-in-a-browser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>We can't.  At this point, our system is in a &quot;non-runnable&quot; state; we'll need
to change view-related files in the next chapter to be able to start the
application successfully.  If you try to start the application (see
<a class="reference internal" href="installation.html#wiki2-start-the-application"><span class="std std-ref">Start the application</span></a>), you'll wind up with a Python traceback on
your console that ends with this exception:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ImportError: cannot import name MyModel
</pre></div>
</div>
<p>This will also happen if you attempt to run the tests.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Defining the Domain Model</a><ul>
<li><a class="reference internal" href="#declaring-dependencies-in-our-setup-py-file">Declaring dependencies in our <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file</a></li>
<li><a class="reference internal" href="#running-pip-install-e">Running <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.</span></code></a></li>
<li><a class="reference internal" href="#remove-mymodel-py">Remove <code class="docutils literal notranslate"><span class="pre">mymodel.py</span></code></a></li>
<li><a class="reference internal" href="#add-user-py">Add <code class="docutils literal notranslate"><span class="pre">user.py</span></code></a></li>
<li><a class="reference internal" href="#add-page-py">Add <code class="docutils literal notranslate"><span class="pre">page.py</span></code></a></li>
<li><a class="reference internal" href="#edit-models-init-py">Edit <code class="docutils literal notranslate"><span class="pre">models/__init__.py</span></code></a></li>
<li><a class="reference internal" href="#edit-scripts-initializedb-py">Edit <code class="docutils literal notranslate"><span class="pre">scripts/initializedb.py</span></code></a></li>
<li><a class="reference internal" href="#installing-the-project-and-re-initializing-the-database">Installing the project and re-initializing the database</a></li>
<li><a class="reference internal" href="#view-the-application-in-a-browser">View the application in a browser</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="basiclayout.html"
                        title="前の章へ">Basic Layout</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="definingviews.html"
                        title="次の章へ">Defining Views</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/definingmodels.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             >次へ</a> |</li>
        <li class="right" >
          <a href="basiclayout.html" title="Basic Layout"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 8月 13, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4 で生成しました。
    </div>
  </body>
</html>