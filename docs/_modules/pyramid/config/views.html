
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyramid.config.views &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="検索" href="../../../search.html" />
    <link rel="copyright" title="著作権" href="../../../copyright.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../../index.html">
      		<img class="logo" src="../../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >モジュールコード</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../config.html" accesskey="U">pyramid.config</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>pyramid.config.views のソースコード</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Interface</span><span class="p">,</span>
    <span class="n">implementedBy</span><span class="p">,</span>
    <span class="n">implementer</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">zope.interface.interfaces</span> <span class="k">import</span> <span class="n">IInterface</span>

<span class="kn">from</span> <span class="nn">pyramid.interfaces</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">IExceptionViewClassifier</span><span class="p">,</span>
    <span class="n">IException</span><span class="p">,</span>
    <span class="n">IMultiView</span><span class="p">,</span>
    <span class="n">IPackageOverrides</span><span class="p">,</span>
    <span class="n">IRendererFactory</span><span class="p">,</span>
    <span class="n">IRequest</span><span class="p">,</span>
    <span class="n">IResponse</span><span class="p">,</span>
    <span class="n">IRouteRequest</span><span class="p">,</span>
    <span class="n">ISecuredView</span><span class="p">,</span>
    <span class="n">IStaticURLInfo</span><span class="p">,</span>
    <span class="n">IView</span><span class="p">,</span>
    <span class="n">IViewClassifier</span><span class="p">,</span>
    <span class="n">IViewDerivers</span><span class="p">,</span>
    <span class="n">IViewDeriverInfo</span><span class="p">,</span>
    <span class="n">IViewMapperFactory</span><span class="p">,</span>
    <span class="n">PHASE1_CONFIG</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid</span> <span class="k">import</span> <span class="n">renderers</span>

<span class="kn">from</span> <span class="nn">pyramid.asset</span> <span class="k">import</span> <span class="n">resolve_asset_spec</span>
<span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">string_types</span><span class="p">,</span>
    <span class="n">urlparse</span><span class="p">,</span>
    <span class="n">url_quote</span><span class="p">,</span>
    <span class="n">WIN</span><span class="p">,</span>
    <span class="n">is_nonstr_iter</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.decorator</span> <span class="k">import</span> <span class="n">reify</span>

<span class="kn">from</span> <span class="nn">pyramid.exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ConfigurationError</span><span class="p">,</span>
    <span class="n">PredicateMismatch</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">HTTPForbidden</span><span class="p">,</span>
    <span class="n">HTTPNotFound</span><span class="p">,</span>
    <span class="n">default_exceptionresponse_view</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.registry</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">predvalseq</span><span class="p">,</span>
    <span class="n">Deferred</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">NO_PERMISSION_REQUIRED</span>
<span class="kn">from</span> <span class="nn">pyramid.static</span> <span class="k">import</span> <span class="n">static_view</span>

<span class="kn">from</span> <span class="nn">pyramid.url</span> <span class="k">import</span> <span class="n">parse_url_overrides</span>

<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="n">AppendSlashNotFoundViewFactory</span>

<span class="kn">import</span> <span class="nn">pyramid.util</span>
<span class="kn">from</span> <span class="nn">pyramid.util</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">viewdefaults</span><span class="p">,</span>
    <span class="n">action_method</span><span class="p">,</span>
    <span class="n">as_sorted_tuple</span><span class="p">,</span>
    <span class="n">TopologicalSorter</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">import</span> <span class="nn">pyramid.predicates</span>
<span class="kn">import</span> <span class="nn">pyramid.viewderivers</span>

<span class="kn">from</span> <span class="nn">pyramid.viewderivers</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">INGRESS</span><span class="p">,</span>
    <span class="n">VIEW</span><span class="p">,</span>
    <span class="n">preserve_view_attrs</span><span class="p">,</span>
    <span class="n">view_description</span><span class="p">,</span>
    <span class="n">requestonly</span><span class="p">,</span>
    <span class="n">DefaultViewMapper</span><span class="p">,</span>
    <span class="n">wraps_view</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.config.util</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">DEFAULT_PHASH</span><span class="p">,</span>
    <span class="n">MAX_ORDER</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">urljoin</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span>
<span class="n">url_parse</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span>

<span class="n">DefaultViewMapper</span> <span class="o">=</span> <span class="n">DefaultViewMapper</span> <span class="c1"># bw-compat</span>
<span class="n">preserve_view_attrs</span> <span class="o">=</span> <span class="n">preserve_view_attrs</span> <span class="c1"># bw-compat</span>
<span class="n">requestonly</span> <span class="o">=</span> <span class="n">requestonly</span> <span class="c1"># bw-compat</span>
<span class="n">view_description</span> <span class="o">=</span> <span class="n">view_description</span> <span class="c1"># bw-compat</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IMultiView</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_views</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__discriminator__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># used by introspection systems like so:</span>
        <span class="c1"># view = adapters.lookup(....)</span>
        <span class="c1"># view.__discriminator__(context, request) -&gt; view&#39;s discriminator</span>
        <span class="c1"># so that superdynamic systems can feed the discriminator to</span>
        <span class="c1"># the introspection system to get info about it</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">__discriminator__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">phash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">phash</span> <span class="o">==</span> <span class="n">h</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="n">accept</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">accept</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_views</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">phash</span> <span class="o">==</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">subset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subset</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span><span class="p">))</span>
                <span class="n">subset</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">accepts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accepts</span><span class="p">)</span>
            <span class="n">accepts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">accept</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accepts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accepts</span><span class="p">)</span> <span class="c1"># dedupe</span>

    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepts</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;accept&#39;</span><span class="p">):</span>
            <span class="n">accepts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepts</span><span class="p">[:]</span>
            <span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">accepts</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">accept</span><span class="o">.</span><span class="n">best_match</span><span class="p">(</span><span class="n">accepts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_views</span><span class="p">[</span><span class="n">match</span><span class="p">]</span>
                <span class="n">views</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
                <span class="n">accepts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
            <span class="n">views</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">views</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_views</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__predicated__&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">view</span>
            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">__predicated__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">view</span>
        <span class="k">raise</span> <span class="n">PredicateMismatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__permitted__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__permitted__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">__permitted__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__call_permissive__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__call_permissive__&#39;</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">phash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_views</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PredicateMismatch</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">raise</span> <span class="n">PredicateMismatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ViewsConfiguratorMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@viewdefaults</span>
    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">for_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">permission</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">route_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">containment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">renderer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wrapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xhr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">path_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_predicates</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">decorator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">http_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">match_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">check_csrf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">require_csrf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exception_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">view_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a :term:`view configuration` to the current</span>
<span class="sd">        configuration state.  Arguments to ``add_view`` are broken</span>
<span class="sd">        down below into *predicate* arguments and *non-predicate*</span>
<span class="sd">        arguments.  Predicate arguments narrow the circumstances in</span>
<span class="sd">        which the view callable will be invoked when a request is</span>
<span class="sd">        presented to :app:`Pyramid`; non-predicate arguments are</span>
<span class="sd">        informational.</span>

<span class="sd">        Non-Predicate Arguments</span>

<span class="sd">        view</span>

<span class="sd">          A :term:`view callable` or a :term:`dotted Python name`</span>
<span class="sd">          which refers to a view callable.  This argument is required</span>
<span class="sd">          unless a ``renderer`` argument also exists.  If a</span>
<span class="sd">          ``renderer`` argument is passed, and a ``view`` argument is</span>
<span class="sd">          not provided, the view callable defaults to a callable that</span>
<span class="sd">          returns an empty dictionary (see</span>
<span class="sd">          :ref:`views_which_use_a_renderer`).</span>

<span class="sd">        permission</span>

<span class="sd">          A :term:`permission` that the user must possess in order to invoke</span>
<span class="sd">          the :term:`view callable`.  See :ref:`view_security_section` for</span>
<span class="sd">          more information about view security and permissions.  This is</span>
<span class="sd">          often a string like ``view`` or ``edit``.</span>

<span class="sd">          If ``permission`` is omitted, a *default* permission may be used</span>
<span class="sd">          for this view registration if one was named as the</span>
<span class="sd">          :class:`pyramid.config.Configurator` constructor&#39;s</span>
<span class="sd">          ``default_permission`` argument, or if</span>
<span class="sd">          :meth:`pyramid.config.Configurator.set_default_permission` was used</span>
<span class="sd">          prior to this view registration.  Pass the value</span>
<span class="sd">          :data:`pyramid.security.NO_PERMISSION_REQUIRED` as the permission</span>
<span class="sd">          argument to explicitly indicate that the view should always be</span>
<span class="sd">          executable by entirely anonymous users, regardless of the default</span>
<span class="sd">          permission, bypassing any :term:`authorization policy` that may be</span>
<span class="sd">          in effect.</span>

<span class="sd">        attr</span>

<span class="sd">          This knob is most useful when the view definition is a class.</span>

<span class="sd">          The view machinery defaults to using the ``__call__`` method</span>
<span class="sd">          of the :term:`view callable` (or the function itself, if the</span>
<span class="sd">          view callable is a function) to obtain a response.  The</span>
<span class="sd">          ``attr`` value allows you to vary the method attribute used</span>
<span class="sd">          to obtain the response.  For example, if your view was a</span>
<span class="sd">          class, and the class has a method named ``index`` and you</span>
<span class="sd">          wanted to use this method instead of the class&#39; ``__call__``</span>
<span class="sd">          method to return the response, you&#39;d say ``attr=&quot;index&quot;`` in the</span>
<span class="sd">          view configuration for the view.</span>

<span class="sd">        renderer</span>

<span class="sd">          This is either a single string term (e.g. ``json``) or a</span>
<span class="sd">          string implying a path or :term:`asset specification`</span>
<span class="sd">          (e.g. ``templates/views.pt``) naming a :term:`renderer`</span>
<span class="sd">          implementation.  If the ``renderer`` value does not contain</span>
<span class="sd">          a dot ``.``, the specified string will be used to look up a</span>
<span class="sd">          renderer implementation, and that renderer implementation</span>
<span class="sd">          will be used to construct a response from the view return</span>
<span class="sd">          value.  If the ``renderer`` value contains a dot (``.``),</span>
<span class="sd">          the specified term will be treated as a path, and the</span>
<span class="sd">          filename extension of the last element in the path will be</span>
<span class="sd">          used to look up the renderer implementation, which will be</span>
<span class="sd">          passed the full path.  The renderer implementation will be</span>
<span class="sd">          used to construct a :term:`response` from the view return</span>
<span class="sd">          value.</span>

<span class="sd">          Note that if the view itself returns a :term:`response` (see</span>
<span class="sd">          :ref:`the_response`), the specified renderer implementation</span>
<span class="sd">          is never called.</span>

<span class="sd">          When the renderer is a path, although a path is usually just</span>
<span class="sd">          a simple relative pathname (e.g. ``templates/foo.pt``,</span>
<span class="sd">          implying that a template named &quot;foo.pt&quot; is in the</span>
<span class="sd">          &quot;templates&quot; directory relative to the directory of the</span>
<span class="sd">          current :term:`package` of the Configurator), a path can be</span>
<span class="sd">          absolute, starting with a slash on UNIX or a drive letter</span>
<span class="sd">          prefix on Windows.  The path can alternately be a</span>
<span class="sd">          :term:`asset specification` in the form</span>
<span class="sd">          ``some.dotted.package_name:relative/path``, making it</span>
<span class="sd">          possible to address template assets which live in a</span>
<span class="sd">          separate package.</span>

<span class="sd">          The ``renderer`` attribute is optional.  If it is not</span>
<span class="sd">          defined, the &quot;null&quot; renderer is assumed (no rendering is</span>
<span class="sd">          performed and the value is passed back to the upstream</span>
<span class="sd">          :app:`Pyramid` machinery unmodified).</span>

<span class="sd">        http_cache</span>

<span class="sd">          .. versionadded:: 1.1</span>

<span class="sd">          When you supply an ``http_cache`` value to a view configuration,</span>
<span class="sd">          the ``Expires`` and ``Cache-Control`` headers of a response</span>
<span class="sd">          generated by the associated view callable are modified.  The value</span>
<span class="sd">          for ``http_cache`` may be one of the following:</span>

<span class="sd">          - A nonzero integer.  If it&#39;s a nonzero integer, it&#39;s treated as a</span>
<span class="sd">            number of seconds.  This number of seconds will be used to</span>
<span class="sd">            compute the ``Expires`` header and the ``Cache-Control:</span>
<span class="sd">            max-age`` parameter of responses to requests which call this view.</span>
<span class="sd">            For example: ``http_cache=3600`` instructs the requesting browser</span>
<span class="sd">            to &#39;cache this response for an hour, please&#39;.</span>

<span class="sd">          - A ``datetime.timedelta`` instance.  If it&#39;s a</span>
<span class="sd">            ``datetime.timedelta`` instance, it will be converted into a</span>
<span class="sd">            number of seconds, and that number of seconds will be used to</span>
<span class="sd">            compute the ``Expires`` header and the ``Cache-Control:</span>
<span class="sd">            max-age`` parameter of responses to requests which call this view.</span>
<span class="sd">            For example: ``http_cache=datetime.timedelta(days=1)`` instructs</span>
<span class="sd">            the requesting browser to &#39;cache this response for a day, please&#39;.</span>

<span class="sd">          - Zero (``0``).  If the value is zero, the ``Cache-Control`` and</span>
<span class="sd">            ``Expires`` headers present in all responses from this view will</span>
<span class="sd">            be composed such that client browser cache (and any intermediate</span>
<span class="sd">            caches) are instructed to never cache the response.</span>

<span class="sd">          - A two-tuple.  If it&#39;s a two tuple (e.g. ``http_cache=(1,</span>
<span class="sd">            {&#39;public&#39;:True})``), the first value in the tuple may be a</span>
<span class="sd">            nonzero integer or a ``datetime.timedelta`` instance; in either</span>
<span class="sd">            case this value will be used as the number of seconds to cache</span>
<span class="sd">            the response.  The second value in the tuple must be a</span>
<span class="sd">            dictionary.  The values present in the dictionary will be used as</span>
<span class="sd">            input to the ``Cache-Control`` response header.  For example:</span>
<span class="sd">            ``http_cache=(3600, {&#39;public&#39;:True})`` means &#39;cache for an hour,</span>
<span class="sd">            and add ``public`` to the Cache-Control header of the response&#39;.</span>
<span class="sd">            All keys and values supported by the</span>
<span class="sd">            ``webob.cachecontrol.CacheControl`` interface may be added to the</span>
<span class="sd">            dictionary.  Supplying ``{&#39;public&#39;:True}`` is equivalent to</span>
<span class="sd">            calling ``response.cache_control.public = True``.</span>

<span class="sd">          Providing a non-tuple value as ``http_cache`` is equivalent to</span>
<span class="sd">          calling ``response.cache_expires(value)`` within your view&#39;s body.</span>

<span class="sd">          Providing a two-tuple value as ``http_cache`` is equivalent to</span>
<span class="sd">          calling ``response.cache_expires(value[0], **value[1])`` within your</span>
<span class="sd">          view&#39;s body.</span>

<span class="sd">          If you wish to avoid influencing, the ``Expires`` header, and</span>
<span class="sd">          instead wish to only influence ``Cache-Control`` headers, pass a</span>
<span class="sd">          tuple as ``http_cache`` with the first element of ``None``, e.g.:</span>
<span class="sd">          ``(None, {&#39;public&#39;:True})``.</span>

<span class="sd">          If you wish to prevent a view that uses ``http_cache`` in its</span>
<span class="sd">          configuration from having its caching response headers changed by</span>
<span class="sd">          this machinery, set ``response.cache_control.prevent_auto = True``</span>
<span class="sd">          before returning the response from the view.  This effectively</span>
<span class="sd">          disables any HTTP caching done by ``http_cache`` for that response.</span>

<span class="sd">        require_csrf</span>

<span class="sd">          .. versionadded:: 1.7</span>

<span class="sd">          A boolean option or ``None``. Default: ``None``.</span>

<span class="sd">          If this option is set to ``True`` then CSRF checks will be enabled</span>
<span class="sd">          for requests to this view. The required token or header default to</span>
<span class="sd">          ``csrf_token`` and ``X-CSRF-Token``, respectively.</span>

<span class="sd">          CSRF checks only affect &quot;unsafe&quot; methods as defined by RFC2616. By</span>
<span class="sd">          default, these methods are anything except</span>
<span class="sd">          ``GET``, ``HEAD``, ``OPTIONS``, and ``TRACE``.</span>

<span class="sd">          The defaults here may be overridden by</span>
<span class="sd">          :meth:`pyramid.config.Configurator.set_default_csrf_options`.</span>

<span class="sd">          This feature requires a configured :term:`session factory`.</span>

<span class="sd">          If this option is set to ``False`` then CSRF checks will be disabled</span>
<span class="sd">          regardless of the default ``require_csrf`` setting passed</span>
<span class="sd">          to ``set_default_csrf_options``.</span>

<span class="sd">          See :ref:`auto_csrf_checking` for more information.</span>

<span class="sd">        wrapper</span>

<span class="sd">          The :term:`view name` of a different :term:`view</span>
<span class="sd">          configuration` which will receive the response body of this</span>
<span class="sd">          view as the ``request.wrapped_body`` attribute of its own</span>
<span class="sd">          :term:`request`, and the :term:`response` returned by this</span>
<span class="sd">          view as the ``request.wrapped_response`` attribute of its</span>
<span class="sd">          own request.  Using a wrapper makes it possible to &quot;chain&quot;</span>
<span class="sd">          views together to form a composite response.  The response</span>
<span class="sd">          of the outermost wrapper view will be returned to the user.</span>
<span class="sd">          The wrapper view will be found as any view is found: see</span>
<span class="sd">          :ref:`view_lookup`.  The &quot;best&quot; wrapper view will be found</span>
<span class="sd">          based on the lookup ordering: &quot;under the hood&quot; this wrapper</span>
<span class="sd">          view is looked up via</span>
<span class="sd">          ``pyramid.view.render_view_to_response(context, request,</span>
<span class="sd">          &#39;wrapper_viewname&#39;)``. The context and request of a wrapper</span>
<span class="sd">          view is the same context and request of the inner view.  If</span>
<span class="sd">          this attribute is unspecified, no view wrapping is done.</span>

<span class="sd">        decorator</span>

<span class="sd">          A :term:`dotted Python name` to function (or the function itself,</span>
<span class="sd">          or an iterable of the aforementioned) which will be used to</span>
<span class="sd">          decorate the registered :term:`view callable`.  The decorator</span>
<span class="sd">          function(s) will be called with the view callable as a single</span>
<span class="sd">          argument.  The view callable it is passed will accept</span>
<span class="sd">          ``(context, request)``.  The decorator(s) must return a</span>
<span class="sd">          replacement view callable which also accepts ``(context,</span>
<span class="sd">          request)``.</span>

<span class="sd">          If decorator is an iterable, the callables will be combined and</span>
<span class="sd">          used in the order provided as a decorator.</span>
<span class="sd">          For example::</span>

<span class="sd">            @view_config(...,</span>
<span class="sd">                decorator=(decorator2,</span>
<span class="sd">                           decorator1))</span>
<span class="sd">            def myview(request):</span>
<span class="sd">                ....</span>

<span class="sd">          Is similar to doing::</span>

<span class="sd">            @view_config(...)</span>
<span class="sd">            @decorator2</span>
<span class="sd">            @decorator1</span>
<span class="sd">            def myview(request):</span>
<span class="sd">                ...</span>

<span class="sd">          Except with the existing benefits of ``decorator=`` (having a common</span>
<span class="sd">          decorator syntax for all view calling conventions and not having to</span>
<span class="sd">          think about preserving function attributes such as ``__name__`` and</span>
<span class="sd">          ``__module__`` within decorator logic).</span>

<span class="sd">          An important distinction is that each decorator will receive a</span>
<span class="sd">          response object implementing :class:`pyramid.interfaces.IResponse`</span>
<span class="sd">          instead of the raw value returned from the view callable. All</span>
<span class="sd">          decorators in the chain must return a response object or raise an</span>
<span class="sd">          exception:</span>

<span class="sd">          .. code-block:: python</span>

<span class="sd">             def log_timer(wrapped):</span>
<span class="sd">                 def wrapper(context, request):</span>
<span class="sd">                     start = time.time()</span>
<span class="sd">                     response = wrapped(context, request)</span>
<span class="sd">                     duration = time.time() - start</span>
<span class="sd">                     response.headers[&#39;X-View-Time&#39;] = &#39;%.3f&#39; % (duration,)</span>
<span class="sd">                     log.info(&#39;view took %.3f seconds&#39;, duration)</span>
<span class="sd">                     return response</span>
<span class="sd">                 return wrapper</span>

<span class="sd">          .. versionchanged:: 1.4a4</span>
<span class="sd">             Passing an iterable.</span>

<span class="sd">        mapper</span>

<span class="sd">          A Python object or :term:`dotted Python name` which refers to a</span>
<span class="sd">          :term:`view mapper`, or ``None``.  By default it is ``None``, which</span>
<span class="sd">          indicates that the view should use the default view mapper.  This</span>
<span class="sd">          plug-point is useful for Pyramid extension developers, but it&#39;s not</span>
<span class="sd">          very useful for &#39;civilians&#39; who are just developing stock Pyramid</span>
<span class="sd">          applications. Pay no attention to the man behind the curtain.</span>

<span class="sd">        accept</span>

<span class="sd">          This value represents a match query for one or more mimetypes in the</span>
<span class="sd">          ``Accept`` HTTP request header.  If this value is specified, it must</span>
<span class="sd">          be in one of the following forms: a mimetype match token in the form</span>
<span class="sd">          ``text/plain``, a wildcard mimetype match token in the form</span>
<span class="sd">          ``text/*`` or a match-all wildcard mimetype match token in the form</span>
<span class="sd">          ``*/*``.  If any of the forms matches the ``Accept`` header of the</span>
<span class="sd">          request, or if the ``Accept`` header isn&#39;t set at all in the request,</span>
<span class="sd">          this will match the current view. If this does not match the</span>
<span class="sd">          ``Accept`` header of the request, view matching continues.</span>

<span class="sd">        Predicate Arguments</span>

<span class="sd">        name</span>

<span class="sd">          The :term:`view name`.  Read :ref:`traversal_chapter` to</span>
<span class="sd">          understand the concept of a view name.</span>

<span class="sd">        context</span>

<span class="sd">          An object or a :term:`dotted Python name` referring to an</span>
<span class="sd">          interface or class object that the :term:`context` must be</span>
<span class="sd">          an instance of, *or* the :term:`interface` that the</span>
<span class="sd">          :term:`context` must provide in order for this view to be</span>
<span class="sd">          found and called.  This predicate is true when the</span>
<span class="sd">          :term:`context` is an instance of the represented class or</span>
<span class="sd">          if the :term:`context` provides the represented interface;</span>
<span class="sd">          it is otherwise false.  This argument may also be provided</span>
<span class="sd">          to ``add_view`` as ``for_`` (an older, still-supported</span>
<span class="sd">          spelling). If the view should *only* match when handling</span>
<span class="sd">          exceptions, then set the ``exception_only`` to ``True``.</span>

<span class="sd">        exception_only</span>

<span class="sd">          .. versionadded:: 1.8</span>

<span class="sd">          When this value is ``True``, the ``context`` argument must be</span>
<span class="sd">          a subclass of ``Exception``. This flag indicates that only an</span>
<span class="sd">          :term:`exception view` should be created, and that this view should</span>
<span class="sd">          not match if the traversal :term:`context` matches the ``context``</span>
<span class="sd">          argument. If the ``context`` is a subclass of ``Exception`` and</span>
<span class="sd">          this value is ``False`` (the default), then a view will be</span>
<span class="sd">          registered to match the traversal :term:`context` as well.</span>

<span class="sd">        route_name</span>

<span class="sd">          This value must match the ``name`` of a :term:`route</span>
<span class="sd">          configuration` declaration (see :ref:`urldispatch_chapter`)</span>
<span class="sd">          that must match before this view will be called.</span>

<span class="sd">        request_type</span>

<span class="sd">          This value should be an :term:`interface` that the</span>
<span class="sd">          :term:`request` must provide in order for this view to be</span>
<span class="sd">          found and called.  This value exists only for backwards</span>
<span class="sd">          compatibility purposes.</span>

<span class="sd">        request_method</span>

<span class="sd">          This value can be either a string (such as ``&quot;GET&quot;``, ``&quot;POST&quot;``,</span>
<span class="sd">          ``&quot;PUT&quot;``, ``&quot;DELETE&quot;``, ``&quot;HEAD&quot;`` or ``&quot;OPTIONS&quot;``) representing</span>
<span class="sd">          an HTTP ``REQUEST_METHOD``, or a tuple containing one or more of</span>
<span class="sd">          these strings.  A view declaration with this argument ensures that</span>
<span class="sd">          the view will only be called when the ``method`` attribute of the</span>
<span class="sd">          request (aka the ``REQUEST_METHOD`` of the WSGI environment) matches</span>
<span class="sd">          a supplied value.  Note that use of ``GET`` also implies that the</span>
<span class="sd">          view will respond to ``HEAD`` as of Pyramid 1.4.</span>

<span class="sd">          .. versionchanged:: 1.2</span>
<span class="sd">             The ability to pass a tuple of items as ``request_method``.</span>
<span class="sd">             Previous versions allowed only a string.</span>

<span class="sd">        request_param</span>

<span class="sd">          This value can be any string or any sequence of strings.  A view</span>
<span class="sd">          declaration with this argument ensures that the view will only be</span>
<span class="sd">          called when the :term:`request` has a key in the ``request.params``</span>
<span class="sd">          dictionary (an HTTP ``GET`` or ``POST`` variable) that has a</span>
<span class="sd">          name which matches the supplied value (if the value is a string)</span>
<span class="sd">          or values (if the value is a tuple).  If any value</span>
<span class="sd">          supplied has a ``=`` sign in it,</span>
<span class="sd">          e.g. ``request_param=&quot;foo=123&quot;``, then the key (``foo``)</span>
<span class="sd">          must both exist in the ``request.params`` dictionary, *and*</span>
<span class="sd">          the value must match the right hand side of the expression</span>
<span class="sd">          (``123``) for the view to &quot;match&quot; the current request.</span>

<span class="sd">        match_param</span>

<span class="sd">          .. versionadded:: 1.2</span>

<span class="sd">          This value can be a string of the format &quot;key=value&quot; or a tuple</span>
<span class="sd">          containing one or more of these strings.</span>

<span class="sd">          A view declaration with this argument ensures that the view will</span>
<span class="sd">          only be called when the :term:`request` has key/value pairs in its</span>
<span class="sd">          :term:`matchdict` that equal those supplied in the predicate.</span>
<span class="sd">          e.g. ``match_param=&quot;action=edit&quot;`` would require the ``action``</span>
<span class="sd">          parameter in the :term:`matchdict` match the right hand side of</span>
<span class="sd">          the expression (``edit``) for the view to &quot;match&quot; the current</span>
<span class="sd">          request.</span>

<span class="sd">          If the ``match_param`` is a tuple, every key/value pair must match</span>
<span class="sd">          for the predicate to pass.</span>

<span class="sd">        containment</span>

<span class="sd">          This value should be a Python class or :term:`interface` (or a</span>
<span class="sd">          :term:`dotted Python name`) that an object in the</span>
<span class="sd">          :term:`lineage` of the context must provide in order for this view</span>
<span class="sd">          to be found and called.  The nodes in your object graph must be</span>
<span class="sd">          &quot;location-aware&quot; to use this feature.  See</span>
<span class="sd">          :ref:`location_aware` for more information about</span>
<span class="sd">          location-awareness.</span>

<span class="sd">        xhr</span>

<span class="sd">          This value should be either ``True`` or ``False``.  If this</span>
<span class="sd">          value is specified and is ``True``, the :term:`request`</span>
<span class="sd">          must possess an ``HTTP_X_REQUESTED_WITH`` (aka</span>
<span class="sd">          ``X-Requested-With``) header that has the value</span>
<span class="sd">          ``XMLHttpRequest`` for this view to be found and called.</span>
<span class="sd">          This is useful for detecting AJAX requests issued from</span>
<span class="sd">          jQuery, Prototype and other Javascript libraries.</span>

<span class="sd">        header</span>

<span class="sd">          This value represents an HTTP header name or a header</span>
<span class="sd">          name/value pair.  If the value contains a ``:`` (colon), it</span>
<span class="sd">          will be considered a name/value pair</span>
<span class="sd">          (e.g. ``User-Agent:Mozilla/.*`` or ``Host:localhost``).  The</span>
<span class="sd">          value portion should be a regular expression.  If the value</span>
<span class="sd">          does not contain a colon, the entire value will be</span>
<span class="sd">          considered to be the header name</span>
<span class="sd">          (e.g. ``If-Modified-Since``).  If the value evaluates to a</span>
<span class="sd">          header name only without a value, the header specified by</span>
<span class="sd">          the name must be present in the request for this predicate</span>
<span class="sd">          to be true.  If the value evaluates to a header name/value</span>
<span class="sd">          pair, the header specified by the name must be present in</span>
<span class="sd">          the request *and* the regular expression specified as the</span>
<span class="sd">          value must match the header value.  Whether or not the value</span>
<span class="sd">          represents a header name or a header name/value pair, the</span>
<span class="sd">          case of the header name is not significant.</span>

<span class="sd">        path_info</span>

<span class="sd">          This value represents a regular expression pattern that will</span>
<span class="sd">          be tested against the ``PATH_INFO`` WSGI environment</span>
<span class="sd">          variable.  If the regex matches, this predicate will be</span>
<span class="sd">          ``True``.</span>

<span class="sd">        check_csrf</span>

<span class="sd">          .. deprecated:: 1.7</span>
<span class="sd">             Use the ``require_csrf`` option or see :ref:`auto_csrf_checking`</span>
<span class="sd">             instead to have :class:`pyramid.exceptions.BadCSRFToken`</span>
<span class="sd">             exceptions raised.</span>

<span class="sd">          If specified, this value should be one of ``None``, ``True``,</span>
<span class="sd">          ``False``, or a string representing the &#39;check name&#39;.  If the value</span>
<span class="sd">          is ``True`` or a string, CSRF checking will be performed.  If the</span>
<span class="sd">          value is ``False`` or ``None``, CSRF checking will not be performed.</span>

<span class="sd">          If the value provided is a string, that string will be used as the</span>
<span class="sd">          &#39;check name&#39;.  If the value provided is ``True``, ``csrf_token`` will</span>
<span class="sd">          be used as the check name.</span>

<span class="sd">          If CSRF checking is performed, the checked value will be the value of</span>
<span class="sd">          ``request.params[check_name]``. This value will be compared against</span>
<span class="sd">          the value of ``policy.get_csrf_token()`` (where ``policy`` is an</span>
<span class="sd">          implementation of :meth:`pyramid.interfaces.ICSRFStoragePolicy`), and the</span>
<span class="sd">          check will pass if these two values are the same. If the check</span>
<span class="sd">          passes, the associated view will be permitted to execute. If the</span>
<span class="sd">          check fails, the associated view will not be permitted to execute.</span>

<span class="sd">          .. versionadded:: 1.4a2</span>

<span class="sd">          .. versionchanged:: 1.9</span>
<span class="sd">            This feature requires either a :term:`session factory` to have been</span>
<span class="sd">            configured, or a :term:`CSRF storage policy` other than the default</span>
<span class="sd">            to be in use.</span>


<span class="sd">        physical_path</span>

<span class="sd">          If specified, this value should be a string or a tuple representing</span>
<span class="sd">          the :term:`physical path` of the context found via traversal for this</span>
<span class="sd">          predicate to match as true.  For example: ``physical_path=&#39;/&#39;`` or</span>
<span class="sd">          ``physical_path=&#39;/a/b/c&#39;`` or ``physical_path=(&#39;&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;)``.</span>
<span class="sd">          This is not a path prefix match or a regex, it&#39;s a whole-path match.</span>
<span class="sd">          It&#39;s useful when you want to always potentially show a view when some</span>
<span class="sd">          object is traversed to, but you can&#39;t be sure about what kind of</span>
<span class="sd">          object it will be, so you can&#39;t use the ``context`` predicate.  The</span>
<span class="sd">          individual path elements inbetween slash characters or in tuple</span>
<span class="sd">          elements should be the Unicode representation of the name of the</span>
<span class="sd">          resource and should not be encoded in any way.</span>

<span class="sd">          .. versionadded:: 1.4a3</span>

<span class="sd">        effective_principals</span>

<span class="sd">          If specified, this value should be a :term:`principal` identifier or</span>
<span class="sd">          a sequence of principal identifiers.  If the</span>
<span class="sd">          :attr:`pyramid.request.Request.effective_principals` property</span>
<span class="sd">          indicates that every principal named in the argument list is present</span>
<span class="sd">          in the current request, this predicate will return True; otherwise it</span>
<span class="sd">          will return False.  For example:</span>
<span class="sd">          ``effective_principals=pyramid.security.Authenticated`` or</span>
<span class="sd">          ``effective_principals=(&#39;fred&#39;, &#39;group:admins&#39;)``.</span>

<span class="sd">          .. versionadded:: 1.4a4</span>

<span class="sd">        custom_predicates</span>

<span class="sd">            .. deprecated:: 1.5</span>
<span class="sd">                This value should be a sequence of references to custom</span>
<span class="sd">                predicate callables.  Use custom predicates when no set of</span>
<span class="sd">                predefined predicates do what you need.  Custom predicates</span>
<span class="sd">                can be combined with predefined predicates as necessary.</span>
<span class="sd">                Each custom predicate callable should accept two arguments:</span>
<span class="sd">                ``context`` and ``request`` and should return either</span>
<span class="sd">                ``True`` or ``False`` after doing arbitrary evaluation of</span>
<span class="sd">                the context and/or the request.  The ``predicates`` argument</span>
<span class="sd">                to this method and the ability to register third-party view</span>
<span class="sd">                predicates via</span>
<span class="sd">                :meth:`pyramid.config.Configurator.add_view_predicate`</span>
<span class="sd">                obsoletes this argument, but it is kept around for backwards</span>
<span class="sd">                compatibility.</span>

<span class="sd">        view_options</span>

<span class="sd">          Pass a key/value pair here to use a third-party predicate or set a</span>
<span class="sd">          value for a view deriver. See</span>
<span class="sd">          :meth:`pyramid.config.Configurator.add_view_predicate` and</span>
<span class="sd">          :meth:`pyramid.config.Configurator.add_view_deriver`. See</span>
<span class="sd">          :ref:`view_and_route_predicates` for more information about</span>
<span class="sd">          third-party predicates and :ref:`view_derivers` for information</span>
<span class="sd">          about view derivers.</span>

<span class="sd">          .. versionadded: 1.4a1</span>

<span class="sd">          .. versionchanged: 1.7</span>

<span class="sd">             Support setting view deriver options. Previously, only custom</span>
<span class="sd">             view predicate values could be supplied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">custom_predicates</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;The &quot;custom_predicates&quot; argument to Configurator.add_view &#39;</span>
                 <span class="s1">&#39;is deprecated as of Pyramid 1.5.  Use &#39;</span>
                 <span class="s1">&#39;&quot;config.add_view_predicate&quot; and use the registered &#39;</span>
                 <span class="s1">&#39;view predicate as a predicate argument to add_view instead. &#39;</span>
                 <span class="s1">&#39;See &quot;Adding A Third Party View, Route, or Subscriber &#39;</span>
                 <span class="s1">&#39;Predicate&quot; in the &quot;Hooks&quot; chapter of the documentation &#39;</span>
                 <span class="s1">&#39;for more information.&#39;</span><span class="p">),</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">check_csrf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;The &quot;check_csrf&quot; argument to Configurator.add_view is &#39;</span>
                 <span class="s1">&#39;deprecated as of Pyramid 1.7. Use the &quot;require_csrf&quot; option &#39;</span>
                 <span class="s1">&#39;instead or see &quot;Checking CSRF Tokens Automatically&quot; in the &#39;</span>
                 <span class="s1">&#39;&quot;Sessions&quot; chapter of the documentation for more &#39;</span>
                 <span class="s1">&#39;information.&#39;</span><span class="p">),</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">for_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">for_</span><span class="p">)</span>
        <span class="n">containment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">containment</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="o">*</span><span class="n">decorators</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">view_callable</span><span class="p">):</span>
                <span class="c1"># reversed() allows a more natural ordering in the api</span>
                <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">decorators</span><span class="p">):</span>
                    <span class="n">view_callable</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">view_callable</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">view_callable</span>
            <span class="k">return</span> <span class="n">decorated</span>

        <span class="k">if</span> <span class="n">is_nonstr_iter</span><span class="p">(</span><span class="n">decorator</span><span class="p">):</span>
            <span class="n">decorator</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">,</span> <span class="n">decorator</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decorator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">view</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">renderer</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;&quot;view&quot; was not specified and &#39;</span>
                                         <span class="s1">&#39;no &quot;renderer&quot; specified&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">request_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">IInterface</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">request_type</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s1">&#39;request_type must be an interface, not </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">for_</span>

        <span class="n">isexc</span> <span class="o">=</span> <span class="n">isexception</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exception_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isexc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s1">&#39;view &quot;context&quot; must be an exception type when &#39;</span>
                <span class="s1">&#39;&quot;exception_only&quot; is True&#39;</span><span class="p">)</span>

        <span class="n">r_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="k">if</span> <span class="n">r_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_context</span> <span class="o">=</span> <span class="n">Interface</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">IInterface</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">r_context</span><span class="p">):</span>
            <span class="n">r_context</span> <span class="o">=</span> <span class="n">implementedBy</span><span class="p">(</span><span class="n">r_context</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="n">renderers</span><span class="o">.</span><span class="n">RendererHelper</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">accept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">accept</span> <span class="o">=</span> <span class="n">accept</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">introspectables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ovals</span> <span class="o">=</span> <span class="n">view_options</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ovals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xhr</span><span class="o">=</span><span class="n">xhr</span><span class="p">,</span>
            <span class="n">request_method</span><span class="o">=</span><span class="n">request_method</span><span class="p">,</span>
            <span class="n">path_info</span><span class="o">=</span><span class="n">path_info</span><span class="p">,</span>
            <span class="n">request_param</span><span class="o">=</span><span class="n">request_param</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
            <span class="n">containment</span><span class="o">=</span><span class="n">containment</span><span class="p">,</span>
            <span class="n">request_type</span><span class="o">=</span><span class="n">request_type</span><span class="p">,</span>
            <span class="n">match_param</span><span class="o">=</span><span class="n">match_param</span><span class="p">,</span>
            <span class="n">check_csrf</span><span class="o">=</span><span class="n">check_csrf</span><span class="p">,</span>
            <span class="n">custom</span><span class="o">=</span><span class="n">predvalseq</span><span class="p">(</span><span class="n">custom_predicates</span><span class="p">),</span>
        <span class="p">))</span>

        <span class="k">def</span> <span class="nf">discrim_func</span><span class="p">():</span>
            <span class="c1"># We need to defer the discriminator until we know what the phash</span>
            <span class="c1"># is.  It can&#39;t be computed any sooner because thirdparty</span>
            <span class="c1"># predicates/view derivers may not yet exist when add_view is</span>
            <span class="c1"># called.</span>
            <span class="n">predlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_predlist</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
            <span class="n">valid_predicates</span> <span class="o">=</span> <span class="n">predlist</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
            <span class="n">pvals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dvals</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ovals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_predicates</span><span class="p">:</span>
                    <span class="n">pvals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dvals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_view_options</span><span class="p">(</span><span class="o">**</span><span class="n">dvals</span><span class="p">)</span>

            <span class="n">order</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">phash</span> <span class="o">=</span> <span class="n">predlist</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">pvals</span><span class="p">)</span>

            <span class="n">view_intr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;phash&#39;</span><span class="p">:</span> <span class="n">phash</span><span class="p">,</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
                <span class="s1">&#39;predicates&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">route_name</span><span class="p">,</span> <span class="n">phash</span><span class="p">)</span>

        <span class="n">discriminator</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">(</span><span class="n">discrim_func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="p">:</span>
            <span class="n">view_desc</span> <span class="o">=</span> <span class="s1">&#39;method </span><span class="si">%r</span><span class="s1"> of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_description</span><span class="p">(</span><span class="n">view</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">view_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_description</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

        <span class="n">tmpl_intr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">view_intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span>
                                        <span class="n">discriminator</span><span class="p">,</span>
                                        <span class="n">view_desc</span><span class="p">,</span>
                                        <span class="s1">&#39;view&#39;</span><span class="p">)</span>
        <span class="n">view_intr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">exception_only</span><span class="o">=</span><span class="n">exception_only</span><span class="p">,</span>
            <span class="n">containment</span><span class="o">=</span><span class="n">containment</span><span class="p">,</span>
            <span class="n">request_param</span><span class="o">=</span><span class="n">request_param</span><span class="p">,</span>
            <span class="n">request_methods</span><span class="o">=</span><span class="n">request_method</span><span class="p">,</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">,</span>
            <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span>
            <span class="n">xhr</span><span class="o">=</span><span class="n">xhr</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">path_info</span><span class="o">=</span><span class="n">path_info</span><span class="p">,</span>
            <span class="n">match_param</span><span class="o">=</span><span class="n">match_param</span><span class="p">,</span>
            <span class="n">check_csrf</span><span class="o">=</span><span class="n">check_csrf</span><span class="p">,</span>
            <span class="n">http_cache</span><span class="o">=</span><span class="n">http_cache</span><span class="p">,</span>
            <span class="n">require_csrf</span><span class="o">=</span><span class="n">require_csrf</span><span class="p">,</span>
            <span class="n">callable</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
            <span class="n">decorator</span><span class="o">=</span><span class="n">decorator</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="n">view_intr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">view_options</span><span class="p">)</span>
        <span class="n">introspectables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view_intr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">permission</span><span class="o">=</span><span class="n">permission</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">):</span>
            <span class="n">request_iface</span> <span class="o">=</span> <span class="n">IRequest</span>
            <span class="k">if</span> <span class="n">route_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">request_iface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IRouteRequest</span><span class="p">,</span>
                                                           <span class="n">name</span><span class="o">=</span><span class="n">route_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">request_iface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># route configuration should have already happened in</span>
                    <span class="c1"># phase 2</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="s1">&#39;No route named </span><span class="si">%s</span><span class="s1"> found for view registration&#39;</span> <span class="o">%</span>
                        <span class="n">route_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># use default renderer if one exists (reg&#39;d in phase 1)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IRendererFactory</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">renderer</span> <span class="o">=</span> <span class="n">renderers</span><span class="o">.</span><span class="n">RendererHelper</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
                        <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span>
                        <span class="p">)</span>

            <span class="n">renderer_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">intrspc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspector</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">renderer_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">tmpl_intr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">intrspc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">intrspc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;renderer factories&#39;</span><span class="p">,</span> <span class="n">renderer_type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                <span class="c1"># allow failure of registered template factories to be deferred</span>
                <span class="c1"># until view execution, like other bad renderer factories; if</span>
                <span class="c1"># we tried to relate this to an existing renderer factory</span>
                <span class="c1"># without checking if the factory actually existed, we&#39;d end</span>
                <span class="c1"># up with a KeyError at startup time, which is inconsistent</span>
                <span class="c1"># with how other bad renderer registrations behave (they throw</span>
                <span class="c1"># a ValueError at view execution time)</span>
                <span class="n">tmpl_intr</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="s1">&#39;renderer factories&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

            <span class="c1"># make a new view separately for normal and exception paths</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exception_only</span><span class="p">:</span>
                <span class="n">derived_view</span> <span class="o">=</span> <span class="n">derive_view</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
                <span class="n">register_view</span><span class="p">(</span><span class="n">IViewClassifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">derived_view</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isexc</span><span class="p">:</span>
                <span class="n">derived_exc_view</span> <span class="o">=</span> <span class="n">derive_view</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
                <span class="n">register_view</span><span class="p">(</span><span class="n">IExceptionViewClassifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span>
                              <span class="n">derived_exc_view</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">exception_only</span><span class="p">:</span>
                    <span class="n">derived_view</span> <span class="o">=</span> <span class="n">derived_exc_view</span>

            <span class="c1"># if there are two derived views, combine them into one for</span>
            <span class="c1"># introspection purposes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exception_only</span> <span class="ow">and</span> <span class="n">isexc</span><span class="p">:</span>
                <span class="n">derived_view</span> <span class="o">=</span> <span class="n">runtime_exc_view</span><span class="p">(</span><span class="n">derived_view</span><span class="p">,</span> <span class="n">derived_exc_view</span><span class="p">)</span>

            <span class="n">derived_view</span><span class="o">.</span><span class="n">__discriminator__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">arg</span><span class="p">:</span> <span class="n">discriminator</span>
            <span class="c1"># __discriminator__ is used by superdynamic systems</span>
            <span class="c1"># that require it for introspection after manual view lookup;</span>
            <span class="c1"># see also MultiView.__discriminator__</span>
            <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;derived_callable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">derived_view</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">_clear_view_lookup_cache</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">derive_view</span><span class="p">(</span><span class="n">isexc_only</span><span class="p">,</span> <span class="n">renderer</span><span class="p">):</span>
            <span class="c1"># added by discrim_func above during conflict resolving</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;predicates&#39;</span><span class="p">]</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
            <span class="n">phash</span> <span class="o">=</span> <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;phash&#39;</span><span class="p">]</span>

            <span class="n">derived_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_view</span><span class="p">(</span>
                <span class="n">view</span><span class="p">,</span>
                <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">,</span>
                <span class="n">permission</span><span class="o">=</span><span class="n">permission</span><span class="p">,</span>
                <span class="n">predicates</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span>
                <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">exception_only</span><span class="o">=</span><span class="n">isexc_only</span><span class="p">,</span>
                <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
                <span class="n">wrapper_viewname</span><span class="o">=</span><span class="n">wrapper</span><span class="p">,</span>
                <span class="n">viewname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                <span class="n">phash</span><span class="o">=</span><span class="n">phash</span><span class="p">,</span>
                <span class="n">decorator</span><span class="o">=</span><span class="n">decorator</span><span class="p">,</span>
                <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
                <span class="n">http_cache</span><span class="o">=</span><span class="n">http_cache</span><span class="p">,</span>
                <span class="n">require_csrf</span><span class="o">=</span><span class="n">require_csrf</span><span class="p">,</span>
                <span class="n">extra_options</span><span class="o">=</span><span class="n">ovals</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">derived_view</span>

        <span class="k">def</span> <span class="nf">register_view</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">derived_view</span><span class="p">):</span>
            <span class="c1"># A multiviews is a set of views which are registered for</span>
            <span class="c1"># exactly the same context type/request type/name triad.  Each</span>
            <span class="c1"># constituent view in a multiview differs only by the</span>
            <span class="c1"># predicates which it possesses.</span>

            <span class="c1"># To find a previously registered view for a context</span>
            <span class="c1"># type/request type/name triad, we need to use the</span>
            <span class="c1"># ``registered`` method of the adapter registry rather than</span>
            <span class="c1"># ``lookup``.  ``registered`` ignores interface inheritance</span>
            <span class="c1"># for the required and provided arguments, returning only a</span>
            <span class="c1"># view registered previously with the *exact* triad we pass</span>
            <span class="c1"># in.</span>

            <span class="c1"># We need to do this three times, because we use three</span>
            <span class="c1"># different interfaces as the ``provided`` interface while</span>
            <span class="c1"># doing registrations, and ``registered`` performs exact</span>
            <span class="c1"># matches on all the arguments it receives.</span>

            <span class="n">old_view</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">order</span><span class="p">,</span> <span class="n">phash</span> <span class="o">=</span> <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="n">view_intr</span><span class="p">[</span><span class="s1">&#39;phash&#39;</span><span class="p">]</span>
            <span class="n">registered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">adapters</span><span class="o">.</span><span class="n">registered</span>

            <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">IView</span><span class="p">,</span> <span class="n">ISecuredView</span><span class="p">,</span> <span class="n">IMultiView</span><span class="p">):</span>
                <span class="n">old_view</span> <span class="o">=</span> <span class="n">registered</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">r_context</span><span class="p">),</span>
                    <span class="n">view_type</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">def</span> <span class="nf">regclosure</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">derived_view</span><span class="p">,</span> <span class="s1">&#39;__call_permissive__&#39;</span><span class="p">):</span>
                    <span class="n">view_iface</span> <span class="o">=</span> <span class="n">ISecuredView</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">view_iface</span> <span class="o">=</span> <span class="n">IView</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerAdapter</span><span class="p">(</span>
                    <span class="n">derived_view</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span>
                    <span class="n">view_iface</span><span class="p">,</span>
                    <span class="n">name</span>
                    <span class="p">)</span>

            <span class="n">is_multiview</span> <span class="o">=</span> <span class="n">IMultiView</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">old_view</span><span class="p">)</span>
            <span class="n">old_phash</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">old_view</span><span class="p">,</span> <span class="s1">&#39;__phash__&#39;</span><span class="p">,</span> <span class="n">DEFAULT_PHASH</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">old_view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># - No component was yet registered for any of our I*View</span>
                <span class="c1">#   interfaces exactly; this is the first view for this</span>
                <span class="c1">#   triad.</span>
                <span class="n">regclosure</span><span class="p">()</span>

            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_multiview</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">old_phash</span> <span class="o">==</span> <span class="n">phash</span><span class="p">):</span>
                <span class="c1"># - A single view component was previously registered with</span>
                <span class="c1">#   the same predicate hash as this view; this registration</span>
                <span class="c1">#   is therefore an override.</span>
                <span class="n">regclosure</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># - A view or multiview was already registered for this</span>
                <span class="c1">#   triad, and the new view is not an override.</span>

                <span class="c1"># XXX we could try to be more efficient here and register</span>
                <span class="c1"># a non-secured view for a multiview if none of the</span>
                <span class="c1"># multiview&#39;s constituent views have a permission</span>
                <span class="c1"># associated with them, but this code is getting pretty</span>
                <span class="c1"># rough already</span>
                <span class="k">if</span> <span class="n">is_multiview</span><span class="p">:</span>
                    <span class="n">multiview</span> <span class="o">=</span> <span class="n">old_view</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">multiview</span> <span class="o">=</span> <span class="n">MultiView</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">old_accept</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">old_view</span><span class="p">,</span> <span class="s1">&#39;__accept__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">old_order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">old_view</span><span class="p">,</span> <span class="s1">&#39;__order__&#39;</span><span class="p">,</span> <span class="n">MAX_ORDER</span><span class="p">)</span>
                    <span class="n">multiview</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">old_view</span><span class="p">,</span> <span class="n">old_order</span><span class="p">,</span> <span class="n">old_accept</span><span class="p">,</span> <span class="n">old_phash</span><span class="p">)</span>
                <span class="n">multiview</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">derived_view</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">accept</span><span class="p">,</span> <span class="n">phash</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">IView</span><span class="p">,</span> <span class="n">ISecuredView</span><span class="p">):</span>
                    <span class="c1"># unregister any existing views</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">adapters</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">r_context</span><span class="p">),</span>
                        <span class="n">view_type</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerAdapter</span><span class="p">(</span>
                    <span class="n">multiview</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">request_iface</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span>
                    <span class="n">IMultiView</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapper</span><span class="p">:</span>
            <span class="n">mapper_intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span>
                <span class="s1">&#39;view mappers&#39;</span><span class="p">,</span>
                <span class="n">discriminator</span><span class="p">,</span>
                <span class="s1">&#39;view mapper for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">view_desc</span><span class="p">,</span>
                <span class="s1">&#39;view mapper&#39;</span>
                <span class="p">)</span>
            <span class="n">mapper_intr</span><span class="p">[</span><span class="s1">&#39;mapper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapper</span>
            <span class="n">mapper_intr</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">)</span>
            <span class="n">introspectables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapper_intr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">route_name</span><span class="p">:</span>
            <span class="n">view_intr</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="s1">&#39;routes&#39;</span><span class="p">,</span> <span class="n">route_name</span><span class="p">)</span> <span class="c1"># see add_route</span>
        <span class="k">if</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">renderer</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">renderer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="c1"># the renderer is a template</span>
            <span class="n">tmpl_intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span>
                <span class="s1">&#39;templates&#39;</span><span class="p">,</span>
                <span class="n">discriminator</span><span class="p">,</span>
                <span class="n">renderer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;template&#39;</span>
                <span class="p">)</span>
            <span class="n">tmpl_intr</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">)</span>
            <span class="n">tmpl_intr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renderer</span><span class="o">.</span><span class="n">name</span>
            <span class="n">tmpl_intr</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renderer</span><span class="o">.</span><span class="n">type</span>
            <span class="n">tmpl_intr</span><span class="p">[</span><span class="s1">&#39;renderer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renderer</span>
            <span class="n">introspectables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpl_intr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">permission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if a permission exists, register a permission introspectable</span>
            <span class="n">perm_intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span>
                <span class="s1">&#39;permissions&#39;</span><span class="p">,</span>
                <span class="n">permission</span><span class="p">,</span>
                <span class="n">permission</span><span class="p">,</span>
                <span class="s1">&#39;permission&#39;</span>
                <span class="p">)</span>
            <span class="n">perm_intr</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">permission</span>
            <span class="n">perm_intr</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">)</span>
            <span class="n">introspectables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm_intr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">introspectables</span><span class="o">=</span><span class="n">introspectables</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_view_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># we only need to validate deriver options because the predicates</span>
        <span class="c1"># were checked by the predlist</span>
        <span class="n">derivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">IViewDerivers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">deriver</span> <span class="ow">in</span> <span class="n">derivers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">deriver</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;Unknown view options: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kw</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_apply_view_derivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">viewderivers</span>

        <span class="c1"># These derivers are not really derivers and so have fixed order</span>
        <span class="n">outer_derivers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;attr_wrapped_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">attr_wrapped_view</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;predicated_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">predicated_view</span><span class="p">)]</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">original_view</span>
        <span class="n">derivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">IViewDerivers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">deriver</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">outer_derivers</span> <span class="o">+</span> <span class="n">derivers</span><span class="o">.</span><span class="n">sorted</span><span class="p">()):</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">wraps_view</span><span class="p">(</span><span class="n">deriver</span><span class="p">)(</span><span class="n">view</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span>

    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_view_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">weighs_more_than</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">weighs_less_than</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. versionadded:: 1.4</span>

<span class="sd">        Adds a view predicate factory.  The associated view predicate can</span>
<span class="sd">        later be named as a keyword argument to</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view` in the</span>
<span class="sd">        ``predicates`` anonyous keyword argument dictionary.</span>

<span class="sd">        ``name`` should be the name of the predicate.  It must be a valid</span>
<span class="sd">        Python identifier (it will be used as a keyword argument to</span>
<span class="sd">        ``add_view`` by others).</span>

<span class="sd">        ``factory`` should be a :term:`predicate factory` or :term:`dotted</span>
<span class="sd">        Python name` which refers to a predicate factory.</span>

<span class="sd">        See :ref:`view_and_route_predicates` for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_predicate</span><span class="p">(</span>
            <span class="s1">&#39;view&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">factory</span><span class="p">,</span>
            <span class="n">weighs_more_than</span><span class="o">=</span><span class="n">weighs_more_than</span><span class="p">,</span>
            <span class="n">weighs_less_than</span><span class="o">=</span><span class="n">weighs_less_than</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_default_view_predicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">predicates</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;xhr&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">XHRPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;request_method&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">RequestMethodPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;path_info&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">PathInfoPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;request_param&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">RequestParamPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">HeaderPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">AcceptPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;containment&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">ContainmentPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;request_type&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">RequestTypePredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;match_param&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">MatchParamPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;check_csrf&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">CheckCSRFTokenPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;physical_path&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">PhysicalPathPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;effective_principals&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">EffectivePrincipalsPredicate</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">CustomPredicate</span><span class="p">),</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_view_predicate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>

    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_view_deriver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deriver</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">under</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. versionadded:: 1.7</span>

<span class="sd">        Add a :term:`view deriver` to the view pipeline. View derivers are</span>
<span class="sd">        a feature used by extension authors to wrap views in custom code</span>
<span class="sd">        controllable by view-specific options.</span>

<span class="sd">        ``deriver`` should be a callable conforming to the</span>
<span class="sd">        :class:`pyramid.interfaces.IViewDeriver` interface.</span>

<span class="sd">        ``name`` should be the name of the view deriver.  There are no</span>
<span class="sd">        restrictions on the name of a view deriver. If left unspecified, the</span>
<span class="sd">        name will be constructed from the name of the ``deriver``.</span>

<span class="sd">        The ``under`` and ``over`` options can be used to control the ordering</span>
<span class="sd">        of view derivers by providing hints about where in the view pipeline</span>
<span class="sd">        the deriver is used. Each option may be a string or a list of strings.</span>
<span class="sd">        At least one view deriver in each, the over and under directions, must</span>
<span class="sd">        exist to fully satisfy the constraints.</span>

<span class="sd">        ``under`` means closer to the user-defined :term:`view callable`,</span>
<span class="sd">        and ``over`` means closer to view pipeline ingress.</span>

<span class="sd">        The default value for ``over`` is ``rendered_view`` and ``under`` is</span>
<span class="sd">        ``decorated_view``. This places the deriver somewhere between the two</span>
<span class="sd">        in the view pipeline. If the deriver should be placed elsewhere in the</span>
<span class="sd">        pipeline, such as above ``decorated_view``, then you MUST also specify</span>
<span class="sd">        ``under`` to something earlier in the order, or a</span>
<span class="sd">        ``CyclicDependencyError`` will be raised when trying to sort the</span>
<span class="sd">        derivers.</span>

<span class="sd">        See :ref:`view_derivers` for more information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deriver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">deriver</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">deriver</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">INGRESS</span><span class="p">,</span> <span class="n">VIEW</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is a reserved view deriver name&#39;</span>
                                     <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">under</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">under</span> <span class="o">=</span> <span class="s1">&#39;decorated_view&#39;</span>

        <span class="k">if</span> <span class="n">over</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">over</span> <span class="o">=</span> <span class="s1">&#39;rendered_view&#39;</span>

        <span class="n">over</span> <span class="o">=</span> <span class="n">as_sorted_tuple</span><span class="p">(</span><span class="n">over</span><span class="p">)</span>
        <span class="n">under</span> <span class="o">=</span> <span class="n">as_sorted_tuple</span><span class="p">(</span><span class="n">under</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">INGRESS</span> <span class="ow">in</span> <span class="n">over</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> cannot be over INGRESS&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># ensure everything is always over mapped_view</span>
        <span class="k">if</span> <span class="n">VIEW</span> <span class="ow">in</span> <span class="n">over</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;mapped_view&#39;</span><span class="p">:</span>
            <span class="n">over</span> <span class="o">=</span> <span class="n">as_sorted_tuple</span><span class="p">(</span><span class="n">over</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;mapped_view&#39;</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">VIEW</span> <span class="ow">in</span> <span class="n">under</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> cannot be under VIEW&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mapped_view&#39;</span> <span class="ow">in</span> <span class="n">under</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> cannot be under &quot;mapped_view&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">discriminator</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;view deriver&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span>
            <span class="s1">&#39;view derivers&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;view deriver&#39;</span><span class="p">)</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;deriver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deriver</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;under&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">under</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;over&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">over</span>
        <span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
            <span class="n">derivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IViewDerivers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">derivers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">derivers</span> <span class="o">=</span> <span class="n">TopologicalSorter</span><span class="p">(</span>
                    <span class="n">default_before</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">default_after</span><span class="o">=</span><span class="n">INGRESS</span><span class="p">,</span>
                    <span class="n">first</span><span class="o">=</span><span class="n">INGRESS</span><span class="p">,</span>
                    <span class="n">last</span><span class="o">=</span><span class="n">VIEW</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">derivers</span><span class="p">,</span> <span class="n">IViewDerivers</span><span class="p">)</span>
            <span class="n">derivers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deriver</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">over</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">under</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">introspectables</span><span class="o">=</span><span class="p">(</span><span class="n">intr</span><span class="p">,),</span>
                    <span class="n">order</span><span class="o">=</span><span class="n">PHASE1_CONFIG</span><span class="p">)</span> <span class="c1"># must be registered before add_view</span>

    <span class="k">def</span> <span class="nf">add_default_view_derivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">pyramid</span><span class="o">.</span><span class="n">viewderivers</span>
        <span class="n">derivers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;secured_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">secured_view</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;owrapped_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">owrapped_view</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;http_cached_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">http_cached_view</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;decorated_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">decorated_view</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;rendered_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">rendered_view</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;mapped_view&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">mapped_view</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">INGRESS</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">deriver</span> <span class="ow">in</span> <span class="n">derivers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_view_deriver</span><span class="p">(</span>
                <span class="n">deriver</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">under</span><span class="o">=</span><span class="n">last</span><span class="p">,</span>
                <span class="n">over</span><span class="o">=</span><span class="n">VIEW</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># leave the csrf_view loosely coupled to the rest of the pipeline</span>
        <span class="c1"># by ensuring nothing in the default pipeline depends on the order</span>
        <span class="c1"># of the csrf_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_view_deriver</span><span class="p">(</span>
            <span class="n">d</span><span class="o">.</span><span class="n">csrf_view</span><span class="p">,</span>
            <span class="s1">&#39;csrf_view&#39;</span><span class="p">,</span>
            <span class="n">under</span><span class="o">=</span><span class="s1">&#39;secured_view&#39;</span><span class="p">,</span>
            <span class="n">over</span><span class="o">=</span><span class="s1">&#39;owrapped_view&#39;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">derive_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a :term:`view callable` using the function, instance,</span>
<span class="sd">        or class (or :term:`dotted Python name` referring to the same)</span>
<span class="sd">        provided as ``view`` object.</span>

<span class="sd">        .. warning::</span>

<span class="sd">           This method is typically only used by :app:`Pyramid` framework</span>
<span class="sd">           extension authors, not by :app:`Pyramid` application developers.</span>

<span class="sd">        This is API is useful to framework extenders who create</span>
<span class="sd">        pluggable systems which need to register &#39;proxy&#39; view</span>
<span class="sd">        callables for functions, instances, or classes which meet the</span>
<span class="sd">        requirements of being a :app:`Pyramid` view callable.  For</span>
<span class="sd">        example, a ``some_other_framework`` function in another</span>
<span class="sd">        framework may want to allow a user to supply a view callable,</span>
<span class="sd">        but he may want to wrap the view callable in his own before</span>
<span class="sd">        registering the wrapper as a :app:`Pyramid` view callable.</span>
<span class="sd">        Because a :app:`Pyramid` view callable can be any of a</span>
<span class="sd">        number of valid objects, the framework extender will not know</span>
<span class="sd">        how to call the user-supplied object.  Running it through</span>
<span class="sd">        ``derive_view`` normalizes it to a callable which accepts two</span>
<span class="sd">        arguments: ``context`` and ``request``.</span>

<span class="sd">        For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           def some_other_framework(user_supplied_view):</span>
<span class="sd">               config = Configurator(reg)</span>
<span class="sd">               proxy_view = config.derive_view(user_supplied_view)</span>
<span class="sd">               def my_wrapper(context, request):</span>
<span class="sd">                   do_something_that_mutates(request)</span>
<span class="sd">                   return proxy_view(context, request)</span>
<span class="sd">               config.add_view(my_wrapper)</span>

<span class="sd">        The ``view`` object provided should be one of the following:</span>

<span class="sd">        - A function or another non-class callable object that accepts</span>
<span class="sd">          a :term:`request` as a single positional argument and which</span>
<span class="sd">          returns a :term:`response` object.</span>

<span class="sd">        - A function or other non-class callable object that accepts</span>
<span class="sd">          two positional arguments, ``context, request`` and which</span>
<span class="sd">          returns a :term:`response` object.</span>

<span class="sd">        - A class which accepts a single positional argument in its</span>
<span class="sd">          constructor named ``request``, and which has a ``__call__``</span>
<span class="sd">          method that accepts no arguments that returns a</span>
<span class="sd">          :term:`response` object.</span>

<span class="sd">        - A class which accepts two positional arguments named</span>
<span class="sd">          ``context, request``, and which has a ``__call__`` method</span>
<span class="sd">          that accepts no arguments that returns a :term:`response`</span>
<span class="sd">          object.</span>

<span class="sd">        - A :term:`dotted Python name` which refers to any of the</span>
<span class="sd">          kinds of objects above.</span>

<span class="sd">        This API returns a callable which accepts the arguments</span>
<span class="sd">        ``context, request`` and which returns the result of calling</span>
<span class="sd">        the provided ``view`` object.</span>

<span class="sd">        The ``attr`` keyword argument is most useful when the view</span>
<span class="sd">        object is a class.  It names the method that should be used as</span>
<span class="sd">        the callable.  If ``attr`` is not provided, the attribute</span>
<span class="sd">        effectively defaults to ``__call__``.  See</span>
<span class="sd">        :ref:`class_as_view` for more information.</span>

<span class="sd">        The ``renderer`` keyword argument should be a renderer</span>
<span class="sd">        name. If supplied, it will cause the returned callable to use</span>
<span class="sd">        a :term:`renderer` to convert the user-supplied view result to</span>
<span class="sd">        a :term:`response` object.  If a ``renderer`` argument is not</span>
<span class="sd">        supplied, the user-supplied view must itself return a</span>
<span class="sd">        :term:`response` object.  &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">)</span>

    <span class="c1"># b/w compat</span>
    <span class="k">def</span> <span class="nf">_derive_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predicates</span><span class="o">=</span><span class="p">(),</span>
                     <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrapper_viewname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">viewname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">MAX_ORDER</span><span class="p">,</span>
                     <span class="n">phash</span><span class="o">=</span><span class="n">DEFAULT_PHASH</span><span class="p">,</span> <span class="n">decorator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">http_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">require_csrf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exception_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">extra_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="n">renderers</span><span class="o">.</span><span class="n">RendererHelper</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># use default renderer if one exists</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IRendererFactory</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">renderer</span> <span class="o">=</span> <span class="n">renderers</span><span class="o">.</span><span class="n">RendererHelper</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
                    <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">permission</span><span class="o">=</span><span class="n">permission</span><span class="p">,</span>
            <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span>
            <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
            <span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper_viewname</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">viewname</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
            <span class="n">decorator</span><span class="o">=</span><span class="n">decorator</span><span class="p">,</span>
            <span class="n">http_cache</span><span class="o">=</span><span class="n">http_cache</span><span class="p">,</span>
            <span class="n">require_csrf</span><span class="o">=</span><span class="n">require_csrf</span><span class="p">,</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_options</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_options</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">ViewDeriverInfo</span><span class="p">(</span>
            <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span>
            <span class="n">predicates</span><span class="o">=</span><span class="n">predicates</span><span class="p">,</span>
            <span class="n">exception_only</span><span class="o">=</span><span class="n">exception_only</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># order and phash are only necessary for the predicated view and</span>
        <span class="c1"># are not really view deriver options</span>
        <span class="n">info</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="n">info</span><span class="o">.</span><span class="n">phash</span> <span class="o">=</span> <span class="n">phash</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_view_derivers</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="nd">@viewdefaults</span>
    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_forbidden_view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">renderer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wrapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">route_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">containment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xhr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">path_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_predicates</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">decorator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">match_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">view_options</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a forbidden view to the current configuration state.  The</span>
<span class="sd">        view will be called when Pyramid or application code raises a</span>
<span class="sd">        :exc:`pyramid.httpexceptions.HTTPForbidden` exception and the set of</span>
<span class="sd">        circumstances implied by the predicates provided are matched.  The</span>
<span class="sd">        simplest example is:</span>

<span class="sd">          .. code-block:: python</span>

<span class="sd">            def forbidden(request):</span>
<span class="sd">                return Response(&#39;Forbidden&#39;, status=&#39;403 Forbidden&#39;)</span>

<span class="sd">            config.add_forbidden_view(forbidden)</span>

<span class="sd">        If ``view`` argument is not provided, the view callable defaults to</span>
<span class="sd">        :func:`~pyramid.httpexceptions.default_exceptionresponse_view`.</span>

<span class="sd">        All arguments have the same meaning as</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view` and each predicate</span>
<span class="sd">        argument restricts the set of circumstances under which this forbidden</span>
<span class="sd">        view will be invoked.  Unlike</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view`, this method will raise</span>
<span class="sd">        an exception if passed ``name``, ``permission``, ``require_csrf``,</span>
<span class="sd">        ``context``, ``for_``, or ``exception_only`` keyword arguments. These</span>
<span class="sd">        argument values make no sense in the context of a forbidden</span>
<span class="sd">        :term:`exception view`.</span>

<span class="sd">        .. versionadded:: 1.3</span>

<span class="sd">        .. versionchanged:: 1.8</span>

<span class="sd">           The view is created using ``exception_only=True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;for_&#39;</span><span class="p">,</span> <span class="s1">&#39;require_csrf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;exception_only&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">view_options</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> may not be used as an argument to add_forbidden_view&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">default_exceptionresponse_view</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">HTTPForbidden</span><span class="p">,</span>
            <span class="n">exception_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper</span><span class="p">,</span>
            <span class="n">request_type</span><span class="o">=</span><span class="n">request_type</span><span class="p">,</span>
            <span class="n">request_method</span><span class="o">=</span><span class="n">request_method</span><span class="p">,</span>
            <span class="n">request_param</span><span class="o">=</span><span class="n">request_param</span><span class="p">,</span>
            <span class="n">containment</span><span class="o">=</span><span class="n">containment</span><span class="p">,</span>
            <span class="n">xhr</span><span class="o">=</span><span class="n">xhr</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">path_info</span><span class="o">=</span><span class="n">path_info</span><span class="p">,</span>
            <span class="n">custom_predicates</span><span class="o">=</span><span class="n">custom_predicates</span><span class="p">,</span>
            <span class="n">decorator</span><span class="o">=</span><span class="n">decorator</span><span class="p">,</span>
            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
            <span class="n">match_param</span><span class="o">=</span><span class="n">match_param</span><span class="p">,</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">,</span>
            <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">,</span>
            <span class="n">require_csrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span>
            <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">view_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">set_forbidden_view</span> <span class="o">=</span> <span class="n">add_forbidden_view</span> <span class="c1"># deprecated sorta-bw-compat alias</span>

    <span class="nd">@viewdefaults</span>
    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_notfound_view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">renderer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wrapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">route_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">request_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">containment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xhr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accept</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">path_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_predicates</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">decorator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">match_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">append_slash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">view_options</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a default :term:`Not Found View` to the current configuration</span>
<span class="sd">        state. The view will be called when Pyramid or application code raises</span>
<span class="sd">        an :exc:`pyramid.httpexceptions.HTTPNotFound` exception (e.g., when a</span>
<span class="sd">        view cannot be found for the request).  The simplest example is:</span>

<span class="sd">          .. code-block:: python</span>

<span class="sd">            def notfound(request):</span>
<span class="sd">                return Response(&#39;Not Found&#39;, status=&#39;404 Not Found&#39;)</span>

<span class="sd">            config.add_notfound_view(notfound)</span>

<span class="sd">        If ``view`` argument is not provided, the view callable defaults to</span>
<span class="sd">        :func:`~pyramid.httpexceptions.default_exceptionresponse_view`.</span>

<span class="sd">        All arguments except ``append_slash`` have the same meaning as</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view` and each predicate</span>
<span class="sd">        argument restricts the set of circumstances under which this notfound</span>
<span class="sd">        view will be invoked.  Unlike</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view`, this method will raise</span>
<span class="sd">        an exception if passed ``name``, ``permission``, ``require_csrf``,</span>
<span class="sd">        ``context``, ``for_``, or ``exception_only`` keyword arguments. These</span>
<span class="sd">        argument values make no sense in the context of a Not Found View.</span>

<span class="sd">        If ``append_slash`` is ``True``, when this Not Found View is invoked,</span>
<span class="sd">        and the current path info does not end in a slash, the notfound logic</span>
<span class="sd">        will attempt to find a :term:`route` that matches the request&#39;s path</span>
<span class="sd">        info suffixed with a slash.  If such a route exists, Pyramid will</span>
<span class="sd">        issue a redirect to the URL implied by the route; if it does not,</span>
<span class="sd">        Pyramid will return the result of the view callable provided as</span>
<span class="sd">        ``view``, as normal.</span>

<span class="sd">        If the argument provided as ``append_slash`` is not a boolean but</span>
<span class="sd">        instead implements :class:`~pyramid.interfaces.IResponse`, the</span>
<span class="sd">        append_slash logic will behave as if ``append_slash=True`` was passed,</span>
<span class="sd">        but the provided class will be used as the response class instead of</span>
<span class="sd">        the default :class:`~pyramid.httpexceptions.HTTPFound` response class</span>
<span class="sd">        when a redirect is performed.  For example:</span>

<span class="sd">          .. code-block:: python</span>

<span class="sd">            from pyramid.httpexceptions import HTTPMovedPermanently</span>
<span class="sd">            config.add_notfound_view(append_slash=HTTPMovedPermanently)</span>

<span class="sd">        The above means that a redirect to a slash-appended route will be</span>
<span class="sd">        attempted, but instead of :class:`~pyramid.httpexceptions.HTTPFound`</span>
<span class="sd">        being used, :class:`~pyramid.httpexceptions.HTTPMovedPermanently will</span>
<span class="sd">        be used` for the redirect response if a slash-appended route is found.</span>

<span class="sd">        .. versionadded:: 1.3</span>

<span class="sd">        .. versionchanged:: 1.6</span>

<span class="sd">           The ``append_slash`` argument was modified to allow any object that</span>
<span class="sd">           implements the ``IResponse`` interface to specify the response class</span>
<span class="sd">           used when a redirect is performed.</span>

<span class="sd">        .. versionchanged:: 1.8</span>

<span class="sd">           The view is created using ``exception_only=True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;for_&#39;</span><span class="p">,</span> <span class="s1">&#39;require_csrf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;exception_only&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">view_options</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> may not be used as an argument to add_notfound_view&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">default_exceptionresponse_view</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">HTTPNotFound</span><span class="p">,</span>
            <span class="n">exception_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper</span><span class="p">,</span>
            <span class="n">request_type</span><span class="o">=</span><span class="n">request_type</span><span class="p">,</span>
            <span class="n">request_method</span><span class="o">=</span><span class="n">request_method</span><span class="p">,</span>
            <span class="n">request_param</span><span class="o">=</span><span class="n">request_param</span><span class="p">,</span>
            <span class="n">containment</span><span class="o">=</span><span class="n">containment</span><span class="p">,</span>
            <span class="n">xhr</span><span class="o">=</span><span class="n">xhr</span><span class="p">,</span>
            <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">path_info</span><span class="o">=</span><span class="n">path_info</span><span class="p">,</span>
            <span class="n">custom_predicates</span><span class="o">=</span><span class="n">custom_predicates</span><span class="p">,</span>
            <span class="n">decorator</span><span class="o">=</span><span class="n">decorator</span><span class="p">,</span>
            <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
            <span class="n">match_param</span><span class="o">=</span><span class="n">match_param</span><span class="p">,</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">,</span>
            <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">,</span>
            <span class="n">require_csrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">view_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append_slash</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">IResponse</span><span class="o">.</span><span class="n">implementedBy</span><span class="p">(</span><span class="n">append_slash</span><span class="p">):</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">AppendSlashNotFoundViewFactory</span><span class="p">(</span>
                    <span class="n">view</span><span class="p">,</span> <span class="n">redirect_class</span><span class="o">=</span><span class="n">append_slash</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">AppendSlashNotFoundViewFactory</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;renderer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renderer</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">set_notfound_view</span> <span class="o">=</span> <span class="n">add_notfound_view</span> <span class="c1"># deprecated sorta-bw-compat alias</span>

    <span class="nd">@viewdefaults</span>
    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_exception_view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># force all other arguments to be specified as key=value</span>
        <span class="o">**</span><span class="n">view_options</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add an :term:`exception view` for the specified ``exception`` to</span>
<span class="sd">        the current configuration state. The view will be called when Pyramid</span>
<span class="sd">        or application code raises the given exception.</span>

<span class="sd">        This method accepts almost all of the same arguments as</span>
<span class="sd">        :meth:`pyramid.config.Configurator.add_view` except for ``name``,</span>
<span class="sd">        ``permission``, ``for_``, ``require_csrf``, and ``exception_only``.</span>

<span class="sd">        By default, this method will set ``context=Exception``, thus</span>
<span class="sd">        registering for most default Python exceptions. Any subclass of</span>
<span class="sd">        ``Exception`` may be specified.</span>

<span class="sd">        .. versionadded:: 1.8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;for_&#39;</span><span class="p">,</span> <span class="s1">&#39;exception_only&#39;</span><span class="p">,</span> <span class="s1">&#39;require_csrf&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">view_options</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> may not be used as an argument to add_exception_view&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="ne">Exception</span>
        <span class="n">view_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">exception_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">,</span>
            <span class="n">require_csrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="o">**</span><span class="n">view_options</span><span class="p">)</span>

    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">set_view_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setting a :term:`view mapper` makes it possible to make use of</span>
<span class="sd">        :term:`view callable` objects which implement different call</span>
<span class="sd">        signatures than the ones supported by :app:`Pyramid` as described in</span>
<span class="sd">        its narrative documentation.</span>

<span class="sd">        The ``mapper`` argument should be an object implementing</span>
<span class="sd">        :class:`pyramid.interfaces.IViewMapperFactory` or a :term:`dotted</span>
<span class="sd">        Python name` to such an object.  The provided ``mapper`` will become</span>
<span class="sd">        the default view mapper to be used by all subsequent :term:`view</span>
<span class="sd">        configuration` registrations.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            See also :ref:`using_a_view_mapper`.</span>

<span class="sd">        .. note::</span>

<span class="sd">           Using the ``default_view_mapper`` argument to the</span>
<span class="sd">           :class:`pyramid.config.Configurator` constructor</span>
<span class="sd">           can be used to achieve the same purpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_dotted</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">IViewMapperFactory</span><span class="p">)</span>
        <span class="c1"># IViewMapperFactory is looked up as the result of view config</span>
        <span class="c1"># in phase 3</span>
        <span class="n">intr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span><span class="s1">&#39;view mappers&#39;</span><span class="p">,</span>
                                   <span class="n">IViewMapperFactory</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">object_description</span><span class="p">(</span><span class="n">mapper</span><span class="p">),</span>
                                   <span class="s1">&#39;default view mapper&#39;</span><span class="p">)</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;mapper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">IViewMapperFactory</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">PHASE1_CONFIG</span><span class="p">,</span>
                    <span class="n">introspectables</span><span class="o">=</span><span class="p">(</span><span class="n">intr</span><span class="p">,))</span>

    <span class="nd">@action_method</span>
    <span class="k">def</span> <span class="nf">add_static_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a view used to render static assets such as images</span>
<span class="sd">        and CSS files.</span>

<span class="sd">        The ``name`` argument is a string representing an</span>
<span class="sd">        application-relative local URL prefix.  It may alternately be a full</span>
<span class="sd">        URL.</span>

<span class="sd">        The ``path`` argument is the path on disk where the static files</span>
<span class="sd">        reside.  This can be an absolute path, a package-relative path, or a</span>
<span class="sd">        :term:`asset specification`.</span>

<span class="sd">        The ``cache_max_age`` keyword argument is input to set the</span>
<span class="sd">        ``Expires`` and ``Cache-Control`` headers for static assets served.</span>
<span class="sd">        Note that this argument has no effect when the ``name`` is a *url</span>
<span class="sd">        prefix*.  By default, this argument is ``None``, meaning that no</span>
<span class="sd">        particular Expires or Cache-Control headers are set in the response.</span>

<span class="sd">        The ``permission`` keyword argument is used to specify the</span>
<span class="sd">        :term:`permission` required by a user to execute the static view.  By</span>
<span class="sd">        default, it is the string</span>
<span class="sd">        :data:`pyramid.security.NO_PERMISSION_REQUIRED`, a special sentinel</span>
<span class="sd">        which indicates that, even if a :term:`default permission` exists for</span>
<span class="sd">        the current application, the static view should be renderered to</span>
<span class="sd">        completely anonymous users.  This default value is permissive</span>
<span class="sd">        because, in most web apps, static assets seldom need protection from</span>
<span class="sd">        viewing.  If ``permission`` is specified, the security checking will</span>
<span class="sd">        be performed against the default root factory ACL.</span>

<span class="sd">        Any other keyword arguments sent to ``add_static_view`` are passed on</span>
<span class="sd">        to :meth:`pyramid.config.Configurator.add_route` (e.g. ``factory``,</span>
<span class="sd">        perhaps to define a custom factory with a custom ACL for this static</span>
<span class="sd">        view).</span>

<span class="sd">        *Usage*</span>

<span class="sd">        The ``add_static_view`` function is typically used in conjunction</span>
<span class="sd">        with the :meth:`pyramid.request.Request.static_url` method.</span>
<span class="sd">        ``add_static_view`` adds a view which renders a static asset when</span>
<span class="sd">        some URL is visited; :meth:`pyramid.request.Request.static_url`</span>
<span class="sd">        generates a URL to that asset.</span>

<span class="sd">        The ``name`` argument to ``add_static_view`` is usually a simple URL</span>
<span class="sd">        prefix (e.g. ``&#39;images&#39;``).  When this is the case, the</span>
<span class="sd">        :meth:`pyramid.request.Request.static_url` API will generate a URL</span>
<span class="sd">        which points to a Pyramid view, which will serve up a set of assets</span>
<span class="sd">        that live in the package itself. For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           add_static_view(&#39;images&#39;, &#39;mypackage:images/&#39;)</span>

<span class="sd">        Code that registers such a view can generate URLs to the view via</span>
<span class="sd">        :meth:`pyramid.request.Request.static_url`:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           request.static_url(&#39;mypackage:images/logo.png&#39;)</span>

<span class="sd">        When ``add_static_view`` is called with a ``name`` argument that</span>
<span class="sd">        represents a URL prefix, as it is above, subsequent calls to</span>
<span class="sd">        :meth:`pyramid.request.Request.static_url` with paths that start with</span>
<span class="sd">        the ``path`` argument passed to ``add_static_view`` will generate a</span>
<span class="sd">        URL something like ``http://&lt;Pyramid app URL&gt;/images/logo.png``,</span>
<span class="sd">        which will cause the ``logo.png`` file in the ``images`` subdirectory</span>
<span class="sd">        of the ``mypackage`` package to be served.</span>

<span class="sd">        ``add_static_view`` can alternately be used with a ``name`` argument</span>
<span class="sd">        which is a *URL*, causing static assets to be served from an external</span>
<span class="sd">        webserver.  This happens when the ``name`` argument is a fully</span>
<span class="sd">        qualified URL (e.g. starts with ``http://`` or similar).  In this</span>
<span class="sd">        mode, the ``name`` is used as the prefix of the full URL when</span>
<span class="sd">        generating a URL using :meth:`pyramid.request.Request.static_url`.</span>
<span class="sd">        Furthermore, if a protocol-relative URL (e.g. ``//example.com/images``)</span>
<span class="sd">        is used as the ``name`` argument, the generated URL will use the</span>
<span class="sd">        protocol of the request (http or https, respectively).</span>

<span class="sd">        For example, if ``add_static_view`` is called like so:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           add_static_view(&#39;http://example.com/images&#39;, &#39;mypackage:images/&#39;)</span>

<span class="sd">        Subsequently, the URLs generated by</span>
<span class="sd">        :meth:`pyramid.request.Request.static_url` for that static view will</span>
<span class="sd">        be prefixed with ``http://example.com/images`` (the external webserver</span>
<span class="sd">        listening on ``example.com`` must be itself configured to respond</span>
<span class="sd">        properly to such a request.):</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           static_url(&#39;mypackage:images/logo.png&#39;, request)</span>

<span class="sd">        See :ref:`static_assets_section` for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spec</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_static_info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_cache_buster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cachebust</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a cache buster to a set of files on disk.</span>

<span class="sd">        The ``path`` should be the path on disk where the static files</span>
<span class="sd">        reside.  This can be an absolute path, a package-relative path, or a</span>
<span class="sd">        :term:`asset specification`.</span>

<span class="sd">        The ``cachebust`` argument may be set to cause</span>
<span class="sd">        :meth:`~pyramid.request.Request.static_url` to use cache busting when</span>
<span class="sd">        generating URLs. See :ref:`cache_busting` for general information</span>
<span class="sd">        about cache busting. The value of the ``cachebust`` argument must</span>
<span class="sd">        be an object which implements</span>
<span class="sd">        :class:`~pyramid.interfaces.ICacheBuster`.</span>

<span class="sd">        If ``explicit`` is set to ``True`` then the ``path`` for the cache</span>
<span class="sd">        buster will be matched based on the ``rawspec`` instead of the</span>
<span class="sd">        ``pathspec`` as defined in the</span>
<span class="sd">        :class:`~pyramid.interfaces.ICacheBuster` interface.</span>
<span class="sd">        Default: ``False``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_spec</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_static_info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">add_cache_buster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">cachebust</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="n">explicit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_static_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IStaticURLInfo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">StaticURLInfo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">IStaticURLInfo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span>

<span class="k">def</span> <span class="nf">isexception</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">IInterface</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">IException</span><span class="o">.</span><span class="n">isEqualOrExtendedBy</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)))</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">runtime_exc_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">excview</span><span class="p">):</span>
    <span class="c1"># create a view callable which can pretend to be both a normal view</span>
    <span class="c1"># and an exception view, dispatching to the appropriate one based</span>
    <span class="c1"># on the state of request.exception</span>
    <span class="k">def</span> <span class="nf">wrapper_view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">excview</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="c1"># these constants are the same between the two views</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__wraps__</span> <span class="o">=</span> <span class="n">wrapper_view</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__original_view__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__original_view__&#39;</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__accept__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__accept__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__order__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__order__&#39;</span><span class="p">,</span> <span class="n">MAX_ORDER</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__phash__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__phash__&#39;</span><span class="p">,</span> <span class="n">DEFAULT_PHASH</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__view_attr__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__view_attr__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__permission__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__permission__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrap_fn</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">selected_view</span> <span class="o">=</span> <span class="n">excview</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_view</span> <span class="o">=</span> <span class="n">view</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">selected_view</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="c1"># these methods are dynamic per-request and should dispatch to their</span>
    <span class="c1"># respective views based on whether it&#39;s an exception or not</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__call_permissive__</span> <span class="o">=</span> <span class="n">wrap_fn</span><span class="p">(</span><span class="s1">&#39;__call_permissive__&#39;</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__permitted__</span> <span class="o">=</span> <span class="n">wrap_fn</span><span class="p">(</span><span class="s1">&#39;__permitted__&#39;</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__predicated__</span> <span class="o">=</span> <span class="n">wrap_fn</span><span class="p">(</span><span class="s1">&#39;__predicated__&#39;</span><span class="p">)</span>
    <span class="n">wrapper_view</span><span class="o">.</span><span class="n">__predicates__</span> <span class="o">=</span> <span class="n">wrap_fn</span><span class="p">(</span><span class="s1">&#39;__predicates__&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper_view</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IViewDeriverInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ViewDeriverInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">view</span><span class="p">,</span>
                 <span class="n">registry</span><span class="p">,</span>
                 <span class="n">package</span><span class="p">,</span>
                 <span class="n">predicates</span><span class="p">,</span>
                 <span class="n">exception_only</span><span class="p">,</span>
                 <span class="n">options</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_view</span> <span class="o">=</span> <span class="n">view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicates</span> <span class="o">=</span> <span class="n">predicates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception_only</span> <span class="o">=</span> <span class="n">exception_only</span>

    <span class="nd">@reify</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IStaticURLInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StaticURLInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_busters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">route_name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">subpath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">WIN</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
                    <span class="n">subpath</span> <span class="o">=</span> <span class="n">subpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="c1"># windows</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_busters</span><span class="p">:</span>
                    <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bust_asset_path</span><span class="p">(</span>
                        <span class="n">request</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;subpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subpath</span>
                    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="n">route_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">app_url</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> <span class="n">parse_url_overrides</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
                    <span class="n">parsed</span> <span class="o">=</span> <span class="n">url_parse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                            <span class="n">scheme</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]))</span>
                    <span class="n">subpath</span> <span class="o">=</span> <span class="n">url_quote</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">subpath</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="n">qs</span> <span class="o">+</span> <span class="n">anchor</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No static URL definition matching </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="c1"># This feature only allows for the serving of a directory and</span>
        <span class="c1"># the files contained within, not of a single asset;</span>
        <span class="c1"># appending a slash here if the spec doesn&#39;t have one is</span>
        <span class="c1"># required for proper prefix matching done in ``generate``</span>
        <span class="c1"># (``subpath = path[len(spec):]``).</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span> <span class="c1"># FBO windows</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">+</span> <span class="n">sep</span>

        <span class="c1"># we also make sure the name ends with a slash, purely as a</span>
        <span class="c1"># convenience: a name that is a url is required to end in a</span>
        <span class="c1"># slash, so that ``urljoin(name, subpath))`` will work above</span>
        <span class="c1"># when the name is a URL, and it doesn&#39;t hurt things for it to</span>
        <span class="c1"># have a name that ends in a slash if it&#39;s used as a route</span>
        <span class="c1"># name instead of a URL.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="c1"># make sure it ends with a slash</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="n">url_parse</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
            <span class="c1"># it&#39;s a URL</span>
            <span class="c1"># url, spec, route_name</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">route_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it&#39;s a view name</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cache_max_age</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cache_max_age&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># create a view</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">static_view</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="n">cache_max_age</span><span class="p">,</span>
                               <span class="n">use_subpath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Mutate extra to allow factory, etc to be passed through here.</span>
            <span class="c1"># Treat permission specially because we&#39;d like to default to</span>
            <span class="c1"># permissiveness (see docs of config.add_static_view).</span>
            <span class="n">permission</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">permission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">permission</span> <span class="o">=</span> <span class="n">NO_PERMISSION_REQUIRED</span>

            <span class="n">context</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;for_&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">renderer</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;renderer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># register a route using the computed view, permission, and</span>
            <span class="c1"># pattern, plus any extras passed to us via add_static_view</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*subpath&quot;</span> <span class="o">%</span> <span class="n">name</span> <span class="c1"># name already ends with slash</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">route_prefix</span><span class="p">:</span>
                <span class="n">route_name</span> <span class="o">=</span> <span class="s1">&#39;__</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">route_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">route_name</span> <span class="o">=</span> <span class="s1">&#39;__</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="n">route_name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span>
                <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">,</span>
                <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
                <span class="n">permission</span><span class="o">=</span><span class="n">permission</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
            <span class="n">registrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registrations</span>

            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">registrations</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">registrations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="c1"># url, spec, route_name</span>
            <span class="n">registrations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">route_name</span><span class="p">))</span>

        <span class="n">intr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span><span class="s1">&#39;static views&#39;</span><span class="p">,</span>
                                     <span class="n">name</span><span class="p">,</span>
                                     <span class="s1">&#39;static view for </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                     <span class="s1">&#39;static view&#39;</span><span class="p">)</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

        <span class="n">config</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callable</span><span class="o">=</span><span class="n">register</span><span class="p">,</span> <span class="n">introspectables</span><span class="o">=</span><span class="p">(</span><span class="n">intr</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">add_cache_buster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">cachebust</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># ensure the spec always has a trailing slash as we only support</span>
        <span class="c1"># adding cache busters to folders, not files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span> <span class="c1"># FBO windows</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">+</span> <span class="n">sep</span>

        <span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pyramid.prevent_cachebust&#39;</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">cache_busters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_busters</span>

            <span class="c1"># find duplicate cache buster (old_idx)</span>
            <span class="c1"># and insertion location (new_idx)</span>
            <span class="n">new_idx</span><span class="p">,</span> <span class="n">old_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_busters</span><span class="p">),</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_</span><span class="p">,</span> <span class="n">cb_</span><span class="p">,</span> <span class="n">explicit_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cache_busters</span><span class="p">):</span>
                <span class="c1"># if we find an identical (spec, explicit) then use it</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="n">spec_</span> <span class="ow">and</span> <span class="n">explicit</span> <span class="o">==</span> <span class="n">explicit_</span><span class="p">:</span>
                    <span class="n">old_idx</span> <span class="o">=</span> <span class="n">new_idx</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">break</span>

                <span class="c1"># past all explicit==False specs then add to the end</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">explicit</span> <span class="ow">and</span> <span class="n">explicit_</span><span class="p">:</span>
                    <span class="n">new_idx</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">break</span>

                <span class="c1"># explicit matches and spec is shorter</span>
                <span class="k">elif</span> <span class="n">explicit</span> <span class="o">==</span> <span class="n">explicit_</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_</span><span class="p">):</span>
                    <span class="n">new_idx</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">old_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cache_busters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_idx</span><span class="p">)</span>

            <span class="n">cache_busters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">new_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">cachebust</span><span class="p">,</span> <span class="n">explicit</span><span class="p">))</span>

        <span class="n">intr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">introspectable</span><span class="p">(</span><span class="s1">&#39;cache busters&#39;</span><span class="p">,</span>
                                     <span class="n">spec</span><span class="p">,</span>
                                     <span class="s1">&#39;cache buster for </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spec</span><span class="p">,</span>
                                     <span class="s1">&#39;cache buster&#39;</span><span class="p">)</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;cachebust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cachebust</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">intr</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">explicit</span>

        <span class="n">config</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callable</span><span class="o">=</span><span class="n">register</span><span class="p">,</span> <span class="n">introspectables</span><span class="o">=</span><span class="p">(</span><span class="n">intr</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_bust_asset_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span>
        <span class="n">pkg_name</span><span class="p">,</span> <span class="n">pkg_subpath</span> <span class="o">=</span> <span class="n">resolve_asset_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">rawspec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pathspec</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">pkg_subpath</span><span class="p">,</span> <span class="n">subpath</span><span class="p">)</span>
            <span class="n">overrides</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IPackageOverrides</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">resource_name</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg_subpath</span><span class="p">,</span> <span class="n">subpath</span><span class="p">)</span>
                <span class="n">sources</span> <span class="o">=</span> <span class="n">overrides</span><span class="o">.</span><span class="n">filtered_sources</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">filtered_path</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                    <span class="n">rawspec</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">filtered_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;pkg_name&#39;</span><span class="p">):</span>
                        <span class="n">rawspec</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">,</span> <span class="n">rawspec</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathspec</span> <span class="o">=</span> <span class="n">pkg_subpath</span> <span class="o">+</span> <span class="n">subpath</span>

        <span class="k">if</span> <span class="n">rawspec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rawspec</span> <span class="o">=</span> <span class="n">pathspec</span>

        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;pathspec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathspec</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;rawspec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rawspec</span>
        <span class="k">for</span> <span class="n">spec_</span><span class="p">,</span> <span class="n">cachebust</span><span class="p">,</span> <span class="n">explicit</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_busters</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">explicit</span> <span class="ow">and</span> <span class="n">rawspec</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">spec_</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">explicit</span> <span class="ow">and</span> <span class="n">pathspec</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">spec_</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">cachebust</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">subpath</span><span class="p">,</span> <span class="n">kw</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >モジュールコード</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../config.html" >pyramid.config</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 27, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>