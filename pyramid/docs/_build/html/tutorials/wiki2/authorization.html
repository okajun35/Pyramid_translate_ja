
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>(機械翻訳)承認を追加する &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="(機械翻訳)テストの追加" href="tests.html" />
    <link rel="prev" title="(機械翻訳)認証の追加" href="authentication.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="tests.html" title="(機械翻訳)テストの追加"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="(機械翻訳)認証の追加"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-authorization">
<span id="wiki2-adding-authorization"></span><h1>(機械翻訳)承認を追加する<a class="headerlink" href="#adding-authorization" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>オブジェクトを使っていくつかの明示的な <a class="reference internal" href="../../glossary.html#term-authorization"><span class="xref std std-term">authorization</span></a> チェックを実行しました。これは多くのアプリケーションでうまくいきますが、app:<cite>Pyramid</cite> は、これをクリーンアップし、ビュー関数自体から制約を切り離すためのいくつかの機能を提供します。 <a class="reference internal" href="../../glossary.html#term-authorization"><span class="xref std std-term">authorization</span></a></p>
<p>次の手順でアクセス制御を実装します。</p>
<ul class="simple">
<li><a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> を更新して <a class="reference internal" href="../../glossary.html#term-userid"><span class="xref std std-term">userid</span></a> を以下のリストに分解してください <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principals</span></a> <cite>(</cite> <cite>security.py`</cite>)です。</li>
<li>ユーザ、リソース、権限( `` security.py``)をマッピングするための:<a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> を定義してください。</li>
<li>Wikiページ( `` routes.py``)の <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> として使用されるnew <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> 定義を追加します。</li>
<li>Add an <a class="reference internal" href="../../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> to each resource (<code class="docutils literal notranslate"><span class="pre">routes.py</span></code>).</li>
<li>ビューのインラインチェックを <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> 宣言(` <cite>views/default.py`</cite>)に置き換えてください。</li>
</ul>
<div class="section" id="add-user-principals">
<h2>ユーザープリンシパルを追加する<a class="headerlink" href="#add-user-principals" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> は、ユーザの能力、役割、または一般化が容易な他の識別子に関してユーザを記述する raw <a class="reference internal" href="../../glossary.html#term-userid"><span class="xref std std-term">userid</span></a> の上に抽象化のレベルです。関連する正確なユーザーに焦点を当てることなく、プリンシパルに対してアクセス許可が書き込まれます。</p>
<p><span>Pyramid</span>  <a class="reference internal" href="../../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pyramid.security.Everyone</span></code></a> と <code class="xref py py-attr docutils literal notranslate"><span class="pre">pyramid.Authenticated</span></code></p>
<p>`` tutorial/security.py``ファイルを開き、以下のように編集してください:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">Authenticated</span><span class="p">,</span>
</span><span class="hll">    <span class="n">Everyone</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span> <span class="nc">MyAuthenticationPolicy</span><span class="p">(</span><span class="n">AuthTktAuthenticationPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>

<span class="hll">    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class="hll">        <span class="n">principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
</span><span class="hll">        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Authenticated</span><span class="p">)</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span class="hll">            <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;role:&#39;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">principals</span>
</span>
<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">unauthenticated_userid</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">MyAuthenticationPolicy</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth.secret&#39;</span><span class="p">],</span>
        <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>強調表示された行だけを追加する必要があります。</p>
<p>役割は `` User`` オブジェクトから来ていることに注意してください。その正確なユーザが自分が作成したページを編集できるようにするために、 `` user.id`` をプリンシパルとして追加します。</p>
</div>
<div class="section" id="add-the-authorization-policy">
<h2>承認ポリシーを追加する<a class="headerlink" href="#add-the-authorization-policy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>前の章で <a class="reference internal" href="../../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> を追加しました <span>Pyramid</span> は <a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> を追加するときに必要です。しかし、それはどこにも使われていなかったので、ここで言及します。</p>
<p>ファイル `` tutorial/security.py``には、次の行があります。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>私たちは <a class="reference internal" href="../../api/authorization.html#pyramid.authorization.ACLAuthorizationPolicy" title="pyramid.authorization.ACLAuthorizationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.authorization.ACLAuthorizationPolicy</span></code></a> を使っています。これは、ほとんどのアプリケーションで十分です。 <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> を使用して、<code class="docutils literal notranslate"><span class="pre">__acl__</span></code> を介して現在のリクエストに対して <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> と  <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> の間のマッピングを定義します。</p>
</div>
<div class="section" id="add-resources-and-acls">
<h2>リソースとACLを追加する<a class="headerlink" href="#add-resources-and-acls" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>リソースは app:<cite>Pyramid</cite> の隠された宝石です。あなたはそれを作った!</p>
<p>WebアプリケーションのすべてのURLは <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> (Uniform Resource Locatorの「R」)を表します。多くの場合、リソースはデータ・モデル内のものですが、多くのモデルで抽象化することもできます。</p>
<p>私たちのwikiには2つのリソースがあります:</p>
<ol class="arabic simple">
<li>`` NewPage``です。存在しない潜在的な `` Page``を表します。 `` basic``または `` editor``の役割を持つログインしているユーザは、ページを作成できます。</li>
<li>`` PageResource``です。表示または編集される「ページ」を表します。 `` Page``の編集者は、 `` PageResource``を編集することができます。誰でもそれを見ることができます。</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">wikiデータモデルは、単純に `` PageResource``が `` models.Page``のSQLAlchemyクラスと重複しているほど簡単です。これらを1つのクラスにまとめることは完全に有効です。しかし、このチュートリアルでは、app:<cite>Pyramid</cite> がアプリケーション定義のオブジェクトと何を区別しているのかを明確に区別するために明示的に区切られています。</p>
</div>
<p>これらのリソースを定義するには多くの方法があり、階層構造のコレクションにグループ化することもできます。しかし、ここでは簡単にしています!</p>
<p><code class="docutils literal notranslate"><span class="pre">tutorial/routes.py</span></code> ファイルを開き、以下の行を編集してください:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">HTTPNotFound</span><span class="p">,</span>
</span><span class="hll">    <span class="n">HTTPFound</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">Allow</span><span class="p">,</span>
</span><span class="hll">    <span class="n">Everyone</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Page</span>
</span><span class="hll">
</span><span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}/edit_page&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">def</span> <span class="nf">new_page_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">NewPage</span><span class="p">(</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">class</span> <span class="nc">NewPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagename</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">pagename</span> <span class="o">=</span> <span class="n">pagename</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:basic&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span><span class="hll">
</span><span class="hll"><span class="k">def</span> <span class="nf">page_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPNotFound</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">PageResource</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="k">class</span> <span class="nc">PageResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">creator_id</span><span class="p">),</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>強調表示された行を編集または追加する必要があります。</p>
<p><code class="docutils literal notranslate"><span class="pre">NewPage</span></code> クラスには、 <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> から <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> までのマッピングのリストを返す __acl__ があります。これは who が何をできるかを定義します <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> 。私たちの場合、 role:editor または role:basic のいずれかのプリンシパルを持つユーザのみが create パーミッションを持つことを許可します:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pagename</span> <span class="o">=</span> <span class="n">pagename</span>

<span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:basic&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>`` NewPage`` は <code class="docutils literal notranslate"><span class="pre">add_page</span></code> ルートの <span class="xref std std-term">context`としてロードされ、ルート上に ``factory`</span> が宣言されます:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>`` PageResource``クラスは `` Page``のための <a class="reference internal" href="../../glossary.html#term-acl"><span class="xref std std-term">ACL</span></a> を定義します。実際の `` Page``オブジェクトを使って*誰がページに何を*できるかを決定します。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PageResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span>

<span class="hll">    <span class="k">def</span> <span class="nf">__acl__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s1">&#39;role:editor&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">            <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">creator_id</span><span class="p">),</span> <span class="s1">&#39;edit&#39;</span><span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">PageResource</span></code> は <code class="docutils literal notranslate"><span class="pre">view_page</span></code> と ` edit_page`` ルートの <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> としてロードされ、ルート上に <code class="docutils literal notranslate"><span class="pre">factory</span></code> が宣言されます:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">,</span>
                     <span class="n">factory</span><span class="o">=</span><span class="n">new_page_factory</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}/edit_page&#39;</span><span class="p">,</span>
</span><span class="hll">                     <span class="n">factory</span><span class="o">=</span><span class="n">page_factory</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add-view-permissions">
<h2>表示権限を追加する<a class="headerlink" href="#add-view-permissions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>現時点では、実際の <code class="docutils literal notranslate"><span class="pre">Page</span></code> モデルを <code class="docutils literal notranslate"><span class="pre">page_factory</span></code> に含めて、 <code class="docutils literal notranslate"><span class="pre">PageResource</span></code> を読み込むようにアプリケーションを修正しました。 `` PageResource`` はすべての <code class="docutils literal notranslate"><span class="pre">view_page</span></code> と <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューの <a class="reference internal" href="../../glossary.html#term-context"><span class="xref std std-term">context</span></a> です。同様に <code class="docutils literal notranslate"><span class="pre">NewPage</span></code> は <code class="docutils literal notranslate"><span class="pre">add_page</span></code> ビューのコンテキストになります。</p>
<p>`` tutorial/views/default.py``ファイルを開きます。</p>
<p>まず、不要になったインポートをいくつか削除できます。</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
</span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">view_page</span></code> ビューを編集して <code class="docutils literal notranslate"><span class="pre">view</span></code> パーミッションを宣言し、ビュー内の明示的なチェックを削除してください:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
</span>
    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
</pre></div>
</td></tr></table></div>
<p>ページを読み込む作業はすでに工場で行われているので、 <code class="docutils literal notranslate"><span class="pre">pageResource</span></code> から <code class="docutils literal notranslate"><span class="pre">page.</span></code> オブジェクトを取り出し、 <code class="docutils literal notranslate"><span class="pre">request.context</span></code> として読み込みます。私たちの工場では、 <code class="docutils literal notranslate"><span class="pre">Page</span></code> が存在しない場合には <code class="docutils literal notranslate"><span class="pre">HTTPNotFound</span></code> 例外が発生し、ビューロジックをやはり単純化するので、 `` Page``を保証します。</p>
<p><code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューを編集して <code class="docutils literal notranslate"><span class="pre">edit</span></code> パーミッションを宣言してください:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
</span>    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">add_page</span></code> ビューを編集して <code class="docutils literal notranslate"><span class="pre">create</span></code> パーミッションを宣言してください:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pagename</span>
</span>    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</pre></div>
</td></tr></table></div>
<p>ここで <code class="docutils literal notranslate"><span class="pre">pagename</span></code> は <code class="docutils literal notranslate"><span class="pre">request.matchdict</span></code> ではなくコンテキストから取り除かれていることに注意してください。工場では、実際のルートパターンを隠すために多くの作業を行っています。</p>
<p>各 <a class="reference internal" href="../../glossary.html#term-resource"><span class="xref std std-term">resource</span></a> で定義されたACLは <a class="reference internal" href="../../glossary.html#term-authorization-policy"><span class="xref std std-term">authorization policy</span></a> によって使用され <a class="reference internal" href="../../glossary.html#term-principal"><span class="xref std std-term">principal</span></a> が何らかの <a class="reference internal" href="../../glossary.html#term-permission"><span class="xref std std-term">permission</span></a> を許可されているかどうかを判断します。。このチェックが失敗した場合(たとえば、ユーザがログインしていない場合)、 <code class="docutils literal notranslate"><span class="pre">HTTPForbidden</span></code> 例外が自動的に呼び出されます。したがって、私たちはビューからそれらの例外やチェックを削除することができます。むしろ、リソースに対する操作の観点からそれらを定義しました。</p>
<p>最後の <code class="docutils literal notranslate"><span class="pre">tutorial/views/default.py</span></code> は次のようになります:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">docutils.core</span> <span class="kn">import</span> <span class="n">publish_parts</span>

<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Page</span>

<span class="c1"># regular expression used to find WikiWords</span>
<span class="n">wikiwords</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="s1">&#39;FrontPage&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>

    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">add_link</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">page</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">pagedata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">,</span>
             <span class="n">permission</span><span class="o">=</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pagename</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">pagedata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="viewing-the-application-in-a-browser">
<h2>ブラウザでのアプリケーションの表示<a class="headerlink" href="#viewing-the-application-in-a-browser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ブラウザでアプリケーションを調べることができます(  <a class="reference internal" href="installation.html#wiki2-start-the-application"><span class="std std-ref">アプリケーションを起動する(Start the application)</span></a> を参照してください)。ブラウザを起動し、次の各URLにアクセスして、結果が期待どおりであることを確認します。</p>
<ul class="simple">
<li><a class="reference external" href="http://localhost:6543/">http://localhost:6543/</a> invokes the <code class="docutils literal notranslate"><span class="pre">view_wiki</span></code> view.  This always
redirects to the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view of the <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object.  It
is executable by any user.</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage">http://localhost:6543/FrontPage</a> は <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> ページオブジェクトの <code class="docutils literal notranslate"><span class="pre">view_page</span></code> ビューを呼び出します。ユーザーが認証されていないときは右上に Login リンクがあり、認証されていない場合は Logout リンクです。</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage/edit_page">http://localhost:6543/FrontPage/edit_page</a> は、 <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> ページオブジェクトの <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューを呼び出します。 <code class="docutils literal notranslate"><span class="pre">editor</span></code> ユーザだけが実行可能です。別のユーザー(または匿名ユーザー)がそれを呼び出すと、ログインフォームが表示されます。ユーザー名 <code class="docutils literal notranslate"><span class="pre">editor</span></code> とパスワード <code class="docutils literal notranslate"><span class="pre">editor</span></code> を入力すると、編集ページのフォームが表示されます。</li>
<li><a class="reference external" href="http://localhost:6543/add_page/SomePageName">http://localhost:6543/add_page/SomePageName</a> はページの <code class="docutils literal notranslate"><span class="pre">add_page</span></code> ビューを呼び出します。ページがすでに存在する場合は、ページオブジェクトの <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューにユーザをリダイレクトします。これは、 <code class="docutils literal notranslate"><span class="pre">editor</span></code> または <code class="docutils literal notranslate"><span class="pre">basic</span></code> ユーザのいずれかによって実行可能です。別のユーザー(または匿名ユーザー)がそれを呼び出すと、ログインフォームが表示されます。ユーザ名 `` editor`` とパスワード <code class="docutils literal notranslate"><span class="pre">editor</span></code> 、またはユーザ名 <code class="docutils literal notranslate"><span class="pre">basic</span></code> とパスワード <code class="docutils literal notranslate"><span class="pre">basic</span></code> のいずれかで証明書を入力すると、編集ページのフォームが表示されます。</li>
<li><a class="reference external" href="http://localhost:6543/SomePageName">http://localhost:6543/SomePageName</a>/edit_pageは、既存のページの <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューを呼び出し、ページが存在しない場合はエラーを生成します。これは、前の手順でそのユーザがページを作成した場合、 `` basic``ユーザによって編集可能です。代わりに、 <code class="docutils literal notranslate"><span class="pre">editor</span></code> ユーザがページを作成した場合、 <code class="docutils literal notranslate"><span class="pre">basic</span></code> ユーザのログインページが表示されます。</li>
<li>ログインした後(編集やページを追加し、 <code class="docutils literal notranslate"><span class="pre">editor</span></code> の資格情報を使ってログインフォームを送信した結果)、右上に Logout というリンクが表示されます。クリックするとログアウトされ、フロントページにリダイレクトされ、右上に Login リンクが表示されます。</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">(機械翻訳)承認を追加する</a><ul>
<li><a class="reference internal" href="#add-user-principals">ユーザープリンシパルを追加する</a></li>
<li><a class="reference internal" href="#add-the-authorization-policy">承認ポリシーを追加する</a></li>
<li><a class="reference internal" href="#add-resources-and-acls">リソースとACLを追加する</a></li>
<li><a class="reference internal" href="#add-view-permissions">表示権限を追加する</a></li>
<li><a class="reference internal" href="#viewing-the-application-in-a-browser">ブラウザでのアプリケーションの表示</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="authentication.html"
                        title="前の章へ">(機械翻訳)認証の追加</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="tests.html"
                        title="次の章へ">(機械翻訳)テストの追加</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/authorization.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="tests.html" title="(機械翻訳)テストの追加"
             >次へ</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="(機械翻訳)認証の追加"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 10, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>