
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Basic Layout &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="Defining the Domain Model" href="definingmodels.html" />
    <link rel="prev" title="Installation" href="installation.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="definingmodels.html" title="Defining the Domain Model"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="basic-layout">
<span id="wiki2-basic-layout"></span><h1>Basic Layout<a class="headerlink" href="#basic-layout" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>The starter files generated by the <code class="docutils literal notranslate"><span class="pre">alchemy</span></code> cookiecutter are very basic, but
they provide a good orientation for the high-level patterns common to most
<a class="reference internal" href="../../glossary.html#term-url-dispatch"><span class="xref std std-term">URL dispatch</span></a>-based <span>Pyramid</span> projects.</p>
<div class="section" id="application-configuration-with-init-py">
<h2>Application configuration with <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code><a class="headerlink" href="#application-configuration-with-init-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A directory on disk can be turned into a Python <a class="reference internal" href="../../glossary.html#term-package"><span class="xref std std-term">package</span></a> by containing
an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file.  Even if empty, this marks a directory as a Python
package.  We use <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> both as a marker, indicating the directory in
which it's contained is a package, and to contain application configuration
code.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">tutorial/__init__.py</span></code>.  It should already contain the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.routes&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Let's go over this piece-by-piece. First we need some imports to support later
code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>


</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> defines a function named <code class="docutils literal notranslate"><span class="pre">main</span></code>.  Here is the entirety of
the <code class="docutils literal notranslate"><span class="pre">main</span></code> function we've defined in our <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.routes&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>When you invoke the <code class="docutils literal notranslate"><span class="pre">pserve</span> <span class="pre">development.ini</span></code> command, the <code class="docutils literal notranslate"><span class="pre">main</span></code> function
above is executed.  It accepts some settings and returns a <a class="reference internal" href="../../glossary.html#term-wsgi"><span class="xref std std-term">WSGI</span></a>
application.  (See <a class="reference internal" href="../../narr/startup.html#startup-chapter"><span class="std std-ref">Startup</span></a> for more about <code class="docutils literal notranslate"><span class="pre">pserve</span></code>.)</p>
<p>Next in <code class="docutils literal notranslate"><span class="pre">main</span></code>, construct a <a class="reference internal" href="../../glossary.html#term-configurator"><span class="xref std std-term">Configurator</span></a> object:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>7</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">settings</span></code> is passed to the <code class="docutils literal notranslate"><span class="pre">Configurator</span></code> as a keyword argument with the
dictionary values passed as the <code class="docutils literal notranslate"><span class="pre">**settings</span></code> argument. This will be a
dictionary of settings parsed from the <code class="docutils literal notranslate"><span class="pre">.ini</span></code> file, which contains
deployment-related values, such as <code class="docutils literal notranslate"><span class="pre">pyramid.reload_templates</span></code>,
<code class="docutils literal notranslate"><span class="pre">sqlalchemy.url</span></code>, and so on.</p>
<p>Next include <a class="reference internal" href="../../glossary.html#term-jinja2"><span class="xref std std-term">Jinja2</span></a> templating bindings so that we can use renderers
with the <code class="docutils literal notranslate"><span class="pre">.jinja2</span></code> extension within our project.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Next include the the package <code class="docutils literal notranslate"><span class="pre">models</span></code> using a dotted Python path. The exact
setup of the models will be covered later.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Next include the <code class="docutils literal notranslate"><span class="pre">routes</span></code> module using a dotted Python path. This module will
be explained in the next section.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>10</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.routes&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Pyramid's <a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.include" title="pyramid.config.Configurator.include"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.include()</span></code></a> method is the primary
mechanism for extending the configurator and breaking your code into
feature-focused modules.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">main</span></code> next calls the <code class="docutils literal notranslate"><span class="pre">scan</span></code> method of the configurator
(<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.scan" title="pyramid.config.Configurator.scan"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.scan()</span></code></a>), which will recursively scan our
<code class="docutils literal notranslate"><span class="pre">tutorial</span></code> package, looking for <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> and other special
decorators. When it finds a <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> decorator, a view configuration
will be registered, allowing one of our application URLs to be mapped to some
code.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Finally <code class="docutils literal notranslate"><span class="pre">main</span></code> is finished configuring things, so it uses the
<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.make_wsgi_app" title="pyramid.config.Configurator.make_wsgi_app"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.make_wsgi_app()</span></code></a> method to return a
<a class="reference internal" href="../../glossary.html#term-wsgi"><span class="xref std std-term">WSGI</span></a> application:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="route-declarations">
<h2>Route declarations<a class="headerlink" href="#route-declarations" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Open the <code class="docutils literal notranslate"><span class="pre">tutorial/routes.py</span></code> file. It should already contain the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>On line 2, we call <a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.add_static_view" title="pyramid.config.Configurator.add_static_view"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_static_view()</span></code></a> with
three arguments: <code class="docutils literal notranslate"><span class="pre">static</span></code> (the name), <code class="docutils literal notranslate"><span class="pre">static</span></code> (the path), and
<code class="docutils literal notranslate"><span class="pre">cache_max_age</span></code> (a keyword argument).</p>
<p>This registers a static resource view which will match any URL that starts
with the prefix <code class="docutils literal notranslate"><span class="pre">/static</span></code> (by virtue of the first argument to
<code class="docutils literal notranslate"><span class="pre">add_static_view</span></code>). This will serve up static resources for us from within
the <code class="docutils literal notranslate"><span class="pre">static</span></code> directory of our <code class="docutils literal notranslate"><span class="pre">tutorial</span></code> package, in this case via
<code class="docutils literal notranslate"><span class="pre">http://localhost:6543/static/</span></code> and below (by virtue of the second argument
to <code class="docutils literal notranslate"><span class="pre">add_static_view</span></code>).  With this declaration, we're saying that any URL that
starts with <code class="docutils literal notranslate"><span class="pre">/static</span></code> should go to the static view; any remainder of its
path (e.g., the <code class="docutils literal notranslate"><span class="pre">/foo</span></code> in <code class="docutils literal notranslate"><span class="pre">/static/foo</span></code>) will be used to compose a path to
a static file resource, such as a CSS file.</p>
<p>On line 3, the module registers a <a class="reference internal" href="../../glossary.html#term-route-configuration"><span class="xref std std-term">route configuration</span></a> via the
<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.add_route" title="pyramid.config.Configurator.add_route"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_route()</span></code></a> method that will be used when the
URL is <code class="docutils literal notranslate"><span class="pre">/</span></code>. Since this route has a <code class="docutils literal notranslate"><span class="pre">pattern</span></code> equaling <code class="docutils literal notranslate"><span class="pre">/</span></code>, it is the
route that will be matched when the URL <code class="docutils literal notranslate"><span class="pre">/</span></code> is visited, e.g.,
<code class="docutils literal notranslate"><span class="pre">http://localhost:6543/</span></code>.</p>
</div>
<div class="section" id="view-declarations-via-the-views-package">
<h2>View declarations via the <code class="docutils literal notranslate"><span class="pre">views</span></code> package<a class="headerlink" href="#view-declarations-via-the-views-package" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The main function of a web framework is mapping each URL pattern to code (a
<a class="reference internal" href="../../glossary.html#term-view-callable"><span class="xref std std-term">view callable</span></a>) that is executed when the requested URL matches the
corresponding <a class="reference internal" href="../../glossary.html#term-route"><span class="xref std std-term">route</span></a>. Our application uses the
<a class="reference internal" href="../../api/view.html#pyramid.view.view_config" title="pyramid.view.view_config"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.view.view_config()</span></code></a> decorator to perform this mapping.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">tutorial/views/default.py</span></code> in the <code class="docutils literal notranslate"><span class="pre">views</span></code> package.  It should already
contain the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">DBAPIError</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">MyModel</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/mytemplate.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;one&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">DBAPIError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">db_err_msg</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;one&#39;</span><span class="p">:</span> <span class="n">one</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;myproj&#39;</span><span class="p">}</span>


<span class="n">db_err_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Pyramid is having a problem using your SQL database.  The problem</span>
<span class="s2">might be caused by one of the following things:</span>

<span class="s2">1.  You may need to run the &quot;initialize_tutorial_db&quot; script</span>
<span class="s2">    to initialize your database tables.  Check your virtual</span>
<span class="s2">    environment&#39;s &quot;bin&quot; directory for this script and try to run it.</span>

<span class="s2">2.  Your database server may not be running.  Check that the</span>
<span class="s2">    database server referred to by the &quot;sqlalchemy.url&quot; setting in</span>
<span class="s2">    your &quot;development.ini&quot; file is running.</span>

<span class="s2">After you fix the problem, please restart the Pyramid application to</span>
<span class="s2">try it again.</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
<p>The important part here is that the <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> decorator associates the
function it decorates (<code class="docutils literal notranslate"><span class="pre">my_view</span></code>) with a <a class="reference internal" href="../../glossary.html#term-view-configuration"><span class="xref std std-term">view configuration</span></a>,
consisting of:</p>
<blockquote>
<div><ul class="simple">
<li>a <code class="docutils literal notranslate"><span class="pre">route_name</span></code> (<code class="docutils literal notranslate"><span class="pre">home</span></code>)</li>
<li>a <code class="docutils literal notranslate"><span class="pre">renderer</span></code>, which is a template from the <code class="docutils literal notranslate"><span class="pre">templates</span></code> subdirectory of
the package.</li>
</ul>
</div></blockquote>
<p>When the pattern associated with the <code class="docutils literal notranslate"><span class="pre">home</span></code> view is matched during a request,
<code class="docutils literal notranslate"><span class="pre">my_view()</span></code> will be executed.  <code class="docutils literal notranslate"><span class="pre">my_view()</span></code> returns a dictionary; the
renderer will use the <code class="docutils literal notranslate"><span class="pre">templates/mytemplate.jinja2</span></code> template to create a
response based on the values in the dictionary.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">my_view()</span></code> accepts a single argument named <code class="docutils literal notranslate"><span class="pre">request</span></code>.  This is
the standard call signature for a Pyramid <a class="reference internal" href="../../glossary.html#term-view-callable"><span class="xref std std-term">view callable</span></a>.</p>
<p>Remember in our <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> when we executed the
<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.scan" title="pyramid.config.Configurator.scan"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.scan()</span></code></a> method <code class="docutils literal notranslate"><span class="pre">config.scan()</span></code>? The purpose
of calling the scan method was to find and process this <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code>
decorator in order to create a view configuration within our application.
Without being processed by <code class="docutils literal notranslate"><span class="pre">scan</span></code>, the decorator effectively does nothing.
<code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> is inert without being detected via a <a class="reference internal" href="../../glossary.html#term-scan"><span class="xref std std-term">scan</span></a>.</p>
<p>The sample <code class="docutils literal notranslate"><span class="pre">my_view()</span></code> created by the cookiecutter uses a <code class="docutils literal notranslate"><span class="pre">try:</span></code> and
<code class="docutils literal notranslate"><span class="pre">except:</span></code> clause to detect if there is a problem accessing the project
database and provide an alternate error response.  That response will include
the text shown at the end of the file, which will be displayed in the browser
to inform the user about possible actions to take to solve the problem.</p>
</div>
<div class="section" id="content-models-with-the-models-package">
<h2>Content models with the <code class="docutils literal notranslate"><span class="pre">models</span></code> package<a class="headerlink" href="#content-models-with-the-models-package" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>In an SQLAlchemy-based application, a <em>model</em> object is an object composed by
querying the SQL database. The <code class="docutils literal notranslate"><span class="pre">models</span></code> package is where the <code class="docutils literal notranslate"><span class="pre">alchemy</span></code>
cookiecutter put the classes that implement our models.</p>
<p>First, open <code class="docutils literal notranslate"><span class="pre">tutorial/models/meta.py</span></code>, which should already contain the
following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="c1"># Recommended naming convention used by Alembic, as various different database</span>
<span class="c1"># providers will autogenerate vastly different names making migrations more</span>
<span class="c1"># difficult. See: http://alembic.zzzcomputing.com/en/latest/naming.html</span>
<span class="n">NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s2">&quot;ix_</span><span class="si">%(column_0_label)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;uq_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;ck_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;fk_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_</span><span class="si">%(referred_table_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;pk_</span><span class="si">%(table_name)s</span><span class="s2">&quot;</span>
<span class="p">}</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">NAMING_CONVENTION</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">meta.py</span></code> contains imports and support code for defining the models. We
create a dictionary <code class="docutils literal notranslate"><span class="pre">NAMING_CONVENTION</span></code> as well for consistent naming of
support objects like indices and constraints.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="c1"># Recommended naming convention used by Alembic, as various different database</span>
<span class="c1"># providers will autogenerate vastly different names making migrations more</span>
<span class="c1"># difficult. See: http://alembic.zzzcomputing.com/en/latest/naming.html</span>
<span class="n">NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s2">&quot;ix_</span><span class="si">%(column_0_label)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;uq_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;ck_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;fk_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_</span><span class="si">%(referred_table_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;pk_</span><span class="si">%(table_name)s</span><span class="s2">&quot;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
<p>Next we create a <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object from the class
<a class="reference external" href="https://docs.sqlalchemy.org/en/latest/core/metadata.html#sqlalchemy.schema.MetaData" title="(in SQLAlchemy v1.2)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.schema.MetaData</span></code></a>, using <code class="docutils literal notranslate"><span class="pre">NAMING_CONVENTION</span></code> as the value
for the <code class="docutils literal notranslate"><span class="pre">naming_convention</span></code> argument.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">MetaData</span></code> object represents the table and other schema definitions for a
single database. We also need to create a declarative <code class="docutils literal notranslate"><span class="pre">Base</span></code> object to use as
a base class for our models. Our models will inherit from this <code class="docutils literal notranslate"><span class="pre">Base</span></code>, which
will attach the tables to the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> we created, and define our
application's database schema.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">NAMING_CONVENTION</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Next open <code class="docutils literal notranslate"><span class="pre">tutorial/models/mymodel.py</span></code>, which should already contain the
following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Column</span><span class="p">,</span>
    <span class="n">Index</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.meta</span> <span class="kn">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;models&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>


<span class="n">Index</span><span class="p">(</span><span class="s1">&#39;my_index&#39;</span><span class="p">,</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mysql_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Notice we've defined the <code class="docutils literal notranslate"><span class="pre">models</span></code> as a package to make it straightforward for
defining models in separate modules. To give a simple example of a model class,
we have defined one named <code class="docutils literal notranslate"><span class="pre">MyModel</span></code> in <code class="docutils literal notranslate"><span class="pre">mymodel.py</span></code>:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;models&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Our example model does not require an <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method because SQLAlchemy
supplies for us a default constructor, if one is not already present, which
accepts keyword arguments of the same name as that of the mapped attributes.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>Example usage of MyModel:</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">johnny</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MyModel</span></code> class has a <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> attribute.  This informs
SQLAlchemy which table to use to store the data representing instances of this
class.</p>
<p>Finally, open <code class="docutils literal notranslate"><span class="pre">tutorial/models/__init__.py</span></code>, which should already
contain the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">configure_mappers</span>
<span class="kn">import</span> <span class="nn">zope.sqlalchemy</span>

<span class="c1"># import or define all models here to ensure they are attached to the</span>
<span class="c1"># Base.metadata prior to any initialization routines</span>
<span class="kn">from</span> <span class="nn">.mymodel</span> <span class="kn">import</span> <span class="n">MyModel</span>  <span class="c1"># flake8: noqa</span>

<span class="c1"># run configure_mappers after defining all of the models to ensure</span>
<span class="c1"># all relationships can be setup</span>
<span class="n">configure_mappers</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_session_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factory</span>


<span class="k">def</span> <span class="nf">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a ``sqlalchemy.orm.Session`` instance backed by a transaction.</span>

<span class="sd">    This function will hook the session to the transaction manager which</span>
<span class="sd">    will take care of committing any changes.</span>

<span class="sd">    - When using pyramid_tm it will automatically be committed or aborted</span>
<span class="sd">      depending on whether an exception is raised.</span>

<span class="sd">    - When using scripts you should wrap the session in a manager yourself.</span>
<span class="sd">      For example::</span>

<span class="sd">          import transaction</span>

<span class="sd">          engine = get_engine(settings)</span>
<span class="sd">          session_factory = get_session_factory(engine)</span>
<span class="sd">          with transaction.manager:</span>
<span class="sd">              dbsession = get_tm_session(session_factory, transaction.manager)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">zope</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
        <span class="n">dbsession</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="o">=</span><span class="n">transaction_manager</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbsession</span>


<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the model for a Pyramid app.</span>

<span class="sd">    Activate this setup using ``config.include(&#39;tutorial.models&#39;)``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tm.manager_hook&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pyramid_tm.explicit_manager&#39;</span>

    <span class="c1"># use pyramid_tm to hook the transaction lifecycle to the request</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_tm&#39;</span><span class="p">)</span>

    <span class="c1"># use pyramid_retry to retry a request when transient exceptions occur</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_retry&#39;</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">get_session_factory</span><span class="p">(</span><span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;dbsession_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_factory</span>

    <span class="c1"># make request.dbsession available for use in Pyramid</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span>
        <span class="c1"># r.tm is the transaction manager used by pyramid_tm</span>
        <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tm</span><span class="p">),</span>
        <span class="s1">&#39;dbsession&#39;</span><span class="p">,</span>
        <span class="n">reify</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Our <code class="docutils literal notranslate"><span class="pre">models/__init__.py</span></code> module defines the primary API we will use for
configuring the database connections within our application, and it contains
several functions we will cover below.</p>
<p>As we mentioned above, the purpose of the <code class="docutils literal notranslate"><span class="pre">models.meta.metadata</span></code> object is to
describe the schema of the database. This is done by defining models that
inherit from the <code class="docutils literal notranslate"><span class="pre">Base</span></code> object attached to that <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object. In
Python, code is only executed if it is imported, and so to attach the
<code class="docutils literal notranslate"><span class="pre">models</span></code> table defined in <code class="docutils literal notranslate"><span class="pre">mymodel.py</span></code> to the <code class="docutils literal notranslate"><span class="pre">metadata</span></code>, we must import
it. If we skip this step, then later, when we run
<a class="reference external" href="https://docs.sqlalchemy.org/en/latest/core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="(in SQLAlchemy v1.2)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sqlalchemy.schema.MetaData.create_all()</span></code></a>, the table will not be created
because the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> object does not know about it!</p>
<p>Another important reason to import all of the models is that, when defining
relationships between models, they must all exist in order for SQLAlchemy to
find and build those internal mappings. This is why, after importing all the
models, we explicitly execute the function
<a class="reference external" href="https://docs.sqlalchemy.org/en/latest/orm/mapping_api.html#sqlalchemy.orm.configure_mappers" title="(in SQLAlchemy v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sqlalchemy.orm.configure_mappers()</span></code></a>, once we are sure all the models have
been defined and before we start creating connections.</p>
<p>Next we define several functions for connecting to our database. The first and
lowest level is the <code class="docutils literal notranslate"><span class="pre">get_engine</span></code> function. This creates an <a class="reference internal" href="../../glossary.html#term-sqlalchemy"><span class="xref std std-term">SQLAlchemy</span></a>
database engine using <a class="reference external" href="https://docs.sqlalchemy.org/en/latest/core/engines.html#sqlalchemy.engine_from_config" title="(in SQLAlchemy v1.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sqlalchemy.engine_from_config()</span></code></a> from the
<code class="docutils literal notranslate"><span class="pre">sqlalchemy.</span></code>-prefixed settings in the <code class="docutils literal notranslate"><span class="pre">development.ini</span></code> file's
<code class="docutils literal notranslate"><span class="pre">[app:main]</span></code> section. This setting is a URI (something like <code class="docutils literal notranslate"><span class="pre">sqlite://</span></code>).</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sqlalchemy.&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The function <code class="docutils literal notranslate"><span class="pre">get_session_factory</span></code> accepts an <a class="reference internal" href="../../glossary.html#term-sqlalchemy"><span class="xref std std-term">SQLAlchemy</span></a> database
engine, and creates a <code class="docutils literal notranslate"><span class="pre">session_factory</span></code> from the <a class="reference internal" href="../../glossary.html#term-sqlalchemy"><span class="xref std std-term">SQLAlchemy</span></a> class
<a class="reference external" href="https://docs.sqlalchemy.org/en/latest/orm/session_api.html#sqlalchemy.orm.session.sessionmaker" title="(in SQLAlchemy v1.2)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.session.sessionmaker</span></code></a>. This <code class="docutils literal notranslate"><span class="pre">session_factory</span></code> is then
used for creating sessions bound to the database engine.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_session_factory</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factory</span>
</pre></div>
</td></tr></table></div>
<p>The function <code class="docutils literal notranslate"><span class="pre">get_tm_session</span></code> registers a database session with a transaction
manager, and returns a <code class="docutils literal notranslate"><span class="pre">dbsession</span></code> object. With the transaction manager, our
application will automatically issue a transaction commit after every request,
unless an exception is raised, in which case the transaction will be aborted.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a ``sqlalchemy.orm.Session`` instance backed by a transaction.</span>

<span class="sd">    This function will hook the session to the transaction manager which</span>
<span class="sd">    will take care of committing any changes.</span>

<span class="sd">    - When using pyramid_tm it will automatically be committed or aborted</span>
<span class="sd">      depending on whether an exception is raised.</span>

<span class="sd">    - When using scripts you should wrap the session in a manager yourself.</span>
<span class="sd">      For example::</span>

<span class="sd">          import transaction</span>

<span class="sd">          engine = get_engine(settings)</span>
<span class="sd">          session_factory = get_session_factory(engine)</span>
<span class="sd">          with transaction.manager:</span>
<span class="sd">              dbsession = get_tm_session(session_factory, transaction.manager)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">zope</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
        <span class="n">dbsession</span><span class="p">,</span> <span class="n">transaction_manager</span><span class="o">=</span><span class="n">transaction_manager</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbsession</span>
</pre></div>
</td></tr></table></div>
<p>Finally, we define an <code class="docutils literal notranslate"><span class="pre">includeme</span></code> function, which is a hook for use with
<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.include" title="pyramid.config.Configurator.include"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.include()</span></code></a> to activate code in a Pyramid
application add-on. It is the code that is executed above when we ran
<code class="docutils literal notranslate"><span class="pre">config.include('.models')</span></code> in our application's <code class="docutils literal notranslate"><span class="pre">main</span></code> function. This
function will take the settings from the application, create an engine, and
define a <code class="docutils literal notranslate"><span class="pre">request.dbsession</span></code> property, which we can use to do work on behalf
of an incoming request to our application.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the model for a Pyramid app.</span>

<span class="sd">    Activate this setup using ``config.include(&#39;tutorial.models&#39;)``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tm.manager_hook&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pyramid_tm.explicit_manager&#39;</span>

    <span class="c1"># use pyramid_tm to hook the transaction lifecycle to the request</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_tm&#39;</span><span class="p">)</span>

    <span class="c1"># use pyramid_retry to retry a request when transient exceptions occur</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_retry&#39;</span><span class="p">)</span>

    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">get_session_factory</span><span class="p">(</span><span class="n">get_engine</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;dbsession_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_factory</span>

    <span class="c1"># make request.dbsession available for use in Pyramid</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span>
        <span class="c1"># r.tm is the transaction manager used by pyramid_tm</span>
        <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">get_tm_session</span><span class="p">(</span><span class="n">session_factory</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">tm</span><span class="p">),</span>
        <span class="s1">&#39;dbsession&#39;</span><span class="p">,</span>
        <span class="n">reify</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>That's about all there is to it regarding models, views, and initialization
code in our stock application.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Index</span></code> import and the <code class="docutils literal notranslate"><span class="pre">Index</span></code> object creation in <code class="docutils literal notranslate"><span class="pre">mymodel.py</span></code> is
not required for this tutorial, and will be removed in the next step.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Basic Layout</a><ul>
<li><a class="reference internal" href="#application-configuration-with-init-py">Application configuration with <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code></a></li>
<li><a class="reference internal" href="#route-declarations">Route declarations</a></li>
<li><a class="reference internal" href="#view-declarations-via-the-views-package">View declarations via the <code class="docutils literal notranslate"><span class="pre">views</span></code> package</a></li>
<li><a class="reference internal" href="#content-models-with-the-models-package">Content models with the <code class="docutils literal notranslate"><span class="pre">models</span></code> package</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="installation.html"
                        title="前の章へ">Installation</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="definingmodels.html"
                        title="次の章へ">Defining the Domain Model</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/basiclayout.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="definingmodels.html" title="Defining the Domain Model"
             >次へ</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 10月 30, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>