
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Adding authentication &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="Adding authorization" href="authorization.html" />
    <link rel="prev" title="Defining Views" href="definingviews.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="authorization.html" title="Adding authorization"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-authentication">
<span id="wiki2-adding-authentication"></span><h1>Adding authentication<a class="headerlink" href="#adding-authentication" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p><span>Pyramid</span> provides facilities for <a class="reference internal" href="../../glossary.html#term-authentication"><span class="xref std std-term">authentication</span></a> and
<a class="reference internal" href="../../glossary.html#term-authorization"><span class="xref std std-term">authorization</span></a>. In this section we'll focus solely on the authentication
APIs to add login and logout functionality to our wiki.</p>
<p>We will implement authentication with the following steps:</p>
<ul class="simple">
<li>Add an <a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a> and a <code class="docutils literal notranslate"><span class="pre">request.user</span></code> computed property
(<code class="docutils literal notranslate"><span class="pre">security.py</span></code>).</li>
<li>Add routes for <code class="docutils literal notranslate"><span class="pre">/login</span></code> and <code class="docutils literal notranslate"><span class="pre">/logout</span></code> (<code class="docutils literal notranslate"><span class="pre">routes.py</span></code>).</li>
<li>Add login and logout views (<code class="docutils literal notranslate"><span class="pre">views/auth.py</span></code>).</li>
<li>Add a login template (<code class="docutils literal notranslate"><span class="pre">login.jinja2</span></code>).</li>
<li>Add &quot;Login&quot; and &quot;Logout&quot; links to every page based on the user's
authenticated state (<code class="docutils literal notranslate"><span class="pre">layout.jinja2</span></code>).</li>
<li>Make the existing views verify user state (<code class="docutils literal notranslate"><span class="pre">views/default.py</span></code>).</li>
<li>Redirect to <code class="docutils literal notranslate"><span class="pre">/login</span></code> when a user is denied access to any of the views that
require permission, instead of a default &quot;403 Forbidden&quot; page
(<code class="docutils literal notranslate"><span class="pre">views/auth.py</span></code>).</li>
</ul>
<div class="section" id="authenticating-requests">
<h2>Authenticating requests<a class="headerlink" href="#authenticating-requests" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The core of <span>Pyramid</span> authentication is an <a class="reference internal" href="../../glossary.html#term-authentication-policy"><span class="xref std std-term">authentication policy</span></a>
which is used to identify authentication information from a <code class="docutils literal notranslate"><span class="pre">request</span></code>,
as well as handling the low-level login and logout operations required to
track users across requests (via cookies, headers, or whatever else you can
imagine).</p>
<div class="section" id="add-the-authentication-policy">
<h3>Add the authentication policy<a class="headerlink" href="#add-the-authentication-policy" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Create a new file <code class="docutils literal notranslate"><span class="pre">tutorial/security.py</span></code> with the following content:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span> <span class="nc">MyAuthenticationPolicy</span><span class="p">(</span><span class="n">AuthTktAuthenticationPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>

<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">unauthenticated_userid</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_settings</span><span class="p">()</span>
    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">MyAuthenticationPolicy</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;auth.secret&#39;</span><span class="p">],</span>
        <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">ACLAuthorizationPolicy</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Here we've defined:</p>
<ul class="simple">
<li>A new authentication policy named <code class="docutils literal notranslate"><span class="pre">MyAuthenticationPolicy</span></code>, which is
subclassed from Pyramid's
<a class="reference internal" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy" title="pyramid.authentication.AuthTktAuthenticationPolicy"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.authentication.AuthTktAuthenticationPolicy</span></code></a>, which tracks the
<a class="reference internal" href="../../glossary.html#term-userid"><span class="xref std std-term">userid</span></a> using a signed cookie (lines 7-11).</li>
<li>A <code class="docutils literal notranslate"><span class="pre">get_user</span></code> function, which can convert the <code class="docutils literal notranslate"><span class="pre">unauthenticated_userid</span></code>
from the policy into a <code class="docutils literal notranslate"><span class="pre">User</span></code> object from our database (lines 13-17).</li>
<li>The <code class="docutils literal notranslate"><span class="pre">get_user</span></code> is registered on the request as <code class="docutils literal notranslate"><span class="pre">request.user</span></code> to be used
throughout our application as the authenticated <code class="docutils literal notranslate"><span class="pre">User</span></code> object for the
logged-in user (line 27).</li>
</ul>
<p>The logic in this file is a little bit interesting, so we'll go into detail
about what's happening here:</p>
<p>First, the default authentication policies all provide a method named
<code class="docutils literal notranslate"><span class="pre">unauthenticated_userid</span></code> which is responsible for the low-level parsing
of the information in the request (cookies, headers, etc.). If a <code class="docutils literal notranslate"><span class="pre">userid</span></code>
is found, then it is returned from this method. This is named
<code class="docutils literal notranslate"><span class="pre">unauthenticated_userid</span></code> because, at the lowest level, it knows the value of
the userid in the cookie, but it doesn't know if it's actually a user in our
system (remember, anything the user sends to our app is untrusted).</p>
<p>Second, our application should only care about <code class="docutils literal notranslate"><span class="pre">authenticated_userid</span></code> and
<code class="docutils literal notranslate"><span class="pre">request.user</span></code>, which have gone through our application-specific process of
validating that the user is logged in.</p>
<p>In order to provide an <code class="docutils literal notranslate"><span class="pre">authenticated_userid</span></code> we need a verification step.
That can happen anywhere, so we've elected to do it inside of the cached
<code class="docutils literal notranslate"><span class="pre">request.user</span></code> computed property. This is a convenience that makes
<code class="docutils literal notranslate"><span class="pre">request.user</span></code> the source of truth in our system. It is either <code class="docutils literal notranslate"><span class="pre">None</span></code> or
a <code class="docutils literal notranslate"><span class="pre">User</span></code> object from our database. This is why the <code class="docutils literal notranslate"><span class="pre">get_user</span></code> function
uses the <code class="docutils literal notranslate"><span class="pre">unauthenticated_userid</span></code> to check the database.</p>
</div>
<div class="section" id="configure-the-app">
<h3>Configure the app<a class="headerlink" href="#configure-the-app" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Since we've added a new <code class="docutils literal notranslate"><span class="pre">tutorial/security.py</span></code> module, we need to include it.
Open the file <code class="docutils literal notranslate"><span class="pre">tutorial/__init__.py</span></code> and edit the following lines:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.models&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.routes&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;.security&#39;</span><span class="p">)</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Our authentication policy is expecting a new setting, <code class="docutils literal notranslate"><span class="pre">auth.secret</span></code>. Open
the file <code class="docutils literal notranslate"><span class="pre">development.ini</span></code> and add the highlighted line below:</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="na">retry.attempts</span> <span class="o">=</span> <span class="s">3</span>

<span class="hll"><span class="na">auth.secret</span> <span class="o">=</span> <span class="s">seekrit</span>
</span></pre></div>
</td></tr></table></div>
<p>Finally, best practices tell us to use a different secret for production, so
open <code class="docutils literal notranslate"><span class="pre">production.ini</span></code> and add a different secret:</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="na">retry.attempts</span> <span class="o">=</span> <span class="s">3</span>

<span class="hll"><span class="na">auth.secret</span> <span class="o">=</span> <span class="s">real-seekrit</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add-permission-checks">
<h3>Add permission checks<a class="headerlink" href="#add-permission-checks" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><span>Pyramid</span> has full support for declarative authorization, which we'll
cover in the next chapter. However, many people looking to get their feet wet
are just interested in authentication with some basic form of home-grown
authorization. We'll show below how to accomplish the simple security goals of
our wiki, now that we can track the logged-in state of users.</p>
<p>Remember our goals:</p>
<ul class="simple">
<li>Allow only <code class="docutils literal notranslate"><span class="pre">editor</span></code> and <code class="docutils literal notranslate"><span class="pre">basic</span></code> logged-in users to create new pages.</li>
<li>Only allow <code class="docutils literal notranslate"><span class="pre">editor</span></code> users and the page creator (possibly a <code class="docutils literal notranslate"><span class="pre">basic</span></code> user)
to edit pages.</li>
</ul>
<p>Open the file <code class="docutils literal notranslate"><span class="pre">tutorial/views/default.py</span></code> and fix the following imports:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="p">(</span>
<span class="hll">    <span class="n">HTTPForbidden</span><span class="p">,</span>
</span>    <span class="n">HTTPFound</span><span class="p">,</span>
    <span class="n">HTTPNotFound</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="hll"><span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Page</span>
</span></pre></div>
</td></tr></table></div>
<p>Change the two highlighted lines.</p>
<p>In the same file, now edit the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;editor&#39;</span> <span class="ow">and</span> <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">!=</span> <span class="n">user</span><span class="p">):</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPForbidden</span>
</span>    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">pagedata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Only the highlighted lines need to be changed.</p>
<p>If the user either is not logged in or the user is not the page's creator
<em>and</em> not an <code class="docutils literal notranslate"><span class="pre">editor</span></code>, then we raise <code class="docutils literal notranslate"><span class="pre">HTTPForbidden</span></code>.</p>
<p>In the same file, now edit the <code class="docutils literal notranslate"><span class="pre">add_page</span></code> view function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;basic&#39;</span><span class="p">):</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPForbidden</span>
</span>    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
<span class="hll">        <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span>        <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Only the highlighted lines need to be changed.</p>
<p>If the user either is not logged in or is not in the <code class="docutils literal notranslate"><span class="pre">basic</span></code> or <code class="docutils literal notranslate"><span class="pre">editor</span></code>
roles, then we raise <code class="docutils literal notranslate"><span class="pre">HTTPForbidden</span></code>, which will return a &quot;403 Forbidden&quot;
response to the user. However, we will hook this later to redirect to the login
page. Also, now that we have <code class="docutils literal notranslate"><span class="pre">request.user</span></code>, we no longer have to hard-code
the creator as the <code class="docutils literal notranslate"><span class="pre">editor</span></code> user, so we can finally drop that hack.</p>
<p>These simple checks should protect our views.</p>
</div>
</div>
<div class="section" id="login-logout">
<h2>Login, logout<a class="headerlink" href="#login-logout" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Now that we've got the ability to detect logged-in users, we need to add the
<code class="docutils literal notranslate"><span class="pre">/login</span></code> and <code class="docutils literal notranslate"><span class="pre">/logout</span></code> views so that they can actually login and logout!</p>
<div class="section" id="add-routes-for-login-and-logout">
<h3>Add routes for <code class="docutils literal notranslate"><span class="pre">/login</span></code> and <code class="docutils literal notranslate"><span class="pre">/logout</span></code><a class="headerlink" href="#add-routes-for-login-and-logout" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Go back to <code class="docutils literal notranslate"><span class="pre">tutorial/routes.py</span></code> and add these two routes as highlighted:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>The preceding lines must be added <em>before</em> the following
<code class="docutils literal notranslate"><span class="pre">view_page</span></code> route definition:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p class="last">This is because <code class="docutils literal notranslate"><span class="pre">view_page</span></code>'s route definition uses a catch-all
&quot;replacement marker&quot; <code class="docutils literal notranslate"><span class="pre">/{pagename}</span></code> (see <a class="reference internal" href="../../narr/urldispatch.html#route-pattern-syntax"><span class="std std-ref">Route Pattern Syntax</span></a>),
which will catch any route that was not already caught by any route
registered before it. Hence, for <code class="docutils literal notranslate"><span class="pre">login</span></code> and <code class="docutils literal notranslate"><span class="pre">logout</span></code> views to
have the opportunity of being matched (or &quot;caught&quot;), they must be above
<code class="docutils literal notranslate"><span class="pre">/{pagename}</span></code>.</p>
</div>
</div>
<div class="section" id="add-login-logout-and-forbidden-views">
<h3>Add login, logout, and forbidden views<a class="headerlink" href="#add-login-logout-and-forbidden-views" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Create a new file <code class="docutils literal notranslate"><span class="pre">tutorial/views/auth.py</span></code>, and add the following code to it:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">remember</span><span class="p">,</span>
    <span class="n">forget</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">forbidden_view_config</span><span class="p">,</span>
    <span class="n">view_config</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/login.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">next_url</span><span class="p">:</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">login</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">login</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed login&#39;</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">),</span>
        <span class="n">next_url</span><span class="o">=</span><span class="n">next_url</span><span class="p">,</span>
        <span class="n">login</span><span class="o">=</span><span class="n">login</span><span class="p">,</span>
        <span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="nd">@forbidden_view_config</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">forbidden_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">_query</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This code adds three new views to the application:</p>
<ul>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">login</span></code> view renders a login form and processes the post from the
login form, checking credentials against our <code class="docutils literal notranslate"><span class="pre">users</span></code> table in the database.</p>
<p>The check is done by first finding a <code class="docutils literal notranslate"><span class="pre">User</span></code> record in the database, then
using our <code class="docutils literal notranslate"><span class="pre">user.check_password</span></code> method to compare the hashed passwords.</p>
<p>If the credentials are valid, then we use our authentication policy to store
the user's id in the response using <a class="reference internal" href="../../api/security.html#pyramid.security.remember" title="pyramid.security.remember"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.security.remember()</span></code></a>.</p>
<p>Finally, the user is redirected back to either the page which they were
trying to access (<code class="docutils literal notranslate"><span class="pre">next</span></code>) or the front page as a fallback. This parameter
is used by our forbidden view, as explained below, to finish the login
workflow.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">logout</span></code> view handles requests to <code class="docutils literal notranslate"><span class="pre">/logout</span></code> by clearing the
credentials using <a class="reference internal" href="../../api/security.html#pyramid.security.forget" title="pyramid.security.forget"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.security.forget()</span></code></a>, then redirecting them to
the front page.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">forbidden_view</span></code> is registered using the
<a class="reference internal" href="../../api/view.html#pyramid.view.forbidden_view_config" title="pyramid.view.forbidden_view_config"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.view.forbidden_view_config</span></code></a> decorator. This is a special
<a class="reference internal" href="../../glossary.html#term-exception-view"><span class="xref std std-term">exception view</span></a>, which is invoked when a
<a class="reference internal" href="../../api/httpexceptions.html#pyramid.httpexceptions.HTTPForbidden" title="pyramid.httpexceptions.HTTPForbidden"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid.httpexceptions.HTTPForbidden</span></code></a> exception is raised.</p>
<p>This view will handle a forbidden error by redirecting the user to
<code class="docutils literal notranslate"><span class="pre">/login</span></code>. As a convenience, it also sets the <code class="docutils literal notranslate"><span class="pre">next=</span></code> query string to the
current URL (the one that is forbidding access). This way, if the user
successfully logs in, they will be sent back to the page which they had been
trying to access.</p>
</li>
</ul>
</div>
<div class="section" id="add-the-login-jinja2-template">
<h3>Add the <code class="docutils literal notranslate"><span class="pre">login.jinja2</span></code> template<a class="headerlink" href="#add-the-login-jinja2-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Create <code class="docutils literal notranslate"><span class="pre">tutorial/templates/login.jinja2</span></code> with the following content:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>{% extends &#39;layout.jinja2&#39; %}

{% block title %}Login - {% endblock title %}

{% block content %}
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>
    Login
<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
{{ message }}
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{{ url }}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;next&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ next_url }}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;login&quot;</span><span class="p">&gt;</span>Username<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;login&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ login }}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;password&quot;</span><span class="p">&gt;</span>Password<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Log In&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span><span class="p">&gt;</span>Log In<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
{% endblock content %}
</pre></div>
</div>
<p>The above template is referenced in the login view that we just added in
<code class="docutils literal notranslate"><span class="pre">tutorial/views/auth.py</span></code>.</p>
</div>
<div class="section" id="add-login-and-logout-links">
<h3>Add &quot;Login&quot; and &quot;Logout&quot; links<a class="headerlink" href="#add-login-and-logout-links" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Open <code class="docutils literal notranslate"><span class="pre">tutorial/templates/layout.jinja2</span></code> and add the following code as
indicated by the highlighted lines.</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span>            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;content&quot;</span><span class="p">&gt;</span>
<span class="hll">            {% if request.user is none %}
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;pull-right&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ request.route_url(&#39;login&#39;) }}&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span class="hll">            {% else %}
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;pull-right&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            {{request.user.name}} <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{request.route_url(&#39;logout&#39;)}}&quot;</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span><span class="hll">            {% endif %}
</span>            {% block content %}{% endblock %}
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">request.user</span></code> will be <code class="docutils literal notranslate"><span class="pre">None</span></code> if the user is not authenticated, or a
<code class="docutils literal notranslate"><span class="pre">tutorial.models.User</span></code> object if the user is authenticated. This check will
make the logout link shown only when the user is logged in, and conversely the
login link is only shown when the user is logged out.</p>
</div>
</div>
<div class="section" id="viewing-the-application-in-a-browser">
<h2>Viewing the application in a browser<a class="headerlink" href="#viewing-the-application-in-a-browser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>We can finally examine our application in a browser (See
<a class="reference internal" href="installation.html#wiki2-start-the-application"><span class="std std-ref">Start the application</span></a>).  Launch a browser and visit each of the
following URLs, checking that the result is as expected:</p>
<ul class="simple">
<li><a class="reference external" href="http://localhost:6543/">http://localhost:6543/</a> invokes the <code class="docutils literal notranslate"><span class="pre">view_wiki</span></code> view.  This always
redirects to the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view of the <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object.  It
is executable by any user.</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage">http://localhost:6543/FrontPage</a> invokes the <code class="docutils literal notranslate"><span class="pre">view_page</span></code> view of the
<code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object. There is a &quot;Login&quot; link in the upper right corner
while the user is not authenticated, else it is a &quot;Logout&quot; link when the user
is authenticated.</li>
<li><a class="reference external" href="http://localhost:6543/FrontPage/edit_page">http://localhost:6543/FrontPage/edit_page</a> invokes the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view for
the <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> page object.  It is executable by only the <code class="docutils literal notranslate"><span class="pre">editor</span></code> user.
If a different user (or the anonymous user) invokes it, then a login form
will be displayed. Supplying the credentials with the username <code class="docutils literal notranslate"><span class="pre">editor</span></code> and
password <code class="docutils literal notranslate"><span class="pre">editor</span></code> will display the edit page form.</li>
<li><a class="reference external" href="http://localhost:6543/add_page/SomePageName">http://localhost:6543/add_page/SomePageName</a> invokes the <code class="docutils literal notranslate"><span class="pre">add_page</span></code> view for
a page. If the page already exists, then it redirects the user to the
<code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view for the page object. It is executable by either the
<code class="docutils literal notranslate"><span class="pre">editor</span></code> or <code class="docutils literal notranslate"><span class="pre">basic</span></code> user.  If a different user (or the anonymous user)
invokes it, then a login form will be displayed. Supplying the credentials
with either the username <code class="docutils literal notranslate"><span class="pre">editor</span></code> and password <code class="docutils literal notranslate"><span class="pre">editor</span></code>, or username
<code class="docutils literal notranslate"><span class="pre">basic</span></code> and password <code class="docutils literal notranslate"><span class="pre">basic</span></code>, will display the edit page form.</li>
<li><a class="reference external" href="http://localhost:6543/SomePageName/edit_page">http://localhost:6543/SomePageName/edit_page</a> invokes the <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> view
for an existing page, or generates an error if the page does not exist. It is
editable by the <code class="docutils literal notranslate"><span class="pre">basic</span></code> user if the page was created by that user in the
previous step. If, instead, the page was created by the <code class="docutils literal notranslate"><span class="pre">editor</span></code> user, then
the login page should be shown for the <code class="docutils literal notranslate"><span class="pre">basic</span></code> user.</li>
<li>After logging in (as a result of hitting an edit or add page and submitting
the login form with the <code class="docutils literal notranslate"><span class="pre">editor</span></code> credentials), we'll see a &quot;Logout&quot; link in
the upper right hand corner.  When we click it, we're logged out, redirected
back to the front page, and a &quot;Login&quot; link is shown in the upper right hand
corner.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding authentication</a><ul>
<li><a class="reference internal" href="#authenticating-requests">Authenticating requests</a><ul>
<li><a class="reference internal" href="#add-the-authentication-policy">Add the authentication policy</a></li>
<li><a class="reference internal" href="#configure-the-app">Configure the app</a></li>
<li><a class="reference internal" href="#add-permission-checks">Add permission checks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#login-logout">Login, logout</a><ul>
<li><a class="reference internal" href="#add-routes-for-login-and-logout">Add routes for <code class="docutils literal notranslate"><span class="pre">/login</span></code> and <code class="docutils literal notranslate"><span class="pre">/logout</span></code></a></li>
<li><a class="reference internal" href="#add-login-logout-and-forbidden-views">Add login, logout, and forbidden views</a></li>
<li><a class="reference internal" href="#add-the-login-jinja2-template">Add the <code class="docutils literal notranslate"><span class="pre">login.jinja2</span></code> template</a></li>
<li><a class="reference internal" href="#add-login-and-logout-links">Add &quot;Login&quot; and &quot;Logout&quot; links</a></li>
</ul>
</li>
<li><a class="reference internal" href="#viewing-the-application-in-a-browser">Viewing the application in a browser</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="definingviews.html"
                        title="前の章へ">Defining Views</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="authorization.html"
                        title="次の章へ">Adding authorization</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/authentication.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="authorization.html" title="Adding authorization"
             >次へ</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 10月 28, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>