
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>(機械翻訳)ビューの定義 &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
    <link rel="next" title="(機械翻訳)認証の追加" href="authentication.html" />
    <link rel="prev" title="(機械翻訳)ドメインモデルの定義" href="definingmodels.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="(機械翻訳)認証の追加"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="definingmodels.html" title="(機械翻訳)ドメインモデルの定義"
             accesskey="P">前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="defining-views">
<span id="wiki2-defining-views"></span><h1>(機械翻訳)ビューの定義<a class="headerlink" href="#defining-views" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>A:term:<cite>view callable</cite> は <span>Pyramid</span> アプリケーションは通常、 <a class="reference internal" href="../../glossary.html#term-request"><span class="xref std std-term">request</span></a> という単一のパラメータを受け入れる単純なPython関数です。ビューcallableは <a class="reference internal" href="../../glossary.html#term-response"><span class="xref std std-term">response</span></a> オブジェクトを返すものとします。</p>
<p>リクエストオブジェクトには、 `` matchdict`` という属性の辞書があります。 `` matchdict`` は、一致するURLのプレースホルダ `` pattern` <cite>を :term:`request</cite> URLのパスの部分文字列にマップします。たとえば、<a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.add_route" title="pyramid.config.Configurator.add_route"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_route()</span></code></a>  への呼び出しが <code class="docutils literal notranslate"><span class="pre">/{one}/{two}</span></code> というパターンを持ち、ユーザが <code class="docutils literal notranslate"><span class="pre">http://example.com/foo/foo/bar</span></code> と一致し、 <code class="docutils literal notranslate"><span class="pre">matchdict</span></code>  は  <code class="docutils literal notranslate"><span class="pre">{'one':'foo',</span> <span class="pre">'two':'bar'}</span></code> のようになります。 。</p>
<div class="section" id="adding-the-docutils-dependency">
<h2><code class="docutils literal notranslate"><span class="pre">docutils</span></code> 依存関係の追加<a class="headerlink" href="#adding-the-docutils-dependency" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>前の章では、 <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code>  パッケージの新しい依存性を追加しました。ここでも、アプリケーションのビューコードは、オリジナルの &quot;tutorial&quot; アプリケーションの依存関係ではないパッケージに依存します。</p>
<p><code class="docutils literal notranslate"><span class="pre">docutils</span></code> パッケージの依存関係を <code class="docutils literal notranslate"><span class="pre">tutorial</span></code> パッケージの <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> ファイルに追加する必要があります。この依存関係は ``  <code class="docutils literal notranslate"><span class="pre">setup()</span></code> 関数の <code class="docutils literal notranslate"><span class="pre">requires</span></code> パラメータに割り当てます。</p>
<p>`` tutorial/setup.py`` を開き、以下のように編集してください：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="s1">&#39;README.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">README</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="s1">&#39;CHANGES.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">CHANGES</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;bcrypt&#39;</span><span class="p">,</span>
<span class="hll">    <span class="s1">&#39;docutils&#39;</span><span class="p">,</span>
</span>    <span class="s1">&#39;plaster_pastedeploy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid &gt;= 1.9a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_debugtoolbar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_retry&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyramid_tm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SQLAlchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;transaction&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zope.sqlalchemy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;waitress&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">tests_require</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;WebTest &gt;= 1.3.1&#39;</span><span class="p">,</span>  <span class="c1"># py3 compat</span>
    <span class="s1">&#39;pytest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pytest-cov&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tutorial&#39;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.0&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;myproj&#39;</span><span class="p">,</span>
    <span class="n">long_description</span><span class="o">=</span><span class="n">README</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">CHANGES</span><span class="p">,</span>
    <span class="n">classifiers</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Programming Language :: Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Framework :: Pyramid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Topic :: Internet :: WWW/HTTP&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Topic :: Internet :: WWW/HTTP :: WSGI :: Application&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">author</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">keywords</span><span class="o">=</span><span class="s1">&#39;web pyramid pylons&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(),</span>
    <span class="n">include_package_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">extras_require</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="n">tests_require</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="n">requires</span><span class="p">,</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;paste.app_factory&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;main = tutorial:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;initialize_tutorial_db = tutorial.scripts.initializedb:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>強調表示された行だけを追加する必要があります。</p>
<p>ここでも、前の章で行ったように依存関係をインストールする必要がありますので、 <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">VENV/bin/pip</span> <span class="pre">install</span> <span class="pre">-e.</span></code> コマンドを再実行してください。</p>
</div>
<div class="section" id="static-assets">
<h2>静的資産<a class="headerlink" href="#static-assets" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>テンプレートには、CSSや画像などの静的資産の名前が付けられます。これらのファイルは、プロジェクトの作成時に提供されたものであるため、パッケージの <code class="docutils literal notranslate"><span class="pre">static</span></code> ディレクトリ内に作成する必要はありません。</p>
<p>たとえば、 `` <a class="reference external" href="http://localhost:6543/static/theme">http://localhost:6543/static/theme</a>.css`` を経由してCSSファイルにアクセスするには、 <code class="docutils literal notranslate"><span class="pre">add_static_view</span></code> ディレクティブを呼び出してください  <code class="docutils literal notranslate"><span class="pre">routes.py</span></code> ファイル。任意の数とタイプの静的アセットをこのディレクトリ（またはサブディレクトリ）に配置することができ、単にURLで、または <code class="docutils literal notranslate"><span class="pre">static_url</span></code> という便利なメソッドを使用するだけです。たとえば、<code class="docutils literal notranslate"><span class="pre">request.static_url('&lt;package&gt;:static/foo.css')</span></code> テンプレート内にあります。</p>
</div>
<div class="section" id="adding-routes-to-routes-py">
<h2><code class="docutils literal notranslate"><span class="pre">routes.py</span></code> にルートを追加する<a class="headerlink" href="#adding-routes-to-routes-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>これは <cite>URL Dispatch</cite> チュートリアルですので、いくつかのURLパターンをアプリケーションに追加してみましょう。後でURLを処理するビューを添付します。</p>
<p><code class="docutils literal notranslate"><span class="pre">routes.py</span></code> ファイルには、アプリケーションにルートを追加するための <a class="reference internal" href="../../api/config.html#pyramid.config.Configurator.add_route" title="pyramid.config.Configurator.add_route"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyramid.config.Configurator.add_route()</span></code></a> 呼び出しが含まれています。最初に、テンプレートによって作成された既存ルートを <code class="docutils literal notranslate"><span class="pre">'home'</span></code> という名前で削除します。これは単なる例であり、私たちのアプリケーションには関係ありません。</p>
<p><code class="docutils literal notranslate"><span class="pre">add_route</span></code> に4回の呼び出しを追加する必要があります。これらの宣言の*順序*は非常に重要であることに注意してください。ルート宣言は、登録された順序で一致します。</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">/</span></code> （ルートURLを示す）パターンを <code class="docutils literal notranslate"><span class="pre">view_wiki</span></code> というルートにマップする宣言を追加してください。次のステップでは、view_wikiビュー・ファンクションに添付された <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> デコレータによってコール可能な <code class="docutils literal notranslate"><span class="pre">view_wiki</span></code> ビューにマップします。これは <code class="docutils literal notranslate"><span class="pre">route_name='view_wiki'</span></code> 。</li>
<li><code class="docutils literal notranslate"><span class="pre">/{pagename}</span></code> パターン を <code class="docutils literal notranslate"><span class="pre">view_page</span></code> というルートにマップする宣言を追加してください。これはページの通常の表示です。また、次のステップでは、 `` view_page`` ビュー関数にアタッチされた <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> デコレータによってコール可能な <code class="docutils literal notranslate"><span class="pre">view_page</span></code> ビューにマップし、 <code class="docutils literal notranslate"><span class="pre">route_name='view_page'</span></code> です。</li>
<li><code class="docutils literal notranslate"><span class="pre">/add_page/{pagename}</span></code> というパターンを <code class="docutils literal notranslate"><span class="pre">add_page</span></code> というルートにマップする宣言を追加してください。これは、新しいページの追加ビューです。 <code class="docutils literal notranslate"><span class="pre">add_page``ビューにマップされる</span> <span class="pre">``&#64;view_config</span></code> デコレータは <code class="docutils literal notranslate"><span class="pre">add_page</span></code> ビュー関数にアタッチされています。これは <code class="docutils literal notranslate"><span class="pre">route_name='add_page'</span></code> で示されます。</li>
<li>パターン  <code class="docutils literal notranslate"><span class="pre">/{pagename}/edit_page</span></code> を <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> という名前のルートにマップする宣言を追加してください。これはページの編集ビューです。 <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビュー関数にアタッチされた <code class="docutils literal notranslate"><span class="pre">&#64;view_config</span></code> デコレータによって呼び出し可能な <code class="docutils literal notranslate"><span class="pre">edit_page</span></code> ビューにマップします。これは <code class="docutils literal notranslate"><span class="pre">route_name='edit_page'</span></code> で示されます。 。</li>
</ol>
<p>編集した結果、<code class="docutils literal notranslate"><span class="pre">routes.py</span></code> ファイルは次のようになります：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/add_page/{pagename}&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="s1">&#39;/{pagename}/edit_page&#39;</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>強調表示されている行は、追加または編集が必要な行です。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">ルートの順序は重要です！ <code class="docutils literal notranslate"><span class="pre">/add_page/{pagename}</span> <span class="pre">``</span> <span class="pre">の前に</span> <span class="pre">``/{pagename}/edit_page</span></code> を置いた場合、ページを追加することはできません。これは、最初のルートが <code class="docutils literal notranslate"><span class="pre">/add_page/edit_page</span></code> にリクエストを常に一致させるためですが、 <code class="docutils literal notranslate"><span class="pre">/add_page/..</span></code> が優先されるようにしたいからです。 wikiページは常にラクダのケースなので、これはこの特定のアプリでは大きな問題ではありませんが、自分のアプリでこの動作を認識することが重要です。</p>
</div>
</div>
<div class="section" id="adding-view-functions-in-views-default-py">
<h2><code class="docutils literal notranslate"><span class="pre">views/default.py</span></code> にビュー関数を追加する<a class="headerlink" href="#adding-view-functions-in-views-default-py" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>大きな変化の時です。 `` tutorial/views/default.py`` を開き、以下のように編集してください：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="kn">import</span> <span class="n">escape</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">re</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">docutils.core</span> <span class="kn">import</span> <span class="n">publish_parts</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">HTTPFound</span><span class="p">,</span>
</span><span class="hll">    <span class="n">HTTPNotFound</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span><span class="hll">
</span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>

<span class="hll"><span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Page</span><span class="p">,</span> <span class="n">User</span>
</span><span class="hll">
</span><span class="hll"><span class="c1"># regular expression used to find WikiWords</span>
</span><span class="hll"><span class="n">wikiwords</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="s1">&#39;FrontPage&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">(</span><span class="s1">&#39;No such page&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
</span><span class="hll">        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="hll">        <span class="n">exists</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
</span><span class="hll">            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
</span><span class="hll">            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
</span><span class="hll">            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">add_link</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class="hll">    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
</span><span class="hll">    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</span><span class="hll">        <span class="n">page</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="hll">        <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class="hll">        <span class="n">pagedata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span class="hll">        <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</span><span class="hll">        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
</span><span class="hll">        <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="hll">            <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">())</span>
</span><span class="hll">        <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</span><span class="hll">        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</span><span class="hll">    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">pagedata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>強調表示された行を追加または編集する必要があります。</p>
<p>いくつかのインポートを追加し、WikiWords　を見つける正規表現を作成しました。</p>
<p>私たちはもともと <code class="docutils literal notranslate"><span class="pre">alchemy</span></code> cookiecutterをレンダリングしたときに追加された <code class="docutils literal notranslate"><span class="pre">my_view</span></code>　ビュー関数とそのデコレータを取り除きました。これは単なる例であり、私たちのアプリケーションには関係ありません。 <code class="docutils literal notranslate"><span class="pre">db_err_msg</span></code> 文字列も削除しました。</p>
<p>前のステップで述べたように、 <cite>view/default.py</cite> モジュールに <a class="reference internal" href="../../glossary.html#term-view-callable"><span class="xref std std-term">view callable</span></a> 関数を4つ追加しました：</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">view_wiki（）</span></code>  -  wiki自体を表示します。それはルートURLで答えるでしょう。</li>
<li><code class="docutils literal notranslate"><span class="pre">view_page（）</span></code>  - 個々のページを表示します。</li>
<li><code class="docutils literal notranslate"><span class="pre">edit_page（）</span></code>  - ユーザがページを編集できるようにします。</li>
<li><code class="docutils literal notranslate"><span class="pre">add_page（）</span></code>  - ユーザーがページを追加できるようにします。</li>
</ul>
<p>以下のセクションでは、それぞれを簡単に説明します。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ファイル名 <code class="docutils literal notranslate"><span class="pre">default.py</span></code> がPythonモジュールであることを除いて特別なことは何もありません。プロジェクトは、コードベース全体で、任意の名前付きモジュールで多くのビュー呼び出し可能ファイルを持つことができます。ビュー呼び出し可能関数を実装しているモジュールは、その名前に <code class="docutils literal notranslate"><span class="pre">view</span></code> をつけている（または、私たちの場合のように `` views`` という名前のアプリケーションパッケージのPythonサブパッケージに入っているかもしれませんが）、これは規約であり、要件ではありません。</p>
</div>
<div class="section" id="the-view-wiki-view-function">
<h3>`` view_wiki``ビュー関数<a class="headerlink" href="#the-view-wiki-view-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下は `` view_wiki``ビュー関数とそのデコレータのコードです：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_wiki&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="s1">&#39;FrontPage&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>view_wiki()``は、wikiのルートURLへのリクエストがあったときに呼び出される <a class="reference internal" href="../../glossary.html#term-default-view"><span class="xref std std-term">default view</span></a> です。常に FrontPage へのパスを表すURLにリダイレクトされます。</p>
<p>`` view_wiki``ビューcallableは、常に FrontPage という名前のページリソースのURLにリダイレクトします。これを行うには、：class： <cite>pyramid.httpexceptions.HTTPFound</cite> クラスのインスタンスを返します（インスタンスは ：class：<cite>pyramid.interfaces.IResponse</cite> インターフェイスを実装しています：class：<cite>pyramid.response.Response</cite> ）。これは ：meth：<cite>pyramid.request.Request.route_url</cite> APIを使用して <code class="docutils literal notranslate"><span class="pre">FrontPage</span></code> ページ（すなわち` <a href="#id1"><span class="problematic" id="id2">`</span></a><a class="reference external" href="http:/">http:/</a></p>
</div>
<div class="section" id="the-view-page-view-function">
<h3>`` view_page``ビュー関数<a class="headerlink" href="#the-view-page-view-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` view_page``ビュー関数とそのデコレータのコードを以下に示します：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/view.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">(</span><span class="s1">&#39;No such page&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">word</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="s1">&#39;html_body&#39;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">add_link</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span><span class="o">=</span><span class="n">edit_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>`` view_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>は、私たちのwikiの1ページを表示するために使われます。これは、ページの：term： <cite>reStructuredText`本体（</cite> <cite>Page``モデルオブジェクトの</cite> <a href="#id3"><span class="problematic" id="id4">`</span></a>data``属性として保存されます）をHTMLとしてレンダリングします。次に、コンパイルされた正規表現を使用して、レンダリングされたHTMLの* WikiWord <a href="#id5"><span class="problematic" id="id6">*</span></a>参照ごとにHTMLアンカーを置き換えます。</p>
<p>`` add_link``というカルト機能は、 `` wikiwords.sub``の最初の引数として使われ、コンテンツ内の各WikiWordマッチの値を提供するために呼び出されるべきであることを示しています。 wikiに一致するWikiWord名のページがすでに含まれている場合、 `` add_link（） <a href="#id1"><span class="problematic" id="id2">``</span></a>は置換値として使用されるビューリンクを生成して返します。 wikiに一致するWikiWord名のページがまだ含まれていない場合、 `` add_link（） <a href="#id3"><span class="problematic" id="id4">``</span></a>は置換値として&amp;quot;add &amp;quot;リンクを生成して返します。</p>
<p>その結果、 `` content``変数は、現在のページオブジェクトの内容に基づいてWikiWords用のさまざまなビューとリンクを含むHTMLの完全に形成されたビットになりました。</p>
<p>テンプレートよりもここでやる方が簡単だから、編集URLを生成し、いくつかの引数を持つ辞書を返します。 `` view_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>が辞書（a：term： <cite>response`オブジェクトとは対照的に）を返すという事実は、 :app:`Pyramid</cite>  には：term： <cite>renderer`レスポンスを表示するためのビュー構成を使用します。私たちの場合、使用されるレンダラは、 `</cite> view_page（） <a href="#id3"><span class="problematic" id="id4">``</span></a>に適用される `` &#64; view_config``デコレータに示されているように、 `` view.jinja2``テンプレートになります。</p>
<p>ページが存在しない場合は、 `` tutorial / views / notfound.py``で定義されている：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid.httpexceptions.HTTPNotFound`を404処理をトリガーとして扱う必要があります。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">HTTP例外を使って `` raise``と `` return``を使うことは、一般的に人々を混乱させる重要な違いです。 `` tutorial / views / notfound.py``には、 `` HTTPNotFound``例外を扱うために登録されたterm： <cite>exception view`があります。例外ビューは、発生した例外に対してのみトリガされます。 `</cite> HTTPNotFound``が返された場合、内部的な&amp;quot;stock &amp;quot;テンプレートがあり、応答として自身をレンダリングするために使用されます。あなたの例外ビューが実行されているのを見ていない場合、これはおそらく問題です！例外ビューの詳細については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>special_exceptions_in_callables`を参照してください。</p>
</div>
</div>
<div class="section" id="the-edit-page-view-function">
<h3>`` edit_page``ビュー関数<a class="headerlink" href="#the-edit-page-view-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` edit_page``ビュー関数とそのデコレータのコードは次のとおりです：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">pagedata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>`` edit_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>は、ユーザがビューフォームの&amp;quot;Edit this Page &amp;quot;ボタンをクリックすると呼び出されます。これは編集フォームをレンダリングしますが、レンダリングするフォームのハンドラとしても機能します。 `` edit_page``ビューに渡されたリクエストの `` matchdict``属性は、ユーザが編集したいページの名前と一致する `` pagename```キーを持っています。</p>
<p>ビューの実行*がフォームの提出の結果である場合（つまり、 `` request.params``の中の `` form.submitted``が `` True``の場合）、ビューは `` body``要素を取得します。リクエストパラメータを設定し、それをページオブジェクトの `` data``属性として設定します。その後、wikiページの `` view_page``ビューにリダイレクトされます。</p>
<p>ビューの実行がフォーム提出の結果でない場合（つまり、 `` request.params``中のform.submittedが `` False``の場合）、ビューは単純に編集フォームをレンダリングし、生成されたフォームのアクションとして使用される `` save_url``があります。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">前章で定義した `` request.dbsession``が `` pyramid_tm``トランザクションマネージャに登録されているので、そのセッションで管理されているオブジェクトに対する変更は自動的にコミットされます。エラーが発生した場合（テンプレートコードでも後で）、変更は中止されます。これは、ビュー自身がコミット/ロールバックロジックに関わる必要はないことを意味します。</p>
</div>
</div>
<div class="section" id="the-add-page-view-function">
<h3>`` add_page``ビュー関数<a class="headerlink" href="#the-add-page-view-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` add_page``ビュー関数とそのデコレータのコードを以下に示します：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/edit.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;pagename&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">())</span>
        <span class="n">request</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;view_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">next_url</span><span class="p">)</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pagename</span><span class="o">=</span><span class="n">pagename</span><span class="p">,</span> <span class="n">pagedata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>`` add_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>はユーザが* WikiWord <em>をクリックしたときに呼び出されます。</em> WikiWord <a href="#id3"><span class="problematic" id="id4">*</span></a>はまだシステム内のページとして表現されていません。 `` view_page``ビュー内の `` add_link``関数は、このビューへのURLを生成します。 `` add_page（） <a href="#id5"><span class="problematic" id="id6">``</span></a>は、ページオブジェクトを追加するときに生成されるフォームのハンドラとしても機能します。 `` add_page（） <a href="#id7"><span class="problematic" id="id8">``</span></a>ビューに渡されるリクエストの `` matchdict``属性は、URLを構築してモデルオブジェクトを見つけるために必要な値を持ちます。</p>
<p>`` matchdict``には、追加したいページの名前と一致する `` pagename```キーがあります。 addビューが、例えば `` http：// localhost：6543 / add_page / SomeName``を介して呼び出された場合、 `` matchdict``の `` &amp;#39;pagename```の値は `` SomeName &amp;#39;``。</p>
<p>次に、 `` Page``が既にデータベースに存在するかどうかを判断するためのチェックが行われます。既に存在する場合、クライアントは `` edit_page``ビューにリダイレクトされます。そうでなければ、次のチェックに進みます。</p>
<p>ビューの実行*が*フォームの提出の結果である場合（つまり、 `` request.params``の `` form.submitted &amp;#39;&amp;#39;が `` True``の場合）、フォームデータからページ本文を取得し、createこのページ本文と `` matchdict [&amp;#39;pagename&amp;#39;] <a href="#id1"><span class="problematic" id="id2">``</span></a>から取った名前を持つPageオブジェクトを作成し、 `` request.dbession.add``を使ってデータベースに保存します。認証はまだ行っていないので、ページの `` creator``として追加するログインユーザはいません。チュートリアルでその点に達するまでは、すべてのページが `` editor``ユーザによって作成されたと仮定します。したがって、そのオブジェクトをクエリし、 `` page.creator``に設定します。最後に、クライアントを新しく作成したページの `` view_page``ビューにリダイレクトします。</p>
<p>ビューの実行がフォーム提出の結果でない場合（つまり、 `` &amp;#39;form.method&amp;#39; &amp;#39;request.params``が `` False``の場合）、ビューの呼び出し可能ビューはテンプレートをレンダリングします。そのために、テンプレートはレンダリング時にフォームのポストURLとして使用する `` save_url``を生成します。ここでは怠惰なので、追加ビューとページ編集ビューに同じテンプレート（ `` templates / edit.jinja2``）を使用します。これを行うために、* pageオブジェクトを `` page``として公開する編集フォームの希望を満たすために、ダミーの `` Page``オブジェクトを作成します。 ：app： <a href="#id1"><span class="problematic" id="id2">`</span></a>Pyramid`は、このビューに関連付けられたテンプレートをレスポンスにレンダリングします。</p>
</div>
</div>
<div class="section" id="adding-templates">
<h2>テンプレートの追加<a class="headerlink" href="#adding-templates" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` view_page``、 `` add_page``、 `` edit_page``ビューは、参照：a：term： <cite>template`を追加しました。各テンプレートは：term： `Jinja2`テンプレートです。これらのテンプレートはチュートリアルパッケージの `</cite> templates``ディレクトリにあります。 Jinja2テンプレートは、そのように認識されるように `` .jinja2``拡張子を持たなければなりません。</p>
<div class="section" id="the-layout-jinja2-template">
<h3>`` layout.jinja2``テンプレート<a class="headerlink" href="#the-layout-jinja2-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` tutorial / templates / layout.jinja2``を以下の内容で更新します。</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;{{request.locale_name}}&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;IE=edge&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;pyramid web application&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;author&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;Pylons Project&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{request.static_url(&#39;tutorial:static/pyramid-16x16.png&#39;)}}&quot;</span><span class="p">&gt;</span>

<span class="hll">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>{% block subtitle %}{% endblock %}Pyramid tutorial wiki (based on TurboGears 20-Minute Wiki)<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span>
    <span class="c">&lt;!-- Bootstrap core CSS --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;//oss.maxcdn.com/libs/twitter-bootstrap/3.0.3/css/bootstrap.min.css&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">&gt;</span>

    <span class="c">&lt;!-- Custom styles for this scaffold --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{request.static_url(&#39;tutorial:static/theme.css&#39;)}}&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">&gt;</span>

    <span class="c">&lt;!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;</span>
    <span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">      &lt;script src=&quot;//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js&quot; integrity=&quot;sha384-0s5Pv64cNZJieYFkXYOTId2HMA2Lfb6q2nAcx2n0RTLUnCAoTTsS0nKEO27XyKcY&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</span>
<span class="c">      &lt;script src=&quot;//oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js&quot; integrity=&quot;sha384-f1r2UzjsxZ9T4V1f2zBO/evUqSEOpeaUUZcMTz1Up63bl4ruYnFYeM+BxI4NhyI0&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</span>
<span class="c">    &lt;![endif]--&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;starter-template&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-2&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">img</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;logo img-responsive&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{request.static_url(&#39;tutorial:static/pyramid.png&#39;) }}&quot;</span> <span class="na">alt</span><span class="o">=</span><span class="s">&quot;pyramid web framework&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-10&quot;</span><span class="p">&gt;</span>
<span class="hll">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;content&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            {% block content %}{% endblock %}
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span>          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;copyright&quot;</span><span class="p">&gt;</span>
            Copyright <span class="ni">&amp;copy;</span> Pylons Project
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>


    <span class="c">&lt;!-- Bootstrap core JavaScript</span>
<span class="c">    ================================================== --&gt;</span>
    <span class="c">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//oss.maxcdn.com/libs/jquery/1.10.2/jquery.min.js&quot;</span> <span class="na">integrity</span><span class="o">=</span><span class="s">&quot;sha384-aBL3Lzi6c9LNDGvpHkZrrm3ZVsIwohDD7CDozL0pk8FwCrfmV7H9w8j3L7ikEv6h&quot;</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">&quot;anonymous&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//oss.maxcdn.com/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js&quot;</span> <span class="na">integrity</span><span class="o">=</span><span class="s">&quot;sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4&quot;</span> <span class="na">crossorigin</span><span class="o">=</span><span class="s">&quot;anonymous&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>テンプレートエンジンを使用しているので、ページテンプレートの一般的な定型文を再利用可能なコンポーネントに組み込むことができます。これを行う1つの方法は、ブロックによるテンプレートの継承です。</p>
<ul class="simple">
<li>レイアウトテンプレートには、子テンプレートがコンテンツをオーバーライドできる2つのプレースホルダが定義されています。これらのブロックの名前は <a href="#id1"><span class="problematic" id="id2">``</span></a>字幕 <a href="#id3"><span class="problematic" id="id4">``</span></a>（行11）と <a href="#id5"><span class="problematic" id="id6">``</span></a>コンテンツ <a href="#id7"><span class="problematic" id="id8">``</span></a>（行36）です。</li>
<li><a href="#id1"><span class="problematic" id="id2">`</span></a>Jinja2のドキュメントを参照してください&lt;<a class="reference external" href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>&gt;テンプレート継承の詳細については <a href="#id3"><span class="problematic" id="id4">`</span></a>_を参照してください。</li>
</ul>
</div>
<div class="section" id="the-view-jinja2-template">
<h3>`` view.jinja2``テンプレート<a class="headerlink" href="#the-view-jinja2-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` tutorial / templates / view.jinja2``を作成し、以下の内容を追加してください：</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{% extends &#39;layout.jinja2&#39; %}

{% block subtitle %}{{page.name}} - {% endblock subtitle %}

{% block content %}
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{ content|safe }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ edit_url }}&quot;</span><span class="p">&gt;</span>
    Edit this page
<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
    Viewing <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{page.name}}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>, created by <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{page.creator.name}}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>You can return to the
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{request.route_url(&#39;view_page&#39;, pagename=&#39;FrontPage&#39;)}}&quot;</span><span class="p">&gt;</span>FrontPage<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
{% endblock content %}
</pre></div>
</td></tr></table></div>
<p>このテンプレートは、単一のwikiページを表示するために `` view_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>によって使用されます。</p>
<ul class="simple">
<li>最初に、上記で定義した <a href="#id1"><span class="problematic" id="id2">`</span></a>layout.jinja2`テンプレートを拡張します。このテンプレートは、ページのスケルトン（行1）を提供します。</li>
<li>ページのタイトル（行3）にページ名を挿入して、基本レイアウトから `` subtitle``ブロックをオーバーライドします。</li>
<li>本文にマークアップを挿入するために、基本レイアウトから `` content``ブロックをオーバーライドします（5行目~18行目）。</li>
<li>ビューが提供する `` content``値で置き換えられる変数を使用します（6行目）。 `` content``はHTMLを含んでいるので、 `` safe``フィルタはエスケープするのを防ぐために使われます（例えば、&amp;quot;&amp;gt; &amp;quot;を&amp;quot;&amp;gt; &amp;quot;に変更する）。</li>
<li>クリックすると、要求されたページの `` edit_page``ビューが呼び出されます（8-10行目）。</li>
</ul>
</div>
<div class="section" id="the-edit-jinja2-template">
<h3>`` edit.jinja2``テンプレート<a class="headerlink" href="#the-edit-jinja2-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` tutorial / templates / edit.jinja2``を作成し、以下の内容を追加してください：</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">{% extends &#39;layout.jinja2&#39; %}
</span>
<span class="hll">{% block subtitle %}Edit {{pagename}} - {% endblock subtitle %}
</span>
{% block content %}
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
Editing <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{pagename}}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>You can return to the
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{request.route_url(&#39;view_page&#39;, pagename=&#39;FrontPage&#39;)}}&quot;</span><span class="p">&gt;</span>FrontPage<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="hll"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{{ save_url }}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
</span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;body&quot;</span> <span class="na">rows</span><span class="o">=</span><span class="s">&quot;10&quot;</span> <span class="na">cols</span><span class="o">=</span><span class="s">&quot;60&quot;</span><span class="p">&gt;</span>{{ pagedata }}<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Save&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span><span class="p">&gt;</span>Save<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
{% endblock content %}
</pre></div>
</td></tr></table></div>
<p>このテンプレートは2つのユースケースを扱います。これは `` add_page（） <a href="#id1"><span class="problematic" id="id2">``</span></a>と `` edit_page（） <a href="#id3"><span class="problematic" id="id4">``</span></a>によってwikiページの追加と編集に使用されます。フォームを含むページが表示され、次の情報が表示されます。</p>
<ul class="simple">
<li>ここでもまた、ページのスケルトン（1行目）を提供する <a href="#id1"><span class="problematic" id="id2">`</span></a>layout.jinja2`テンプレートを拡張します。</li>
<li>&lt;html&gt; `` subtitle``ブロックをオーバーライドして、 `` &lt;title&gt; <a href="#id1"><span class="problematic" id="id2">``</span></a>タグ <a href="#id3"><span class="problematic" id="id4">``</span></a>の `` head``（行3）にある。&amp;lt;/ html&amp;gt;</li>
<li>既存のページデータがレンダリングされたときにそれが埋め込まれた <cite>body`という名前の10行×60列の</cite> textarea`フィールドです（14行目）。</li>
<li>「form.submitted」という名前の送信ボタン（17行目）。</li>
<li>フォームは、ビューが提供する `` save_url``引数に戻ります（12行目）。ビューは `` body``と `` form.submitted``の値を使用します。</li>
</ul>
</div>
<div class="section" id="the-404-jinja2-template">
<h3>`` 404.jinja2``テンプレート<a class="headerlink" href="#the-404-jinja2-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` tutorial / templates / 404.jinja2``を以下の内容に置き換えてください：</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{% extends &quot;layout.jinja2&quot; %}

{% block content %}
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;content&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;font-semi-bold&quot;</span><span class="p">&gt;</span>Pyramid tutorial wiki<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;smaller&quot;</span><span class="p">&gt;</span>(based on TurboGears 20-Minute Wiki)<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;lead&quot;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;font-semi-bold&quot;</span><span class="p">&gt;</span>404<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> Page Not Found<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{% endblock content %}
</pre></div>
</td></tr></table></div>
<p>このテンプレートは、以下に示すように `` tutorial / views / notfound.py``で定義された `` notfound_view``からリンクされています：</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">notfound_view_config</span>


<span class="nd">@notfound_view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;../templates/404.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notfound_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="hll">    <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">404</span>
</span>    <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</td></tr></table></div>
<p>この設定については、いくつか重要な点があります。</p>
<ul class="simple">
<li>上のsnippetの `` notfound_view``は：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>例外ビュー`と呼ばれます。詳細については、ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>special_exceptions_in_callables`を参照してください。</li>
<li>`` notfound_view``はレスポンスステータスを404に設定します：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>request_response_attr`でレンダラが使用するレスポンスオブジェクトに影響を与えることができます。</li>
<li>`` notfound_view``は例外ビューとして登録され、 `` pyramid.httpexceptions.HTTPNotFound``が例外として呼び出された場合に** <a href="#id1"><span class="problematic" id="id2">**</span></a>のみ呼び出されます。つまり、通常はビューから返された応答に対しては呼び出されません。たとえば、 `` tutorial / views / default.py`の27行目では、ビューがトリガされる例外が発生します。</li>
</ul>
<p>最後に、 `` alchemy`` cookiecutterによって提供された `` tutorial / templates / mytemplate.jinja2``テンプレートを削除するかもしれません。これはwiki用の独自のテンプレートを作成したからです。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">私たちのテンプレートは、私たちのチュートリアルビューのどれもが辞書に返されない `` request``オブジェクトを使います。 `` request``は、テンプレートレンダラーが使用されているときに、テンプレート内でデフォルトで利用可能ないくつかの名前の1つです。テンプレートがレンダラーとして使われるときにデフォルトで利用可能な他の名前については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>renderer_system_values`を参照してください。</p>
</div>
</div>
</div>
<div class="section" id="viewing-the-application-in-a-browser">
<h2>ブラウザでのアプリケーションの表示<a class="headerlink" href="#viewing-the-application-in-a-browser" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ブラウザでアプリケーションを調べることができます（ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>wiki2-start-the-application`を参照してください）。ブラウザを起動し、次の各URLにアクセスして、結果が期待どおりであることを確認します。</p>
<ul class="simple">
<li>http：// localhost：6543 / `` view_wiki``ビューを呼び出します。これは常に `` FrontPage``ページオブジェクトの `` view_page``ビューにリダイレクトされます。</li>
<li>http：// localhost：6543 / FrontPageは `` FrontPage``ページオブジェクトの `` view_page``ビューを呼び出します。</li>
<li>http：// localhost：6543 / FrontPage / edit_pageは、 `` FrontPage``ページオブジェクトの `` edit_page``ビューを呼び出します。</li>
<li>http：// localhost：6543 / add_page / SomePageNameはページの `` add_page``ビューを呼び出します。ページがすでに存在する場合は、ページオブジェクトの `` edit_page``ビューにユーザをリダイレクトします。</li>
<li><a class="reference external" href="http://localhost:6543/SomePageName/edit_page">http://localhost:6543/SomePageName/edit_page</a>　は、既存のページの <code class="docutils literal notranslate"><span class="pre">edit_page</span></code>　ビューを呼び出し、ページが存在しない場合はエラーを生成します。</li>
<li>エラーを生成するには、 <a class="reference external" href="http://localhost:6543/foobars/edit_page">http://localhost:6543/foobars/edit_page</a> にアクセスし、 <code class="docutils literal notranslate"><span class="pre">NoResultFound:</span> <span class="pre">No</span> <span class="pre">row</span> <span class="pre">was</span> <span class="pre">found</span> <span class="pre">for</span> <span class="pre">one()</span></code>  エラーで行が見つかりませんでした。対話的なトレースバック機能がterm： <a href="#id1"><span class="problematic" id="id2">`</span></a>pyramid_debugtoolbar`によって提供されます。</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">(機械翻訳)ビューの定義</a><ul>
<li><a class="reference internal" href="#adding-the-docutils-dependency"><code class="docutils literal notranslate"><span class="pre">docutils</span></code> 依存関係の追加</a></li>
<li><a class="reference internal" href="#static-assets">静的資産</a></li>
<li><a class="reference internal" href="#adding-routes-to-routes-py"><code class="docutils literal notranslate"><span class="pre">routes.py</span></code> にルートを追加する</a></li>
<li><a class="reference internal" href="#adding-view-functions-in-views-default-py"><code class="docutils literal notranslate"><span class="pre">views/default.py</span></code> にビュー関数を追加する</a><ul>
<li><a class="reference internal" href="#the-view-wiki-view-function">`` view_wiki``ビュー関数</a></li>
<li><a class="reference internal" href="#the-view-page-view-function">`` view_page``ビュー関数</a></li>
<li><a class="reference internal" href="#the-edit-page-view-function">`` edit_page``ビュー関数</a></li>
<li><a class="reference internal" href="#the-add-page-view-function">`` add_page``ビュー関数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-templates">テンプレートの追加</a><ul>
<li><a class="reference internal" href="#the-layout-jinja2-template">`` layout.jinja2``テンプレート</a></li>
<li><a class="reference internal" href="#the-view-jinja2-template">`` view.jinja2``テンプレート</a></li>
<li><a class="reference internal" href="#the-edit-jinja2-template">`` edit.jinja2``テンプレート</a></li>
<li><a class="reference internal" href="#the-404-jinja2-template">`` 404.jinja2``テンプレート</a></li>
</ul>
</li>
<li><a class="reference internal" href="#viewing-the-application-in-a-browser">ブラウザでのアプリケーションの表示</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="definingmodels.html"
                        title="前の章へ">(機械翻訳)ドメインモデルの定義</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="authentication.html"
                        title="次の章へ">(機械翻訳)認証の追加</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/tutorials/wiki2/definingviews.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="(機械翻訳)認証の追加"
             >次へ</a> |</li>
        <li class="right" >
          <a href="definingmodels.html" title="(機械翻訳)ドメインモデルの定義"
             >前へ</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >SQLAlchemy + URL dispatch wiki tutorial(翻訳中)</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 02, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>