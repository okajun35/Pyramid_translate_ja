
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyramid.csrf &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">モジュールコード</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>pyramid.csrf のソースコード</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">webob.cookies</span> <span class="k">import</span> <span class="n">CookieProfile</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="k">import</span> <span class="n">implementer</span>


<span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="k">import</span> <span class="n">_SimpleSerializer</span>

<span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">bytes_</span><span class="p">,</span>
    <span class="n">urlparse</span><span class="p">,</span>
    <span class="n">text_</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BadCSRFOrigin</span><span class="p">,</span>
    <span class="n">BadCSRFToken</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.interfaces</span> <span class="k">import</span> <span class="n">ICSRFStoragePolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.settings</span> <span class="k">import</span> <span class="n">aslist</span>
<span class="kn">from</span> <span class="nn">pyramid.util</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">is_same_domain</span><span class="p">,</span>
    <span class="n">strings_differ</span>
<span class="p">)</span>


<div class="viewcode-block" id="LegacySessionCSRFStoragePolicy"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.LegacySessionCSRFStoragePolicy">[ドキュメント]</a><span class="nd">@implementer</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LegacySessionCSRFStoragePolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A CSRF storage policy that defers control of CSRF storage to the</span>
<span class="sd">    session.</span>

<span class="sd">    This policy maintains compatibility with legacy ISession implementations</span>
<span class="sd">    that know how to manage CSRF tokens themselves via</span>
<span class="sd">    ``ISession.new_csrf_token`` and ``ISession.get_csrf_token``.</span>

<span class="sd">    Note that using this CSRF implementation requires that</span>
<span class="sd">    a :term:`session factory` is configured.</span>

<span class="sd">    .. versionadded:: 1.9</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LegacySessionCSRFStoragePolicy.new_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.LegacySessionCSRFStoragePolicy.new_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">new_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets a new CSRF token into the session and returns it. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">new_csrf_token</span><span class="p">()</span></div>

<div class="viewcode-block" id="LegacySessionCSRFStoragePolicy.get_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.LegacySessionCSRFStoragePolicy.get_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">get_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the currently active CSRF token from the session,</span>
<span class="sd">        generating a new one if needed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">()</span></div>

<div class="viewcode-block" id="LegacySessionCSRFStoragePolicy.check_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.LegacySessionCSRFStoragePolicy.check_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">check_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">supplied_token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns ``True`` if the ``supplied_token`` is valid.&quot;&quot;&quot;</span>
        <span class="n">expected_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">strings_differ</span><span class="p">(</span>
            <span class="n">bytes_</span><span class="p">(</span><span class="n">expected_token</span><span class="p">),</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">supplied_token</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SessionCSRFStoragePolicy"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.SessionCSRFStoragePolicy">[ドキュメント]</a><span class="nd">@implementer</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SessionCSRFStoragePolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A CSRF storage policy that persists the CSRF token in the session.</span>

<span class="sd">    Note that using this CSRF implementation requires that</span>
<span class="sd">    a :term:`session factory` is configured.</span>

<span class="sd">    ``key``</span>

<span class="sd">        The session key where the CSRF token will be stored.</span>
<span class="sd">        Default: `_csrft_`.</span>

<span class="sd">    .. versionadded:: 1.9</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_token_factory</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">text_</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;_csrft_&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

<div class="viewcode-block" id="SessionCSRFStoragePolicy.new_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.SessionCSRFStoragePolicy.new_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">new_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets a new CSRF token into the session and returns it. &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_factory</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="SessionCSRFStoragePolicy.get_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.SessionCSRFStoragePolicy.get_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">get_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the currently active CSRF token from the session,</span>
<span class="sd">        generating a new one if needed.&quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="SessionCSRFStoragePolicy.check_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.SessionCSRFStoragePolicy.check_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">check_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">supplied_token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns ``True`` if the ``supplied_token`` is valid.&quot;&quot;&quot;</span>
        <span class="n">expected_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">strings_differ</span><span class="p">(</span>
            <span class="n">bytes_</span><span class="p">(</span><span class="n">expected_token</span><span class="p">),</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">supplied_token</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CookieCSRFStoragePolicy"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.CookieCSRFStoragePolicy">[ドキュメント]</a><span class="nd">@implementer</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CookieCSRFStoragePolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An alternative CSRF implementation that stores its information in</span>
<span class="sd">    unauthenticated cookies, known as the &#39;Double Submit Cookie&#39; method in the</span>
<span class="sd">    `OWASP CSRF guidelines &lt;https://www.owasp.org/index.php/</span>
<span class="sd">    Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#</span>
<span class="sd">    Double_Submit_Cookie&gt;`_. This gives some additional flexibility with</span>
<span class="sd">    regards to scaling as the tokens can be generated and verified by a</span>
<span class="sd">    front-end server.</span>

<span class="sd">    .. versionadded:: 1.9</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_token_factory</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">text_</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookie_name</span><span class="o">=</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">_SimpleSerializer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_profile</span> <span class="o">=</span> <span class="n">CookieProfile</span><span class="p">(</span>
            <span class="n">cookie_name</span><span class="o">=</span><span class="n">cookie_name</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="n">httponly</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">domains</span><span class="o">=</span><span class="p">[</span><span class="n">domain</span><span class="p">],</span>
            <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span> <span class="o">=</span> <span class="n">cookie_name</span>

<div class="viewcode-block" id="CookieCSRFStoragePolicy.new_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.CookieCSRFStoragePolicy.new_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">new_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets a new CSRF token into the request and returns it. &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_factory</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cookie_profile</span><span class="o">.</span><span class="n">set_cookies</span><span class="p">(</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">token</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">add_response_callback</span><span class="p">(</span><span class="n">set_cookie</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="CookieCSRFStoragePolicy.get_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.CookieCSRFStoragePolicy.get_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">get_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the currently active CSRF token by checking the cookies</span>
<span class="sd">        sent with the current request.&quot;&quot;&quot;</span>
        <span class="n">bound_cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie_profile</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">bound_cookies</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="CookieCSRFStoragePolicy.check_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.CookieCSRFStoragePolicy.check_csrf_token">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">check_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">supplied_token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns ``True`` if the ``supplied_token`` is valid.&quot;&quot;&quot;</span>
        <span class="n">expected_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">strings_differ</span><span class="p">(</span>
            <span class="n">bytes_</span><span class="p">(</span><span class="n">expected_token</span><span class="p">),</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">supplied_token</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="get_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.get_csrf_token">[ドキュメント]</a><span class="k">def</span> <span class="nf">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the currently active CSRF token for the request passed, generating</span>
<span class="sd">    a new one using ``new_csrf_token(request)`` if one does not exist. This</span>
<span class="sd">    calls the equivalent method in the chosen CSRF protection implementation.</span>

<span class="sd">    .. versionadded :: 1.9</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span>
    <span class="n">csrf</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">csrf</span><span class="o">.</span><span class="n">get_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<div class="viewcode-block" id="new_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.new_csrf_token">[ドキュメント]</a><span class="k">def</span> <span class="nf">new_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generate a new CSRF token for the request passed and persist it in an</span>
<span class="sd">    implementation defined manner. This calls the equivalent method in the</span>
<span class="sd">    chosen CSRF protection implementation.</span>

<span class="sd">    .. versionadded :: 1.9</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span>
    <span class="n">csrf</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">csrf</span><span class="o">.</span><span class="n">new_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_csrf_token"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.check_csrf_token">[ドキュメント]</a><span class="k">def</span> <span class="nf">check_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                     <span class="n">token</span><span class="o">=</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span>
                     <span class="n">header</span><span class="o">=</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">,</span>
                     <span class="n">raises</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check the CSRF token returned by the</span>
<span class="sd">    :class:`pyramid.interfaces.ICSRFStoragePolicy` implementation against the</span>
<span class="sd">    value in ``request.POST.get(token)`` (if a POST request) or</span>
<span class="sd">    ``request.headers.get(header)``. If a ``token`` keyword is not supplied to</span>
<span class="sd">    this function, the string ``csrf_token`` will be used to look up the token</span>
<span class="sd">    in ``request.POST``. If a ``header`` keyword is not supplied to this</span>
<span class="sd">    function, the string ``X-CSRF-Token`` will be used to look up the token in</span>
<span class="sd">    ``request.headers``.</span>

<span class="sd">    If the value supplied by post or by header cannot be verified by the</span>
<span class="sd">    :class:`pyramid.interfaces.ICSRFStoragePolicy`, and ``raises`` is</span>
<span class="sd">    ``True``, this function will raise an</span>
<span class="sd">    :exc:`pyramid.exceptions.BadCSRFToken` exception. If the values differ</span>
<span class="sd">    and ``raises`` is ``False``, this function will return ``False``.  If the</span>
<span class="sd">    CSRF check is successful, this function will return ``True``</span>
<span class="sd">    unconditionally.</span>

<span class="sd">    See :ref:`auto_csrf_checking` for information about how to secure your</span>
<span class="sd">    application automatically against CSRF attacks.</span>

<span class="sd">    .. versionadded:: 1.4a2</span>

<span class="sd">    .. versionchanged:: 1.7a1</span>
<span class="sd">       A CSRF token passed in the query string of the request is no longer</span>
<span class="sd">       considered valid. It must be passed in either the request body or</span>
<span class="sd">       a header.</span>

<span class="sd">    .. versionchanged:: 1.9</span>
<span class="sd">       Moved from :mod:`pyramid.session` to :mod:`pyramid.csrf` and updated</span>
<span class="sd">       to use the configured :class:`pyramid.interfaces.ICSRFStoragePolicy` to</span>
<span class="sd">       verify the CSRF token.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supplied_token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># We first check the headers for a csrf token, as that is significantly</span>
    <span class="c1"># cheaper than checking the POST body</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">supplied_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># If this is a POST/PUT/etc request, then we&#39;ll check the body to see if it</span>
    <span class="c1"># has a token. We explicitly use request.POST here because CSRF tokens</span>
    <span class="c1"># should never appear in an URL as doing so is a security issue. We also</span>
    <span class="c1"># explicitly check for request.POST here as we do not support sending form</span>
    <span class="c1"># encoded data over anything but a request.POST.</span>
    <span class="k">if</span> <span class="n">supplied_token</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">supplied_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">ICSRFStoragePolicy</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="o">.</span><span class="n">check_csrf_token</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">text_</span><span class="p">(</span><span class="n">supplied_token</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">raises</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadCSRFToken</span><span class="p">(</span><span class="s1">&#39;check_csrf_token(): Invalid token&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="check_csrf_origin"><a class="viewcode-back" href="../../api/csrf.html#pyramid.csrf.check_csrf_origin">[ドキュメント]</a><span class="k">def</span> <span class="nf">check_csrf_origin</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">trusted_origins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raises</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the ``Origin`` of the request to see if it is a cross site request or</span>
<span class="sd">    not.</span>

<span class="sd">    If the value supplied by the ``Origin`` or ``Referer`` header isn&#39;t one of the</span>
<span class="sd">    trusted origins and ``raises`` is ``True``, this function will raise a</span>
<span class="sd">    :exc:`pyramid.exceptions.BadCSRFOrigin` exception, but if ``raises`` is</span>
<span class="sd">    ``False``, this function will return ``False`` instead. If the CSRF origin</span>
<span class="sd">    checks are successful this function will return ``True`` unconditionally.</span>

<span class="sd">    Additional trusted origins may be added by passing a list of domain (and</span>
<span class="sd">    ports if non-standard like ``[&#39;example.com&#39;, &#39;dev.example.com:8080&#39;]``) in</span>
<span class="sd">    with the ``trusted_origins`` parameter. If ``trusted_origins`` is ``None``</span>
<span class="sd">    (the default) this list of additional domains will be pulled from the</span>
<span class="sd">    ``pyramid.csrf_trusted_origins`` setting.</span>

<span class="sd">    Note that this function will do nothing if ``request.scheme`` is not</span>
<span class="sd">    ``https``.</span>

<span class="sd">    .. versionadded:: 1.7</span>

<span class="sd">    .. versionchanged:: 1.9</span>
<span class="sd">       Moved from :mod:`pyramid.session` to :mod:`pyramid.csrf`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_fail</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">raises</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadCSRFOrigin</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
        <span class="c1"># Suppose user visits http://example.com/</span>
        <span class="c1"># An active network attacker (man-in-the-middle, MITM) sends a</span>
        <span class="c1"># POST form that targets https://example.com/detonate-bomb/ and</span>
        <span class="c1"># submits it via JavaScript.</span>
        <span class="c1">#</span>
        <span class="c1"># The attacker will need to provide a CSRF cookie and token, but</span>
        <span class="c1"># that&#39;s no problem for a MITM when we cannot make any assumptions</span>
        <span class="c1"># about what kind of session storage is being used. So the MITM can</span>
        <span class="c1"># circumvent the CSRF protection. This is true for any HTTP connection,</span>
        <span class="c1"># but anyone using HTTPS expects better! For this reason, for</span>
        <span class="c1"># https://example.com/ we need additional protection that treats</span>
        <span class="c1"># http://example.com/ as completely untrusted. Under HTTPS,</span>
        <span class="c1"># Barth et al. found that the Referer header is missing for</span>
        <span class="c1"># same-domain requests in only about 0.2% of cases or less, so</span>
        <span class="c1"># we can use strict Referer checking.</span>

        <span class="c1"># Determine the origin of this request</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span>

        <span class="c1"># Fail if we were not able to locate an origin at all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_fail</span><span class="p">(</span><span class="s2">&quot;Origin checking failed - no Origin or Referer.&quot;</span><span class="p">)</span>

        <span class="c1"># Parse our origin so we we can extract the required information from</span>
        <span class="c1"># it.</span>
        <span class="n">originp</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

        <span class="c1"># Ensure that our Referer is also secure.</span>
        <span class="k">if</span> <span class="n">originp</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span> <span class="s2">&quot;https&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_fail</span><span class="p">(</span>
                <span class="s2">&quot;Referer checking failed - Referer is insecure while host is &quot;</span>
                <span class="s2">&quot;secure.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Determine which origins we trust, which by default will include the</span>
        <span class="c1"># current origin.</span>
        <span class="k">if</span> <span class="n">trusted_origins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trusted_origins</span> <span class="o">=</span> <span class="n">aslist</span><span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;pyramid.csrf_trusted_origins&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">host_port</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="s2">&quot;443&quot;</span><span class="p">]):</span>
            <span class="n">trusted_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0.domain}</span><span class="s2">:</span><span class="si">{0.host_port}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trusted_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Actually check to see if the request&#39;s origin matches any of our</span>
        <span class="c1"># trusted origins.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_same_domain</span><span class="p">(</span><span class="n">originp</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">trusted_origins</span><span class="p">):</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Referer checking failed - </span><span class="si">{0}</span><span class="s2"> does not match any trusted &quot;</span>
                <span class="s2">&quot;origins.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_fail</span><span class="p">(</span><span class="n">reason</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >モジュールコード</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 10, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>