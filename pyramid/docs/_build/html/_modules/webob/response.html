
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>webob.response &#8212; The Pyramid Web Framework v1.9.2</title>
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="copyright" title="著作権" href="../../copyright.html" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="//static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head><body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">モジュールコード</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>webob.response のソースコード</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">base64</span> <span class="k">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">datetime</span><span class="p">,</span>
    <span class="n">timedelta</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">md5</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">webob.byterange</span> <span class="k">import</span> <span class="n">ContentRange</span>

<span class="kn">from</span> <span class="nn">webob.cachecontrol</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CacheControl</span><span class="p">,</span>
    <span class="n">serialize_cache_control</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">webob.compat</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">PY2</span><span class="p">,</span>
    <span class="n">bytes_</span><span class="p">,</span>
    <span class="n">native_</span><span class="p">,</span>
    <span class="n">text_type</span><span class="p">,</span>
    <span class="n">url_quote</span><span class="p">,</span>
    <span class="n">urlparse</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">webob.cookies</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Cookie</span><span class="p">,</span>
    <span class="n">make_cookie</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">webob.datetime_utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">parse_date_delta</span><span class="p">,</span>
    <span class="n">serialize_date_delta</span><span class="p">,</span>
    <span class="n">timedelta_to_seconds</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">webob.descriptors</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CHARSET_RE</span><span class="p">,</span>
    <span class="n">SCHEME_RE</span><span class="p">,</span>
    <span class="n">converter</span><span class="p">,</span>
    <span class="n">date_header</span><span class="p">,</span>
    <span class="n">header_getter</span><span class="p">,</span>
    <span class="n">list_header</span><span class="p">,</span>
    <span class="n">parse_auth</span><span class="p">,</span>
    <span class="n">parse_content_range</span><span class="p">,</span>
    <span class="n">parse_etag_response</span><span class="p">,</span>
    <span class="n">parse_int</span><span class="p">,</span>
    <span class="n">parse_int_safe</span><span class="p">,</span>
    <span class="n">serialize_auth</span><span class="p">,</span>
    <span class="n">serialize_content_range</span><span class="p">,</span>
    <span class="n">serialize_etag_response</span><span class="p">,</span>
    <span class="n">serialize_int</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">webob.headers</span> <span class="k">import</span> <span class="n">ResponseHeaders</span>
<span class="kn">from</span> <span class="nn">webob.request</span> <span class="k">import</span> <span class="n">BaseRequest</span>
<span class="kn">from</span> <span class="nn">webob.util</span> <span class="k">import</span> <span class="n">status_reasons</span><span class="p">,</span> <span class="n">status_generic_reasons</span><span class="p">,</span> <span class="n">warn_deprecation</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Response&#39;</span><span class="p">]</span>

<span class="n">_PARAM_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([a-z0-9]+)=(?:&quot;([^&quot;]*)&quot;|([a-z0-9_.-]*))&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">_OK_PARAM_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z0-9_.-]+$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="n">_gzip_header</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1f\x8b\x08\x00\x00\x00\x00\x00\x02\xff</span><span class="s1">&#39;</span>

<span class="n">_marker</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a WSGI response.</span>

<span class="sd">    If no arguments are passed, creates a :class:`~Response` that uses a</span>
<span class="sd">    variety of defaults. The defaults may be changed by sub-classing the</span>
<span class="sd">    :class:`~Response`. See the :ref:`sub-classing notes</span>
<span class="sd">    &lt;response_subclassing_notes&gt;`.</span>

<span class="sd">    :cvar ~Response.body: If ``body`` is a ``text_type``, then it will be</span>
<span class="sd">        encoded using either ``charset`` when provided or ``default_encoding``</span>
<span class="sd">        when ``charset`` is not provided if the ``content_type`` allows for a</span>
<span class="sd">        ``charset``. This argument is mutually  exclusive with ``app_iter``.</span>

<span class="sd">    :vartype ~Response.body: bytes or text_type</span>

<span class="sd">    :cvar ~Response.status: Either an :class:`int` or a string that is</span>
<span class="sd">        an integer followed by the status text. If it is an integer, it will be</span>
<span class="sd">        converted to a proper status that also includes the status text.  Any</span>
<span class="sd">        existing status text will be kept. Non-standard values are allowed.</span>

<span class="sd">    :vartype ~Response.status: int or str</span>

<span class="sd">    :cvar ~Response.headerlist: A list of HTTP headers for the response.</span>

<span class="sd">    :vartype ~Response.headerlist: list</span>

<span class="sd">    :cvar ~Response.app_iter: An iterator that is used as the body of the</span>
<span class="sd">        response. Should conform to the WSGI requirements and should provide</span>
<span class="sd">        bytes. This argument is mutually exclusive with ``body``.</span>

<span class="sd">    :vartype ~Response.app_iter: iterable</span>

<span class="sd">    :cvar ~Response.content_type: Sets the ``Content-Type`` header. If no</span>
<span class="sd">        ``content_type`` is provided, and there is no ``headerlist``, the</span>
<span class="sd">        ``default_content_type`` will be automatically set. If ``headerlist``</span>
<span class="sd">        is provided then this value is ignored.</span>

<span class="sd">    :vartype ~Response.content_type: str or None</span>

<span class="sd">    :cvar conditional_response: Used to change the behavior of the</span>
<span class="sd">        :class:`~Response` to check the original request for conditional</span>
<span class="sd">        response headers. See :meth:`~Response.conditional_response_app` for</span>
<span class="sd">        more information.</span>

<span class="sd">    :vartype conditional_response: bool</span>

<span class="sd">    :cvar ~Response.charset: Adds a ``charset`` ``Content-Type`` parameter. If</span>
<span class="sd">        no ``charset`` is provided and the ``Content-Type`` is text, then the</span>
<span class="sd">        ``default_charset`` will automatically be added.  Currently the only</span>
<span class="sd">        ``Content-Type``&#39;s that allow for a ``charset`` are defined to be</span>
<span class="sd">        ``text/*``, ``application/xml``, and ``*/*+xml``. Any other</span>
<span class="sd">        ``Content-Type``&#39;s will not have a ``charset`` added. If a</span>
<span class="sd">        ``headerlist`` is provided this value is ignored.</span>

<span class="sd">    :vartype ~Response.charset: str or None</span>

<span class="sd">    All other response attributes may be set on the response by providing them</span>
<span class="sd">    as keyword arguments. A :exc:`TypeError` will be raised for any unexpected</span>
<span class="sd">    keywords.</span>

<span class="sd">    .. _response_subclassing_notes:</span>

<span class="sd">    **Sub-classing notes:**</span>

<span class="sd">    * The ``default_content_type`` is used as the default for the</span>
<span class="sd">      ``Content-Type`` header that is returned on the response. It is</span>
<span class="sd">      ``text/html``.</span>

<span class="sd">    * The ``default_charset`` is used as the default character set to return on</span>
<span class="sd">      the ``Content-Type`` header, if the ``Content-Type`` allows for a</span>
<span class="sd">      ``charset`` parameter. Currently the only ``Content-Type``&#39;s that allow</span>
<span class="sd">      for a ``charset`` are defined to be: ``text/*``, ``application/xml``, and</span>
<span class="sd">      ``*/*+xml``. Any other ``Content-Type``&#39;s will not have a ``charset``</span>
<span class="sd">      added.</span>

<span class="sd">    * The ``unicode_errors`` is set to ``strict``, and access on a</span>
<span class="sd">      :attr:`~Response.text` will raise an error if it fails to decode the</span>
<span class="sd">      :attr:`~Response.body`.</span>

<span class="sd">    * ``default_conditional_response`` is set to ``False``. This flag may be</span>
<span class="sd">      set to ``True`` so that all ``Response`` objects will attempt to check</span>
<span class="sd">      the original request for conditional response headers. See</span>
<span class="sd">      :meth:`~Response.conditional_response_app` for more information.</span>

<span class="sd">    * ``default_body_encoding`` is set to &#39;UTF-8&#39; by default. It exists to</span>
<span class="sd">      allow users to get/set the ``Response`` object using ``.text``, even if</span>
<span class="sd">      no ``charset`` has been set for the ``Content-Type``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_content_type</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span>
    <span class="n">default_charset</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span>
    <span class="n">unicode_errors</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span>
    <span class="n">default_conditional_response</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">default_body_encoding</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span>

    <span class="c1"># These two are only around so that when people pass them into the</span>
    <span class="c1"># constructor they correctly get saved and set, however they are not used</span>
    <span class="c1"># by any part of the Response. See commit</span>
    <span class="c1"># 627593bbcd4ab52adc7ee569001cdda91c670d5d for rationale.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#</span>
    <span class="c1"># __init__, from_file, copy</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headerlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conditional_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="n">_marker</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># Do some sanity checking, and turn json_body into an actual body</span>
        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;json_body&#39;</span> <span class="ow">in</span> <span class="n">kw</span> <span class="ow">or</span> <span class="s1">&#39;json&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;json_body&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
                <span class="n">json_body</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;json_body&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_body</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_body</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>

        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;You may only give one of the body and app_iter arguments&quot;</span><span class="p">)</span>

        <span class="c1"># Set up Response.status</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># Initialize headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">headerlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span> <span class="o">=</span> <span class="n">headerlist</span>

        <span class="c1"># Set the encoding for the Response to charset, so if a charset is</span>
        <span class="c1"># passed but the Content-Type does not allow for a charset, we can</span>
        <span class="c1"># still encode text_type body&#39;s.</span>
        <span class="c1"># r = Response(</span>
        <span class="c1">#   content_type=&#39;application/foo&#39;,</span>
        <span class="c1">#   charset=&#39;UTF-8&#39;,</span>
        <span class="c1">#   body=u&#39;somebody&#39;)</span>
        <span class="c1"># Should work without issues, and the header will be correctly set to</span>
        <span class="c1"># Content-Type: application/foo with no charset on it.</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_marker</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">charset</span>

        <span class="c1"># Does the status code have a body or not?</span>
        <span class="n">code_has_body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;204&#39;</span><span class="p">,</span> <span class="s1">&#39;205&#39;</span><span class="p">,</span> <span class="s1">&#39;304&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># We only set the content_type to the one passed to the constructor or</span>
        <span class="c1"># the default content type if there is none that exists AND there was</span>
        <span class="c1"># no headerlist passed. If a headerlist was provided then most likely</span>
        <span class="c1"># the ommission of the Content-Type is on purpose and we shouldn&#39;t try</span>
        <span class="c1"># to be smart about it.</span>
        <span class="c1">#</span>
        <span class="c1"># Also allow creation of a empty Response with just the status set to a</span>
        <span class="c1"># Response with empty body, such as Response(status=&#39;204 No Content&#39;)</span>
        <span class="c1"># without the default content_type being set (since empty bodies have</span>
        <span class="c1"># no Content-Type)</span>
        <span class="c1">#</span>
        <span class="c1"># Check if content_type is set because default_content_type could be</span>
        <span class="c1"># None, in which case there is no content_type, and thus we don&#39;t need</span>
        <span class="c1"># to anything</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_content_type</span>

        <span class="k">if</span> <span class="n">headerlist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">code_has_body</span> <span class="ow">and</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="c1"># Set up the charset, if the content_type doesn&#39;t already have one</span>

            <span class="n">has_charset</span> <span class="o">=</span> <span class="s1">&#39;charset=&#39;</span> <span class="ow">in</span> <span class="n">content_type</span>

            <span class="c1"># If the Content-Type already has a charset, we don&#39;t set the user</span>
            <span class="c1"># provided charset on the Content-Type, so we shouldn&#39;t use it as</span>
            <span class="c1"># the encoding for text_type based body&#39;s.</span>
            <span class="k">if</span> <span class="n">has_charset</span><span class="p">:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Do not use the default_charset for the encoding because we</span>
            <span class="c1"># want things like</span>
            <span class="c1"># Response(content_type=&#39;image/jpeg&#39;,body=u&#39;foo&#39;) to raise when</span>
            <span class="c1"># trying to encode the body.</span>

            <span class="n">new_charset</span> <span class="o">=</span> <span class="n">encoding</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">has_charset</span> <span class="ow">and</span>
                <span class="n">charset</span> <span class="ow">is</span> <span class="n">_marker</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>
            <span class="p">):</span>
                <span class="n">new_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>

            <span class="c1"># Optimize for the default_content_type as shipped by</span>
            <span class="c1"># WebOb, becuase we know that &#39;text/html&#39; has a charset,</span>
            <span class="c1"># otherwise add a charset if the content_type has a charset.</span>
            <span class="c1">#</span>
            <span class="c1"># Even if the user supplied charset explicitly, we do not add</span>
            <span class="c1"># it to the Content-Type unless it has has a charset, instead</span>
            <span class="c1"># the user supplied charset is solely used for encoding the</span>
            <span class="c1"># body if it is a text_type</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">new_charset</span> <span class="ow">and</span>
                <span class="p">(</span>
                    <span class="n">content_type</span> <span class="o">==</span> <span class="s1">&#39;text/html&#39;</span> <span class="ow">or</span>
                    <span class="n">_content_type_has_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">content_type</span> <span class="o">+=</span> <span class="s1">&#39;; charset=&#39;</span> <span class="o">+</span> <span class="n">new_charset</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">content_type</span><span class="p">))</span>

        <span class="c1"># Set up conditional response</span>
        <span class="k">if</span> <span class="n">conditional_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditional_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_conditional_response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditional_response</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">conditional_response</span><span class="p">)</span>

        <span class="c1"># Set up app_iter if the HTTP Status code has a body</span>
        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">code_has_body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="c1"># Fall back to trying self.charset if encoding is not set. In</span>
                <span class="c1"># most cases encoding will be set to the default value.</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;You cannot set the body to a text value without a &quot;</span>
                        <span class="s2">&quot;charset&quot;</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">app_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">headerlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;content-length&#39;</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">code_has_body</span><span class="p">:</span>
            <span class="n">app_iter</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="n">app_iter</span>

        <span class="c1"># Loop through all the remaining keyword arguments</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="c1"># Not a basic attribute</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected keyword: </span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Response.from_file"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.from_file">[ドキュメント]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a response from a file-like object (it must implement</span>
<span class="sd">        ``.read(size)`` and ``.readline()``).</span>

<span class="sd">        It will read up to the end of the response, not the end of the</span>
<span class="sd">        file.</span>

<span class="sd">        This reads the response as represented by ``str(resp)``; it</span>
<span class="sd">        may not read every valid HTTP response properly.  Responses</span>
<span class="sd">        must have a ``Content-Length``.&quot;&quot;&quot;</span>
        <span class="n">headerlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">is_text</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">text_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_text</span><span class="p">:</span>
            <span class="n">_colon</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
            <span class="n">_http</span> <span class="o">=</span> <span class="s1">&#39;HTTP/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_colon</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;:&#39;</span>
            <span class="n">_http</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;HTTP/&#39;</span>

        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_http</span><span class="p">):</span>
            <span class="p">(</span><span class="n">http_ver</span><span class="p">,</span> <span class="n">status_num</span><span class="p">,</span> <span class="n">status_text</span><span class="p">)</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">native_</span><span class="p">(</span><span class="n">status_num</span><span class="p">),</span> <span class="n">native_</span><span class="p">(</span><span class="n">status_text</span><span class="p">))</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># end of headers</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_colon</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bad header line: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">native_</span><span class="p">(</span><span class="n">header_name</span><span class="p">,</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">),</span>
                <span class="n">native_</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
            <span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">headerlist</span><span class="o">=</span><span class="n">headerlist</span><span class="p">,</span>
            <span class="n">app_iter</span><span class="o">=</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content_length</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_text</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">body</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Response.copy"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.copy">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a copy of the response.&quot;&quot;&quot;</span>
        <span class="c1"># we need to do this for app_iter to be reusable</span>
        <span class="n">app_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
        <span class="n">iter_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
        <span class="c1"># and this to make sure app_iter instances are different</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span>
            <span class="n">headerlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span><span class="p">[:],</span>
            <span class="n">app_iter</span><span class="o">=</span><span class="n">app_iter</span><span class="p">,</span>
            <span class="n">conditional_response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_response</span><span class="p">)</span></div>

    <span class="c1">#</span>
    <span class="c1"># __repr__, __str__</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> at 0x</span><span class="si">%x</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_body</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_body</span><span class="p">:</span>
            <span class="c1"># Force enumeration of the body (to set content-length)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="n">parts</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_body</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="k">if</span> <span class="n">PY2</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># status, status_code/status_int</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_status__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The status string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="k">def</span> <span class="nf">_status__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PY2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;You must set status to a string or integer (not </span><span class="si">%s</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="c1"># Attempt to get the status code itself, if this fails we should fail</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We don&#39;t need this value anywhere, we just want to validate it&#39;s</span>
            <span class="c1"># an integer. So we are using the side-effect of int() raises a</span>
            <span class="c1"># ValueError as a test</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid status code, integer required.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">status</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_status__get</span><span class="p">,</span> <span class="n">_status__set</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_status__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_status_code__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The status as an integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_status_code__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">status_reasons</span><span class="p">[</span><span class="n">code</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">status_generic_reasons</span><span class="p">[</span><span class="n">code</span> <span class="o">//</span> <span class="mi">100</span><span class="p">])</span>

    <span class="n">status_code</span> <span class="o">=</span> <span class="n">status_int</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_status_code__get</span><span class="p">,</span> <span class="n">_status_code__set</span><span class="p">,</span>
                                        <span class="n">doc</span><span class="o">=</span><span class="n">_status_code__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># headerslist, headers</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_headerlist__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The list of response headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span>

    <span class="k">def</span> <span class="nf">_headerlist__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_headerlist__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">headerlist</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_headerlist__get</span><span class="p">,</span> <span class="n">_headerlist__set</span><span class="p">,</span>
                          <span class="n">_headerlist__del</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_headerlist__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_headers__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The headers in a dictionary-like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">ResponseHeaders</span><span class="o">.</span><span class="n">view_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

    <span class="k">def</span> <span class="nf">_headers__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_headers__get</span><span class="p">,</span> <span class="n">_headers__set</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_headers__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># body</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_body__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The body of the response, as a :class:`bytes`.  This will read in</span>
<span class="sd">        the entire app_iter if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>
<span class="c1">#         try:</span>
<span class="c1">#             if len(app_iter) == 1:</span>
<span class="c1">#                 return app_iter[0]</span>
<span class="c1">#         except:</span>
<span class="c1">#             pass</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">app_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No body has been set&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">iter_close</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_error_unicode_in_app_iter</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if body-length is zero, we assume it&#39;s a HEAD response and</span>
            <span class="c1"># leave content_length alone</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;Content-Length is different from actual app_iter length &quot;</span>
                <span class="s2">&quot;(</span><span class="si">%r</span><span class="s2">!=</span><span class="si">%r</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">_body__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You cannot set Response.body to a text object &quot;</span>
                       <span class="s2">&quot;(use Response.text)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You can only set the body to a binary type (not </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                       <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_md5</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1">#     def _body__del(self):</span>
<span class="c1">#         self.body = &#39;&#39;</span>
<span class="c1">#         #self.content_length = None</span>

    <span class="n">body</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_body__get</span><span class="p">,</span> <span class="n">_body__set</span><span class="p">,</span> <span class="n">_body__set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_json_body__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set/get the body of the response as JSON.</span>

<span class="sd">        .. note::</span>

<span class="sd">           This will automatically :meth:`~bytes.decode` the</span>
<span class="sd">           :attr:`~Response.body` as ``UTF-8`` on get, and</span>
<span class="sd">           :meth:`~str.encode` the :meth:`json.dumps` as ``UTF-8``</span>
<span class="sd">           before assigning to :attr:`~Response.body`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: UTF-8 is a content-type specific default for JSON</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_json_body__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_json_body__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>

    <span class="n">json</span> <span class="o">=</span> <span class="n">json_body</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_json_body__get</span><span class="p">,</span> <span class="n">_json_body__set</span><span class="p">,</span> <span class="n">_json_body__del</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_body__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the the response has a :attr:`~Response.body`. In</span>
<span class="sd">        contrast to simply accessing :attr:`~Response.body`, this method</span>
<span class="sd">        will **not** read the underlying :attr:`~Response.app_iter`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">app_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">has_body</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_has_body__get</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># text, unicode_body, ubody</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_text__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get/set the text value of the body using the ``charset`` of the</span>
<span class="sd">        ``Content-Type`` or the ``default_body_encoding``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_body_encoding</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;You cannot access Response.text unless charset or default_body_encoding&quot;</span>
                <span class="s2">&quot; is set&quot;</span>
            <span class="p">)</span>
        <span class="n">decoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_body_encoding</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">decoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicode_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_text__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_body_encoding</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;You cannot access Response.text unless charset or default_body_encoding&quot;</span>
                <span class="s2">&quot; is set&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;You can only set Response.text to a unicode string &quot;</span>
                <span class="s2">&quot;(not </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_body_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_text__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>

    <span class="n">text</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_text__get</span><span class="p">,</span> <span class="n">_text__set</span><span class="p">,</span> <span class="n">_text__del</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_text__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="n">unicode_body</span> <span class="o">=</span> <span class="n">ubody</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_text__get</span><span class="p">,</span> <span class="n">_text__set</span><span class="p">,</span> <span class="n">_text__del</span><span class="p">,</span>
                                    <span class="s2">&quot;Deprecated alias for .text&quot;</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># body_file, write(text)</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_body_file__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A file-like object that can be used to write to the</span>
<span class="sd">        body.  If you passed in a list ``app_iter``, that ``app_iter`` will be</span>
<span class="sd">        modified by writes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ResponseBodyFile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_body_file__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span> <span class="o">=</span> <span class="n">iter_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_body_file__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>

    <span class="n">body_file</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_body_file__get</span><span class="p">,</span> <span class="n">_body_file__set</span><span class="p">,</span> <span class="n">_body_file__del</span><span class="p">,</span>
                         <span class="n">doc</span><span class="o">=</span><span class="n">_body_file__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;You can only write str to a Response.body_file, not </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You can only write text to Response if charset has &quot;</span>
                       <span class="s2">&quot;been set&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">iter_close</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
            <span class="n">app_iter</span> <span class="o">=</span> <span class="n">new_app_iter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">)</span>
        <span class="n">app_iter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># app_iter</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_app_iter__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the ``app_iter`` of the response.</span>

<span class="sd">        If ``body`` was set, this will create an ``app_iter`` from that</span>
<span class="sd">        ``body`` (a single-item list).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>

    <span class="k">def</span> <span class="nf">_app_iter__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Undo the automatically-set content-length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_app_iter__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">app_iter</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_app_iter__get</span><span class="p">,</span> <span class="n">_app_iter__set</span><span class="p">,</span> <span class="n">_app_iter__del</span><span class="p">,</span>
                        <span class="n">doc</span><span class="o">=</span><span class="n">_app_iter__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># headers attrs</span>
    <span class="c1">#</span>

    <span class="n">allow</span> <span class="o">=</span> <span class="n">list_header</span><span class="p">(</span><span class="s1">&#39;Allow&#39;</span><span class="p">,</span> <span class="s1">&#39;14.7&#39;</span><span class="p">)</span>
    <span class="c1"># TODO: (maybe) support response.vary += &#39;something&#39;</span>
    <span class="c1"># TODO: same thing for all listy headers</span>
    <span class="n">vary</span> <span class="o">=</span> <span class="n">list_header</span><span class="p">(</span><span class="s1">&#39;Vary&#39;</span><span class="p">,</span> <span class="s1">&#39;14.44&#39;</span><span class="p">)</span>

    <span class="n">content_length</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s1">&#39;14.17&#39;</span><span class="p">),</span>
        <span class="n">parse_int</span><span class="p">,</span> <span class="n">serialize_int</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;14.11&#39;</span><span class="p">)</span>
    <span class="n">content_language</span> <span class="o">=</span> <span class="n">list_header</span><span class="p">(</span><span class="s1">&#39;Content-Language&#39;</span><span class="p">,</span> <span class="s1">&#39;14.12&#39;</span><span class="p">)</span>
    <span class="n">content_location</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-Location&#39;</span><span class="p">,</span> <span class="s1">&#39;14.14&#39;</span><span class="p">)</span>
    <span class="n">content_md5</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-MD5&#39;</span><span class="p">,</span> <span class="s1">&#39;14.14&#39;</span><span class="p">)</span>
    <span class="n">content_disposition</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span> <span class="s1">&#39;19.5.1&#39;</span><span class="p">)</span>

    <span class="n">accept_ranges</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Accept-Ranges&#39;</span><span class="p">,</span> <span class="s1">&#39;14.5&#39;</span><span class="p">)</span>
    <span class="n">content_range</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="s1">&#39;14.16&#39;</span><span class="p">),</span>
        <span class="n">parse_content_range</span><span class="p">,</span> <span class="n">serialize_content_range</span><span class="p">,</span> <span class="s1">&#39;ContentRange object&#39;</span><span class="p">)</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">date_header</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;14.18&#39;</span><span class="p">)</span>
    <span class="n">expires</span> <span class="o">=</span> <span class="n">date_header</span><span class="p">(</span><span class="s1">&#39;Expires&#39;</span><span class="p">,</span> <span class="s1">&#39;14.21&#39;</span><span class="p">)</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">date_header</span><span class="p">(</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">,</span> <span class="s1">&#39;14.29&#39;</span><span class="p">)</span>

    <span class="n">_etag_raw</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;ETag&#39;</span><span class="p">,</span> <span class="s1">&#39;14.19&#39;</span><span class="p">)</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">_etag_raw</span><span class="p">,</span>
        <span class="n">parse_etag_response</span><span class="p">,</span> <span class="n">serialize_etag_response</span><span class="p">,</span>
        <span class="s1">&#39;Entity tag&#39;</span>
    <span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">etag_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parse_etag_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_etag_raw</span><span class="p">,</span> <span class="n">strong</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">location</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;14.30&#39;</span><span class="p">)</span>
    <span class="n">pragma</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Pragma&#39;</span><span class="p">,</span> <span class="s1">&#39;14.32&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;14.6&#39;</span><span class="p">),</span>
        <span class="n">parse_int_safe</span><span class="p">,</span> <span class="n">serialize_int</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="n">retry_after</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">,</span> <span class="s1">&#39;14.37&#39;</span><span class="p">),</span>
        <span class="n">parse_date_delta</span><span class="p">,</span> <span class="n">serialize_date_delta</span><span class="p">,</span> <span class="s1">&#39;HTTP date or delta seconds&#39;</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;14.38&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: the standard allows this to be a list of challenges</span>
    <span class="n">www_authenticate</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span>
        <span class="n">header_getter</span><span class="p">(</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;14.47&#39;</span><span class="p">),</span>
        <span class="n">parse_auth</span><span class="p">,</span> <span class="n">serialize_auth</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># charset</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_charset__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get/set the ``charset`` specified in ``Content-Type``.</span>

<span class="sd">        There is no checking to validate that a ``content_type`` actually</span>
<span class="sd">        allows for a ``charset`` parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">CHARSET_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_charset__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_charset__del</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;You cannot set the charset when no &quot;</span>
                                 <span class="s2">&quot;content-type is defined&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">CHARSET_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;; charset=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

    <span class="k">def</span> <span class="nf">_charset__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Don&#39;t need to remove anything</span>
            <span class="k">return</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">CHARSET_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

    <span class="n">charset</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_charset__get</span><span class="p">,</span> <span class="n">_charset__set</span><span class="p">,</span> <span class="n">_charset__del</span><span class="p">,</span>
                       <span class="n">doc</span><span class="o">=</span><span class="n">_charset__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># content_type</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_content_type__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get/set the ``Content-Type`` header. If no ``Content-Type`` header is</span>
<span class="sd">        set, this will return ``None``.</span>

<span class="sd">        .. versionchanged:: 1.7</span>

<span class="sd">            Setting a new ``Content-Type`` will remove all ``Content-Type``</span>
<span class="sd">            parameters and reset the ``charset`` to the default if the</span>
<span class="sd">            ``Content-Type`` is ``text/*`` or XML (``application/xml`` or</span>
<span class="sd">            ``*/*+xml``).</span>

<span class="sd">            To preserve all ``Content-Type`` parameters, you may use the</span>
<span class="sd">            following code:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                resp = Response()</span>
<span class="sd">                params = resp.content_type_params</span>
<span class="sd">                resp.content_type = &#39;application/something&#39;</span>
<span class="sd">                resp.content_type_params = params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_content_type__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type__del</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># Set up the charset if the content-type doesn&#39;t have one</span>

            <span class="n">has_charset</span> <span class="o">=</span> <span class="s1">&#39;charset=&#39;</span> <span class="ow">in</span> <span class="n">content_type</span>

            <span class="n">new_charset</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">has_charset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>
            <span class="p">):</span>
                <span class="n">new_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>

            <span class="c1"># Optimize for the default_content_type as shipped by</span>
            <span class="c1"># WebOb, becuase we know that &#39;text/html&#39; has a charset,</span>
            <span class="c1"># otherwise add a charset if the content_type has a charset.</span>
            <span class="c1">#</span>
            <span class="c1"># We add the default charset if the content-type is &quot;texty&quot;.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">new_charset</span> <span class="ow">and</span>
                <span class="p">(</span>
                    <span class="n">content_type</span> <span class="o">==</span> <span class="s1">&#39;text/html&#39;</span> <span class="ow">or</span>
                    <span class="n">_content_type_has_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">content_type</span> <span class="o">+=</span> <span class="s1">&#39;; charset=&#39;</span> <span class="o">+</span> <span class="n">new_charset</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>

    <span class="k">def</span> <span class="nf">_content_type__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_content_type__get</span><span class="p">,</span> <span class="n">_content_type__set</span><span class="p">,</span>
                            <span class="n">_content_type__del</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_content_type__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># content_type_params</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_content_type_params__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dictionary of all the parameters in the content type.</span>

<span class="sd">        (This is not a view, set to change, modifications of the dict will not</span>
<span class="sd">        be applied otherwise.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">_PARAM_RE</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_content_type_params__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type_params__del</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">value_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_OK_PARAM_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;; </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ct</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span>

    <span class="k">def</span> <span class="nf">_content_type_params__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">content_type_params</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_content_type_params__get</span><span class="p">,</span>
        <span class="n">_content_type_params__set</span><span class="p">,</span>
        <span class="n">_content_type_params__del</span><span class="p">,</span>
        <span class="n">_content_type_params__get</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># set_cookie, unset_cookie, delete_cookie, merge_cookies</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="Response.set_cookie"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.set_cookie">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">samesite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set (add) a cookie for the response.</span>

<span class="sd">        Arguments are:</span>

<span class="sd">        ``name``</span>

<span class="sd">           The cookie name.</span>

<span class="sd">        ``value``</span>

<span class="sd">           The cookie value, which should be a string or ``None``.  If</span>
<span class="sd">           ``value`` is ``None``, it&#39;s equivalent to calling the</span>
<span class="sd">           :meth:`webob.response.Response.unset_cookie` method for this</span>
<span class="sd">           cookie key (it effectively deletes the cookie on the client).</span>

<span class="sd">        ``max_age``</span>

<span class="sd">           An integer representing a number of seconds, ``datetime.timedelta``,</span>
<span class="sd">           or ``None``. This value is used as the ``Max-Age`` of the generated</span>
<span class="sd">           cookie.  If ``expires`` is not passed and this value is not</span>
<span class="sd">           ``None``, the ``max_age`` value will also influence the ``Expires``</span>
<span class="sd">           value of the cookie (``Expires`` will be set to ``now`` +</span>
<span class="sd">           ``max_age``).  If this value is ``None``, the cookie will not have a</span>
<span class="sd">           ``Max-Age`` value (unless ``expires`` is set). If both ``max_age``</span>
<span class="sd">           and ``expires`` are set, this value takes precedence.</span>

<span class="sd">        ``path``</span>

<span class="sd">           A string representing the cookie ``Path`` value.  It defaults to</span>
<span class="sd">           ``/``.</span>

<span class="sd">        ``domain``</span>

<span class="sd">           A string representing the cookie ``Domain``, or ``None``.  If</span>
<span class="sd">           domain is ``None``, no ``Domain`` value will be sent in the</span>
<span class="sd">           cookie.</span>

<span class="sd">        ``secure``</span>

<span class="sd">           A boolean.  If it&#39;s ``True``, the ``secure`` flag will be sent in</span>
<span class="sd">           the cookie, if it&#39;s ``False``, the ``secure`` flag will not be</span>
<span class="sd">           sent in the cookie.</span>

<span class="sd">        ``httponly``</span>

<span class="sd">           A boolean.  If it&#39;s ``True``, the ``HttpOnly`` flag will be sent</span>
<span class="sd">           in the cookie, if it&#39;s ``False``, the ``HttpOnly`` flag will not</span>
<span class="sd">           be sent in the cookie.</span>

<span class="sd">        ``samesite``</span>

<span class="sd">          A string representing the ``SameSite`` attribute of the cookie or</span>
<span class="sd">          ``None``. If samesite is ``None`` no ``SameSite`` value will be sent</span>
<span class="sd">          in the cookie. Should only be ``&quot;Strict&quot;`` or ``&quot;Lax&quot;``.</span>

<span class="sd">        ``comment``</span>

<span class="sd">           A string representing the cookie ``Comment`` value, or ``None``.</span>
<span class="sd">           If ``comment`` is ``None``, no ``Comment`` value will be sent in</span>
<span class="sd">           the cookie.</span>

<span class="sd">        ``expires``</span>

<span class="sd">           A ``datetime.timedelta`` object representing an amount of time,</span>
<span class="sd">           ``datetime.datetime`` or ``None``. A non-``None`` value is used to</span>
<span class="sd">           generate the ``Expires`` value of the generated cookie. If</span>
<span class="sd">           ``max_age`` is not passed, but this value is not ``None``, it will</span>
<span class="sd">           influence the ``Max-Age`` header. If this value is ``None``, the</span>
<span class="sd">           ``Expires`` cookie value will be unset (unless ``max_age`` is set).</span>
<span class="sd">           If ``max_age`` is set, it will be used to generate the ``expires``</span>
<span class="sd">           and this value is ignored.</span>

<span class="sd">           If a ``datetime.datetime`` is provided it has to either be timezone</span>
<span class="sd">           aware or be based on UTC. ``datetime.datetime`` objects that are</span>
<span class="sd">           local time are not supported. Timezone aware ``datetime.datetime``</span>
<span class="sd">           objects are converted to UTC.</span>

<span class="sd">           This argument will be removed in future versions of WebOb (version</span>
<span class="sd">           1.9).</span>

<span class="sd">        ``overwrite``</span>

<span class="sd">           If this key is ``True``, before setting the cookie, unset any</span>
<span class="sd">           existing cookie.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Remove in WebOb 1.10</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">warn_deprecation</span><span class="p">(</span><span class="s1">&#39;Argument &quot;expires&quot; will be removed in a future &#39;</span>
                             <span class="s1">&#39;version of WebOb, please use &quot;max_age&quot;.&#39;</span><span class="p">,</span> <span class="mf">1.10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unset_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># If expires is set, but not max_age we set max_age to expires</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="n">expires</span>

        <span class="c1"># expires can also be a datetime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>

            <span class="c1"># If expires has a timezone attached, convert it to UTC</span>
            <span class="k">if</span> <span class="n">expires</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">and</span> <span class="n">expires</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">():</span>
                <span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">expires</span> <span class="o">-</span> <span class="n">expires</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">max_age</span> <span class="o">=</span> <span class="n">expires</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">cookie</span> <span class="o">=</span> <span class="n">make_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="n">httponly</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="n">samesite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">))</span></div>

<div class="viewcode-block" id="Response.delete_cookie"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.delete_cookie">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">delete_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a cookie from the client.  Note that ``path`` and ``domain``</span>
<span class="sd">        must match how the cookie was originally set.</span>

<span class="sd">        This sets the cookie to the empty string, and ``max_age=0`` so</span>
<span class="sd">        that it should expire immediately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span></div>

<div class="viewcode-block" id="Response.unset_cookie"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.unset_cookie">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">unset_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unset a cookie with the given name (remove it from the response).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">Cookie</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">cookies</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">cookies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">serialize</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No cookie has been set with the name </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Response.merge_cookies"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.merge_cookies">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">merge_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge the cookies that were set on this response with the</span>
<span class="sd">        given ``resp`` object (which can be any WSGI application).</span>

<span class="sd">        If the ``resp`` is a :class:`webob.Response` object, then the</span>
<span class="sd">        other object will be modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">):</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span> <span class="k">if</span>
                         <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;set-cookie&#39;</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">repl_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">repl_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span> <span class="o">+</span> <span class="n">c_headers</span><span class="p">,</span>
                                          <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">repl_start_response</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">repl_app</span></div>

    <span class="c1">#</span>
    <span class="c1"># cache_control</span>
    <span class="c1">#</span>

    <span class="n">_cache_control_obj</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_cache_control__get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get/set/modify the Cache-Control header (`HTTP spec section 14.9</span>
<span class="sd">        &lt;http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9&gt;`_).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span> <span class="o">=</span> <span class="n">CacheControl</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">updates_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_cache_control</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span><span class="o">.</span><span class="n">header_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span><span class="o">.</span><span class="n">header_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">new_obj</span> <span class="o">=</span> <span class="n">CacheControl</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_obj</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span><span class="o">.</span><span class="n">header_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span>

    <span class="k">def</span> <span class="nf">_cache_control__set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># This actually becomes a copy</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CacheControl</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_control_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CacheControl</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_control</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cache_control__del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_control</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_update_cache_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_dict</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">serialize_cache_control</span><span class="p">(</span><span class="n">prop_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Cache-Control&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">cache_control</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_cache_control__get</span><span class="p">,</span> <span class="n">_cache_control__set</span><span class="p">,</span>
        <span class="n">_cache_control__del</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_cache_control__get</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># cache_expires</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_cache_expires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set expiration on this request.  This sets the response to</span>
<span class="sd">            expire in the given seconds, and any other attributes are used</span>
<span class="sd">            for ``cache_control`` (e.g., ``private=True``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">timedelta_to_seconds</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
        <span class="n">cache_control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_control</span>
        <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">seconds</span><span class="p">:</span>
            <span class="c1"># To really expire something, you have to force a</span>
            <span class="c1"># bunch of these cache control attributes, and IE may</span>
            <span class="c1"># not pay attention to those still so we also set</span>
            <span class="c1"># Expires.</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">no_store</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">no_cache</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">must_revalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">post_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">pre_check</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;last-modified&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span> <span class="o">=</span> <span class="s1">&#39;no-cache&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache_control</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pragma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cache_control</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">cache_expires</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_expires</span><span class="p">,</span> <span class="n">_cache_expires</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># encode_content, decode_content, md5_etag</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="Response.encode_content"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.encode_content">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">encode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode the content with the given encoding (only ``gzip`` and</span>
<span class="sd">        ``identity`` are supported).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;gzip&#39;</span><span class="p">),</span> \
            <span class="s2">&quot;Unknown encoding: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">encoding</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decode_content</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span> <span class="o">=</span> <span class="n">gzip_app_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gzip_app_iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_encoding</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span></div>

    <span class="k">def</span> <span class="nf">decode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_encoding</span> <span class="ow">or</span> <span class="s1">&#39;identity&#39;</span>
        <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">content_encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="s1">&#39;deflate&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;I don&#39;t know how to decode the content </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content_encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">gzip</span> <span class="k">import</span> <span class="n">GzipFile</span>
            <span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
            <span class="n">gzip_f</span> <span class="o">=</span> <span class="n">GzipFile</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">gzip_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_encoding</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gzip_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Weird feature: http://bugs.python.org/issue5784</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_encoding</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Response.md5_etag"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.md5_etag">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">md5_etag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_content_md5</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an etag for the response object using an MD5 hash of</span>
<span class="sd">        the body (the ``body`` parameter, or ``self.body`` if not given).</span>

<span class="sd">        Sets ``self.etag``.</span>

<span class="sd">        If ``set_content_md5`` is ``True``, sets ``self.content_md5`` as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="n">md5_digest</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">md5_digest</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">md5_digest</span><span class="p">)</span>
        <span class="n">md5_digest</span> <span class="o">=</span> <span class="n">md5_digest</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">md5_digest</span> <span class="o">=</span> <span class="n">native_</span><span class="p">(</span><span class="n">md5_digest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etag</span> <span class="o">=</span> <span class="n">md5_digest</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_content_md5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_md5</span> <span class="o">=</span> <span class="n">md5_digest</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_location_absolute</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">SCHEME_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">new_location</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">_request_uri</span><span class="p">(</span><span class="n">environ</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_location</span>

    <span class="k">def</span> <span class="nf">_abs_headerlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="c1"># Build the headerlist, if we have a Location header, make it absolute</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;location&#39;</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_location_absolute</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headerlist</span>
        <span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># __call__, conditional_response_app</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WSGI application interface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional_response</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional_response_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="n">headerlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abs_headerlist</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">start_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">headerlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
            <span class="c1"># Special case here...</span>
            <span class="k">return</span> <span class="n">EmptyResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>

    <span class="n">_safe_methods</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Response.conditional_response_app"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.conditional_response_app">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">conditional_response_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like the normal ``__call__`` interface, but checks conditional headers:</span>

<span class="sd">            * ``If-Modified-Since``   (``304 Not Modified``; only on ``GET``,</span>
<span class="sd">              ``HEAD``)</span>
<span class="sd">            * ``If-None-Match``       (``304 Not Modified``; only on ``GET``,</span>
<span class="sd">              ``HEAD``)</span>
<span class="sd">            * ``Range``               (``406 Partial Content``; only on ``GET``,</span>
<span class="sd">              ``HEAD``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">BaseRequest</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">headerlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abs_headerlist</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_methods</span><span class="p">:</span>
            <span class="n">status304</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">if_none_match</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">etag</span><span class="p">:</span>
                <span class="n">status304</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etag</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">if_none_match</span>
            <span class="k">elif</span> <span class="n">req</span><span class="o">.</span><span class="n">if_modified_since</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">:</span>
                <span class="n">status304</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">&lt;=</span> <span class="n">req</span><span class="o">.</span><span class="n">if_modified_since</span>
            <span class="k">if</span> <span class="n">status304</span><span class="p">:</span>
                <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;304 Not Modified&#39;</span><span class="p">,</span> <span class="n">filter_headers</span><span class="p">(</span><span class="n">headerlist</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">EmptyResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">range</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">if_range</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_range</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">content_range</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">content_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iter_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="s2">&quot;Requested range not satisfiable: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">req</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
                <span class="n">headerlist</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))),</span>
                    <span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ContentRange</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span><span class="p">))),</span>
                    <span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
                <span class="p">]</span> <span class="o">+</span> <span class="n">filter_headers</span><span class="p">(</span><span class="n">headerlist</span><span class="p">)</span>
                <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;416 Requested Range Not Satisfiable&#39;</span><span class="p">,</span>
                               <span class="n">headerlist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">()</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_iter_range</span><span class="p">(</span><span class="n">content_range</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                               <span class="n">content_range</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># the following should be guaranteed by</span>
                    <span class="c1"># Range.range_for_length(length)</span>
                    <span class="k">assert</span> <span class="n">content_range</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">headerlist</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">content_range</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">content_range</span><span class="o">.</span><span class="n">start</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_range</span><span class="p">)),</span>
                    <span class="p">]</span> <span class="o">+</span> <span class="n">filter_headers</span><span class="p">(</span><span class="n">headerlist</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,))</span>
                    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;206 Partial Content&#39;</span><span class="p">,</span> <span class="n">headerlist</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">EmptyResponse</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">app_iter</span>

        <span class="n">start_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">headerlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EmptyResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span></div>

<div class="viewcode-block" id="Response.app_iter_range"><a class="viewcode-back" href="../../api/response.html#pyramid.response.Response.app_iter_range">[ドキュメント]</a>    <span class="k">def</span> <span class="nf">app_iter_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new ``app_iter`` built from the response ``app_iter``, that</span>
<span class="sd">        serves up only the given ``start:stop`` range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_iter</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s1">&#39;app_iter_range&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">app_iter</span><span class="o">.</span><span class="n">app_iter_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AppIterRange</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">filter_headers</span><span class="p">(</span><span class="n">hlist</span><span class="p">,</span> <span class="n">remove_headers</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hlist</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_headers</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">iter_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">):</span> <span class="c1"># 256Kb</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="n">data</span>

<span class="k">class</span> <span class="nc">ResponseBodyFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;wb&#39;</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a :class:`~Response` as a file like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">write</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;body_file for </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;The encoding of the file (inherited from response.charset)&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a sequence of lines to the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Response bodies cannot be closed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide the current location where we are going to start writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">has_body</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">app_iter</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">AppIterRange</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps an ``app_iter``, returning just a range of bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_iter</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Bad start: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">start</span>
        <span class="k">assert</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Bad stop: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># position in app_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_skip_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="n">start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="k">return</span> <span class="n">chunk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="c1"># need to skip some leading bytes</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skip_start</span><span class="p">()</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">]</span>

    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span> <span class="c1"># py3</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">iter_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_iter</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmptyResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An empty WSGI response.</span>

<span class="sd">    An iterator that immediately stops. Optionally provides a close</span>
<span class="sd">    method to close an underlying ``app_iter`` it replaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">app_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">app_iter</span><span class="o">.</span><span class="n">close</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span> <span class="c1"># py3</span>

<span class="k">def</span> <span class="nf">_is_xml</span><span class="p">(</span><span class="n">content_type</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span>
            <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;application/&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">content_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;+xml&#39;</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span>
            <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;image/&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">content_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;+xml&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_content_type_has_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;text/&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">_is_xml</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">_request_uri</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like ``wsgiref.url.request_uri``, except eliminates ``:80`` ports.</span>

<span class="sd">    Returns the full request URI.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span>

    <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:80&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;http&#39;</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:443&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">path_info</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="n">path_info</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">+=</span> <span class="n">url_quote</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
    <span class="n">qpath_info</span> <span class="o">=</span> <span class="n">url_quote</span><span class="p">(</span><span class="n">path_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;SCRIPT_NAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">qpath_info</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="n">qpath_info</span>
    <span class="k">return</span> <span class="n">url</span>


<span class="k">def</span> <span class="nf">iter_close</span><span class="p">(</span><span class="nb">iter</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
        <span class="nb">iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">gzip_app_iter</span><span class="p">(</span><span class="n">app_iter</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">crc</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">compress</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">zlib</span><span class="o">.</span><span class="n">DEFLATED</span><span class="p">,</span> <span class="o">-</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">,</span>
                                <span class="n">zlib</span><span class="o">.</span><span class="n">DEF_MEM_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">_gzip_header</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">app_iter</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">crc</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">crc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>

        <span class="c1"># The compress function may return zero length bytes if the input is</span>
        <span class="c1"># small enough; it buffers the input for the next iteration or for a</span>
        <span class="c1"># flush.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compress</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">result</span>

    <span class="c1"># Similarly, flush may also not yield a value.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">compress</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">result</span>
    <span class="k">yield</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;2L&quot;</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_error_unicode_in_app_iter</span><span class="p">(</span><span class="n">app_iter</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">app_iter_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">app_iter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">app_iter_repr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">app_iter_repr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">app_iter_repr</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="o">+</span> <span class="n">app_iter_repr</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s1">&#39;An item of the app_iter (</span><span class="si">%s</span><span class="s1">) was text, causing a &#39;</span>
        <span class="s1">&#39;text body: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_iter_repr</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.9.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >モジュールコード</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2008-2018, Agendaless Consulting.
      最終更新: 11月 13, 2018
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1 で生成しました。
    </div>
  </body>
</html>